import{d as _e,f as Ne,h as d,w as R,e as F,i as ze,L as B,J as Fe,c as g,a as s,j as I,n as G,t as N,p as u,q as y,F as K,m as Q,E as Z,k as ee,o as h,_ as De}from"./main.js";import{u as Pe,n as We}from"./videoStore.js";function ue(r){if(!Number.isFinite(r)||r<0)return"00:00";const m=Math.floor(r/60),x=Math.floor(r%60);return`${m.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`}function $e(r,m,x){return!Number.isFinite(r)||!Number.isFinite(m)||!Number.isFinite(x)||x<=0||m<=r?0:(m-r)/x*100}function Re(r,m){return!Number.isFinite(r)||!Number.isFinite(m)||m<=0?0:r/m*100}function Be(){for(var r="0123456789ABCDEF",m="#",x=0;x<6;x++)m+=r[Math.floor(Math.random()*16)];return m}const Ie={class:"timeline-container"},Xe={class:"timeline-header"},He={class:"timeline-controls"},Oe=["disabled"],Ve={class:"time-display"},je={class:"zoom-controls"},Ue=["disabled"],qe={class:"zoom-level"},Ae=["disabled"],Je={class:"time-markers"},Ye={class:"marker-text"},Ge={class:"segments-container"},Ke=["data-id","onClick","onContextmenu"],Qe={class:"segment-content"},Ze={class:"segment-label"},et={class:"segment-duration"},tt=["onClick"],nt={key:0,class:"draft-indicator"},it={key:0,class:"waveform-container"},st=_e({__name:"Timeline",props:{video:{},segments:{},labels:{},currentTime:{},isPlaying:{type:Boolean},activeSegmentId:{},showWaveform:{type:Boolean},selectionMode:{type:Boolean},fps:{}},emits:["seek","play-pause","segment-select","segment-edit","segment-delete","segment-create","segment-resize","segment-move","time-selection"],setup(r,{emit:m}){const x=Ne(),j=Pe();j.segmentsByLabel;const T=r,f=m,M=d(null),U=d(null),ce=d([]),D=d([]),k=d(1),P=d(!1),L=d(0),_=d(0),X=d([]);R(()=>T.segments,t=>{(t||[]).forEach(e=>{X.value.includes(e.label)||X.value.push(e.label)})},{immediate:!0});const de=d(null),me=d(null),C=d({visible:!1,x:0,y:0,segment:null}),H=d({visible:!1,x:0,y:0,text:""}),b=F(()=>T.video?.duration||0),ve=F(()=>{const t=b.value,e=T.currentTime||0;if(!t||t===0||!Number.isFinite(t))return console.warn("[Timeline] Duration is 0 or invalid:",t),0;if(!Number.isFinite(e)||e<0)return console.warn("[Timeline] CurrentTime is invalid:",e),0;const n=e/t*100;return Number.isFinite(n)?Math.max(0,Math.min(100,n)):(console.warn("[Timeline] Calculated percentage is NaN:",{currentVideoTime:e,videoDuration:t}),0)}),fe=F(()=>{const t=[],e=b.value;if(e===0)return t;const i=10/k.value,a=Math.floor(e/i);for(let l=0;l<=a;l++){const o=l*i;o<=e&&t.push({time:o,position:o/e*100})}return t});F(()=>T.fps||50);const pe=t=>{const e=We(t),n=t.label_name??t.label??e.label??"",i=te(n);return!t.startTime&&t.start_time&&console.debug("[Timeline] Converted snake_case to camelCase:",{from:{start_time:t.start_time,end_time:t.end_time,label_name:t.label_name},to:{startTime:e.startTime,endTime:e.endTime,label:n}}),{...e,start:e.startTime,end:e.endTime,isDraft:typeof t.id=="string"&&(t.id==="draft"||t.id.startsWith("temp-")),color:i||Be()||void 0,avgConfidence:t.avgConfidence??0,label:n}},W=d(null),ge=t=>{const e=t.label_name??t.label;W.value=e,f("segment-select",t)},he=t=>j.getTranslationForLabel(t),te=t=>j.getColorForLabel(t),w=d([]);R(()=>T.segments,t=>{t?(console.debug("[Timeline] Processing segments:",{count:t.length,sample:t.slice(0,2).map(e=>({id:e.id,label:e.label,label_name:e.label_name,start_time:e.start_time,startTime:e.startTime,end_time:e.end_time,endTime:e.endTime}))}),w.value=t.map(pe),console.debug("[Timeline] Canonical segments created:",{count:w.value.length,sample:w.value.slice(0,2).map(e=>({id:e.id,label:e.label,start:e.start,end:e.end,startTime:e.startTime,endTime:e.endTime}))})):w.value=[]},{immediate:!0});const $=F(()=>{const t={};console.debug("[Timeline] segmentRows - processing segments:",{count:w.value.length,segments:w.value.map(i=>({id:i.id,label:i.label,start:i.start,end:i.end}))});for(const i of w.value){if(!i.label){console.error("[Timeline] Segment missing label property:",i);continue}(t[i.label]||=[]).push(i)}console.debug("[Timeline] Label buckets created:",{labels:Object.keys(t),counts:Object.entries(t).map(([i,a])=>`${i}:${a.length}`)});const e=W.value?[W.value,...X.value.filter(i=>i!==W.value)]:[...X.value],n=[];return e.forEach(i=>{if(!t[i])return;const a=t[i].sort((c,E)=>c.start-E.start);let l=0,o={key:`${i}-0`,label:i,rowNumber:n.length,segments:[],maxEndTime:0};for(const c of a)c.start<o.maxEndTime-1e-4&&(n.push(o),l+=1,o={key:`${i}-${l}`,label:i,rowNumber:n.length,segments:[],maxEndTime:0}),o.segments.push(c),o.maxEndTime=Math.max(o.maxEndTime,c.end);n.push(o)}),console.debug("[Timeline] Rows created:",{count:n.length,rows:n.map(i=>({key:i.key,label:i.label,segmentCount:i.segments.length}))}),n}),z=F(()=>60+$.value.length*45+10),q=t=>typeof t!="number"||isNaN(t)?"00:00":ue(t),be=(t,e)=>{const n=e-t;return ue(n)},ye=t=>{const e=Re(t,b.value);return!Number.isFinite(e)||e<0?(console.error("[Timeline] Invalid segment position calculated:",{startTime:t,duration:b.value,position:e}),0):e},ne=(t,e)=>{const n=$e(t,e,b.value);return!Number.isFinite(n)||n<=0?(console.error("[Timeline] Invalid segment width calculated:",{startTime:t,endTime:e,duration:b.value,width:n}),0):n};function xe(t,e){let n=null,i=0,a=0,l=0,o=0,c=0;const E=p=>p/e.trackPx()*e.duration();function oe(p){p.stopPropagation();const S=p.target.closest(".resize-handle");S?.classList.contains("start-handle")?n="start":S?.classList.contains("end-handle")?n="end":n="drag",i=p.clientX,a=t.offsetLeft,l=t.offsetWidth,t.setPointerCapture(p.pointerId),p.preventDefault()}function Y(p){if(!n)return;const S=p.clientX-i;if(n==="drag"){let v=Math.min(Math.max(0,a+S),e.trackPx()-l);t.style.left=v+"px",o=v,c=v+l}if(n==="start"){let v=Math.min(a+S,a+l-10),re=l+(a-v);t.style.left=v+"px",t.style.width=re+"px",o=v,c=v+re}if(n==="end"){let v=Math.max(10,l+S);t.style.width=v+"px",t.style.left=a+"px",o=a,c=a+v}}function V(p){if(!n)return;Y(p);let S=o,v=c;n==="drag"?e.onMove(E(S),E(v)):e.onResize(E(S),E(v),n),n=null,t.releasePointerCapture(p.pointerId),e.onDone()}return t.addEventListener("pointerdown",oe),t.addEventListener("pointermove",Y),t.addEventListener("pointerup",V),t.addEventListener("pointercancel",V),()=>{t.removeEventListener("pointerdown",oe),t.removeEventListener("pointermove",Y),t.removeEventListener("pointerup",V),t.removeEventListener("pointercancel",V)}}const ie=()=>{D.value.forEach(t=>t()),D.value=[],M.value&&B(()=>{$.value.forEach(t=>{t.segments.forEach(e=>{const n=document.querySelector(`[data-id="${e.id}"]`);if(!n)return;const i=xe(n,{trackPx:()=>M.value.offsetWidth,duration:()=>b.value,onMove:(a,l)=>{const o=w.value.find(c=>c.id===e.id);o&&(o.start=a,o.end=l,o.startTime=a,o.endTime=l),f("segment-move",e.id,a,l)},onResize:(a,l,o)=>{const c=w.value.find(E=>E.id===e.id);c&&(c.start=a,c.end=l,c.startTime=a,c.endTime=l),f("segment-resize",e.id,a,l,o)},onDone:()=>{const a=w.value.find(l=>l.id===e.id);if(a)if(typeof e.id=="string"&&(e.id==="draft"||e.id.startsWith("temp-")))f("segment-resize",e.id,a.start,a.end,"end",!0);else{const l=Le(e.id);l!==null&&f("segment-resize",l,a.start,a.end,"end",!0)}}});D.value.push(i)})})})},Te=()=>{k.value<5&&(k.value=Math.min(5,k.value+.5))},ke=()=>{k.value>1&&(k.value=Math.max(1,k.value-.5))},we=()=>{f("play-pause")},Ce=t=>{t&&(O(),f("segment-edit",t))},se=t=>{t&&(O(),f("segment-delete",t))},Se=t=>{t&&(O(),f("seek",t.startTime||0),f("play-pause"))},Ee=(t,e)=>{C.value={visible:!0,x:e.clientX,y:e.clientY,segment:t}},O=()=>{C.value.visible=!1},Me=t=>{if(me.value||de.value)return;const e=M.value.getBoundingClientRect(),n=t.clientX-e.left,i=n/e.width*b.value;T.selectionMode?(P.value=!0,L.value=n/e.width*100,_.value=L.value,document.addEventListener("mousemove",A),document.addEventListener("mouseup",J)):f("seek",i)},A=t=>{if(!P.value||!M.value)return;const e=M.value.getBoundingClientRect(),n=t.clientX-e.left;_.value=Math.max(0,Math.min(100,n/e.width*100))},J=t=>{if(!P.value)return;M.value.getBoundingClientRect();const e=Math.min(L.value,_.value),n=Math.max(L.value,_.value),i=e/100*b.value,a=n/100*b.value;a-i>.1&&f("time-selection",{start:i,end:a}),P.value=!1,L.value=0,_.value=0,document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",J)};R(()=>T.video,()=>{T.showWaveform&&B(()=>{ae()})}),R($,()=>B(ie),{immediate:!0}),R($,t=>{t.forEach(e=>{e.segments.forEach(n=>{ne(n.start,n.end)===0&&console.warn("[Timeline] Segment mit 0% Breite:",n)})})},{immediate:!0});const ae=()=>{if(!U.value||!T.video)return;const t=U.value,e=t.getContext("2d");if(e){t.width=t.offsetWidth,t.height=t.offsetHeight,e.fillStyle="#e0e0e0",e.fillRect(0,0,t.width,t.height),e.strokeStyle="#2196F3",e.lineWidth=1,e.beginPath();for(let n=0;n<t.width;n+=2){const i=Math.random()*t.height*.8+t.height*.1;n===0?e.moveTo(n,i):e.lineTo(n,i)}e.stroke()}},le=t=>{C.value.visible&&!t.target?.closest(".context-menu")&&O()};ze(()=>{document.addEventListener("click",le),B(()=>{ie()}),T.showWaveform&&B(()=>{ae()}),x.success({text:"[Timeline] Component mounted and ready"})}),Fe(()=>{document.removeEventListener("click",le),D.value.forEach(t=>t()),D.value=[],document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",J)});const Le=t=>{if(typeof t=="number")return t;if(typeof t=="string"){if(t==="draft"||t.startsWith("temp-"))return console.warn("[Timeline] Ignoring draft/temp segment:",t),null;const e=parseInt(t,10);return isNaN(e)?(console.error("[Timeline] Invalid segment ID:",t),null):e}return console.error("[Timeline] Unexpected segment ID type:",typeof t,t),null};return(t,e)=>(h(),g("div",Ie,[s("div",Xe,[s("div",He,[s("button",{onClick:we,class:"play-btn",disabled:!r.video},[s("i",{class:G(r.isPlaying?"fas fa-pause":"fas fa-play")},null,2)],8,Oe),s("span",Ve,N(q(r.currentTime))+" / "+N(q(b.value)),1)]),s("div",je,[s("button",{onClick:ke,disabled:u(k)<=1},[...e[4]||(e[4]=[s("i",{class:"fas fa-search-minus"},null,-1)])],8,Ue),s("span",qe,N(Math.round(u(k)*100))+"%",1),s("button",{onClick:Te,disabled:u(k)>=5},[...e[5]||(e[5]=[s("i",{class:"fas fa-search-plus"},null,-1)])],8,Ae)])]),s("div",{class:"timeline-wrapper",style:y({height:z.value+"px"})},[s("div",{class:"timeline",ref_key:"timeline",ref:M,onMousedown:Me,style:y({height:z.value+"px"})},[s("div",Je,[(h(!0),g(K,null,Q(fe.value,n=>(h(),g("div",{key:n.time,class:"time-marker",style:y({left:n.position+"%"})},[s("div",{class:"marker-line",style:y({height:z.value+"px"})},null,4),s("div",Ye,N(q(n.time)),1)],4))),128))]),s("div",Ge,[(h(!0),g(K,null,Q($.value,n=>(h(),g("div",{key:n.key,class:G(["segment-row",{active:n.label===u(W)}]),style:y({top:n.rowNumber*45+"px",height:"40px"})},[(h(!0),g(K,null,Q(n.segments,i=>(h(),g("div",{key:i.id,ref_for:!0,ref_key:"segmentElements",ref:ce,class:G(["segment",{active:i.id===r.activeSegmentId,draft:i.isDraft}]),style:y({left:ye(i.start)+"%",width:ne(i.start,i.end)+"%",backgroundColor:i.color||te(i.label),borderColor:i.isDraft?"#ff9800":"transparent"}),"data-id":i.id,onClick:a=>ge(i),onContextmenu:Z(a=>Ee(i,a),["prevent"])},[e[7]||(e[7]=s("div",{class:"resize-handle start-handle",title:"Segment-Start ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),s("div",Qe,[s("span",Ze,N(he(i.label)),1),s("span",et,N(be(i.start,i.end)),1)]),s("div",{class:"segment-delete-btn",onClick:Z(a=>se(i),["stop"]),title:"Segment löschen"},"X",8,tt),e[8]||(e[8]=s("div",{class:"resize-handle end-handle",title:"Segment-Ende ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),i.isDraft?(h(),g("div",nt,[...e[6]||(e[6]=[s("i",{class:"fas fa-edit"},null,-1)])])):I("",!0)],46,Ke))),128))],6))),128))]),s("div",{class:"playhead",style:y({left:ve.value+"%",height:z.value+"px"})},[s("div",{class:"playhead-line",style:y({height:z.value+"px"})},null,4),e[9]||(e[9]=s("div",{class:"playhead-handle"},null,-1))],4),u(P)?(h(),g("div",{key:0,class:"selection-overlay",style:y({left:Math.min(u(L),u(_))+"%",width:Math.abs(u(_)-u(L))+"%",height:z.value+"px"})},null,4)):I("",!0)],36),r.showWaveform?(h(),g("div",it,[s("canvas",{ref_key:"waveformCanvas",ref:U,class:"waveform-canvas"},null,512)])):I("",!0)],4),u(C).visible?(h(),g("div",{key:0,class:"context-menu",style:y({left:u(C).x+"px",top:u(C).y+"px"}),onClick:e[3]||(e[3]=Z(()=>{},["stop"]))},[s("div",{class:"context-menu-item",onClick:e[0]||(e[0]=n=>Ce(u(C).segment))},[...e[10]||(e[10]=[s("i",{class:"fas fa-edit"},null,-1),ee(" Segment bearbeiten ",-1)])]),s("div",{class:"context-menu-item danger",onClick:e[1]||(e[1]=n=>se(u(C).segment))},[...e[11]||(e[11]=[s("i",{class:"fas fa-trash"},null,-1),ee(" Segment löschen ",-1)])]),e[13]||(e[13]=s("div",{class:"context-menu-separator"},null,-1)),s("div",{class:"context-menu-item",onClick:e[2]||(e[2]=n=>Se(u(C).segment))},[...e[12]||(e[12]=[s("i",{class:"fas fa-play"},null,-1),ee(" Segment abspielen ",-1)])])],4)):I("",!0),u(H).visible?(h(),g("div",{key:1,class:"timeline-tooltip",style:y({left:u(H).x+"px",top:u(H).y+"px"})},N(u(H).text),5)):I("",!0)]))}}),ot=De(st,[["__scopeId","data-v-efc951e6"]]);export{ot as T};
