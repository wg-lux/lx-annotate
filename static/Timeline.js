import{d as ze,f as Ne,h as d,w as $,e as D,i as Fe,O as R,K as De,c as h,a as s,j as I,C as Y,t as z,n as u,p as y,F as J,m as Q,G as Z,k as ee,o as g,_ as _e}from"./main.js";import{u as Pe,n as We}from"./videoStore.js";function ue(r){if(!Number.isFinite(r)||r<0)return"00:00";const m=Math.floor(r/60),x=Math.floor(r%60);return`${m.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`}function Be(r,m,x){return!Number.isFinite(r)||!Number.isFinite(m)||!Number.isFinite(x)||x<=0||m<=r?0:(m-r)/x*100}function $e(r,m){return!Number.isFinite(r)||!Number.isFinite(m)||m<=0?0:r/m*100}function Re(){for(var r="0123456789ABCDEF",m="#",x=0;x<6;x++)m+=r[Math.floor(Math.random()*16)];return m}const Ie={class:"timeline-container"},Xe={class:"timeline-header"},He={class:"timeline-controls"},Ve=["disabled"],Oe={class:"time-display"},Ue={class:"zoom-controls"},je=["disabled"],qe={class:"zoom-level"},Ae=["disabled"],Ge={class:"time-markers"},Ke={class:"marker-text"},Ye={class:"segments-container"},Je=["data-id","onClick","onContextmenu"],Qe={class:"segment-content"},Ze={class:"segment-label"},et={class:"segment-duration"},tt=["onClick"],nt={key:0,class:"draft-indicator"},it={key:0,class:"waveform-container"},st=ze({__name:"Timeline",props:{video:{},segments:{},labels:{},currentTime:{},isPlaying:{type:Boolean},activeSegmentId:{},showWaveform:{type:Boolean},selectionMode:{type:Boolean},fps:{}},emits:["seek","play-pause","segment-select","segment-edit","segment-delete","segment-create","segment-resize","segment-move","time-selection"],setup(r,{emit:m}){const x=Ne(),U=Pe();U.segmentsByLabel;const b=r,f=m,S=d(null),j=d(null),ce=d([]),_=d([]),k=d(1),P=d(!1),E=d(0),L=d(0),X=d([]);$(()=>b.segments,e=>{(e||[]).forEach(t=>{X.value.includes(t.label)||X.value.push(t.label)})},{immediate:!0});const de=d(null),me=d(null),T=d({visible:!1,x:0,y:0,segment:null}),H=d({visible:!1,x:0,y:0,text:""}),C=D(()=>b.video?.duration||0),ve=D(()=>{const e=C.value,t=b.currentTime||0;if(!e||e===0||!Number.isFinite(e))return console.warn("[Timeline] Duration is 0 or invalid:",e),0;if(!Number.isFinite(t)||t<0)return console.warn("[Timeline] CurrentTime is invalid:",t),0;const n=t/e*100;return Number.isFinite(n)?Math.max(0,Math.min(100,n)):(console.warn("[Timeline] Calculated percentage is NaN:",{currentVideoTime:t,videoDuration:e}),0)}),fe=D(()=>{const e=[],t=C.value;if(t===0)return e;const i=10/k.value,o=Math.floor(t/i);for(let a=0;a<=o;a++){const l=a*i;l<=t&&e.push({time:l,position:l/t*100})}return e});D(()=>b.fps||50);const pe=e=>{const t=We(e),n=te(e.label);return{...t,start:t.startTime,end:t.endTime,isDraft:typeof e.id=="string"&&(e.id==="draft"||e.id.startsWith("temp-")),color:n||Re()||void 0,avgConfidence:e.avgConfidence??0,label:e.label??e.label_name}},W=d(null),he=e=>{W.value=e.label,f("segment-select",e)},ge=e=>U.getTranslationForLabel(e),te=e=>U.getColorForLabel(e),N=d([]);$(()=>b.segments,e=>{e?N.value=e?.map(pe):N.value=[]},{immediate:!0});const B=D(()=>{const e={};for(const i of N.value)(e[i.label]||=[]).push(i);const t=W.value?[W.value,...X.value.filter(i=>i!==W.value)]:[...X.value],n=[];return t.forEach(i=>{if(!e[i])return;const o=e[i].sort((c,M)=>c.start-M.start);let a=0,l={key:`${i}-0`,label:i,rowNumber:n.length,segments:[],maxEndTime:0};for(const c of o)c.start<l.maxEndTime-1e-4&&(n.push(l),a+=1,l={key:`${i}-${a}`,label:i,rowNumber:n.length,segments:[],maxEndTime:0}),l.segments.push(c),l.maxEndTime=Math.max(l.maxEndTime,c.end);n.push(l)}),n}),F=D(()=>60+B.value.length*45+10),q=e=>typeof e!="number"||isNaN(e)?"00:00":ue(e),ye=(e,t)=>{const n=t-e;return ue(n)},xe=e=>$e(e,C.value),ne=(e,t)=>Be(e,t,C.value);function be(e,t){let n=null,i=0,o=0,a=0,l=0,c=0;const M=p=>p/t.trackPx()*t.duration();function le(p){p.stopPropagation();const w=p.target.closest(".resize-handle");w?.classList.contains("start-handle")?n="start":w?.classList.contains("end-handle")?n="end":n="drag",i=p.clientX,o=e.offsetLeft,a=e.offsetWidth,e.setPointerCapture(p.pointerId),p.preventDefault()}function K(p){if(!n)return;const w=p.clientX-i;if(n==="drag"){let v=Math.min(Math.max(0,o+w),t.trackPx()-a);e.style.left=v+"px",l=v,c=v+a}if(n==="start"){let v=Math.min(o+w,o+a-10),re=a+(o-v);e.style.left=v+"px",e.style.width=re+"px",l=v,c=v+re}if(n==="end"){let v=Math.max(10,a+w);e.style.width=v+"px",e.style.left=o+"px",l=o,c=o+v}}function O(p){if(!n)return;K(p);let w=l,v=c;n==="drag"?t.onMove(M(w),M(v)):t.onResize(M(w),M(v),n),n=null,e.releasePointerCapture(p.pointerId),t.onDone()}return e.addEventListener("pointerdown",le),e.addEventListener("pointermove",K),e.addEventListener("pointerup",O),e.addEventListener("pointercancel",O),()=>{e.removeEventListener("pointerdown",le),e.removeEventListener("pointermove",K),e.removeEventListener("pointerup",O),e.removeEventListener("pointercancel",O)}}const ie=()=>{_.value.forEach(e=>e()),_.value=[],S.value&&R(()=>{B.value.forEach(e=>{e.segments.forEach(t=>{const n=document.querySelector(`[data-id="${t.id}"]`);if(!n)return;const i=be(n,{trackPx:()=>S.value.offsetWidth,duration:()=>C.value,onMove:(o,a)=>{const l=N.value.find(c=>c.id===t.id);l&&(l.start=o,l.end=a,l.startTime=o,l.endTime=a),f("segment-move",t.id,o,a)},onResize:(o,a,l)=>{const c=N.value.find(M=>M.id===t.id);c&&(c.start=o,c.end=a,c.startTime=o,c.endTime=a),f("segment-resize",t.id,o,a,l)},onDone:()=>{const o=N.value.find(a=>a.id===t.id);if(o)if(typeof t.id=="string"&&(t.id==="draft"||t.id.startsWith("temp-")))f("segment-resize",t.id,o.start,o.end,"end",!0);else{const a=Le(t.id);a!==null&&f("segment-resize",a,o.start,o.end,"end",!0)}}});_.value.push(i)})})})},ke=()=>{k.value<5&&(k.value=Math.min(5,k.value+.5))},Te=()=>{k.value>1&&(k.value=Math.max(1,k.value-.5))},Ce=()=>{f("play-pause")},we=e=>{e&&(V(),f("segment-edit",e))},se=e=>{e&&(V(),f("segment-delete",e))},Me=e=>{e&&(V(),f("seek",e.startTime||0),f("play-pause"))},Se=(e,t)=>{T.value={visible:!0,x:t.clientX,y:t.clientY,segment:e}},V=()=>{T.value.visible=!1},Ee=e=>{if(me.value||de.value)return;const t=S.value.getBoundingClientRect(),n=e.clientX-t.left,i=n/t.width*C.value;b.selectionMode?(P.value=!0,E.value=n/t.width*100,L.value=E.value,document.addEventListener("mousemove",A),document.addEventListener("mouseup",G)):f("seek",i)},A=e=>{if(!P.value||!S.value)return;const t=S.value.getBoundingClientRect(),n=e.clientX-t.left;L.value=Math.max(0,Math.min(100,n/t.width*100))},G=e=>{if(!P.value)return;S.value.getBoundingClientRect();const t=Math.min(E.value,L.value),n=Math.max(E.value,L.value),i=t/100*C.value,o=n/100*C.value;o-i>.1&&f("time-selection",{start:i,end:o}),P.value=!1,E.value=0,L.value=0,document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",G)};$(()=>b.video,()=>{b.showWaveform&&R(()=>{oe()})}),$(B,()=>R(ie),{immediate:!0}),$(B,e=>{e.forEach(t=>{t.segments.forEach(n=>{ne(n.start,n.end)===0&&console.warn("[Timeline] Segment mit 0% Breite:",n)})})},{immediate:!0});const oe=()=>{if(!j.value||!b.video)return;const e=j.value,t=e.getContext("2d");if(t){e.width=e.offsetWidth,e.height=e.offsetHeight,t.fillStyle="#e0e0e0",t.fillRect(0,0,e.width,e.height),t.strokeStyle="#2196F3",t.lineWidth=1,t.beginPath();for(let n=0;n<e.width;n+=2){const i=Math.random()*e.height*.8+e.height*.1;n===0?t.moveTo(n,i):t.lineTo(n,i)}t.stroke()}},ae=e=>{T.value.visible&&!e.target?.closest(".context-menu")&&V()};Fe(()=>{document.addEventListener("click",ae),R(()=>{ie()}),b.showWaveform&&R(()=>{oe()}),x.success({text:"[Timeline] Component mounted and ready"})}),De(()=>{document.removeEventListener("click",ae),_.value.forEach(e=>e()),_.value=[],document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",G)});const Le=e=>{if(typeof e=="number")return e;if(typeof e=="string"){if(e==="draft"||e.startsWith("temp-"))return console.warn("[Timeline] Ignoring draft/temp segment:",e),null;const t=parseInt(e,10);return isNaN(t)?(console.error("[Timeline] Invalid segment ID:",e),null):t}return console.error("[Timeline] Unexpected segment ID type:",typeof e,e),null};return(e,t)=>(g(),h("div",Ie,[s("div",Xe,[s("div",He,[s("button",{onClick:Ce,class:"play-btn",disabled:!r.video},[s("i",{class:Y(r.isPlaying?"fas fa-pause":"fas fa-play")},null,2)],8,Ve),s("span",Oe,z(q(r.currentTime))+" / "+z(q(C.value)),1)]),s("div",Ue,[s("button",{onClick:Te,disabled:u(k)<=1},[...t[4]||(t[4]=[s("i",{class:"fas fa-search-minus"},null,-1)])],8,je),s("span",qe,z(Math.round(u(k)*100))+"%",1),s("button",{onClick:ke,disabled:u(k)>=5},[...t[5]||(t[5]=[s("i",{class:"fas fa-search-plus"},null,-1)])],8,Ae)])]),s("div",{class:"timeline-wrapper",style:y({height:F.value+"px"})},[s("div",{class:"timeline",ref_key:"timeline",ref:S,onMousedown:Ee,style:y({height:F.value+"px"})},[s("div",Ge,[(g(!0),h(J,null,Q(fe.value,n=>(g(),h("div",{key:n.time,class:"time-marker",style:y({left:n.position+"%"})},[s("div",{class:"marker-line",style:y({height:F.value+"px"})},null,4),s("div",Ke,z(q(n.time)),1)],4))),128))]),s("div",Ye,[(g(!0),h(J,null,Q(B.value,n=>(g(),h("div",{key:n.key,class:Y(["segment-row",{active:n.label===u(W)}]),style:y({top:n.rowNumber*45+"px",height:"40px"})},[(g(!0),h(J,null,Q(n.segments,i=>(g(),h("div",{key:i.id,ref_for:!0,ref_key:"segmentElements",ref:ce,class:Y(["segment",{active:i.id===r.activeSegmentId,draft:i.isDraft}]),style:y({left:xe(i.start)+"%",width:ne(i.start,i.end)+"%",backgroundColor:i.color||te(i.label),borderColor:i.isDraft?"#ff9800":"transparent"}),"data-id":i.id,onClick:o=>he(i),onContextmenu:Z(o=>Se(i,o),["prevent"])},[t[7]||(t[7]=s("div",{class:"resize-handle start-handle",title:"Segment-Start ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),s("div",Qe,[s("span",Ze,z(ge(i.label)),1),s("span",et,z(ye(i.start,i.end)),1)]),s("div",{class:"segment-delete-btn",onClick:Z(o=>se(i),["stop"]),title:"Segment löschen"},"X",8,tt),t[8]||(t[8]=s("div",{class:"resize-handle end-handle",title:"Segment-Ende ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),i.isDraft?(g(),h("div",nt,[...t[6]||(t[6]=[s("i",{class:"fas fa-edit"},null,-1)])])):I("",!0)],46,Je))),128))],6))),128))]),s("div",{class:"playhead",style:y({left:ve.value+"%",height:F.value+"px"})},[s("div",{class:"playhead-line",style:y({height:F.value+"px"})},null,4),t[9]||(t[9]=s("div",{class:"playhead-handle"},null,-1))],4),u(P)?(g(),h("div",{key:0,class:"selection-overlay",style:y({left:Math.min(u(E),u(L))+"%",width:Math.abs(u(L)-u(E))+"%",height:F.value+"px"})},null,4)):I("",!0)],36),r.showWaveform?(g(),h("div",it,[s("canvas",{ref_key:"waveformCanvas",ref:j,class:"waveform-canvas"},null,512)])):I("",!0)],4),u(T).visible?(g(),h("div",{key:0,class:"context-menu",style:y({left:u(T).x+"px",top:u(T).y+"px"}),onClick:t[3]||(t[3]=Z(()=>{},["stop"]))},[s("div",{class:"context-menu-item",onClick:t[0]||(t[0]=n=>we(u(T).segment))},[...t[10]||(t[10]=[s("i",{class:"fas fa-edit"},null,-1),ee(" Segment bearbeiten ",-1)])]),s("div",{class:"context-menu-item danger",onClick:t[1]||(t[1]=n=>se(u(T).segment))},[...t[11]||(t[11]=[s("i",{class:"fas fa-trash"},null,-1),ee(" Segment löschen ",-1)])]),t[13]||(t[13]=s("div",{class:"context-menu-separator"},null,-1)),s("div",{class:"context-menu-item",onClick:t[2]||(t[2]=n=>Me(u(T).segment))},[...t[12]||(t[12]=[s("i",{class:"fas fa-play"},null,-1),ee(" Segment abspielen ",-1)])])],4)):I("",!0),u(H).visible?(g(),h("div",{key:1,class:"timeline-tooltip",style:y({left:u(H).x+"px",top:u(H).y+"px"})},z(u(H).text),5)):I("",!0)]))}}),lt=_e(st,[["__scopeId","data-v-b2283c3f"]]);export{lt as T};
