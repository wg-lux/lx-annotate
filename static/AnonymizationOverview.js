import{d as P,g as q,h as T,e as D,i as G,K as Q,c as a,a as t,b as S,k as r,C as f,r as X,D as V,j as u,n as k,t as c,F as Y,m as Z,y as I,o,_ as M}from"./main.js";import{u as ee}from"./videoStore.js";import{useAnnotationStore as te}from"./annotationStore.js";import{u as ne}from"./mediaTypeStore.js";import{u as se,a as ae}from"./usePollingProtection.js";const oe={class:"container-fluid py-4"},ie={class:"card"},re={class:"card-header pb-0 d-flex justify-content-between align-items-center"},le={class:"d-flex gap-2"},de=["disabled"],ue={class:"card-body"},ce={key:0,class:"alert alert-danger",role:"alert"},me={key:1,class:"text-center py-5"},ge={key:2,class:"text-center py-5"},pe={key:3,class:"table-responsive"},ye={class:"table table-hover"},ve={class:"d-flex align-items-center"},be={class:"fw-medium"},fe={key:0,class:"fas fa-spinner fa-spin me-1"},_e={key:0,class:"text-success"},he={key:1,class:"text-danger"},we={class:"text-muted"},ke={class:"btn-group btn-group-sm",role:"group"},Se=["onClick","disabled"],xe=["onClick","disabled"],ze=["onClick","disabled"],Fe=["onClick","disabled"],Ce=["onClick","disabled"],Ae=["onClick","disabled"],Te=["onClick","disabled"],De={key:6,class:"btn btn-outline-info",disabled:""},Ve={key:7,class:"btn btn-outline-info",disabled:""},Pe={key:4,class:"row mt-4"},Me={class:"col-md-12"},Oe={class:"card bg-light"},$e={class:"card-body"},Be={class:"row text-center"},Ne={class:"col-md-3"},Ee={class:"mb-2"},Le={class:"badge bg-secondary fs-6"},Re={class:"col-md-3"},Ke={class:"mb-2"},Ue={class:"badge bg-warning fs-6"},je={class:"col-md-3"},We={class:"mb-2"},He={class:"badge bg-warning fs-6"},Je={class:"col-md-3"},qe={class:"mb-2"},Ge={class:"badge bg-success fs-6"},Qe={class:"col-md-3"},Xe={class:"mb-2"},Ye={class:"badge bg-danger fs-6"},Ze={key:5,class:"alert alert-warning mt-3",role:"alert"},Ie=P({__name:"AnonymizationOverviewComponent",setup(O){const h=I(),l=q(),$=ee();te();const y=ne(),w=se(),B=ae(),_=T(!1),m=T(new Set),d=D(()=>l.overview),x=D(()=>l.overview.length-d.value.length),v=async()=>{_.value=!0;try{await l.fetchOverview()}finally{_.value=!1}},z=async n=>{const e=d.value.find(g=>g.id===n);if(!e){console.warn("File not found for anonymization:",n);return}const i=e.mediaType==="video"?"video":"pdf";(await w.startAnonymizationSafeWithProtection(n,i))?.success?(await v(),console.log("Anonymization started successfully for file",n)):console.warn("startAnonymization failed - staying on current page")},N=async n=>{const e=d.value.find(i=>i.id===n);e&&y.setCurrentItem(e),h.push({name:"Anonymisierung Korrektur",params:{fileId:n}})},E=n=>{const e=d.value.find(i=>i.id===n);return e?e.anonymizationStatus==="done"||e.anonymizationStatus==="validated":!1},L=async n=>{if(m.value.add(n),!n){console.warn("File not found for validation:",n);return}try{if(await l.setCurrentForValidation(n)){const i=d.value.find(s=>s.id===n);if(i)y.setCurrentItem(i);else{console.warn("File not found for validation:",n);return}h.push("/anonymisierung/validierung")}}catch(e){console.error("Navigation to validation failed:",e)}finally{m.value.delete(n)}},R=async n=>{m.value.add(n);try{await l.reimportVideo(n)?(await v(),console.log("Video re-imported successfully:",n)):console.warn("Re-import failed - staying on current page")}finally{m.value.delete(n)}},K=async n=>{m.value.add(n);try{await l.reimportPdf(n)?(await v(),console.log("PDF re-imported successfully:",n)):console.warn("PDF re-import failed - staying on current page")}catch(e){console.error("PDF re-import failed:",e)}finally{m.value.delete(n)}},U=async n=>{const e=d.value.find(s=>s.id===n);if(!e){console.warn("File not found for deletion:",n);return}if(confirm(`Sind Sie sicher, dass Sie die Datei "${e.filename}" permanent löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.`)){m.value.add(n);try{await B.deleteMediaFile(n)?(await v(),console.log("File deleted successfully:",n)):console.warn("File deletion failed")}catch(s){console.error("File deletion failed:",s)}finally{m.value.delete(n)}}},p=n=>{const e=d.value.find(s=>s.id===n);if(!e)return!1;const i=y.detectMediaType(e);return i==="unknown"?m.value.has(n):m.value.has(n)||!w.canProcessMedia.value(n,i)},F=n=>n.mediaType==="video"?!n.metadataImported:n.mediaType==="pdf"?n.anonymizationStatus==="failed"||n.anonymizationStatus==="not_started":!1,j=n=>y.getMediaTypeIcon(n),W=n=>y.getMediaTypeBadgeClass(n),C=n=>({not_started:"bg-secondary",processing_anonymization:"bg-warning",extracting_frames:"bg-info",predicting_segments:"bg-info",done:"bg-success",validated:"bg-success",failed:"bg-danger"})[n]||"bg-secondary",A=n=>({not_started:"Nicht gestartet",processing_anonymization:"Anonymisierung läuft",extracting_frames:"Frames extrahieren",predicting_segments:"Segmente vorhersagen",done:"Fertig",validated:"Validiert",failed:"Fehlgeschlagen"})[n]||n,H=n=>n?new Date(n).toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",b=n=>{const i={not_started:["not_started"],processing:["processing_anonymization","extracting_frames","predicting_segments"],done:["done","validated"],failed:["failed"]}[n]||[n];return d.value.filter(s=>i.includes(s.anonymizationStatus)).length},J=n=>n.mediaType==="video"?$.hasRawVideoFile?.valueOf()??!1:n.mediaType==="pdf"?!!(n.rawFile&&n.rawFile.trim()!==""):!0;return G(async()=>{await l.fetchOverview(),l.overview.forEach(n=>{l.startPolling(n.id)})}),Q(()=>{l.stopAllPolling(),w.clearAllLocalLocks()}),(n,e)=>{const i=X("router-link");return o(),a("div",oe,[t("div",ie,[t("div",re,[e[2]||(e[2]=t("h4",{class:"mb-0"},"Anonymisierungs-Übersicht",-1)),t("div",le,[t("button",{class:"btn btn-outline-primary btn-sm",onClick:v,disabled:_.value},[t("i",{class:f(["fas fa-sync-alt",{"fa-spin":_.value}])},null,2),e[0]||(e[0]=r(" Aktualisieren ",-1))],8,de),S(i,{to:"/anonymisierung/validierung",class:"btn btn-primary btn-sm"},{default:V(()=>[...e[1]||(e[1]=[t("i",{class:"fas fa-play me-1"},null,-1),r(" Validierung starten ",-1)])]),_:1})])]),t("div",ue,[k(l).error?(o(),a("div",ce,[e[3]||(e[3]=t("strong",null,"Fehler:",-1)),r(" "+c(k(l).error),1)])):u("",!0),k(l).loading&&!d.value.length?(o(),a("div",me,[...e[4]||(e[4]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Wird geladen...")],-1),t("p",{class:"mt-2"},"Dateien werden geladen...",-1)])])):d.value.length?(o(),a("div",pe,[t("table",ye,[e[20]||(e[20]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Dateiname"),t("th",null,"Typ"),t("th",null,"Anonymisierung"),t("th",null,"Annotation"),t("th",null,"Unverarbeitete Daten vorhanden"),t("th",null,"Erstellt"),t("th",null,"Aktionen")])],-1)),t("tbody",null,[(o(!0),a(Y,null,Z(d.value,s=>(o(),a("tr",{key:s.id},[t("td",null,[t("div",ve,[t("i",{class:f([j(s.mediaType),"me-2"])},null,2),t("span",be,c(s.filename),1)])]),t("td",null,[t("span",{class:f([W(s.mediaType),"badge"])},c(s.mediaType.toUpperCase()),3)]),t("td",null,[t("span",{class:f([C(s.anonymizationStatus),"badge"])},[s.anonymizationStatus==="processing_anonymization"?(o(),a("i",fe)):u("",!0),r(" "+c(A(s.anonymizationStatus)),1)],2)]),t("td",null,[t("span",{class:f([C(s.annotationStatus),"badge"])},c(A(s.annotationStatus)),3)]),t("td",null,[J(s)?(o(),a("span",_e,[...e[9]||(e[9]=[t("i",{class:"fas fa-check-circle me-1"},null,-1),r(" Ja ",-1)])])):(o(),a("span",he,[...e[10]||(e[10]=[t("i",{class:"fas fa-times-circle me-1"},null,-1),r(" Nein ",-1)])]))]),t("td",null,[t("small",we,c(H(s.createdAt)),1)]),t("td",null,[t("div",ke,[s.mediaType==="video"&&F(s)?(o(),a("button",{key:0,onClick:g=>R(s.id),class:"btn btn-outline-info",disabled:p(s.id),title:"Video erneut importieren und Metadaten aktualisieren"},[...e[11]||(e[11]=[t("i",{class:"fas fa-redo-alt"},null,-1),r(" Erneut importieren ",-1)])],8,Se)):u("",!0),s.mediaType==="pdf"&&F(s)?(o(),a("button",{key:1,onClick:g=>K(s.id),class:"btn btn-outline-info",disabled:p(s.id),title:"PDF erneut importieren und verarbeiten"},[...e[12]||(e[12]=[t("i",{class:"fas fa-redo-alt"},null,-1),r(" Erneut importieren ",-1)])],8,xe)):u("",!0),s.anonymizationStatus==="not_started"?(o(),a("button",{key:2,onClick:g=>z(s.id),class:"btn btn-outline-primary",disabled:p(s.id)},[...e[13]||(e[13]=[t("i",{class:"fas fa-play"},null,-1),r(" Starten ",-1)])],8,ze)):u("",!0),s.anonymizationStatus==="failed"?(o(),a("button",{key:3,onClick:g=>z(s.id),class:"btn btn-outline-warning",disabled:p(s.id)},[...e[14]||(e[14]=[t("i",{class:"fas fa-redo"},null,-1),r(" Erneut versuchen ",-1)])],8,Fe)):u("",!0),s.anonymizationStatus==="done"?(o(),a("button",{key:4,onClick:g=>L(s.id),class:"btn btn-outline-success bg-success",disabled:!E(s.id)},[...e[15]||(e[15]=[t("i",{class:"fas fa-eye"},null,-1),r(" Validieren ",-1)])],8,Ce)):u("",!0),s.mediaType==="video"&&(s.anonymizationStatus==="done"||s.anonymizationStatus==="validated")?(o(),a("button",{key:5,onClick:g=>N(s.id),class:"btn btn-outline-warning",disabled:p(s.id)},[...e[16]||(e[16]=[t("i",{class:"fas fa-edit"},null,-1),r(" Korrektur ",-1)])],8,Ae)):u("",!0),t("button",{onClick:g=>U(s.id),class:"btn btn-outline-danger",disabled:p(s.id),title:"Datei permanent löschen"},[...e[17]||(e[17]=[t("i",{class:"fas fa-trash"},null,-1),r(" Löschen ",-1)])],8,Te),s.anonymizationStatus==="processing_anonymization"?(o(),a("button",De,[...e[18]||(e[18]=[t("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),r(" Anonymisierung... ",-1)])])):u("",!0),s.anonymizationStatus==="extracting_frames"?(o(),a("button",Ve,[...e[19]||(e[19]=[t("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),r(" Frames extrahieren... ",-1)])])):u("",!0)])])]))),128))])])])):(o(),a("div",ge,[e[6]||(e[6]=t("div",{class:"mb-4"},[t("i",{class:"fas fa-folder-open fa-3x text-muted"})],-1)),e[7]||(e[7]=t("h5",{class:"text-muted"},"Keine Dateien vorhanden",-1)),e[8]||(e[8]=t("p",{class:"text-muted mb-4"}," Laden Sie Videos oder PDFs hoch, um mit der Anonymisierung zu beginnen. ",-1)),S(i,{to:"/upload",class:"btn btn-primary"},{default:V(()=>[...e[5]||(e[5]=[t("i",{class:"fas fa-upload me-2"},null,-1),r(" Dateien hochladen ",-1)])]),_:1})])),d.value.length?(o(),a("div",Pe,[t("div",Me,[t("div",Oe,[t("div",$e,[e[26]||(e[26]=t("h6",{class:"card-title"},"Status-Übersicht",-1)),t("div",Be,[t("div",Ne,[t("div",Ee,[t("span",Le,c(b("not_started")),1)]),e[21]||(e[21]=t("small",{class:"text-muted"},"Nicht gestartet",-1))]),t("div",Re,[t("div",Ke,[t("span",Ue,c(b("processing")),1)]),e[22]||(e[22]=t("small",{class:"text-muted"},"In Bearbeitung",-1))]),t("div",je,[t("div",We,[t("span",He,c(b("started")),1)]),e[23]||(e[23]=t("small",{class:"text-muted"},"Anonymisierung gestartet",-1))]),t("div",Je,[t("div",qe,[t("span",Ge,c(b("done")),1)]),e[24]||(e[24]=t("small",{class:"text-muted"},"Fertig",-1))]),t("div",Qe,[t("div",Xe,[t("span",Ye,c(b("failed")),1)]),e[25]||(e[25]=t("small",{class:"text-muted"},"Fehlgeschlagen",-1))])])])])])])):u("",!0),x.value>0?(o(),a("div",Ze,[e[27]||(e[27]=t("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),e[28]||(e[28]=t("strong",null,"Hinweis:",-1)),r(" "+c(x.value)+" Datei(en) wurden ausgeblendet, da die ursprünglichen Dateien nicht mehr verfügbar sind. ",1)])):u("",!0)])])])}}}),et=M(Ie,[["__scopeId","data-v-cc0e3ee7"]]),tt={class:"anonymization-overview-page"},nt=P({__name:"AnonymizationOverview",setup(O){return(h,l)=>(o(),a("div",tt,[S(et)]))}}),lt=M(nt,[["__scopeId","data-v-4b00a75f"]]);export{lt as default};
