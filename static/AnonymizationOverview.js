import{d as M,g as q,h as A,e as D,i as G,J as Q,c as o,a as t,b as S,k as l,n as f,r as X,C as V,j as c,p as k,t as u,F as Y,m as Z,y as I,o as i,_ as P}from"./main.js";import{u as ee}from"./videoStore.js";import{useAnnotationStore as te}from"./annotationStore.js";import{u as ne}from"./mediaTypeStore.js";import{u as se,a as ae}from"./usePollingProtection.js";const oe={class:"container-fluid py-4"},ie={class:"card"},re={class:"card-header pb-0 d-flex justify-content-between align-items-center"},le={class:"d-flex gap-2"},de=["disabled"],ce={class:"card-body"},ue={key:0,class:"alert alert-danger",role:"alert"},me={key:1,class:"text-center py-5"},ge={key:2,class:"text-center py-5"},pe={key:3,class:"table-responsive"},ye={class:"table table-hover"},ve={class:"d-flex align-items-center"},be={class:"fw-medium"},fe={key:0,class:"fas fa-spinner fa-spin me-1"},_e={key:0,class:"text-success"},he={key:1,class:"text-danger"},we={class:"text-muted"},ke={class:"btn-group btn-group-sm",role:"group"},Se=["onClick","disabled"],ze=["onClick","disabled"],Fe=["onClick","disabled"],xe=["onClick","disabled"],Te=["onClick","disabled"],Ce=["onClick","disabled"],Ae=["onClick","disabled"],De={key:6,class:"btn btn-outline-info",disabled:""},Ve={key:7,class:"btn btn-outline-info",disabled:""},Me={key:4,class:"row mt-4"},Pe={class:"col-md-12"},$e={class:"card bg-light"},Oe={class:"card-body"},Be={class:"row text-center"},Ee={class:"col-md-3"},Ne={class:"mb-2"},Le={class:"badge bg-secondary fs-6"},Re={class:"col-md-3"},Ke={class:"mb-2"},Ue={class:"badge bg-warning fs-6"},je={class:"col-md-3"},Je={class:"mb-2"},We={class:"badge bg-warning fs-6"},He={class:"col-md-3"},qe={class:"mb-2"},Ge={class:"badge bg-success fs-6"},Qe={class:"col-md-3"},Xe={class:"mb-2"},Ye={class:"badge bg-danger fs-6"},Ze={key:5,class:"alert alert-warning mt-3",role:"alert"},Ie=M({__name:"AnonymizationOverviewComponent",setup($){const h=I(),r=q(),O=ee();te();const m=ne(),w=se(),B=ae(),_=A(!1),g=A(new Set),d=D(()=>r.overview),z=D(()=>r.overview.length-d.value.length),v=async()=>{_.value=!0;try{await r.fetchOverview(),m.seedTypesFromOverview(r.overview)}finally{_.value=!1}},F=async n=>{const e=d.value.find(p=>p.id===n);if(!e){console.warn("File not found for anonymization:",n);return}const a=e.mediaType==="video"?"video":"pdf";(await w.startAnonymizationSafeWithProtection(n,a))?.success?(await v(),console.log("Anonymization started successfully for file",n)):console.warn("startAnonymization failed - staying on current page")},E=async n=>{const e=d.value.find(a=>a.id===n);if(e)m.setCurrentItem(e);else{console.warn("File not found for correction:",n);return}h.push({name:"Anonymisierung Korrektur",params:{fileId:n,mediaType:e.mediaType}})},N=n=>{const e=d.value.find(a=>a.id===n);return e?e.anonymizationStatus==="done"||e.anonymizationStatus==="validated":!1},L=async n=>{if(g.value.add(n),!n){console.warn("File not found for validation:",n);return}try{if(await r.setCurrentForValidation(n)){const a=d.value.find(s=>s.id===n);if(a){m.setCurrentItem(a);const s=a.mediaType;try{m.rememberType(n,s,s)}catch(p){console.error("Error remembering media type for file:",n,p)}a.sensitiveMetaId&&m.rememberType(a.sensitiveMetaId,s,"meta"),sessionStorage.setItem("last:fileId",String(n)),sessionStorage.setItem("last:scope",s)}else{console.warn("File not found for validation:",n);return}console.log("File set for validation:",n,"file media type:",a.mediaType),h.push({name:"AnonymisierungValidierung",params:{fileId:n,mediaType:a.mediaType}})}}catch(e){console.error("Navigation to validation failed:",e)}finally{g.value.delete(n)}},R=async n=>{g.value.add(n);try{await r.reimportVideo(n)?(await v(),console.log("Video re-imported successfully:",n)):console.warn("Re-import failed - staying on current page")}finally{g.value.delete(n)}},K=async n=>{g.value.add(n);try{await r.reimportPdf(n)?(await v(),console.log("PDF re-imported successfully:",n)):console.warn("PDF re-import failed - staying on current page")}catch(e){console.error("PDF re-import failed:",e)}finally{g.value.delete(n)}},U=async n=>{const e=d.value.find(s=>s.id===n);if(!e){console.warn("File not found for deletion:",n);return}if(confirm(`Sind Sie sicher, dass Sie die Datei "${e.filename}" permanent löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.`)){g.value.add(n);try{await B.deleteMediaFile(n)?(await v(),console.log("File deleted successfully:",n)):console.warn("File deletion failed")}catch(s){console.error("File deletion failed:",s)}finally{g.value.delete(n)}}},y=n=>{const e=d.value.find(s=>s.id===n);if(!e)return!1;const a=m.detectMediaType(e);return a==="unknown"?g.value.has(n):g.value.has(n)||!w.canProcessMedia.value(n,a)},x=n=>n.mediaType==="video"?!n.metadataImported:n.mediaType==="pdf"?n.anonymizationStatus==="failed"||n.anonymizationStatus==="not_started":!1,j=n=>m.getMediaTypeIcon(n),J=n=>m.getMediaTypeBadgeClass(n),T=n=>({not_started:"bg-secondary",processing_anonymization:"bg-warning",extracting_frames:"bg-info",predicting_segments:"bg-info",done:"bg-success",validated:"bg-success",failed:"bg-danger"})[n]||"bg-secondary",C=n=>({not_started:"Nicht gestartet",processing_anonymization:"Anonymisierung läuft",extracting_frames:"Frames extrahieren",predicting_segments:"Segmente vorhersagen",done:"Fertig",validated:"Validiert",failed:"Fehlgeschlagen"})[n]||n,W=n=>n?new Date(n).toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",b=n=>{const a={not_started:["not_started"],processing:["processing_anonymization","extracting_frames","predicting_segments"],done:["done","validated"],failed:["failed"]}[n]||[n];return d.value.filter(s=>a.includes(s.anonymizationStatus)).length},H=n=>n.mediaType==="video"?O.hasRawVideoFile?.valueOf()??!1:n.mediaType==="pdf"?!!(n.rawFile&&n.rawFile.trim()!==""):!0;return G(async()=>{await r.fetchOverview(),m.seedTypesFromOverview(r.overview),console.table(r.overview.map(e=>({id:e.id,fromOverview:e.mediaType,remembered:m.getType(e.id)})));const n=["processing_anonymization","extracting_frames","predicting_segments"];r.overview.forEach(e=>{n.includes(e.anonymizationStatus)?(console.log(`Starting polling for processing file ${e.id} (status: ${e.anonymizationStatus})`),r.startPolling(e.id)):console.log(`Skipping polling for file ${e.id} (status: ${e.anonymizationStatus})`)})}),Q(()=>{r.stopAllPolling(),w.clearAllLocalLocks()}),(n,e)=>{const a=X("router-link");return i(),o("div",oe,[t("div",ie,[t("div",re,[e[2]||(e[2]=t("h4",{class:"mb-0"},"Anonymisierungs-Übersicht",-1)),t("div",le,[t("button",{class:"btn btn-outline-primary btn-sm",onClick:v,disabled:_.value},[t("i",{class:f(["fas fa-sync-alt",{"fa-spin":_.value}])},null,2),e[0]||(e[0]=l(" Aktualisieren ",-1))],8,de),S(a,{to:"/anonymisierung/validierung",class:"btn btn-primary btn-sm"},{default:V(()=>[...e[1]||(e[1]=[t("i",{class:"fas fa-play me-1"},null,-1),l(" Validierung starten ",-1)])]),_:1})])]),t("div",ce,[k(r).error?(i(),o("div",ue,[e[3]||(e[3]=t("strong",null,"Fehler:",-1)),l(" "+u(k(r).error),1)])):c("",!0),k(r).loading&&!d.value.length?(i(),o("div",me,[...e[4]||(e[4]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Wird geladen...")],-1),t("p",{class:"mt-2"},"Dateien werden geladen...",-1)])])):d.value.length?(i(),o("div",pe,[t("table",ye,[e[20]||(e[20]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Dateiname"),t("th",null,"Typ"),t("th",null,"Anonymisierung"),t("th",null,"Annotation"),t("th",null,"Unverarbeitete Daten vorhanden"),t("th",null,"Erstellt"),t("th",null,"Aktionen")])],-1)),t("tbody",null,[(i(!0),o(Y,null,Z(d.value,s=>(i(),o("tr",{key:s.id},[t("td",null,[t("div",ve,[t("i",{class:f([j(s.mediaType),"me-2"])},null,2),t("span",be,u(s.filename),1)])]),t("td",null,[t("span",{class:f([J(s.mediaType),"badge"])},u(s.mediaType.toUpperCase()),3)]),t("td",null,[t("span",{class:f([T(s.anonymizationStatus),"badge"])},[s.anonymizationStatus==="processing_anonymization"?(i(),o("i",fe)):c("",!0),l(" "+u(C(s.anonymizationStatus)),1)],2)]),t("td",null,[t("span",{class:f([T(s.annotationStatus),"badge"])},u(C(s.annotationStatus)),3)]),t("td",null,[H(s)?(i(),o("span",_e,[...e[9]||(e[9]=[t("i",{class:"fas fa-check-circle me-1"},null,-1),l(" Ja ",-1)])])):(i(),o("span",he,[...e[10]||(e[10]=[t("i",{class:"fas fa-times-circle me-1"},null,-1),l(" Nein ",-1)])]))]),t("td",null,[t("small",we,u(W(s.createdAt)),1)]),t("td",null,[t("div",ke,[s.mediaType==="video"&&x(s)?(i(),o("button",{key:0,onClick:p=>R(s.id),class:"btn btn-outline-info",disabled:y(s.id),title:"Video erneut importieren und Metadaten aktualisieren"},[...e[11]||(e[11]=[t("i",{class:"fas fa-redo-alt"},null,-1),l(" Erneut importieren ",-1)])],8,Se)):c("",!0),s.mediaType==="pdf"&&x(s)?(i(),o("button",{key:1,onClick:p=>K(s.id),class:"btn btn-outline-info",disabled:y(s.id),title:"PDF erneut importieren und verarbeiten"},[...e[12]||(e[12]=[t("i",{class:"fas fa-redo-alt"},null,-1),l(" Erneut importieren ",-1)])],8,ze)):c("",!0),s.anonymizationStatus==="not_started"?(i(),o("button",{key:2,onClick:p=>F(s.id),class:"btn btn-outline-primary",disabled:y(s.id)},[...e[13]||(e[13]=[t("i",{class:"fas fa-play"},null,-1),l(" Starten ",-1)])],8,Fe)):c("",!0),s.anonymizationStatus==="failed"?(i(),o("button",{key:3,onClick:p=>F(s.id),class:"btn btn-outline-warning",disabled:y(s.id)},[...e[14]||(e[14]=[t("i",{class:"fas fa-redo"},null,-1),l(" Erneut versuchen ",-1)])],8,xe)):c("",!0),s.anonymizationStatus==="done"?(i(),o("button",{key:4,onClick:p=>L(s.id),class:"btn btn-outline-success bg-success",disabled:!N(s.id)},[...e[15]||(e[15]=[t("i",{class:"fas fa-eye"},null,-1),l(" Validieren ",-1)])],8,Te)):c("",!0),s.mediaType==="video"&&(s.anonymizationStatus==="done"||s.anonymizationStatus==="validated")?(i(),o("button",{key:5,onClick:p=>E(s.id),class:"btn btn-outline-warning",disabled:y(s.id)},[...e[16]||(e[16]=[t("i",{class:"fas fa-edit"},null,-1),l(" Korrektur ",-1)])],8,Ce)):c("",!0),t("button",{onClick:p=>U(s.id),class:"btn btn-outline-danger",disabled:y(s.id),title:"Datei permanent löschen"},[...e[17]||(e[17]=[t("i",{class:"fas fa-trash"},null,-1),l(" Löschen ",-1)])],8,Ae),s.anonymizationStatus==="processing_anonymization"?(i(),o("button",De,[...e[18]||(e[18]=[t("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),l(" Anonymisierung... ",-1)])])):c("",!0),s.anonymizationStatus==="extracting_frames"?(i(),o("button",Ve,[...e[19]||(e[19]=[t("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),l(" Frames extrahieren... ",-1)])])):c("",!0)])])]))),128))])])])):(i(),o("div",ge,[e[6]||(e[6]=t("div",{class:"mb-4"},[t("i",{class:"fas fa-folder-open fa-3x text-muted"})],-1)),e[7]||(e[7]=t("h5",{class:"text-muted"},"Keine Dateien vorhanden",-1)),e[8]||(e[8]=t("p",{class:"text-muted mb-4"}," Laden Sie Videos oder PDFs hoch, um mit der Anonymisierung zu beginnen. ",-1)),S(a,{to:"/upload",class:"btn btn-primary"},{default:V(()=>[...e[5]||(e[5]=[t("i",{class:"fas fa-upload me-2"},null,-1),l(" Dateien hochladen ",-1)])]),_:1})])),d.value.length?(i(),o("div",Me,[t("div",Pe,[t("div",$e,[t("div",Oe,[e[26]||(e[26]=t("h6",{class:"card-title"},"Status-Übersicht",-1)),t("div",Be,[t("div",Ee,[t("div",Ne,[t("span",Le,u(b("not_started")),1)]),e[21]||(e[21]=t("small",{class:"text-muted"},"Nicht gestartet",-1))]),t("div",Re,[t("div",Ke,[t("span",Ue,u(b("processing")),1)]),e[22]||(e[22]=t("small",{class:"text-muted"},"In Bearbeitung",-1))]),t("div",je,[t("div",Je,[t("span",We,u(b("started")),1)]),e[23]||(e[23]=t("small",{class:"text-muted"},"Anonymisierung gestartet",-1))]),t("div",He,[t("div",qe,[t("span",Ge,u(b("done")),1)]),e[24]||(e[24]=t("small",{class:"text-muted"},"Fertig",-1))]),t("div",Qe,[t("div",Xe,[t("span",Ye,u(b("failed")),1)]),e[25]||(e[25]=t("small",{class:"text-muted"},"Fehlgeschlagen",-1))])])])])])])):c("",!0),z.value>0?(i(),o("div",Ze,[e[27]||(e[27]=t("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),e[28]||(e[28]=t("strong",null,"Hinweis:",-1)),l(" "+u(z.value)+" Datei(en) wurden ausgeblendet, da die ursprünglichen Dateien nicht mehr verfügbar sind. ",1)])):c("",!0)])])])}}}),et=P(Ie,[["__scopeId","data-v-e394042f"]]),tt={class:"anonymization-overview-page"},nt=M({__name:"AnonymizationOverview",setup($){return(h,r)=>(i(),o("div",tt,[S(et)]))}}),lt=P(nt,[["__scopeId","data-v-4b00a75f"]]);export{lt as default};
