import{d as P,g as q,h as T,e as D,i as G,J as Q,c as a,a as e,b as S,k as r,n as f,r as X,C as V,j as u,p as k,t as c,F as Y,m as Z,y as I,o,_ as M}from"./main.js";import{u as tt}from"./videoStore.js";import{useAnnotationStore as et}from"./annotationStore.js";import{u as nt}from"./mediaTypeStore.js";import{u as st,a as at}from"./usePollingProtection.js";const ot={class:"container-fluid py-4"},it={class:"card"},rt={class:"card-header pb-0 d-flex justify-content-between align-items-center"},lt={class:"d-flex gap-2"},dt=["disabled"],ut={class:"card-body"},ct={key:0,class:"alert alert-danger",role:"alert"},mt={key:1,class:"text-center py-5"},gt={key:2,class:"text-center py-5"},pt={key:3,class:"table-responsive"},yt={class:"table table-hover"},vt={class:"d-flex align-items-center"},bt={class:"fw-medium"},ft={key:0,class:"fas fa-spinner fa-spin me-1"},_t={key:0,class:"text-success"},ht={key:1,class:"text-danger"},wt={class:"text-muted"},kt={class:"btn-group btn-group-sm",role:"group"},St=["onClick","disabled"],zt=["onClick","disabled"],xt=["onClick","disabled"],Ft=["onClick","disabled"],Ct=["onClick","disabled"],At=["onClick","disabled"],Tt=["onClick","disabled"],Dt={key:6,class:"btn btn-outline-info",disabled:""},Vt={key:7,class:"btn btn-outline-info",disabled:""},Pt={key:4,class:"row mt-4"},Mt={class:"col-md-12"},$t={class:"card bg-light"},Ot={class:"card-body"},Bt={class:"row text-center"},Nt={class:"col-md-3"},Et={class:"mb-2"},Lt={class:"badge bg-secondary fs-6"},Rt={class:"col-md-3"},Kt={class:"mb-2"},Ut={class:"badge bg-warning fs-6"},jt={class:"col-md-3"},Jt={class:"mb-2"},Wt={class:"badge bg-warning fs-6"},Ht={class:"col-md-3"},qt={class:"mb-2"},Gt={class:"badge bg-success fs-6"},Qt={class:"col-md-3"},Xt={class:"mb-2"},Yt={class:"badge bg-danger fs-6"},Zt={key:5,class:"alert alert-warning mt-3",role:"alert"},It=P({__name:"AnonymizationOverviewComponent",setup($){const h=I(),l=q(),O=tt();et();const y=nt(),w=st(),B=at(),_=T(!1),m=T(new Set),d=D(()=>l.overview),z=D(()=>l.overview.length-d.value.length),v=async()=>{_.value=!0;try{await l.fetchOverview()}finally{_.value=!1}},x=async n=>{const t=d.value.find(g=>g.id===n);if(!t){console.warn("File not found for anonymization:",n);return}const i=t.mediaType==="video"?"video":"pdf";(await w.startAnonymizationSafeWithProtection(n,i))?.success?(await v(),console.log("Anonymization started successfully for file",n)):console.warn("startAnonymization failed - staying on current page")},N=async n=>{const t=d.value.find(i=>i.id===n);t&&y.setCurrentItem(t),h.push({name:"Anonymisierung Korrektur",params:{fileId:n}})},E=n=>{const t=d.value.find(i=>i.id===n);return t?t.anonymizationStatus==="done"||t.anonymizationStatus==="validated":!1},L=async n=>{if(m.value.add(n),!n){console.warn("File not found for validation:",n);return}try{if(await l.setCurrentForValidation(n)){const i=d.value.find(s=>s.id===n);if(i)y.setCurrentItem(i);else{console.warn("File not found for validation:",n);return}h.push("/anonymisierung/validierung")}}catch(t){console.error("Navigation to validation failed:",t)}finally{m.value.delete(n)}},R=async n=>{m.value.add(n);try{await l.reimportVideo(n)?(await v(),console.log("Video re-imported successfully:",n)):console.warn("Re-import failed - staying on current page")}finally{m.value.delete(n)}},K=async n=>{m.value.add(n);try{await l.reimportPdf(n)?(await v(),console.log("PDF re-imported successfully:",n)):console.warn("PDF re-import failed - staying on current page")}catch(t){console.error("PDF re-import failed:",t)}finally{m.value.delete(n)}},U=async n=>{const t=d.value.find(s=>s.id===n);if(!t){console.warn("File not found for deletion:",n);return}if(confirm(`Sind Sie sicher, dass Sie die Datei "${t.filename}" permanent löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.`)){m.value.add(n);try{await B.deleteMediaFile(n)?(await v(),console.log("File deleted successfully:",n)):console.warn("File deletion failed")}catch(s){console.error("File deletion failed:",s)}finally{m.value.delete(n)}}},p=n=>{const t=d.value.find(s=>s.id===n);if(!t)return!1;const i=y.detectMediaType(t);return i==="unknown"?m.value.has(n):m.value.has(n)||!w.canProcessMedia.value(n,i)},F=n=>n.mediaType==="video"?!n.metadataImported:n.mediaType==="pdf"?n.anonymizationStatus==="failed"||n.anonymizationStatus==="not_started":!1,j=n=>y.getMediaTypeIcon(n),J=n=>y.getMediaTypeBadgeClass(n),C=n=>({not_started:"bg-secondary",processing_anonymization:"bg-warning",extracting_frames:"bg-info",predicting_segments:"bg-info",done:"bg-success",validated:"bg-success",failed:"bg-danger"})[n]||"bg-secondary",A=n=>({not_started:"Nicht gestartet",processing_anonymization:"Anonymisierung läuft",extracting_frames:"Frames extrahieren",predicting_segments:"Segmente vorhersagen",done:"Fertig",validated:"Validiert",failed:"Fehlgeschlagen"})[n]||n,W=n=>n?new Date(n).toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",b=n=>{const i={not_started:["not_started"],processing:["processing_anonymization","extracting_frames","predicting_segments"],done:["done","validated"],failed:["failed"]}[n]||[n];return d.value.filter(s=>i.includes(s.anonymizationStatus)).length},H=n=>n.mediaType==="video"?O.hasRawVideoFile?.valueOf()??!1:n.mediaType==="pdf"?!!(n.rawFile&&n.rawFile.trim()!==""):!0;return G(async()=>{await l.fetchOverview();const n=["processing_anonymization","extracting_frames","predicting_segments"];l.overview.forEach(t=>{n.includes(t.anonymizationStatus)?(console.log(`Starting polling for processing file ${t.id} (status: ${t.anonymizationStatus})`),l.startPolling(t.id)):console.log(`Skipping polling for file ${t.id} (status: ${t.anonymizationStatus})`)})}),Q(()=>{l.stopAllPolling(),w.clearAllLocalLocks()}),(n,t)=>{const i=X("router-link");return o(),a("div",ot,[e("div",it,[e("div",rt,[t[2]||(t[2]=e("h4",{class:"mb-0"},"Anonymisierungs-Übersicht",-1)),e("div",lt,[e("button",{class:"btn btn-outline-primary btn-sm",onClick:v,disabled:_.value},[e("i",{class:f(["fas fa-sync-alt",{"fa-spin":_.value}])},null,2),t[0]||(t[0]=r(" Aktualisieren ",-1))],8,dt),S(i,{to:"/anonymisierung/validierung",class:"btn btn-primary btn-sm"},{default:V(()=>[...t[1]||(t[1]=[e("i",{class:"fas fa-play me-1"},null,-1),r(" Validierung starten ",-1)])]),_:1})])]),e("div",ut,[k(l).error?(o(),a("div",ct,[t[3]||(t[3]=e("strong",null,"Fehler:",-1)),r(" "+c(k(l).error),1)])):u("",!0),k(l).loading&&!d.value.length?(o(),a("div",mt,[...t[4]||(t[4]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Wird geladen...")],-1),e("p",{class:"mt-2"},"Dateien werden geladen...",-1)])])):d.value.length?(o(),a("div",pt,[e("table",yt,[t[20]||(t[20]=e("thead",{class:"table-light"},[e("tr",null,[e("th",null,"Dateiname"),e("th",null,"Typ"),e("th",null,"Anonymisierung"),e("th",null,"Annotation"),e("th",null,"Unverarbeitete Daten vorhanden"),e("th",null,"Erstellt"),e("th",null,"Aktionen")])],-1)),e("tbody",null,[(o(!0),a(Y,null,Z(d.value,s=>(o(),a("tr",{key:s.id},[e("td",null,[e("div",vt,[e("i",{class:f([j(s.mediaType),"me-2"])},null,2),e("span",bt,c(s.filename),1)])]),e("td",null,[e("span",{class:f([J(s.mediaType),"badge"])},c(s.mediaType.toUpperCase()),3)]),e("td",null,[e("span",{class:f([C(s.anonymizationStatus),"badge"])},[s.anonymizationStatus==="processing_anonymization"?(o(),a("i",ft)):u("",!0),r(" "+c(A(s.anonymizationStatus)),1)],2)]),e("td",null,[e("span",{class:f([C(s.annotationStatus),"badge"])},c(A(s.annotationStatus)),3)]),e("td",null,[H(s)?(o(),a("span",_t,[...t[9]||(t[9]=[e("i",{class:"fas fa-check-circle me-1"},null,-1),r(" Ja ",-1)])])):(o(),a("span",ht,[...t[10]||(t[10]=[e("i",{class:"fas fa-times-circle me-1"},null,-1),r(" Nein ",-1)])]))]),e("td",null,[e("small",wt,c(W(s.createdAt)),1)]),e("td",null,[e("div",kt,[s.mediaType==="video"&&F(s)?(o(),a("button",{key:0,onClick:g=>R(s.id),class:"btn btn-outline-info",disabled:p(s.id),title:"Video erneut importieren und Metadaten aktualisieren"},[...t[11]||(t[11]=[e("i",{class:"fas fa-redo-alt"},null,-1),r(" Erneut importieren ",-1)])],8,St)):u("",!0),s.mediaType==="pdf"&&F(s)?(o(),a("button",{key:1,onClick:g=>K(s.id),class:"btn btn-outline-info",disabled:p(s.id),title:"PDF erneut importieren und verarbeiten"},[...t[12]||(t[12]=[e("i",{class:"fas fa-redo-alt"},null,-1),r(" Erneut importieren ",-1)])],8,zt)):u("",!0),s.anonymizationStatus==="not_started"?(o(),a("button",{key:2,onClick:g=>x(s.id),class:"btn btn-outline-primary",disabled:p(s.id)},[...t[13]||(t[13]=[e("i",{class:"fas fa-play"},null,-1),r(" Starten ",-1)])],8,xt)):u("",!0),s.anonymizationStatus==="failed"?(o(),a("button",{key:3,onClick:g=>x(s.id),class:"btn btn-outline-warning",disabled:p(s.id)},[...t[14]||(t[14]=[e("i",{class:"fas fa-redo"},null,-1),r(" Erneut versuchen ",-1)])],8,Ft)):u("",!0),s.anonymizationStatus==="done"?(o(),a("button",{key:4,onClick:g=>L(s.id),class:"btn btn-outline-success bg-success",disabled:!E(s.id)},[...t[15]||(t[15]=[e("i",{class:"fas fa-eye"},null,-1),r(" Validieren ",-1)])],8,Ct)):u("",!0),s.mediaType==="video"&&(s.anonymizationStatus==="done"||s.anonymizationStatus==="validated")?(o(),a("button",{key:5,onClick:g=>N(s.id),class:"btn btn-outline-warning",disabled:p(s.id)},[...t[16]||(t[16]=[e("i",{class:"fas fa-edit"},null,-1),r(" Korrektur ",-1)])],8,At)):u("",!0),e("button",{onClick:g=>U(s.id),class:"btn btn-outline-danger",disabled:p(s.id),title:"Datei permanent löschen"},[...t[17]||(t[17]=[e("i",{class:"fas fa-trash"},null,-1),r(" Löschen ",-1)])],8,Tt),s.anonymizationStatus==="processing_anonymization"?(o(),a("button",Dt,[...t[18]||(t[18]=[e("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),r(" Anonymisierung... ",-1)])])):u("",!0),s.anonymizationStatus==="extracting_frames"?(o(),a("button",Vt,[...t[19]||(t[19]=[e("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),r(" Frames extrahieren... ",-1)])])):u("",!0)])])]))),128))])])])):(o(),a("div",gt,[t[6]||(t[6]=e("div",{class:"mb-4"},[e("i",{class:"fas fa-folder-open fa-3x text-muted"})],-1)),t[7]||(t[7]=e("h5",{class:"text-muted"},"Keine Dateien vorhanden",-1)),t[8]||(t[8]=e("p",{class:"text-muted mb-4"}," Laden Sie Videos oder PDFs hoch, um mit der Anonymisierung zu beginnen. ",-1)),S(i,{to:"/upload",class:"btn btn-primary"},{default:V(()=>[...t[5]||(t[5]=[e("i",{class:"fas fa-upload me-2"},null,-1),r(" Dateien hochladen ",-1)])]),_:1})])),d.value.length?(o(),a("div",Pt,[e("div",Mt,[e("div",$t,[e("div",Ot,[t[26]||(t[26]=e("h6",{class:"card-title"},"Status-Übersicht",-1)),e("div",Bt,[e("div",Nt,[e("div",Et,[e("span",Lt,c(b("not_started")),1)]),t[21]||(t[21]=e("small",{class:"text-muted"},"Nicht gestartet",-1))]),e("div",Rt,[e("div",Kt,[e("span",Ut,c(b("processing")),1)]),t[22]||(t[22]=e("small",{class:"text-muted"},"In Bearbeitung",-1))]),e("div",jt,[e("div",Jt,[e("span",Wt,c(b("started")),1)]),t[23]||(t[23]=e("small",{class:"text-muted"},"Anonymisierung gestartet",-1))]),e("div",Ht,[e("div",qt,[e("span",Gt,c(b("done")),1)]),t[24]||(t[24]=e("small",{class:"text-muted"},"Fertig",-1))]),e("div",Qt,[e("div",Xt,[e("span",Yt,c(b("failed")),1)]),t[25]||(t[25]=e("small",{class:"text-muted"},"Fehlgeschlagen",-1))])])])])])])):u("",!0),z.value>0?(o(),a("div",Zt,[t[27]||(t[27]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[28]||(t[28]=e("strong",null,"Hinweis:",-1)),r(" "+c(z.value)+" Datei(en) wurden ausgeblendet, da die ursprünglichen Dateien nicht mehr verfügbar sind. ",1)])):u("",!0)])])])}}}),te=M(It,[["__scopeId","data-v-9a453a94"]]),ee={class:"anonymization-overview-page"},ne=P({__name:"AnonymizationOverview",setup($){return(h,l)=>(o(),a("div",ee,[S(te)]))}}),le=M(ne,[["__scopeId","data-v-4b00a75f"]]);export{le as default};
