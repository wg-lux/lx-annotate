const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./annotationStore.js","./main.js","./main.css","./authStore.js"])))=>i.map(i=>d[i]);
import{L as Me,h as _,I as Oe,e as S,O as $,z as v,A as f,P as G,Q as H,g as je}from"./main.js";const xe={appendix:"Appendix",blood:"Blut",diverticule:"Divertikel",grasper:"Greifer",ileocaecalvalve:"IleozÃ¤kalklappe",ileum:"Ileum",low_quality:"Niedrige BildqualitÃ¤t",nbi:"Narrow Band Imaging",needle:"Nadel",outside:"AuÃŸerhalb",polyp:"Polyp",snare:"Snare",water_jet:"Wasserstrahl",wound:"Wunde"};function D(a){return xe[a]??a}const Re={outside:"#e74c3c",polyp:"#f39c12",needle:"#3498db",blood:"#e74c3c",snare:"#9b59b6",grasper:"#2ecc71",water_jet:"#1abc9c",appendix:"#f1c40f",ileum:"#e67e22",diverticule:"#34495e",ileocaecalvalve:"#95a5a6",nbi:"#8e44ad",low_quality:"#7f8c8d",wound:"#c0392b"};function L(a){return Re[a]??"#95a5a6"}const E=a=>{if(!a||a<0)return"00:00";const l=Math.floor(a/60),b=Math.floor(a%60);return`${l.toString().padStart(2,"0")}:${b.toString().padStart(2,"0")}`};function ze(a){return a.replace(/[A-Z]/g,l=>`_${l.toLowerCase()}`)}function M(a){if(!a||typeof a!="object")return a;const l={};for(const[b,s]of Object.entries(a)){const d=ze(b);s&&typeof s=="object"&&!Array.isArray(s)?l[d]=M(s):Array.isArray(s)?l[d]=s.map(h=>h&&typeof h=="object"?M(h):h):l[d]=s}return l}function Z(a){let l="";a.labelName?l=a.labelName:(console.warn("ISSUE WITH SNAKE CASE CAMEL CASE CONVERSION IN AXIOS INTERCEPTOR: Backend segment label is missing or in unexpected format:",a),l=a.labelName||"");const b={id:a.id,startFrameNumber:a.startFrameNumber,endFrameNumber:a.endFrameNumber,label:l,startTime:a.startTime,endTime:a.endTime,usingFPS:!1};return a.startTime!==void 0&&(b.usingFPS=!0),b}function Q(a){return a.map(Z)}function Ge(a){let l="";return a.label_name?l=a.label_name:a.label&&typeof a.label=="object"&&a.label.name?l=a.label.name:a.label&&typeof a.label=="string"?l=a.label:l="",{id:a.id,label:l,startTime:a.startTime??a.start_time??a.segmentStart??a.segment_start??0,endTime:a.endTime??a.end_time??a.segmentEnd??a.segment_end??0,startFrameNumber:a.startFrameNumber??a.start_frame_number??0,endFrameNumber:a.endFrameNumber??a.end_frame_number??0,videoName:a.videoName||a.video_name||"",usingFPS:a.usingFPS??a.using_fps??!1}}function ke(a,l,b,s){const d={start_time:l,end_time:b,label_name:s?.label||s?.label_name,...s};return M(d)}const Be=_([]),Ke={},We=1/50,X=5,He=Me("video",()=>{const a=_(null),l=_(""),b=_(""),s=Oe({...Ke}),d=_({videos:[],labels:[]}),h=_(null),O=_(null),F=_(0),i=_(null);_(null);const w=_(null);function N(e){return`${window.location.origin}/api/media/videos/${e}/`}const J=S(()=>i.value?{...i.value,start:i.value.startTime,end:i.value.endTime}:null),Y=S(()=>!!a.value),I=S(()=>h.value?.duration?h.value.duration:0),ee=S(()=>a.value?.segments||[]),te=S(()=>d.value?.labels||[]),V=S(()=>{const e={};return d.value.labels.forEach(t=>e[t.name]=t.id),e});function j(e){return{...e,labelID:e.labelID??V.value[e.label]??null}}const A=S(()=>{const e=[...a.value?.segments||[]];if(i.value){const t={id:i.value.id,label:i.value.label,startTime:i.value.startTime,endTime:i.value.endTime||i.value.startTime,avgConfidence:0};e.push(t)}return e}),ae=S(()=>A.value.map(e=>({id:e.id,label:D(e.label),startTime:e.startTime,endTime:e.endTime,display:`${D(e.label)}: ${E(e.startTime)} â€“ ${E(e.endTime)}`}))),ne=S(()=>A.value.find(e=>e.id===O.value)||null);async function oe(e){if(e||(e=a.value?.id||null),!e)return console.error(`Invalid video ID: ${e}`),!1;try{return await v.delete(`/api/media-management/${e}/force-remove/`),!0}catch(t){return console.error(`Failed to delete video ${e}:`,t),!1}}function re(e,t){const n=V.value[t]??null;let r=1;if(e.frames&&Object.keys(e.frames).length>0){const o=Object.keys(e.frames).map(Number),c=e.segment_start,u=e.segment_end,y=o.filter(g=>g>=c&&g<=u);if(y.length>0){let g=0,m=0;y.forEach(T=>{const p=e.frames[T.toString()];p?.predictions?.confidence!==void 0&&(g+=p.predictions.confidence,m++)}),m>0?(r=g/m,console.log(`Segment ${e.segment_id}: Calculated avg confidence ${r.toFixed(3)} from ${m} frame predictions (frames ${c}-${u})`)):console.warn(`Segment ${e.segment_id}: No valid predictions found in frames ${c}-${u}`)}else console.warn(`Segment ${e.segment_id}: No frames found within segment boundaries ${c}-${u}`)}else console.warn(`Segment ${e.segment_id}: No frame data available for confidence calculation`);return{id:e.segment_id,label:t,startTime:e.start_time,endTime:e.end_time,avgConfidence:r,labelID:n,startFrameNumber:e.segment_start,endFrameNumber:e.segment_end,frames:e.frames}}function se(e){O.value=e}function le(e,t){t&&e.startTime&&(t.currentTime=e.startTime,t.play().catch(console.error))}function ie(e,t){const n=e.startTime/t*100,r=(e.endTime-e.startTime)/t*100;return{left:`${n}%`,width:`${r}%`,backgroundColor:L(e.label)}}function x(e,t){for(const n in s){const r=s[n].findIndex(o=>o.id===e);if(r!==-1){Object.assign(s[n][r],t);break}}}function ce(){return ae.value}function de(){Object.keys(s).forEach(e=>{delete s[e]})}async function ue(e){try{const t=e?f(`video/media/${e}`):f("video/sensitivemeta/"),n=await v.get(t);return h.value=n.data,n.data}catch(t){return console.error("Error fetching video meta:",t),null}}async function me(e){try{return await v.patch(f("media/videos/${payload.id}/"),e),!0}catch(t){return console.error("Error updating sensitive meta:",t),!1}}function fe(){h.value=null}function ge(e,t,n){t()}function ve(e,t,n,r,o){r(t.name)}async function R(e){if(console.log(`[VideoStore] fetchAllSegments called with video ID: ${e}`),a.value||(console.log(`[VideoStore] No currentVideo found, creating basic video object for ID: ${e}`),a.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null}),await B(e),a.value){const t=[];Object.values(s).forEach(n=>{t.push(...n)}),a.value.segments=t,console.log(`[VideoStore] Timeline segments populated: ${t.length} segments for video ${e}`)}}async function pe(){console.log("Saving annotations...")}async function be(e){a.value&&(a.value.status=e)}async function he(e){a.value&&(a.value.assignedUser=e)}async function z(){console.log("ðŸ·ï¸ [VideoStore] Fetching labels with high priority...");try{const t=(await v.get(f("videos/"))).data.labels.map(n=>({id:parseInt(n.id),name:n.name,color:n.color||L(n.name)}));return d.value.labels=t,console.log(`âœ… [VideoStore] Loaded ${t.length} labels:`,t.map(n=>n.name).join(", ")),t}catch(e){throw console.error("âŒ Error loading labels:",e),d.value.labels=[],e}}async function ye(){console.log("Fetching all videos...");try{await z();const e=await v.get(f("videos/"));console.log("API Response:",e.data);const t=e.data.videos.map(o=>({id:parseInt(o.id),original_file_name:o.original_file_name,status:o.status||"available",assignedUser:o.assignedUser||null,anonymized:o.anonymized||!1,centerName:o.center_name||"Unbekannt",processorName:o.processor_name||"Unbekannt"})),n=d.value.labels;console.log("Fetching segments for",t.length,"videos...");const r=await Promise.all(t.map(async o=>{try{const c=await v.get(f(`media/videos/${o.id}/segments/`));console.log(`Video ${o.id}: Found ${c.data.length} segments`);const u=c.data,g=Q(u).map(m=>j({id:m.id,label:m.label,startTime:m.startTime,endTime:m.endTime,avgConfidence:1,videoID:parseInt(o.id.toString()),labelID:V.value[m.label]??null}));return{...o,segments:g}}catch(c){return console.warn(`Failed to load segments for video ${o.id}:`,c),{...o,segments:[]}}}));return d.value={videos:r,labels:n},console.log("âœ… Processed videos with segments:",d.value),d.value}catch(e){throw console.error("Error loading videos:",e),d.value={videos:[],labels:[]},e}}function Se(){a.value=null}function _e(e){a.value=e}function Te(e){const t=d.value.videos.find(n=>n.id===e)||null;return t?a.value={id:t.id,isAnnotated:!0,errorMessage:"",segments:[],videoUrl:N(t.id)+"?type=processed",status:t.status,assignedUser:t.assignedUser||null}:a.value=null,a.value}async function k(e){try{const t=e||a.value?.id;if(!t){console.warn("No video ID available for fetching video URL"),l.value="No video selected.";return}const n=await v.get(f(`media/videos/${t}/`),{headers:{Accept:"application/json"}});n.data.video_url?(b.value=n.data.video_url,console.log("Fetched video URL:",b.value)):(console.warn("No video URL returned from API response:",n.data),l.value="Video URL not available.")}catch(t){const n=t;console.error("Error loading video URL:",n.response?.data||n.message),l.value="Error loading video URL. Please check the API endpoint or try again later."}}const $e=S(()=>a.value?N(a.value.id)+"?type=processed":"");function we(){if(!a.value?.id){w.value=null;return}const e=a.value.id;v.get(f(`anonymization/${e}/has-raw/`)).then(t=>{w.value=t.data.has_raw_file,console.log(`Raw video file for ID ${e}:`,w.value)}).catch(t=>{console.error("Error checking raw video file:",t),w.value=null})}async function De(e,t="outside"){try{const n=await v.get(f(`videos/${e}/labels/${t}/`),{headers:{Accept:"application/json"}});console.log(`[video ${e}] API response for label ${t}:`,n.data);const r=n.data.time_segments.map(o=>re(o,t));console.log(`[video ${e}] Mapped ${r.length} segments for label ${t}`),s[t]=r,a.value&&(a.value.segments=Object.values(s).flat())}catch(n){const r=n;console.error("Error loading segments for label "+t+":",r.response?.data||r.message),l.value=`Error loading segments for label ${t}. Please check the API endpoint or try again later.`}}async function B(e){const t=++F.value;try{const n=await v.get(f(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"}});if(t!==F.value)return;Object.keys(s).forEach(o=>{delete s[o]}),console.log(`[VideoStore] Loading ${n.data.length} segments for video ${e}`),Q(n.data).forEach(o=>{const c=j({id:o.id,label:o.label,startTime:o.startTime,endTime:o.endTime,avgConfidence:1,videoID:e,labelID:V.value[o.label]??null}),u=o.label;s[u]||(s[u]=[]),o.endTime-o.startTime<.1&&console.warn(`âš ï¸ Very short segment ${o.id}: ${o.endTime-o.startTime}s`),s[u].push(c)}),console.log("[VideoStore] Processed segments by label:",Object.keys(s).map(o=>`${o}: ${s[o].length}`))}catch(n){if(t===F.value){const r=n;console.error("Error loading video segments:",r.response?.data||r.message),l.value="Error loading video segments. Please try again later."}}}async function Ee(e,t,n,r){try{const o=d.value.labels.find(C=>C.name===t);if(!o)return console.error(`Label ${t} not found in store`),l.value=`Label ${t} nicht gefunden`,null;const c=o.id,u=I.value>0&&h.value?.fps||30,y=Math.floor(n*u),g=Math.floor(r*u),m={video_file:parseInt(e),label:c,start_frame_number:y,end_frame_number:g},T=await v.post(f(`media/videos/${e}/segments/`),m),p={id:T.data.id,label:t,startTime:T.data.start_time,endTime:T.data.end_time,avgConfidence:1,videoID:parseInt(e),labelID:c,startFrameNumber:T.data.start_frame_number,endFrameNumber:T.data.end_frame_number};return s[t]||(s[t]=[]),s[t].push(p),console.log("Created segment:",p),p}catch(o){const c=o;return console.error("Error creating segment:",c.response?.data||c.message),l.value="Error creating segment. Please try again.",null}}async function Ve(e,t){try{console.log(`[VideoStore] Updating segment ${e} with:`,t);const n=ke(e,(t.startTime||t.start_time)??0,(t.endTime||t.end_time)??0,t),r=a.value?.id,o=r?f(`media/videos/${r}/segments/${e}/`):f(`media/videos/segments/${e}/`),c=await v.patch(o,n),u=Z(c.data);return x(e,u),console.log(`[VideoStore] Successfully updated segment ${e}`),!0}catch(n){const r=n;return console.error("Error updating segment:",r.response?.data||r.message),l.value="Error updating segment. Please try again.",!1}}async function Ae(e){try{const t=a.value?.id,n=t?f(`media/videos/${t}/segments/${e}/`):f(`media/videos/segments/${e}/`);await v.delete(n);for(const r in s){const o=s[r].findIndex(c=>c.id===e);if(o!==-1){s[r].splice(o,1);break}}return!0}catch(t){const n=t;return console.error("Error deleting segment:",n.response?.data||n.message),l.value="Error deleting segment. Please try again.",!1}}function Fe(e){const t=Object.keys(s);for(const n of t)s[n]=s[n].filter(r=>r.id!==e)}function K(e,t){console.log(`[Draft] Starting draft: ${e} at ${E(t)}`),i.value={id:`draft-${Date.now()}`,label:e,startTime:t,endTime:null},console.log("[Draft] Created draft segment:",i.value)}function W(e){if(!i.value){console.warn("[Draft] Kein aktiver Draft gefunden zum Aktualisieren.");return}const t=i.value.startTime+We,n=Math.max(t,e);i.value.endTime=n,console.log(`[Draft] Draft-Ende aktualisiert: ${E(n)}, Duration: ${n-i.value.startTime}s`)}async function q(){if(console.log("[Draft] commitDraft() called, draftSegment:",i.value),console.log("[Draft] currentVideo:",a.value?.id),!i.value)return console.warn("[Draft] Kein Draft zum Committen gefunden - draftSegment.value ist null/undefined"),null;if(!a.value)return console.warn("[Draft] Kein currentVideo gefunden"),null;const e=i.value;if(e.endTime===null||e.endTime===void 0)return console.error("[Draft] Draft-Ende muss gesetzt sein vor dem Committen. Current endTime:",e.endTime),null;try{const t=d.value.labels.find(p=>p.name===e.label);if(!t)return console.error(`[Draft] Label ${e.label} not found in store`),console.log("[Draft] Available labels:",d.value.labels.map(p=>p.name)),l.value=`Label ${e.label} nicht gefunden`,null;const n=h.value?.fps||30,r=Math.floor(e.startTime*n),o=Math.floor(e.endTime*n),c={video_file:parseInt(a.value.id.toString()),label:t.id,start_frame_number:r,end_frame_number:o};console.log("[Draft] Committing Draft-Segment with payload:",c);const u=a.value?.id;if(!u)return console.error("[Draft] Cannot commit: no current video"),null;const y=await v.post(f(`media/videos/${u}/segments/`),c);console.log("[Draft] API response:",y.data);const g={id:y.data.id,label:e.label,startTime:y.data.start_time,endTime:y.data.end_time,avgConfidence:1,videoID:parseInt(a.value.id.toString()),labelID:t.id,startFrameNumber:y.data.start_frame_number,endFrameNumber:y.data.end_frame_number};a.value?.segments&&(a.value.segments.push(g),console.log("[Draft] Added segment to currentVideo.segments, new count:",a.value.segments.length));const m=e.label;s[m]||(s[m]=[]),s[m].push(g),console.log("[Draft] Added segment to segmentsByLabel["+m+"], new count:",s[m].length);try{const{useAnnotationStore:p}=await G(async()=>{const{useAnnotationStore:P}=await import("./annotationStore.js");return{useAnnotationStore:P}},__vite__mapDeps([0,1,2]),import.meta.url),{useAuthStore:C}=await G(async()=>{const{useAuthStore:P}=await import("./authStore.js");return{useAuthStore:P}},__vite__mapDeps([3,1,2]),import.meta.url),Le=p(),U=C();U.initMockUser(),U.user?.id?(await Le.createSegmentAnnotation(a.value.id.toString(),g,U.user.id),console.log(`âœ… Created annotation for segment ${g.id}`)):console.warn("No authenticated user found for annotation creation")}catch(p){console.error("Failed to create segment annotation:",p)}const T={...i.value};return i.value=null,console.log("[Draft] Draft erfolgreich committed und gecleared:",T,"-> New segment:",g),g}catch(t){return console.error("[Draft] Fehler beim Committen des Draft-Segments:",t),t instanceof H&&t.response?.data&&console.error("[Draft] Backend error details:",t.response.data),l.value=t instanceof H&&(t.response?.data?.detail||t.message)||"Unbekannter Fehler beim Speichern",null}}function Ne(){if(!i.value){console.warn("[Draft] Kein Draft zum Abbrechen gefunden.");return}console.log("[Draft] Draft abgebrochen:",i.value),i.value=null}async function Ie(e,t){const n=e,r=Math.min(e+X,I.value||e+X);return K(t,n),W(r),await q()}async function Ce(e){if(console.log(`[VideoStore] loadVideo called with ID: ${e}`),!je().overview.some(r=>r.id===Number(e)&&r.mediaType==="video"&&r.anonymizationStatus==="done"))throw new Error(`Video ${e} darf nicht annotiert werden, solange die Anonymisierung nicht abgeschlossen ist.`);try{a.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null};try{const o=(await v.get(f(`media/videos/${e}/`))).data;console.log("[VideoStore] Got video metadata:",o),a.value={id:o.id||e,videoUrl:o.video_url||"",status:o.status||"available",assignedUser:o.assignedUser||null,isAnnotated:o.isAnnotated||!1,errorMessage:"",segments:[],duration:o.duration,fps:o.fps}}catch(r){console.warn(`[VideoStore] Could not fetch video metadata for ${e}, using basic object:`,r)}await k(e),await R(e),console.log(`[VideoStore] Video ${e} successfully loaded with ${a.value?.segments?.length||0} segments`)}catch(r){const o=r;console.error(`[VideoStore] Error loading video ${e}:`,o.response?.data||o.message),l.value="Error loading video. Please try again."}}const Ue=S(()=>A.value.map(e=>({id:e.id,label:e.label,label_display:D(e.label),name:D(e.label),startTime:e.startTime,endTime:e.endTime,avgConfidence:e.avgConfidence,video_id:e.videoID,label_id:e.labelID})));function Pe(e,t){x(e,t)}return{currentVideo:$(a),errorMessage:$(l),videoUrl:$(b),segmentsByLabel:s,videoList:$(d),videoMeta:$(h),videos:Be,allSegments:A,draftSegment:$(J),activeSegment:ne,duration:I,hasVideo:Y,segments:ee,labels:te,videoStreamUrl:$e,timelineSegments:Ue,hasRawVideoFile:$(w),buildVideoStreamUrl:N,setCurrentVideo:Te,clearVideo:Se,deleteVideo:oe,setVideo:_e,loadVideo:Ce,fetchVideoUrl:k,fetchAllSegments:R,fetchAllVideos:ye,fetchLabels:z,fetchVideoMeta:ue,fetchVideoSegments:B,fetchSegmentsByLabel:De,createSegment:Ee,patchSegmentLocally:Pe,updateSegment:Ve,deleteSegment:Ae,removeSegment:Fe,saveAnnotations:pe,uploadRevert:ge,uploadProcess:ve,getSegmentStyle:ie,getColorForLabel:L,getTranslationForLabel:D,jumpToSegment:le,setActiveSegment:se,updateVideoStatus:be,assignUserToVideo:he,updateSensitiveMeta:me,clearVideoMeta:fe,hasRawVideoFileFn:we,startDraft:K,updateDraftEnd:W,commitDraft:q,cancelDraft:Ne,createFiveSecondSegment:Ie,formatTime:E,getSegmentOptions:ce,clearSegments:de}});export{E as f,D as g,Ge as n,He as u};
