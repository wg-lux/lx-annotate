import{M as Qe,h as f,e as y,d as De,i as Ve,w as xe,c as u,j as V,a as e,x as et,p as Me,C as W,t as l,k as m,F as me,m as $e,o,z as te,_ as Ee,f as tt,g as at,K as nt,n as Z,b as ke,D as st,r as it,l as J,I as rt,H as ee,v as lt,A as se,y as ot}from"./main.js";import{u as Ae}from"./videoStore.js";import{u as ut}from"./patientStore.js";import{u as dt}from"./mediaTypeStore.js";import{T as ct}from"./Timeline.js";import{u as vt}from"./usePollingProtection.js";const mt=Qe("pdf",()=>{const w=f(null),i=f(!1),n=f(null),v=f(!1),r=f(null),F=y(()=>w.value!==null),$=y(()=>w.value?.status==="processing"),S=y(()=>w.value?.status==="done"),k=y(()=>n.value!==null||w.value?.error===!0),x=y(()=>w.value?.pdfStreamUrl?w.value.pdfStreamUrl:null);function z(g){return`/api/media/pdfs/${g}/stream`}async function c(g){i.value=!0,n.value=null;try{const d=await fetch("/api/anonymization/items/overview/");if(!d.ok)throw new Error(`Failed to fetch overview: ${d.status}`);const Y=(await d.json()).pdfs?.filter(j=>j.status==="pending_validation"||j.status==="not_started")||[];if(Y.length===0){w.value=null,r.value=null;return}let T;if(g){const j=Y.findIndex(q=>q.id===g);T=Y[j+1]||Y[0]}else T=Y[0];w.value=T,r.value=T.id,T.id&&w.value&&(w.value.pdfStreamUrl=z(T.id),v.value=!0)}catch(d){n.value=d instanceof Error?d.message:"Unknown error occurred",console.error("Error fetching next PDF:",d)}finally{i.value=!1}}async function G(g,d){if(!w.value)throw new Error("No current PDF to update");i.value=!0,n.value=null;try{const D=await fetch(`/api/media/pdfs/${g}/sensitive-metadata/`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":_()},body:JSON.stringify(d)});if(!D.ok)throw new Error(`Failed to update sensitive metadata: ${D.status}`);const Y=await D.json();w.value.reportMeta&&(w.value.reportMeta={...w.value.reportMeta,...Y})}catch(D){throw n.value=D instanceof Error?D.message:"Unknown error occurred",console.error("Error updating sensitive metadata:",D),D}finally{i.value=!1}}async function L(g,d){if(!w.value)throw new Error("No current PDF to update");i.value=!0,n.value=null;try{const D=await fetch(`/api/media/pdfs/${g}/sensitive-metadata/`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":_()},body:JSON.stringify({anonymized_text:d})});if(!D.ok)throw new Error(`Failed to update anonymized text: ${D.status}`);w.value.anonymizedText=d,w.value.status="done"}catch(D){throw n.value=D instanceof Error?D.message:"Unknown error occurred",console.error("Error updating anonymized text:",D),D}finally{i.value=!1}}async function E(){if(!w.value)throw new Error("No current PDF to approve");const g=w.value.id;i.value=!0,n.value=null;try{const d=await fetch(`/api/anonymization/${g}/validate/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":_()},body:JSON.stringify({validation_status:"approved"})});if(!d.ok)throw new Error(`Failed to approve PDF: ${d.status}`);r.value=g,await c(g)}catch(d){throw n.value=d instanceof Error?d.message:"Unknown error occurred",console.error("Error approving PDF:",d),d}finally{i.value=!1}}async function U(){if(!w.value)throw new Error("No current PDF to skip");const g=w.value.id;r.value=g,await c(g)}async function N(g){try{const d=await fetch(`/api/anonymization/${g}/status/`);if(!d.ok)throw new Error(`Failed to check status: ${d.status}`);return await d.json()}catch(d){throw n.value=d instanceof Error?d.message:"Unknown error occurred",console.error("Error checking anonymization status:",d),d}}function B(){v.value=!1}function O(){w.value=null,i.value=!1,n.value=null,v.value=!1,r.value=null}function _(){const g=document.querySelector("[name=csrfmiddlewaretoken]")?.getAttribute("value");if(!g)throw new Error("CSRF token not found");return g}return{currentPdf:w,loading:i,error:n,streamingActive:v,lastProcessedId:r,hasCurrentPdf:F,isProcessing:$,isDone:S,hasError:k,pdfStreamUrl:x,buildPdfStreamUrl:z,fetchNextPdf:c,updateSensitiveMeta:G,updateAnonymizedText:L,approvePdf:E,skipPdf:U,checkAnonymizationStatus:N,stopStreaming:B,clearState:O}}),ft={class:"video-with-outside-timeline"},gt={key:0,class:"validation-status mb-3"},pt={class:"row align-items-center"},bt={class:"col-md-8"},ht={class:"progress"},yt={class:"col-md-4 text-end"},wt=["disabled"],St={key:0,class:"spinner-border spinner-border-sm me-1"},_t={key:1,class:"fas fa-check-double me-1"},kt=["disabled"],Dt=["src"],Vt={key:1,class:"segments-overview mb-3"},xt={class:"segments-list"},Mt={class:"ms-2 text-muted"},$t={class:"ms-2 badge bg-secondary"},Et=["onClick","disabled"],At={key:1,class:"text-success"},Ft={key:2,class:"alert alert-info"},zt=De({__name:"OutsideSegmentComponent",props:{videoId:{}},emits:["segment-validated","validation-complete"],setup(w,{emit:i}){const n=w,v=i,r=f(null),F=f(""),$=f(0),S=f(0),k=f(!1),x=Ae(),z=f(new Set),c=f(!1);async function G(h){const{data:p}=await te.get(`/api/media/videos/${h}/`);F.value=p.video_url,$.value=Number(p.duration??0)}async function L(h){await x.fetchAllSegments(h)}const E=y(()=>(x.allSegments??[]).filter(p=>(p.label??"").toLowerCase()==="outside").map(p=>({...p}))),U=y(()=>E.value.filter(h=>!z.value.has(h.id))),N=y(()=>E.value.length>0&&U.value.length===0);async function B(h){if(!(z.value.has(h.id)||c.value)){c.value=!0;try{z.value.add(h.id),v("segment-validated",h.id),console.log(`✅ Segment ${h.id} validated`),N.value&&(v("validation-complete"),console.log("🎉 All outside segments validated!"))}catch(p){console.error("Error validating segment:",p),z.value.delete(h.id)}finally{c.value=!1}}}async function O(){for(const h of U.value)await B(h)}function _(){z.value.clear()}function g(h){const p=Math.floor(h/60),A=Math.floor(h%60);return`${p.toString().padStart(2,"0")}:${A.toString().padStart(2,"0")}`}Ve(()=>{r.value&&(r.value.addEventListener("loadedmetadata",()=>{!$.value&&r.value&&($.value=r.value.duration||0)}),r.value.addEventListener("timeupdate",()=>{r.value&&(S.value=r.value.currentTime)}),r.value.addEventListener("play",()=>{k.value=!0}),r.value.addEventListener("pause",()=>{k.value=!1}))}),xe(()=>n.videoId,async h=>{_(),await Promise.all([G(h),L(h)])},{immediate:!0});function d(...h){const[p]=h;r.value&&Number.isFinite(p)&&(r.value.currentTime=p),S.value=p}function D(){r.value&&(r.value.paused?r.value.play().catch(()=>{}):r.value.pause(),k.value=!r.value.paused)}function Y(){}function T(){}function j(){}function q(){}function oe(){}function ue(){}function X(){}return(h,p)=>(o(),u("div",ft,[E.value.length>0?(o(),u("div",gt,[e("div",pt,[e("div",bt,[e("div",ht,[e("div",{class:W(["progress-bar",N.value?"bg-success":"bg-warning"]),style:Me(`width: ${z.value.size/E.value.length*100}%`)},l(z.value.size)+" / "+l(E.value.length)+" validiert ",7)])]),e("div",yt,[e("button",{class:"btn btn-sm btn-success me-2",onClick:O,disabled:c.value||N.value},[c.value?(o(),u("span",St)):(o(),u("i",_t)),p[0]||(p[0]=m(" Alle validieren ",-1))],8,wt),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:_,disabled:c.value||z.value.size===0},[...p[1]||(p[1]=[e("i",{class:"fas fa-redo me-1"},null,-1),m(" Zurücksetzen ",-1)])],8,kt)])])])):V("",!0),e("video",{ref_key:"videoEl",ref:r,src:F.value,controls:"",style:{width:"100%","max-height":"480px"}},null,8,Dt),E.value.length>0?(o(),u("div",Vt,[e("h6",null,"Outside-Segmente ("+l(E.value.length)+")",1),e("div",xt,[(o(!0),u(me,null,$e(E.value,A=>(o(),u("div",{key:A.id,class:W(["segment-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded",{"border-success bg-success bg-opacity-10":z.value.has(A.id),"border-warning bg-warning bg-opacity-10":!z.value.has(A.id)}])},[e("div",null,[e("strong",null,"Segment "+l(A.id),1),e("span",Mt,l(g(A.startTime))+" - "+l(g(A.endTime)),1),e("span",$t,l(A.label),1)]),e("div",null,[z.value.has(A.id)?(o(),u("span",At,[...p[3]||(p[3]=[e("i",{class:"fas fa-check-circle me-1"},null,-1),m(" Validiert ",-1)])])):(o(),u("button",{key:0,class:"btn btn-sm btn-outline-success",onClick:fe=>B(A),disabled:c.value},[...p[2]||(p[2]=[e("i",{class:"fas fa-check me-1"},null,-1),m(" Validieren ",-1)])],8,Et))])],2))),128))])])):(o(),u("div",Ft,[p[4]||(p[4]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),m(' Keine "Outside"-Segmente für Video '+l(n.videoId)+" gefunden. ",1)])),E.value.length>0?(o(),et(ct,{key:3,video:{duration:$.value},segments:E.value,"current-time":S.value,"is-playing":k.value,"selection-mode":!1,onSeek:d,onPlayPause:D,onSegmentCreate:Y,onSegmentResize:T,onSegmentMove:j,onTimeSelection:q,onSegmentSelect:oe,onSegmentEdit:ue,onSegmentDelete:X},null,8,["video","segments","current-time","is-playing"])):V("",!0)]))}}),It=Ee(zt,[["__scopeId","data-v-f646399d"]]);class P{static toISO(i){if(!i)return null;const n=i.trim().split(" ")[0],r=/^(\d{4})-(\d{2})-(\d{2})$/.exec(n);if(r){const[,S,k,x]=r;return this._isValidDate(parseInt(S),parseInt(k),parseInt(x))?n:null}const $=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(n);if($){const[,S,k,x]=$;return this._isValidDate(parseInt(x),parseInt(k),parseInt(S))?`${x}-${k}-${S}`:null}return null}static toGerman(i){if(!i)return"";const n=i.trim(),r=/^(\d{4})-(\d{2})-(\d{2})$/.exec(n);if(!r)return"";const[,F,$,S]=r;return this._isValidDate(parseInt(F),parseInt($),parseInt(S))?`${S}.${$}.${F}`:""}static validate(i,n){if(!i)return!1;const v=i.trim();if(n==="ISO"){const F=/^(\d{4})-(\d{2})-(\d{2})$/.exec(v);if(!F)return!1;const[,$,S,k]=F;return this._isValidDate(parseInt($),parseInt(S),parseInt(k))}if(n==="German"){const F=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(v);if(!F)return!1;const[,$,S,k]=F;return this._isValidDate(parseInt(k),parseInt(S),parseInt($))}return!1}static compare(i,n){if(!this.validate(i,"ISO")||!this.validate(n,"ISO"))return null;const v=new Date(i),r=new Date(n);return v<r?-1:v>r?1:0}static isBefore(i,n){return this.compare(i,n)===-1}static isAfter(i,n){return this.compare(i,n)===1}static isBeforeOrEqual(i,n){const v=this.compare(i,n);return v===-1||v===0}static isAfterOrEqual(i,n){const v=this.compare(i,n);return v===1||v===0}static today(){const i=new Date,n=i.getFullYear(),v=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0");return`${n}-${v}-${r}`}static todayGerman(){return this.toGerman(this.today())}static _isValidDate(i,n,v){if(i<1900||i>2100||n<1||n>12||v<1||v>31)return!1;const r=new Date(i,n-1,v);return r.getFullYear()===i&&r.getMonth()===n-1&&r.getDate()===v}}class Pt{errors=new Map;addField(i,n,v){if(!n){this.errors.set(i,`${i}: Pflichtfeld (darf nicht leer sein)`);return}if(!P.validate(n,v)){const r=v==="ISO"?"YYYY-MM-DD":"DD.MM.YYYY";this.errors.set(i,`${i}: Ungültiges Format (erwartet: ${r})`)}}addConstraint(i,n,v){n||this.errors.set(i,v)}hasErrors(){return this.errors.size>0}getErrors(){return Array.from(this.errors.values())}getSummary(){const i=this.errors.size;return i===0?"Alle Datumsfelder sind gültig":i===1?"1 Datumsfehler gefunden":`${i} Datumsfehler gefunden`}clear(){this.errors.clear()}getErrorsAsHtml(){return this.errors.size===0?"":`<ul class="date-validation-errors">${this.getErrors().map(n=>`<li>${n}</li>`).join("")}</ul>`}}const Yt={class:"container-fluid py-4"},Nt={class:"card"},Ot={class:"card-body"},Tt={key:0,class:"text-center py-5"},Ut={key:1,class:"alert alert-danger",role:"alert"},Ct={key:2,class:"alert alert-info",role:"alert"},Gt={key:3,class:"alert alert-warning mt-3"},Bt={class:"mt-2"},Lt={class:"row mb-3"},Kt={class:"col-12"},Rt={class:"alert alert-info d-flex align-items-center justify-content-between",role:"alert"},jt={key:0,class:"text-end"},qt={class:"text-muted"},Ht={class:"row mb-4"},Jt={class:"col-12"},Wt={class:"form-check"},Xt={key:0,class:"row mb-4"},Zt={class:"col-12"},Qt={class:"alert alert-danger alert-dismissible fade show",role:"alert"},ea={class:"alert-heading"},ta={class:"mb-0"},aa={class:"row mb-4"},na={class:"col-md-5"},sa={class:"card bg-light mb-4"},ia={class:"card-body"},ra={class:"mb-3"},la={key:0,class:"invalid-feedback"},oa={class:"mb-3"},ua={key:0,class:"invalid-feedback"},da={class:"mb-3"},ca={class:"mb-3"},va={class:"form-text text-muted"},ma={key:0,class:"ms-2 badge bg-secondary"},fa={key:0,class:"invalid-feedback"},ga={class:"mb-3"},pa={class:"mb-3"},ba={class:"form-text text-muted"},ha={key:0,class:"ms-2 badge bg-secondary"},ya={key:0,class:"invalid-feedback"},wa={class:"mb-3"},Sa={class:"card bg-light"},_a={class:"card-body"},ka={key:0,class:"mt-3"},Da=["src"],Va={class:"mt-3"},xa={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},Ma={class:"col-md-7"},$a={class:"card"},Ea={class:"card-header pb-0"},Aa={class:"mb-0"},Fa={class:"alert alert-info mt-2 mb-0"},za={key:0},Ia={key:1},Pa={key:2},Ya={class:"card-body media-viewer-container"},Na=["src"],Oa=["href"],Ta={key:1,class:"dual-video-container"},Ua={class:"row"},Ca={class:"col-md-6"},Ga={class:"video-section raw-video"},Ba=["src"],La={class:"mt-2 text-center"},Ka={class:"text-muted"},Ra={class:"col-md-6"},ja={class:"video-section anonymized-video"},qa=["src"],Ha={class:"mt-2 text-center"},Ja={class:"text-muted"},Wa={class:"video-controls mt-3 text-center"},Xa=["disabled"],Za={key:0,class:"spinner-border spinner-border-sm me-1",role:"status"},Qa={key:1,class:"fas fa-check me-1"},en={key:0,class:"outside-timeline-container mt-4"},tn={class:"card border-warning"},an={class:"card-header bg-warning bg-opacity-10"},nn={class:"d-flex justify-content-between align-items-center"},sn={class:"mb-0 text-warning"},rn={class:"text-end"},ln={class:"badge bg-warning text-dark fs-6"},on={class:"progress mt-2",style:{width:"200px",height:"8px"}},un=["aria-valuenow","aria-valuemax"],dn={class:"text-muted"},cn={class:"card-body"},vn={key:0,class:"mt-2"},mn={key:2,class:"alert alert-warning"},fn={class:"mb-0"},gn={class:"row"},pn={class:"col-12 d-flex justify-content-between"},bn={class:"d-flex gap-2"},hn=["disabled","title"],yn={key:0,class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",style:{"font-size":"0.6em"},title:"Ungespeicherte Änderungen"},wn=["disabled","title"],Sn={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},_n={key:1,class:"alert alert-warning mt-2 mb-0"},kn=De({__name:"AnonymizationValidationComponent",setup(w){const i=vt(),n=tt(),v=ot(),r=at(),F=Ae();ut();const $=mt(),S=dt(),k=f(""),x=f(""),z=f(!1),c=f({patientFirstName:"",patientLastName:"",patientGender:"",patientDob:"",casenumber:""}),G=f([]),L=f(""),E=f(""),U=f(""),N=f(""),B=f(!1),O=f(!1),_=f(null),g=f(0),d=f(0),D=f(""),Y=f(""),T=f(!1),j=f(!1),q=f({anonymizedText:"",examinationDate:"",patient:{patientFirstName:"",patientLastName:"",patientGender:"",patientDob:"",casenumber:""}});function oe(a,t){return a.patientFirstName===t.patientFirstName&&a.patientLastName===t.patientLastName&&a.patientGender===t.patientGender&&a.patientDob===t.patientDob&&a.casenumber===t.casenumber}function ue(a){return{patient_first_name:c.value.patientFirstName||"",patient_last_name:c.value.patientLastName||"",patient_gender:c.value.patientGender||"",patient_dob:a,casenumber:c.value.casenumber||""}}const X=y(()=>c.value.patientFirstName.trim().length>0),h=y(()=>c.value.patientLastName.trim().length>0),p=y(()=>P.toISO(c.value.patientDob)),A=y(()=>P.toISO(x.value)),fe=y(()=>{const a=G.value.length;return a===0?"Alle Felder sind gültig":a===1?"1 Validierungsfehler gefunden":`${a} Validierungsfehler gefunden`}),ae=y(()=>!!p.value),ne=y(()=>A.value?p.value?P.isAfterOrEqual(A.value,p.value):!1:!0),ie=y(()=>X.value&&h.value&&ae.value&&ne.value),Fe=y(()=>ie.value),de=y(()=>!(!ie.value||M.value&&O.value)),re=y(()=>{if(!ie.value){const a=[];return X.value||a.push("Vorname"),h.value||a.push("Nachname"),ae.value||a.push("gültiges Geburtsdatum"),ne.value||a.push("gültiges Untersuchungsdatum"),`Bitte korrigieren Sie: ${a.join(", ")}`}return M.value&&O.value?`Bitte validieren Sie zuerst alle Outside-Segmente (${d.value-g.value} verbleibend)`:""}),ge=y(()=>d.value===0?0:Math.round(g.value/d.value*100)),s=y(()=>r.current),C=y(()=>s.value?S.detectMediaType(s.value)==="pdf":!1),M=y(()=>s.value?S.detectMediaType(s.value)==="video":!1),pe=y(()=>{if(!(!C.value||!s.value))return S.getPdfUrl(s.value)||$.pdfStreamUrl||$.buildPdfStreamUrl(s.value.id)});y(()=>{if(!(!M.value||!s.value))return S.getVideoUrl(s.value)});const ce=y(()=>!M.value||!s.value?void 0:`${window.location.origin}/api/media/videos/${s.value.id}/?type=raw`),ve=y(()=>!M.value||!s.value?void 0:`${window.location.origin}/api/media/videos/${s.value.id}/?type=processed`),K=f(null),R=f(null),ze=a=>{console.error("Raw video error:",a)},Ie=()=>{console.log("Raw video load started")},Pe=()=>{console.log("Raw video can play")},Ye=a=>{console.error("Anonymized video error:",a)},Ne=()=>{console.log("Anonymized video load started")},Oe=()=>{console.log("Anonymized video can play")},be=(a,t)=>{if(!K.value||!R.value)return;const I=a==="raw"?K.value:R.value,b=a==="raw"?R.value:K.value;Math.abs(I.currentTime-b.currentTime)>.5&&(b.currentTime=I.currentTime)},Te=()=>{if(!K.value||!R.value)return;const a=(K.value.currentTime+R.value.currentTime)/2;K.value.currentTime=a,R.value.currentTime=a,console.log("Videos synchronized to time:",a)},Ue=()=>{K.value&&K.value.pause(),R.value&&R.value.pause(),console.log("All videos paused")},Ce=async()=>{if(!s.value||!M.value){n.warning({text:"Kein Video zur Validierung ausgewählt."});return}B.value=!0,O.value=!1,_.value=null;try{console.log(`🔍 Validating video ${s.value.id} for segment annotation...`);const t=(await te.get(se(`media/videos/${s.value.id}/validation/segments/`))).data;if(console.log("Video validation response:",t),t.eligible){const b=(await te.get(se(`media/videos/${s.value.id}/segments/?label=outside`))).data;d.value=b.length,g.value=0,b.length>0?(O.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Segmentvalidierung erforderlich",message:`${b.length} "Outside"-Segmente gefunden, die validiert werden müssen.`,details:"Verwenden Sie die Timeline unten, um die Segmente zu überprüfen und zu bestätigen."}):_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Video bereit für Annotation",message:'Keine "Outside"-Segmente gefunden. Video ist bereit für die Segment-Annotation.',details:`Video ID: ${s.value.id} - Alle Validierungen bestanden.`}}else _.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Video nicht bereit",message:t.reasons?.join(", ")||"Video ist nicht für Segment-Annotation geeignet.",details:"Überprüfen Sie die Video-Verarbeitung und Metadaten-Extraktion."};n.info({text:`Video ${s.value.id} validiert`})}catch(a){console.error("Error validating video for segment annotation:",a);try{await F.fetchAllSegments(s.value.id);const t=F.allSegments.filter(I=>I.label==="outside");d.value=t.length,g.value=0,t.length>0?(O.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Outside-Segmente gefunden (Fallback)",message:`${t.length} "Outside"-Segmente zur Validierung gefunden.`,details:"Fallback-Validierung über VideoStore. API-Endpoint nicht verfügbar."}):_.value={class:"alert-info",icon:"fas fa-info-circle",title:"Fallback-Validierung",message:'Keine "Outside"-Segmente gefunden (über VideoStore).',details:"API-Validierung fehlgeschlagen, Fallback verwendet."}}catch{_.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Validierung fehlgeschlagen",message:"Video konnte nicht für Segment-Annotation validiert werden.",details:a?.response?.data?.detail||a?.message||"Unbekannter Fehler"}}}finally{B.value=!1}},Ge=a=>{g.value++,console.log(`✅ Segment ${a} validated. Progress: ${g.value}/${d.value}`),_.value&&(_.value.message=`Fortschritt: ${g.value}/${d.value} Outside-Segmente validiert.`)},Be=()=>{console.log("🎉 All outside segments validated!"),O.value=!1,_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Validierung abgeschlossen",message:"Alle Outside-Segmente wurden erfolgreich validiert.",details:`Video ${s.value?.id} ist jetzt bereit für die vollständige Segment-Annotation.`},n.success({text:"Outside-Segment Validierung abgeschlossen!"})},he=a=>{if(!a)return;O.value=!1,_.value=null,g.value=0,d.value=0,B.value=!1,k.value=a.anonymizedText||"";const t=a.reportMeta?.examinationDate||"",I=a.reportMeta?.patientDob||"";x.value=P.toISO(t)||"";const b={patientFirstName:a.reportMeta?.patientFirstName||"",patientLastName:a.reportMeta?.patientLastName||"",patientGender:a.reportMeta?.patientGender||"",patientDob:P.toISO(I)||"",casenumber:a.reportMeta?.casenumber||""};c.value={...b},q.value={anonymizedText:k.value,examinationDate:x.value,patient:{...b}}};xe(s,a=>{a&&(S.setCurrentItem(a),he(a))},{immediate:!0});const le=async()=>{try{await r.fetchNext()}catch(a){console.error("Error fetching next item:",a)}},ye=y(()=>k.value!==q.value.anonymizedText||x.value!==q.value.examinationDate||!oe(c.value,q.value.patient)),we=y(()=>s.value&&!Q.value&&!H.value),Q=f(!1),H=f(!1),Le=()=>{T.value=!T.value};function Se(){const a=new Pt;if(G.value=[],L.value="",E.value="",c.value.patientDob){const t=c.value.patientDob;P.validate(t,"ISO")?U.value="ISO (YYYY-MM-DD)":P.validate(t,"German")?U.value="Deutsch (DD.MM.YYYY)":(U.value="",L.value="Ungültiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",a.addField("Geburtsdatum",t,"German"))}else U.value="";if(x.value){const t=x.value;P.validate(t,"ISO")?N.value="ISO (YYYY-MM-DD)":P.validate(t,"German")?N.value="Deutsch (DD.MM.YYYY)":(N.value="",E.value="Ungültiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",a.addField("Untersuchungsdatum",t,"ISO"))}else N.value="";p.value&&A.value&&a.addConstraint("DOB_BEFORE_EXAM",P.isBeforeOrEqual(p.value,A.value),"Geburtsdatum muss vor oder am selben Tag wie das Untersuchungsdatum liegen"),a.hasErrors()&&(G.value=a.getErrors(),a.getErrors().forEach(I=>{I.includes("Geburtsdatum")&&(L.value=I.replace("Geburtsdatum: ","")),I.includes("Untersuchungsdatum")&&(E.value=I.replace("Untersuchungsdatum: ",""))}))}function Ke(){const a=c.value.patientDob;if(!a)return;const t=P.toISO(a);t&&(c.value.patientDob=t,U.value="ISO (YYYY-MM-DD)"),Se()}function Re(){const a=x.value;if(!a)return;const t=P.toISO(a);t&&(x.value=t,N.value="ISO (YYYY-MM-DD)"),Se()}function je(){G.value=[],L.value="",E.value=""}const qe=async()=>{s.value&&await le()},He=()=>{if(!s.value){n.error({text:"Kein Video zur Segmentierung ausgewählt."});return}v.push({name:"Video-Untersuchung",query:{video:s.value.id.toString()}}),console.log(`🎯 Navigating to Video-Untersuchung with video ID: ${s.value.id}`)},Je=async()=>{if(!(!s.value||!we.value||H.value)){if(!de.value){const a=re.value;console.warn(`❌ Approval blocked: ${a}`),n.warning({text:a});return}if(M.value&&O.value){console.warn("❌ Outside segments still pending validation"),n.error({text:"Bitte validieren Sie zuerst alle Outside-Segmente, bevor Sie das Video bestätigen."});return}H.value=!0;try{console.log(`Validating anonymization for file ${s.value.id}...`);try{await te.post(se(`anonymization/${s.value.id}/validate/`),{patient_first_name:c.value.patientFirstName,patient_last_name:c.value.patientLastName,patient_gender:c.value.patientGender,patient_dob:P.toGerman(p.value||"")||"",examination_date:P.toGerman(A.value||"")||"",casenumber:c.value.casenumber||"",anonymized_text:C.value?k.value:void 0,is_verified:!0,file_type:C.value?"pdf":M.value?"video":"unknown"}),console.log(`Anonymization validated successfully for file ${s.value.id}`),n.success({text:"Dokument bestätigt und Anonymisierung validiert"})}catch(a){console.error("Error validating anonymization:",a),n.warning({text:"Dokument bestätigt, aber Validierung fehlgeschlagen"})}i.validateAnonymizationSafeWithProtection(s.value.id,"pdf"),await He()}catch(a){console.error("Error approving item:",a),n.error({text:"Fehler beim Bestätigen des Elements"})}finally{H.value=!1}}},We=async()=>{if(!Q.value){if(!Fe.value){if(!Y.value||!D.value)n.error({text:"Bitte laden Sie zuerst Bilder hoch (Original und bearbeitetes Bild)."});else if(!ie.value){const a=[];X.value||a.push("Vorname"),h.value||a.push("Nachname"),ae.value||a.push("gültiges Geburtsdatum"),ne.value||a.push("gültiges Untersuchungsdatum (darf nicht vor Geburtsdatum liegen)"),n.error({text:`Bitte korrigieren Sie: ${a.join(", ")}`})}return}Q.value=!0;try{const a={processed_image_url:Y.value,patient_data:ue(P.toGerman(p.value||"")||""),examinationDate:P.toGerman(A.value||"")||"",anonymized_text:k.value};if(s.value&&M.value)await te.post(se("save-anonymization-annotation-video/"),{...a,itemId:s.value.id});else if(s.value&&C.value)await te.post(se("save-anonymization-annotation-pdf/"),a);else{n.error({text:"Keine gültige Anonymisierung zum Speichern gefunden."});return}D.value="",Y.value="",j.value=!1,n.success({text:"Annotation erfolgreich gespeichert"})}catch(a){console.error("Error saving annotation:",a),n.error({text:"Fehler beim Speichern der Annotation"})}finally{Q.value=!1}}},Xe=async()=>{s.value&&await le()},Ze=async()=>{if(!s.value){n.error({text:"Kein Element zur Korrektur ausgewählt."});return}if(ye.value){const I=confirm(`Sie haben ungespeicherte Änderungen!

Möchten Sie diese zuerst speichern, bevor Sie zur Korrektur wechseln?

• Ja = Änderungen speichern und zur Korrektur
• Nein = Änderungen verwerfen und zur Korrektur
• Abbrechen = Hier bleiben`);if(I===null)return;if(I){if(!we.value){n.error({text:"Bitte korrigieren Sie die Validierungsfehler vor dem Speichern."});return}try{v.push({name:"Anonymisierung Korrektur",params:{fileId:s.value.id.toString()}}),n.info({text:"Änderungen gespeichert. Bitte wählen Sie das Element erneut für die Korrektur aus."});return}catch{n.error({text:"Fehler beim Speichern. Korrektur-Navigation abgebrochen."});return}}}S.setCurrentItem(s.value);const a=M.value?"Video":C.value?"PDF":"Dokument",t=M.value?"Verfügbare Optionen: Maskierung, Frame-Entfernung, Neuverarbeitung":"Verfügbare Optionen: Text-Annotation anpassen, Metadaten korrigieren";console.log(`🔧 Navigating to correction for ${a}:`,{id:s.value.id,mediaType:a,detectedType:S.detectMediaType(s.value),mediaUrl:S.currentMediaUrl}),v.push({name:"AnonymisierungKorrektur",params:{fileId:s.value.id.toString()}}),n.info({text:`${a}-Korrektur geöffnet. ${t}`})};return Ve(async()=>{r.current?he(r.current):await le()}),nt(()=>{le()}),(a,t)=>{const I=it("router-link");return o(),u("div",Yt,[e("div",Nt,[t[59]||(t[59]=e("div",{class:"card-header pb-0"},[e("h4",{class:"mb-0"},"Anonymisierungsvalidierung und Annotationen")],-1)),e("div",Ot,[Z(r).loading?(o(),u("div",Tt,[...t[10]||(t[10]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Wird geladen...")],-1),e("p",{class:"mt-2"},"Anonymisierte Daten werden geladen...",-1)])])):Z(r).error?(o(),u("div",Ut,[t[11]||(t[11]=e("strong",null,"Fehler:",-1)),m(" "+l(Z(r).error),1)])):s.value?V("",!0):(o(),u("div",Ct," Alle Anonymisierungen wurden bearbeitet. ")),Z(r).isAnyFileProcessing?(o(),u("div",Gt,[t[13]||(t[13]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("strong",null,l(Z(r).processingFiles.length)+" Datei(en)",1),t[14]||(t[14]=m(" werden gerade anonymisiert. ",-1)),e("div",Bt,[ke(I,{to:"/anonymisierung/uebersicht",class:"btn btn-sm btn-outline-primary"},{default:st(()=>[...t[12]||(t[12]=[e("i",{class:"fas fa-eye me-1"},null,-1),m(" Zur Übersicht ",-1)])]),_:1})])])):V("",!0)]),s.value?(o(),u(me,{key:0},[e("div",Lt,[e("div",Kt,[e("div",Rt,[e("div",null,[t[16]||(t[16]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("span",null,[t[15]||(t[15]=e("strong",null,"Validierung:",-1)),m(" "+l(C.value?"PDF-Dokument":M.value?"Video-Datei":"Unbekanntes Format")+" "+l(s.value?.reportMeta?.centerName?`- ${s.value.reportMeta.centerName}`:""),1)])]),s.value&&(M.value||C.value)?(o(),u("div",jt,[e("small",qt,[t[17]||(t[17]=e("i",{class:"fas fa-tools me-1"},null,-1)),m(" "+l(M.value?"Video-Korrektur verfügbar":"Text-Korrektur verfügbar"),1)])])):V("",!0)])])]),e("div",Ht,[e("div",Jt,[e("div",Wt,[J(e("input",{type:"checkbox",class:"form-check-input",id:"noMoreNames","onUpdate:modelValue":t[0]||(t[0]=b=>z.value=b)},null,512),[[rt,z.value]]),t[18]||(t[18]=e("label",{class:"form-check-label",for:"noMoreNames"}," Keine weiteren Namen im Video oder PDF vorhanden ",-1))])])]),G.value.length>0?(o(),u("div",Xt,[e("div",Zt,[e("div",Qt,[e("h6",ea,[t[19]||(t[19]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" "+l(fe.value),1)]),t[20]||(t[20]=e("hr",null,null,-1)),e("ul",ta,[(o(!0),u(me,null,$e(G.value,(b,_e)=>(o(),u("li",{key:_e},l(b),1))),128))]),e("button",{type:"button",class:"btn-close",onClick:je,"aria-label":"Schließen"})])])])):V("",!0),e("div",aa,[e("div",na,[e("div",sa,[e("div",ia,[t[33]||(t[33]=e("h5",{class:"card-title"},"Patienteninformationen",-1)),e("div",ra,[t[21]||(t[21]=e("label",{class:"form-label"},"Vorname:",-1)),J(e("input",{type:"text",class:W(["form-control",{"is-invalid":!X.value}]),"onUpdate:modelValue":t[1]||(t[1]=b=>c.value.patientFirstName=b)},null,2),[[ee,c.value.patientFirstName]]),X.value?V("",!0):(o(),u("div",la," Vorname ist erforderlich. "))]),e("div",oa,[t[22]||(t[22]=e("label",{class:"form-label"},"Nachname:",-1)),J(e("input",{type:"text",class:W(["form-control",{"is-invalid":!h.value}]),"onUpdate:modelValue":t[2]||(t[2]=b=>c.value.patientLastName=b)},null,2),[[ee,c.value.patientLastName]]),h.value?V("",!0):(o(),u("div",ua," Nachname ist erforderlich. "))]),e("div",da,[t[24]||(t[24]=e("label",{class:"form-label"},"Geschlecht:",-1)),J(e("select",{class:"form-select","onUpdate:modelValue":t[3]||(t[3]=b=>c.value.patientGender=b)},[...t[23]||(t[23]=[e("option",{value:"male"},"Männlich",-1),e("option",{value:"female"},"Weiblich",-1),e("option",{value:"other"},"Divers",-1)])],512),[[lt,c.value.patientGender]])]),e("div",ca,[t[27]||(t[27]=e("label",{class:"form-label"},"Geburtsdatum:",-1)),J(e("input",{type:"date",class:W(["form-control",{"is-invalid":!ae.value}]),"onUpdate:modelValue":t[4]||(t[4]=b=>c.value.patientDob=b),onBlur:Ke},null,34),[[ee,c.value.patientDob]]),e("small",va,[t[25]||(t[25]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),t[26]||(t[26]=m(" Format: DD.MM.YYYY oder YYYY-MM-DD ",-1)),U.value?(o(),u("span",ma,l(U.value),1)):V("",!0)]),ae.value?V("",!0):(o(),u("div",fa,l(L.value||"Gültiges Geburtsdatum ist erforderlich."),1))]),e("div",ga,[t[28]||(t[28]=e("label",{class:"form-label"},"Fallnummer:",-1)),J(e("input",{type:"text",class:"form-control","onUpdate:modelValue":t[5]||(t[5]=b=>c.value.casenumber=b)},null,512),[[ee,c.value.casenumber]])]),e("div",pa,[t[31]||(t[31]=e("label",{class:"form-label"},"Untersuchungsdatum:",-1)),J(e("input",{type:"date",class:W(["form-control",{"is-invalid":!ne.value}]),"onUpdate:modelValue":t[6]||(t[6]=b=>x.value=b),onBlur:Re},null,34),[[ee,x.value]]),e("small",ba,[t[29]||(t[29]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),t[30]||(t[30]=m(" Format: DD.MM.YYYY oder YYYY-MM-DD ",-1)),N.value?(o(),u("span",ha,l(N.value),1)):V("",!0)]),ne.value?V("",!0):(o(),u("div",ya,l(E.value||"Das Untersuchungsdatum darf nicht vor dem Geburtsdatum liegen."),1))]),e("div",wa,[t[32]||(t[32]=e("label",{class:"form-label"},"Anonymisierter Text:",-1)),J(e("textarea",{class:"form-control",rows:"6","onUpdate:modelValue":t[7]||(t[7]=b=>k.value=b)},null,512),[[ee,k.value]])])])]),e("div",Sa,[e("div",_a,[t[34]||(t[34]=e("h5",{class:"card-title"},"Annotationen",-1)),Y.value?(o(),u("div",ka,[e("img",{src:T.value?D.value:Y.value,class:"img-fluid",alt:"Uploaded Image"},null,8,Da),e("button",{class:"btn btn-info btn-sm mt-2",onClick:Le},l(T.value?"Bearbeitetes Bild anzeigen":"Original anzeigen"),1)])):V("",!0),e("div",Va,[e("button",{class:"btn btn-primary",onClick:We},[Q.value?(o(),u("span",xa)):V("",!0),m(" "+l(Q.value?"Speichern...":"Annotation zwischenspeichern"),1)])])])])]),e("div",Ma,[e("div",$a,[e("div",Ea,[e("h5",Aa,l(C.value?"PDF Vorschau":"Video Vorschau"),1),e("div",Fa,[t[35]||(t[35]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),t[36]||(t[36]=e("strong",null,"Datenformat:",-1)),C.value?(o(),u("span",za," PDF-Dokument ("+l(Math.round((s.value?.reportMeta?.file?.length||0)/1024)||"Unbekannt")+" KB) ",1)):M.value?(o(),u("span",Ia," Video-Datei (Raw: "+l(ce.value||"N/A")+" | Anonymized: "+l(ve.value||"N/A")+") ",1)):(o(),u("span",Pa," Unbekanntes Format - ID: "+l(s.value?.id),1))])]),e("div",Ya,[C.value?(o(),u("iframe",{key:0,src:pe.value,width:"100%",height:"800px",frameborder:"0",title:"PDF Vorschau"},[t[37]||(t[37]=m(" Ihr Browser unterstützt keine eingebetteten PDFs. Sie können die Datei ",-1)),e("a",{href:pe.value},"hier herunterladen",8,Oa),t[38]||(t[38]=m(". ",-1))],8,Na)):M.value?(o(),u("div",Ta,[e("div",Ua,[e("div",Ca,[e("div",Ga,[t[39]||(t[39]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-eye me-1"}),m(" Original Video (Raw) ")],-1)),e("video",{ref_key:"rawVideoElement",ref:K,src:ce.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:ze,onLoadstart:Ie,onCanplay:Pe,onTimeupdate:t[8]||(t[8]=b=>be("raw"))}," Ihr Browser unterstützt dieses Video-Format nicht. ",40,Ba),e("div",La,[e("small",Ka," URL: "+l(ce.value||"Nicht verfügbar"),1)])])]),e("div",Ra,[e("div",ja,[t[40]||(t[40]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes Video (Processed) ")],-1)),e("video",{ref_key:"anonymizedVideoElement",ref:R,src:ve.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ye,onLoadstart:Ne,onCanplay:Oe,onTimeupdate:t[9]||(t[9]=b=>be("anonymized"))}," Ihr Browser unterstützt dieses Video-Format nicht. ",40,qa),e("div",Ha,[e("small",Ja," URL: "+l(ve.value||"Nicht verfügbar"),1)])])])]),e("div",Wa,[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Te},[...t[41]||(t[41]=[e("i",{class:"fas fa-sync me-1"},null,-1),m(" Videos synchronisieren ",-1)])]),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:Ue},[...t[42]||(t[42]=[e("i",{class:"fas fa-pause me-1"},null,-1),m(" Alle pausieren ",-1)])]),e("button",{class:"btn btn-outline-info btn-sm ms-2",onClick:Ce,disabled:B.value},[B.value?(o(),u("span",Za)):(o(),u("i",Qa)),t[43]||(t[43]=m(" Segment-Annotation prüfen ",-1))],8,Xa)]),O.value&&s.value?(o(),u("div",en,[e("div",tn,[e("div",an,[e("div",nn,[e("div",null,[e("h6",sn,[t[44]||(t[44]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" Segmente zur Entfernung - Video ID: "+l(s.value.id),1)]),t[45]||(t[45]=e("small",{class:"text-muted"},' Diese Segmente wurden als "outside" klassifiziert und sollten aus dem Video entfernt werden. ',-1))]),e("div",rn,[e("div",ln,l(g.value)+" / "+l(d.value),1),e("div",on,[e("div",{class:"progress-bar bg-success",role:"progressbar",style:Me({width:ge.value+"%"}),"aria-valuenow":g.value,"aria-valuemin":0,"aria-valuemax":d.value},null,12,un)]),e("small",dn,l(ge.value)+"% validiert",1)])])]),e("div",cn,[ke(It,{videoId:s.value.id,onSegmentValidated:Ge,onValidationComplete:Be},null,8,["videoId"])])])])):V("",!0),_.value?(o(),u("div",{key:1,class:W(["alert mt-3",_.value.class])},[e("i",{class:W([_.value.icon,"me-2"])},null,2),e("strong",null,l(_.value.title)+":",1),m(" "+l(_.value.message)+" ",1),_.value.details?(o(),u("div",vn,[e("small",null,l(_.value.details),1)])):V("",!0)],2)):V("",!0)])):(o(),u("div",mn,[t[55]||(t[55]=e("h6",null,"Debug-Informationen:",-1)),e("ul",fn,[e("li",null,[t[46]||(t[46]=e("strong",null,"Current Item ID:",-1)),m(" "+l(s.value?.id||"Nicht verfügbar"),1)]),e("li",null,[t[47]||(t[47]=e("strong",null,"SensitiveMeta ID:",-1)),m(" "+l(s.value?.sensitiveMetaId||"Nicht verfügbar"),1)]),e("li",null,[t[48]||(t[48]=e("strong",null,"Is PDF:",-1)),m(" "+l(C.value),1)]),e("li",null,[t[49]||(t[49]=e("strong",null,"Is Video:",-1)),m(" "+l(M.value),1)]),e("li",null,[t[50]||(t[50]=e("strong",null,"Detected Media Type:",-1)),m(" "+l(s.value?Z(S).detectMediaType(s.value):"N/A"),1)]),e("li",null,[t[51]||(t[51]=e("strong",null,"Media URL:",-1)),m(" "+l(s.value?Z(S).currentMediaUrl:"N/A"),1)]),e("li",null,[t[52]||(t[52]=e("strong",null,"PDF URL:",-1)),m(" "+l(s.value?.reportMeta?.pdfUrl||"Nicht verfügbar"),1)]),e("li",null,[t[53]||(t[53]=e("strong",null,"Video URL:",-1)),m(" "+l(s.value?.videoUrl||"Nicht verfügbar"),1)]),e("li",null,[t[54]||(t[54]=e("strong",null,"PDF Stream URL:",-1)),m(" "+l(s.value?.pdfStreamUrl||"Nicht verfügbar"),1)])])]))])])])]),e("div",gn,[e("div",pn,[e("button",{class:"btn btn-secondary",onClick:qe}," Überspringen "),e("div",bn,[s.value&&(M.value||C.value)?(o(),u("button",{key:0,class:"btn btn-warning position-relative",onClick:Ze,disabled:H.value,title:M.value?"Video-Korrektur: Maskierung, Frame-Entfernung, etc.":"PDF-Korrektur: Text-Annotation anpassen"},[t[56]||(t[56]=e("i",{class:"fas fa-edit me-1"},null,-1)),m(" "+l(M.value?"Video-Korrektur":"PDF-Korrektur")+" ",1),ye.value?(o(),u("span",yn," ! ")):V("",!0)],8,hn)):V("",!0),e("button",{class:"btn btn-danger me-2",onClick:Xe}," Ablehnen "),e("button",{class:"btn btn-success",onClick:Je,disabled:H.value||!de.value,title:re.value},[H.value?(o(),u("span",Sn)):V("",!0),m(" "+l(H.value?"Wird bestätigt...":"Bestätigen"),1)],8,wn),!de.value&&re.value?(o(),u("div",_n,[t[57]||(t[57]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[58]||(t[58]=e("strong",null,"Bestätigung blockiert:",-1)),m(" "+l(re.value),1)])):V("",!0)])])])],64)):V("",!0)])])}}}),An=Ee(kn,[["__scopeId","data-v-b943ce34"]]);export{An as default};
