import{d as Ne,h as g,e as y,i as Ae,w as _e,c as d,j as _,a as e,x as ct,q as ze,n as K,t as r,k as m,F as pe,m as xe,o as i,z as ne,_ as Fe,f as vt,g as mt,u as ft,J as gt,p as J,b as Ie,C as pt,r as bt,l as z,H as ht,G as Y,v as $e,A as ce,y as yt}from"./main.js";import{u as Oe}from"./videoStore.js";import{u as _t}from"./mediaTypeStore.js";import{T as xt}from"./Timeline.js";import{u as wt}from"./usePollingProtection.js";const St={class:"video-with-outside-timeline"},Dt={key:0,class:"validation-status mb-3"},kt={class:"row align-items-center"},Vt={class:"col-md-8"},It={class:"progress"},$t={class:"col-md-4 text-end"},Nt=["disabled"],At={key:0,class:"spinner-border spinner-border-sm me-1"},zt={key:1,class:"fas fa-check-double me-1"},Ft=["disabled"],Ot=["src"],Et={key:1,class:"segments-overview mb-3"},Pt={class:"segments-list"},Mt={class:"ms-2 text-muted"},Yt={class:"ms-2 badge bg-secondary"},Tt=["onClick","disabled"],Ct={key:1,class:"text-success"},Ut={key:2,class:"alert alert-info"},Bt=Ne({__name:"OutsideSegmentComponent",props:{videoId:{}},emits:["segment-validated","validation-complete"],setup(ae,{emit:u}){const a=ae,f=u,s=g(null),V=g(""),x=g(0),S=g(0),b=g(!1),h=Oe(),N=g(new Set),P=g(!1);async function I(v){const{data:p}=await ne.get(`/api/media/videos/${v}/`);V.value=p.video_url,x.value=Number(p.duration??0)}async function M(v){await h.fetchAllSegments(v)}const F=y(()=>(h.allSegments??[]).filter(p=>(p.label??"").toLowerCase()==="outside").map(p=>({...p}))),Q=y(()=>F.value.filter(v=>!N.value.has(v.id))),se=y(()=>F.value.length>0&&Q.value.length===0);async function R(v){if(!(N.value.has(v.id)||P.value)){P.value=!0;try{N.value.add(v.id),f("segment-validated",v.id),console.log(`‚úÖ Segment ${v.id} validated`),se.value&&(f("validation-complete"),console.log("üéâ All outside segments validated!"))}catch(p){console.error("Error validating segment:",p),N.value.delete(v.id)}finally{P.value=!1}}}async function A(){for(const v of Q.value)await R(v)}function ie(){N.value.clear()}function l(v){const p=Math.floor(v/60),D=Math.floor(v%60);return`${p.toString().padStart(2,"0")}:${D.toString().padStart(2,"0")}`}Ae(()=>{s.value&&(s.value.addEventListener("loadedmetadata",()=>{!x.value&&s.value&&(x.value=s.value.duration||0)}),s.value.addEventListener("timeupdate",()=>{s.value&&(S.value=s.value.currentTime)}),s.value.addEventListener("play",()=>{b.value=!0}),s.value.addEventListener("pause",()=>{b.value=!1}))}),_e(()=>a.videoId,async v=>{ie(),await Promise.all([I(v),M(v)])},{immediate:!0});function G(...v){const[p]=v;s.value&&Number.isFinite(p)&&(s.value.currentTime=p),S.value=p}function j(){s.value&&(s.value.paused?s.value.play().catch(()=>{}):s.value.pause(),b.value=!s.value.paused)}function q(){}function T(){}function C(){}function W(){}function E(){}function w(){}function O(){}return(v,p)=>(i(),d("div",St,[F.value.length>0?(i(),d("div",Dt,[e("div",kt,[e("div",Vt,[e("div",It,[e("div",{class:K(["progress-bar",se.value?"bg-success":"bg-warning"]),style:ze(`width: ${N.value.size/F.value.length*100}%`)},r(N.value.size)+" / "+r(F.value.length)+" validiert ",7)])]),e("div",$t,[e("button",{class:"btn btn-sm btn-success me-2",onClick:A,disabled:P.value||se.value},[P.value?(i(),d("span",At)):(i(),d("i",zt)),p[0]||(p[0]=m(" Alle validieren ",-1))],8,Nt),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:ie,disabled:P.value||N.value.size===0},[...p[1]||(p[1]=[e("i",{class:"fas fa-redo me-1"},null,-1),m(" Zur√ºcksetzen ",-1)])],8,Ft)])])])):_("",!0),e("video",{ref_key:"videoEl",ref:s,src:V.value,controls:"",style:{width:"100%","max-height":"480px"}},null,8,Ot),F.value.length>0?(i(),d("div",Et,[e("h6",null,"Outside-Segmente ("+r(F.value.length)+")",1),e("div",Pt,[(i(!0),d(pe,null,xe(F.value,D=>(i(),d("div",{key:D.id,class:K(["segment-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded",{"border-success bg-success bg-opacity-10":N.value.has(D.id),"border-warning bg-warning bg-opacity-10":!N.value.has(D.id)}])},[e("div",null,[e("strong",null,"Segment "+r(D.id),1),e("span",Mt,r(l(D.startTime))+" - "+r(l(D.endTime)),1),e("span",Yt,r(D.label),1)]),e("div",null,[N.value.has(D.id)?(i(),d("span",Ct,[...p[3]||(p[3]=[e("i",{class:"fas fa-check-circle me-1"},null,-1),m(" Validiert ",-1)])])):(i(),d("button",{key:0,class:"btn btn-sm btn-outline-success",onClick:le=>R(D),disabled:P.value},[...p[2]||(p[2]=[e("i",{class:"fas fa-check me-1"},null,-1),m(" Validieren ",-1)])],8,Tt))])],2))),128))])])):(i(),d("div",Ut,[p[4]||(p[4]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),m(' Keine "Outside"-Segmente f√ºr Video '+r(a.videoId)+" gefunden. ",1)])),F.value.length>0?(i(),ct(xt,{key:3,video:{duration:x.value},segments:F.value,"current-time":S.value,"is-playing":b.value,"selection-mode":!1,onSeek:G,onPlayPause:j,onSegmentCreate:q,onSegmentResize:T,onSegmentMove:C,onTimeSelection:W,onSegmentSelect:E,onSegmentEdit:w,onSegmentDelete:O},null,8,["video","segments","current-time","is-playing"])):_("",!0)]))}}),Gt=Fe(Bt,[["__scopeId","data-v-f646399d"]]);class k{static toISO(u){if(!u)return null;const a=u.trim().split(" ")[0],s=/^(\d{4})-(\d{2})-(\d{2})$/.exec(a);if(s){const[,S,b,h]=s;return this._isValidDate(parseInt(S),parseInt(b),parseInt(h))?a:null}const x=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(a);if(x){const[,S,b,h]=x;return this._isValidDate(parseInt(h),parseInt(b),parseInt(S))?`${h}-${b}-${S}`:null}return null}static toGerman(u){if(!u)return"";const a=u.trim(),s=/^(\d{4})-(\d{2})-(\d{2})$/.exec(a);if(!s)return"";const[,V,x,S]=s;return this._isValidDate(parseInt(V),parseInt(x),parseInt(S))?`${S}.${x}.${V}`:""}static validate(u,a){if(!u)return!1;const f=u.trim();if(a==="ISO"){const V=/^(\d{4})-(\d{2})-(\d{2})$/.exec(f);if(!V)return!1;const[,x,S,b]=V;return this._isValidDate(parseInt(x),parseInt(S),parseInt(b))}if(a==="German"){const V=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(f);if(!V)return!1;const[,x,S,b]=V;return this._isValidDate(parseInt(b),parseInt(S),parseInt(x))}return!1}static compare(u,a){if(!this.validate(u,"ISO")||!this.validate(a,"ISO"))return null;const f=new Date(u),s=new Date(a);return f<s?-1:f>s?1:0}static isBefore(u,a){return this.compare(u,a)===-1}static isAfter(u,a){return this.compare(u,a)===1}static isBeforeOrEqual(u,a){const f=this.compare(u,a);return f===-1||f===0}static isAfterOrEqual(u,a){const f=this.compare(u,a);return f===1||f===0}static today(){const u=new Date,a=u.getFullYear(),f=String(u.getMonth()+1).padStart(2,"0"),s=String(u.getDate()).padStart(2,"0");return`${a}-${f}-${s}`}static todayGerman(){return this.toGerman(this.today())}static _isValidDate(u,a,f){if(u<1900||u>2100||a<1||a>12||f<1||f>31)return!1;const s=new Date(u,a-1,f);return s.getFullYear()===u&&s.getMonth()===a-1&&s.getDate()===f}}class Lt{errors=new Map;addField(u,a,f){if(!a){this.errors.set(u,`${u}: Pflichtfeld (darf nicht leer sein)`);return}if(!k.validate(a,f)){const s=f==="ISO"?"YYYY-MM-DD":"DD.MM.YYYY";this.errors.set(u,`${u}: Ung√ºltiges Format (erwartet: ${s})`)}}addConstraint(u,a,f){a||this.errors.set(u,f)}hasErrors(){return this.errors.size>0}getErrors(){return Array.from(this.errors.values())}getSummary(){const u=this.errors.size;return u===0?"Alle Datumsfelder sind g√ºltig":u===1?"1 Datumsfehler gefunden":`${u} Datumsfehler gefunden`}clear(){this.errors.clear()}getErrorsAsHtml(){return this.errors.size===0?"":`<ul class="date-validation-errors">${this.getErrors().map(a=>`<li>${a}</li>`).join("")}</ul>`}}const Kt={class:"container-fluid py-4"},Rt={class:"card"},jt={class:"card-body"},qt={key:0,class:"text-center py-5"},Wt={key:1,class:"alert alert-danger",role:"alert"},Ht={key:3,class:"alert alert-warning mt-3"},Zt={class:"mt-2"},Jt={class:"row mb-3"},Qt={class:"col-12"},Xt={class:"alert alert-info d-flex align-items-center justify-content-between",role:"alert"},en={key:0,class:"text-end"},tn={class:"text-muted"},nn={class:"row mb-4"},an={class:"col-12"},sn={class:"form-check"},ln={key:0,class:"row mb-4"},on={class:"col-12"},rn={class:"alert alert-danger alert-dismissible fade show",role:"alert"},dn={class:"alert-heading"},un={class:"mb-0"},cn={class:"row mb-4"},vn={class:"col-md-5"},mn={class:"card bg-light mb-4"},fn={class:"card-body"},gn={class:"mb-3"},pn={key:0,class:"invalid-feedback"},bn={class:"mb-3"},hn={key:0,class:"invalid-feedback"},yn={class:"mb-3"},_n={class:"mb-3"},xn={class:"form-text text-muted"},wn={key:0,class:"ms-2 badge bg-secondary"},Sn={key:0,class:"invalid-feedback"},Dn={class:"mb-3"},kn={class:"mb-3"},Vn={class:"form-text text-muted"},In={key:0,class:"ms-2 badge bg-secondary"},$n={key:0,class:"invalid-feedback"},Nn={class:"mb-3"},An={class:"mb-3"},zn={class:"mb-3"},Fn={class:"mb-3"},On={class:"mb-3"},En={class:"card bg-light"},Pn={class:"card-body"},Mn={key:0,class:"mt-3"},Yn=["src"],Tn={class:"mt-3"},Cn={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},Un={class:"col-md-7"},Bn={class:"card"},Gn={class:"card-header pb-0"},Ln={class:"mb-0"},Kn={class:"alert alert-info mt-2 mb-0"},Rn={key:0},jn={key:1},qn={key:2},Wn={class:"card-body media-viewer-container"},Hn={key:0,class:"dual-pdf-container"},Zn={class:"row"},Jn={class:"col-md-6"},Qn={class:"pdf-section raw-pdf"},Xn=["src"],ea=["href"],ta={class:"mt-2 text-center"},na={class:"text-muted"},aa={class:"col-md-6"},sa={class:"pdf-section anonymized-pdf"},ia=["src"],la=["href"],oa={class:"mt-2 text-center"},ra={class:"text-muted"},da={key:1,class:"dual-video-container"},ua={class:"row"},ca={class:"col-md-6"},va={class:"video-section raw-video"},ma=["src"],fa={class:"mt-2 text-center"},ga={class:"text-muted"},pa={class:"col-md-6"},ba={class:"video-section anonymized-video"},ha=["src"],ya={class:"mt-2 text-center"},_a={class:"text-muted"},xa={class:"video-controls mt-3 text-center"},wa=["disabled"],Sa={key:0,class:"spinner-border spinner-border-sm me-1",role:"status"},Da={key:1,class:"fas fa-check me-1"},ka={key:0,class:"outside-timeline-container mt-4"},Va={class:"card border-warning"},Ia={class:"card-header bg-warning bg-opacity-10"},$a={class:"d-flex justify-content-between align-items-center"},Na={class:"mb-0 text-warning"},Aa={class:"text-end"},za={class:"badge bg-warning text-dark fs-6"},Fa={class:"progress mt-2",style:{width:"200px",height:"8px"}},Oa=["aria-valuenow","aria-valuemax"],Ea={class:"text-muted"},Pa={class:"card-body"},Ma={key:0,class:"mt-2"},Ya={key:2,class:"alert alert-warning"},Ta={class:"mb-0"},Ca={class:"row"},Ua={class:"col-12 d-flex justify-content-between"},Ba={class:"d-flex gap-2"},Ga=["disabled","title"],La={key:0,class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",style:{"font-size":"0.6em"},title:"Ungespeicherte √Ñnderungen"},Ka=["disabled","title"],Ra={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},ja={key:1,class:"alert alert-warning mt-2 mb-0"},qa=["value"],Wa={key:2,class:"alert alert-warning mt-2 mb-0"},Ha=Ne({__name:"AnonymizationValidationComponent",props:{fileId:{},mediaType:{}},setup(ae){const u=wt(),a=vt(),f=yt(),s=mt(),V=Oe(),x=_t(),S=ft(),b=y(()=>x.isPdf),h=y(()=>x.isVideo);function N(){const n=Number(sessionStorage.getItem("last:fileId")||""),t=sessionStorage.getItem("last:scope");return{fileId:Number.isFinite(n)?n:void 0,scope:t||void 0}}const P=ae;let I=Number(P.fileId||S.query.fileId),M=P.mediaType||S.query.mediaType;if(console.log("fileid and scope",I,M),!Number.isFinite(I)||!M){const n=N();n.fileId!==void 0&&(I=n.fileId),n.scope&&(M=n.scope)}!Number.isFinite(I)||!M?console.error("Validation view: cannot determine fileId/scope; aborting mediaStore init.",{fileId:I,scope:M}):x.setCurrentByKey(M,I);const F=[{text:"Video",value:"video"},{text:"PDF",value:"pdf"}],Q=g(""),se=y(()=>!b.value&&!h.value);_e(Q,n=>{!n||!o.value||(x.rememberType(o.value.id,n,n),x.setCurrentByKey(n,o.value.id))});const R=g(""),A=g(""),ie=g(!1),l=g({patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:"",externalId:"",externalIdOrigin:"",centerName:"",text:"",anonymizedText:"",examinersDisplay:"",examinationDate:""}),G=g([]),j=g(""),q=g(""),T=g(""),C=g(""),W=g(!1),E=g(!1),w=g(null),O=g(0),v=g(0),p=g(""),D=g(""),le=g(!1),Ee=g(!1),ve=g({anonymizedText:"",examinationDate:"",patient:{patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:""}});function Pe(n,t){return n.patientFirstName===t.patientFirstName&&n.patientLastName===t.patientLastName&&n.patientGenderName===t.patientGenderName&&n.patientDob===t.patientDob&&n.casenumber===t.casenumber}function Me(n){return{patient_first_name:l.value.patientFirstName||"",patient_last_name:l.value.patientLastName||"",patient_gender:l.value.patientGenderName||"",patient_dob:n,casenumber:l.value.casenumber||""}}const oe=y(()=>l.value.patientFirstName.trim().length>0),re=y(()=>l.value.patientLastName.trim().length>0),H=y(()=>k.toISO(l.value.patientDob)),X=y(()=>k.toISO(A.value)),Ye=y(()=>{const n=G.value.length;return n===0?"Alle Felder sind g√ºltig":n===1?"1 Validierungsfehler gefunden":`${n} Validierungsfehler gefunden`}),de=y(()=>!!H.value),ue=y(()=>X.value?H.value?k.isAfterOrEqual(X.value,H.value):!1:!0),me=y(()=>oe.value&&re.value&&de.value&&ue.value),Te=y(()=>me.value),be=y(()=>!(!me.value||h.value&&E.value)),fe=y(()=>{if(!me.value){const n=[];return oe.value||n.push("Vorname"),re.value||n.push("Nachname"),de.value||n.push("g√ºltiges Geburtsdatum"),ue.value||n.push("g√ºltiges Untersuchungsdatum"),`Bitte korrigieren Sie: ${n.join(", ")}`}return h.value&&E.value?`Bitte validieren Sie zuerst alle Outside-Segmente (${v.value-O.value} verbleibend)`:""}),we=y(()=>v.value===0?0:Math.round(O.value/v.value*100)),o=y(()=>s.current),he=y(()=>!h.value||!o.value?void 0:`${window.location.origin}/api/media/videos/${I}/?type=raw`),ye=y(()=>!h.value||!o.value?void 0:`${window.location.origin}/api/media/videos/${I}/?type=processed`),ee=y(()=>!b.value||!o.value?void 0:`${window.location.origin}/api/media/pdfs/${I}/stream/?type=raw`),Z=y(()=>!b.value||!o.value?void 0:`${window.location.origin}/api/media/pdfs/${I}/stream/?type=processed`),U=g(null),B=g(null),Ce=n=>{console.error("Raw video error:",n)},Ue=()=>{console.log("Raw video load started")},Be=()=>{console.log("Raw video can play")},Ge=n=>{console.error("Anonymized video error:",n)},Le=()=>{console.log("Anonymized video load started")},Ke=()=>{console.log("Anonymized video can play")},Se=(n,t)=>{if(!U.value||!B.value)return;const $=n==="raw"?U.value:B.value,c=n==="raw"?B.value:U.value;Math.abs($.currentTime-c.currentTime)>.5&&(c.currentTime=$.currentTime)},Re=()=>{if(!U.value||!B.value)return;const n=(U.value.currentTime+B.value.currentTime)/2;U.value.currentTime=n,B.value.currentTime=n,console.log("Videos synchronized to time:",n)},je=()=>{U.value&&U.value.pause(),B.value&&B.value.pause(),console.log("All videos paused")},qe=()=>{if(!ee.value){a.warning({text:"Original-PDF nicht verf√ºgbar."});return}window.open(ee.value,"_blank"),console.log("Downloading raw PDF:",ee.value)},We=()=>{if(!Z.value){a.warning({text:"Anonymisiertes PDF nicht verf√ºgbar."});return}window.open(Z.value,"_blank"),console.log("Downloading anonymized PDF:",Z.value)},He=async()=>{if(!o.value||!h.value){a.warning({text:"Kein Video zur Validierung ausgew√§hlt."});return}W.value=!0,E.value=!1,w.value=null;try{console.log(`üîç Validating video ${o.value.id} for segment annotation...`);const t=(await ne.get(ce(`media/videos/${o.value.id}/validation/segments/`))).data;if(console.log("Video validation response:",t),t.eligible){const c=(await ne.get(ce(`media/videos/${o.value.id}/segments/?label=outside`))).data;v.value=c.length,O.value=0,c.length>0?(E.value=!0,w.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Segmentvalidierung erforderlich",message:`${c.length} "Outside"-Segmente gefunden, die validiert werden m√ºssen.`,details:"Verwenden Sie die Timeline unten, um die Segmente zu √ºberpr√ºfen und zu best√§tigen."}):w.value={class:"alert-success",icon:"fas fa-check-circle",title:"Video bereit f√ºr Annotation",message:'Keine "Outside"-Segmente gefunden. Video ist bereit f√ºr die Segment-Annotation.',details:`Video ID: ${o.value.id} - Alle Validierungen bestanden.`}}else w.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Video nicht bereit",message:t.reasons?.join(", ")||"Video ist nicht f√ºr Segment-Annotation geeignet.",details:"√úberpr√ºfen Sie die Video-Verarbeitung und Metadaten-Extraktion."};a.info({text:`Video ${o.value.id} validiert`})}catch(n){console.error("Error validating video for segment annotation:",n);try{await V.fetchAllSegments(o.value.id);const t=V.allSegments.filter($=>$.label==="outside");v.value=t.length,O.value=0,t.length>0?(E.value=!0,w.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Outside-Segmente gefunden (Fallback)",message:`${t.length} "Outside"-Segmente zur Validierung gefunden.`,details:"Fallback-Validierung √ºber VideoStore. API-Endpoint nicht verf√ºgbar."}):w.value={class:"alert-info",icon:"fas fa-info-circle",title:"Fallback-Validierung",message:'Keine "Outside"-Segmente gefunden (√ºber VideoStore).',details:"API-Validierung fehlgeschlagen, Fallback verwendet."}}catch{w.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Validierung fehlgeschlagen",message:"Video konnte nicht f√ºr Segment-Annotation validiert werden.",details:n?.response?.data?.detail||n?.message||"Unbekannter Fehler"}}}finally{W.value=!1}},Ze=n=>{O.value++,console.log(`‚úÖ Segment ${n} validated. Progress: ${O.value}/${v.value}`),w.value&&(w.value.message=`Fortschritt: ${O.value}/${v.value} Outside-Segmente validiert.`)},Je=()=>{console.log("üéâ All outside segments validated!"),E.value=!1,w.value={class:"alert-success",icon:"fas fa-check-circle",title:"Validierung abgeschlossen",message:"Alle Outside-Segmente wurden erfolgreich validiert.",details:`Video ${o.value?.id} ist jetzt bereit f√ºr die vollst√§ndige Segment-Annotation.`},a.success({text:"Outside-Segment Validierung abgeschlossen!"})};function Qe(n){return n==null?"unknown":["male","m√§nnlich","m"].includes(n)?"male":["female","weiblich","f","w"].includes(n)?"female":["other","divers","d"].includes(n)?"unknown":n}function De(n){if(!n)return;E.value=!1,w.value=null,O.value=0,v.value=0,W.value=!1;const t=n.examinationDate||"",$=n.patientDobDisplay||n.patientDob;A.value=k.toISO(t)||"";const c=Qe(n.patientGenderName);l.value={patientFirstName:n.patientFirstName||"",patientLastName:n.patientLastName||"",patientGenderName:c||"",patientDob:k.toISO($)||"",casenumber:n.casenumber||"",externalId:n.externalId??"",externalIdOrigin:n.externalIdOrigin??"",centerName:n.centerName??"",text:n.text??"",anonymizedText:n.anonymizedText??"",examinersDisplay:n.examinersDisplay??"",examinationDate:A.value},ve.value={anonymizedText:l.value.anonymizedText??"",examinationDate:A.value,patient:{...l.value}},sessionStorage.setItem("last:fileId",String(n.id))}_e(o,n=>{n&&De(n)},{immediate:!0});const ge=async()=>{try{await s.fetchNext()}catch(n){console.error("Error fetching next item:",n)}},Xe=y(()=>R.value!==ve.value.anonymizedText||A.value!==ve.value.examinationDate||!Pe(l.value,ve.value.patient)),et=y(()=>o.value&&!te.value&&!L.value),te=g(!1),L=g(!1),tt=()=>{le.value=!le.value};function ke(){const n=new Lt;if(G.value=[],j.value="",q.value="",l.value.patientDob){const t=l.value.patientDob;k.validate(t,"ISO")?T.value="ISO (YYYY-MM-DD)":k.validate(t,"German")?T.value="Deutsch (DD.MM.YYYY)":(T.value="",j.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",n.addField("Geburtsdatum",t,"German"))}else T.value="";if(A.value){const t=A.value;k.validate(t,"ISO")?C.value="ISO (YYYY-MM-DD)":k.validate(t,"German")?C.value="Deutsch (DD.MM.YYYY)":(C.value="",q.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",n.addField("Untersuchungsdatum",t,"ISO"))}else C.value="";H.value&&X.value&&n.addConstraint("DOB_BEFORE_EXAM",k.isBeforeOrEqual(H.value,X.value),"Geburtsdatum muss vor oder am selben Tag wie das Untersuchungsdatum liegen"),n.hasErrors()&&(G.value=n.getErrors(),n.getErrors().forEach($=>{$.includes("Geburtsdatum")&&(j.value=$.replace("Geburtsdatum: ","")),$.includes("Untersuchungsdatum")&&(q.value=$.replace("Untersuchungsdatum: ",""))}))}function nt(){const n=l.value.patientDob;if(!n)return;const t=k.toISO(n);t&&(l.value.patientDob=t,T.value="ISO (YYYY-MM-DD)"),ke()}function at(){const n=A.value;if(!n)return;const t=k.toISO(n);t&&(A.value=t,C.value="ISO (YYYY-MM-DD)"),ke()}function st(){G.value=[],j.value="",q.value=""}const it=async()=>{o.value&&await ge()},lt=()=>{if(!o.value){a.error({text:"Kein Video zur Segmentierung ausgew√§hlt."});return}f.push({name:"Video-Untersuchung",query:{video:o.value.id.toString()}}),console.log(`üéØ Navigating to Video-Untersuchung with video ID: ${o.value.id}`)},ot=async()=>{if(!(!o.value||!et.value||L.value)){if(!be.value){const n=fe.value;console.warn(`‚ùå Approval blocked: ${n}`),a.warning({text:n});return}if(h.value&&E.value){console.warn("‚ùå Outside segments still pending validation"),a.error({text:"Bitte validieren Sie zuerst alle Outside-Segmente, bevor Sie das Video best√§tigen."});return}L.value=!0;try{console.log(`Validating anonymization for file ${o.value.id}...`);try{await ne.post(ce(`anonymization/${o.value.id}/validate/`),{patient_first_name:l.value.patientFirstName,patient_last_name:l.value.patientLastName,patient_gender:l.value.patientGenderName,patient_dob:k.toGerman(H.value||"")||"",examination_date:k.toGerman(X.value||"")||"",casenumber:l.value.casenumber||"",anonymized_text:l.value.anonymizedText||void 0,text:l.value.text||void 0,is_verified:"true",file_type:b.value?"pdf":h.value?"video":"unknown",center_name:l.value.centerName||"",external_id:l.value.externalId||"",external_id_origin:l.value.externalIdOrigin||""}),console.log(`Anonymization validated successfully for file ${o.value.id}`),a.success({text:"Dokument best√§tigt und Anonymisierung validiert"})}catch(t){console.error("Error validating anonymization:",t),a.warning({text:"Dokument best√§tigt, aber Validierung fehlgeschlagen"})}const n=b.value?"pdf":h.value?"video":"unknown";if(n==="unknown"){a.error({text:"Bitte Medientyp ausw√§hlen, bevor best√§tigt wird."});return}u.validateAnonymizationSafeWithProtection(o.value.id,n),await lt()}catch(n){console.error("Error approving item:",n),a.error({text:"Fehler beim Best√§tigen des Elements"})}finally{L.value=!1}}},rt=async()=>{if(!te.value){if(!Te.value){if(!D.value||!p.value)a.error({text:"Bitte laden Sie zuerst Bilder hoch (Original und bearbeitetes Bild)."});else if(!me.value){const n=[];oe.value||n.push("Vorname"),re.value||n.push("Nachname"),de.value||n.push("g√ºltiges Geburtsdatum"),ue.value||n.push("g√ºltiges Untersuchungsdatum (darf nicht vor Geburtsdatum liegen)"),a.error({text:`Bitte korrigieren Sie: ${n.join(", ")}`})}return}te.value=!0;try{const n={processed_image_url:D.value,patient_data:Me(k.toGerman(H.value||"")||""),examinationDate:k.toGerman(X.value||"")||"",anonymized_text:R.value};if(o.value&&h.value)await ne.post(ce("save-anonymization-annotation-video/"),{...n,itemId:o.value.id});else if(o.value&&b.value)await ne.post(ce("save-anonymization-annotation-pdf/"),n);else{a.error({text:"Keine g√ºltige Anonymisierung zum Speichern gefunden."});return}p.value="",D.value="",Ee.value=!1,a.success({text:"Annotation erfolgreich gespeichert"})}catch(n){console.error("Error saving annotation:",n),a.error({text:"Fehler beim Speichern der Annotation"})}finally{te.value=!1}}},dt=async()=>{o.value&&await ge()},ut=async()=>{if(!o.value){a.error({text:"Kein Element zur Korrektur ausgew√§hlt."});return}try{f.push({name:"Anonymisierung Korrektur",params:{fileId:o.value.id.toString()}}),a.info({text:"√Ñnderungen gespeichert. Bitte w√§hlen Sie das Element erneut f√ºr die Korrektur aus."});return}catch{a.error({text:"Fehler beim Speichern. Korrektur-Navigation abgebrochen."});return}};return Ae(async()=>{Number.isFinite(I)&&M&&x.setCurrentByKey(M,I),s.current?De(s.current):await ge()}),gt(()=>{ge()}),(n,t)=>{const $=bt("router-link");return i(),d("div",Kt,[e("div",Rt,[t[69]||(t[69]=e("div",{class:"card-header pb-0"},[e("h4",{class:"mb-0"},"Anonymisierungsvalidierung und Annotationen")],-1)),e("div",jt,[J(s).loading?(i(),d("div",qt,[...t[16]||(t[16]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Wird geladen...")],-1),e("p",{class:"mt-2"},"Anonymisierte Daten werden geladen...",-1)])])):J(s).error?(i(),d("div",Wt,[t[17]||(t[17]=e("strong",null,"Fehler:",-1)),m(" "+r(J(s).error),1)])):o.value?_("",!0):(i(),d("div",{key:2,class:"alert alert-info",role:"alert",onLoadstart:t[0]||(t[0]=c=>J(s).fetchNext())}," Alle Anonymisierungen wurden bearbeitet. ",32)),J(s).isAnyFileProcessing?(i(),d("div",Ht,[t[19]||(t[19]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("strong",null,r(J(s).processingFiles.length)+" Datei(en)",1),t[20]||(t[20]=m(" werden gerade anonymisiert. ",-1)),e("div",Zt,[Ie($,{to:"/anonymisierung/uebersicht",class:"btn btn-sm btn-outline-primary"},{default:pt(()=>[...t[18]||(t[18]=[e("i",{class:"fas fa-eye me-1"},null,-1),m(" Zur √úbersicht ",-1)])]),_:1})])])):_("",!0)]),o.value?(i(),d(pe,{key:0},[e("div",Jt,[e("div",Qt,[e("div",Xt,[e("div",null,[t[22]||(t[22]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("span",null,[t[21]||(t[21]=e("strong",null,"Validierung:",-1)),m(" "+r(b.value?"PDF-Dokument":h.value?"Video-Datei":"Unbekanntes Format")+" "+r(o.value?.centerName?`- ${o.value.centerName}`:""),1)])]),o.value&&(h.value||b.value)?(i(),d("div",en,[e("small",tn,[t[23]||(t[23]=e("i",{class:"fas fa-tools me-1"},null,-1)),m(" "+r(h.value?"Video-Korrektur verf√ºgbar":"Text-Korrektur verf√ºgbar"),1)])])):_("",!0)])])]),e("div",nn,[e("div",an,[e("div",sn,[z(e("input",{type:"checkbox",class:"form-check-input",id:"noMoreNames","onUpdate:modelValue":t[1]||(t[1]=c=>ie.value=c)},null,512),[[ht,ie.value]]),t[24]||(t[24]=e("label",{class:"form-check-label",for:"noMoreNames"}," Keine weiteren Namen im Video oder PDF vorhanden ",-1))])])]),G.value.length>0?(i(),d("div",ln,[e("div",on,[e("div",rn,[e("h6",dn,[t[25]||(t[25]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" "+r(Ye.value),1)]),t[26]||(t[26]=e("hr",null,null,-1)),e("ul",un,[(i(!0),d(pe,null,xe(G.value,(c,Ve)=>(i(),d("li",{key:Ve},r(c),1))),128))]),e("button",{type:"button",class:"btn-close",onClick:st,"aria-label":"Schlie√üen"})])])])):_("",!0),e("div",cn,[e("div",vn,[e("div",mn,[e("div",fn,[t[41]||(t[41]=e("h5",{class:"card-title"},"Patienteninformationen",-1)),e("div",gn,[t[27]||(t[27]=e("label",{class:"form-label"},"Vorname:",-1)),z(e("input",{type:"text",class:K(["form-control",{"is-invalid":!oe.value}]),"onUpdate:modelValue":t[2]||(t[2]=c=>l.value.patientFirstName=c)},null,2),[[Y,l.value.patientFirstName]]),oe.value?_("",!0):(i(),d("div",pn," Vorname ist erforderlich. "))]),e("div",bn,[t[28]||(t[28]=e("label",{class:"form-label"},"Nachname:",-1)),z(e("input",{type:"text",class:K(["form-control",{"is-invalid":!re.value}]),"onUpdate:modelValue":t[3]||(t[3]=c=>l.value.patientLastName=c)},null,2),[[Y,l.value.patientLastName]]),re.value?_("",!0):(i(),d("div",hn," Nachname ist erforderlich. "))]),e("div",yn,[t[30]||(t[30]=e("label",{class:"form-label"},"Geschlecht:",-1)),z(e("select",{class:"form-select","onUpdate:modelValue":t[4]||(t[4]=c=>l.value.patientGenderName=c)},[...t[29]||(t[29]=[e("option",{value:"male"},"M√§nnlich",-1),e("option",{value:"female"},"Weiblich",-1),e("option",{value:"unknown"},"Divers",-1)])],512),[[$e,l.value.patientGenderName]])]),e("div",_n,[t[32]||(t[32]=e("label",{class:"form-label"},"Geburtsdatum:",-1)),z(e("input",{type:"date",class:K(["form-control",{"is-invalid":!de.value}]),"onUpdate:modelValue":t[5]||(t[5]=c=>l.value.patientDob=c),onBlur:nt},null,34),[[Y,l.value.patientDob]]),e("small",xn,[t[31]||(t[31]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),T.value?(i(),d("span",wn,r(T.value),1)):_("",!0)]),de.value?_("",!0):(i(),d("div",Sn,r(j.value||"G√ºltiges Geburtsdatum ist erforderlich."),1))]),e("div",Dn,[t[33]||(t[33]=e("label",{class:"form-label"},"Fallnummer:",-1)),z(e("input",{type:"text",class:"form-control","onUpdate:modelValue":t[6]||(t[6]=c=>l.value.casenumber=c)},null,512),[[Y,l.value.casenumber]])]),e("div",kn,[t[35]||(t[35]=e("label",{class:"form-label"},"Untersuchungsdatum:",-1)),z(e("input",{type:"date",class:K(["form-control",{"is-invalid":!ue.value}]),"onUpdate:modelValue":t[7]||(t[7]=c=>A.value=c),onBlur:at},null,34),[[Y,A.value]]),e("small",Vn,[t[34]||(t[34]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),C.value?(i(),d("span",In,r(C.value),1)):_("",!0)]),ue.value?_("",!0):(i(),d("div",$n,r(q.value||"Das Untersuchungsdatum darf nicht vor dem Geburtsdatum liegen."),1))]),e("div",Nn,[t[36]||(t[36]=e("label",{class:"form-label"},"Anonymisierter Text:",-1)),z(e("textarea",{class:"form-control",rows:"6","onUpdate:modelValue":t[8]||(t[8]=c=>R.value=c)},null,512),[[Y,R.value]])]),e("div",An,[t[37]||(t[37]=e("label",{class:"form-label"},"Externe ID:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[9]||(t[9]=c=>l.value.externalId=c)},null,512),[[Y,l.value.externalId]])]),e("div",zn,[t[38]||(t[38]=e("label",{class:"form-label"},"Untersucher:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[10]||(t[10]=c=>l.value.examinersDisplay=c)},null,512),[[Y,l.value.examinersDisplay]])]),e("div",Fn,[t[39]||(t[39]=e("label",{class:"form-label"},"Quelle der Daten:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[11]||(t[11]=c=>l.value.externalIdOrigin=c)},"                    ",512),[[Y,l.value.externalIdOrigin]])]),e("div",On,[t[40]||(t[40]=e("label",{class:"form-label"},"Zentrum:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[12]||(t[12]=c=>l.value.centerName=c)},"                    ",512),[[Y,l.value.centerName]])])]),e("div",En,[e("div",Pn,[t[42]||(t[42]=e("h5",{class:"card-title"},"Annotationen",-1)),D.value?(i(),d("div",Mn,[e("img",{src:le.value?p.value:D.value,class:"img-fluid",alt:"Uploaded Image"},null,8,Yn),e("button",{class:"btn btn-info btn-sm mt-2",onClick:tt},r(le.value?"Bearbeitetes Bild anzeigen":"Original anzeigen"),1)])):_("",!0),e("div",Tn,[e("button",{class:"btn btn-primary",onClick:rt},[te.value?(i(),d("span",Cn)):_("",!0),m(" "+r(te.value?"Speichern...":"Annotation zwischenspeichern"),1)])])])])])]),e("div",Un,[e("div",Bn,[e("div",Gn,[e("h5",Ln,r(b.value?"PDF Vorschau":"Video Vorschau"),1),e("div",Kn,[t[43]||(t[43]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),t[44]||(t[44]=e("strong",null,"Datenformat:",-1)),b.value?(i(),d("span",Rn," PDF-Dokument ("+r(Math.round((Z.value?.length||0)/1024)||"Nicht Verf√ºgbar")+" KB) ",1)):h.value?(i(),d("span",jn," Video-Datei (Raw: "+r(he.value||"N/A")+" | Anonymized: "+r(ye.value||"N/A")+") ",1)):(i(),d("span",qn," Unbekanntes Format - ID: "+r(o.value?.id),1))])]),e("div",Wn,[b.value?(i(),d("div",Hn,[e("div",Zn,[e("div",Jn,[e("div",Qn,[t[47]||(t[47]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-file-pdf me-1"}),m(" Original PDF (Raw) ")],-1)),e("iframe",{src:ee.value,width:"100%",height:"700px",frameborder:"0",title:"Original PDF Vorschau"},[t[45]||(t[45]=m(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:ee.value},"hier herunterladen",8,ea),t[46]||(t[46]=m(". ",-1))],8,Xn),e("div",ta,[e("small",na," URL: "+r(ee.value||"Nicht verf√ºgbar"),1)])])]),e("div",aa,[e("div",sa,[t[50]||(t[50]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes PDF (Processed) ")],-1)),e("iframe",{src:Z.value,width:"100%",height:"700px",frameborder:"0",title:"Anonymisiertes PDF Vorschau"},[t[48]||(t[48]=m(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:Z.value},"hier herunterladen",8,la),t[49]||(t[49]=m(". ",-1))],8,ia),e("div",oa,[e("small",ra," URL: "+r(Z.value||"Nicht verf√ºgbar"),1)])])])]),e("div",{class:"pdf-controls mt-3 text-center"},[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:qe},[...t[51]||(t[51]=[e("i",{class:"fas fa-download me-1"},null,-1),m(" Original herunterladen ",-1)])]),e("button",{class:"btn btn-outline-success btn-sm",onClick:We},[...t[52]||(t[52]=[e("i",{class:"fas fa-download me-1"},null,-1),m(" Anonymisiert herunterladen ",-1)])])])])):h.value?(i(),d("div",da,[e("div",ua,[e("div",ca,[e("div",va,[t[53]||(t[53]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-eye me-1"}),m(" Original Video (Raw) ")],-1)),e("video",{ref_key:"rawVideoElement",ref:U,src:he.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ce,onLoadstart:Ue,onCanplay:Be,onTimeupdate:t[13]||(t[13]=c=>Se("raw"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,ma),e("div",fa,[e("small",ga," URL: "+r(he.value||"Nicht verf√ºgbar"),1)])])]),e("div",pa,[e("div",ba,[t[54]||(t[54]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes Video (Processed) ")],-1)),e("video",{ref_key:"anonymizedVideoElement",ref:B,src:ye.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ge,onLoadstart:Le,onCanplay:Ke,onTimeupdate:t[14]||(t[14]=c=>Se("anonymized"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,ha),e("div",ya,[e("small",_a," URL: "+r(ye.value||"Nicht verf√ºgbar"),1)])])])]),e("div",xa,[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Re},[...t[55]||(t[55]=[e("i",{class:"fas fa-sync me-1"},null,-1),m(" Videos synchronisieren ",-1)])]),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:je},[...t[56]||(t[56]=[e("i",{class:"fas fa-pause me-1"},null,-1),m(" Alle pausieren ",-1)])]),e("button",{class:"btn btn-outline-info btn-sm ms-2",onClick:He,disabled:W.value},[W.value?(i(),d("span",Sa)):(i(),d("i",Da)),t[57]||(t[57]=m(" Segment-Annotation pr√ºfen ",-1))],8,wa)]),E.value&&o.value?(i(),d("div",ka,[e("div",Va,[e("div",Ia,[e("div",$a,[e("div",null,[e("h6",Na,[t[58]||(t[58]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" Segmente zur Entfernung - Video ID: "+r(o.value.id),1)]),t[59]||(t[59]=e("small",{class:"text-muted"},' Diese Segmente wurden als "outside" klassifiziert und sollten aus dem Video entfernt werden. ',-1))]),e("div",Aa,[e("div",za,r(O.value)+" / "+r(v.value),1),e("div",Fa,[e("div",{class:"progress-bar bg-success",role:"progressbar",style:ze({width:we.value+"%"}),"aria-valuenow":O.value,"aria-valuemin":0,"aria-valuemax":v.value},null,12,Oa)]),e("small",Ea,r(we.value)+"% validiert",1)])])]),e("div",Pa,[Ie(Gt,{videoId:o.value.id,onSegmentValidated:Ze,onValidationComplete:Je},null,8,["videoId"])])])])):_("",!0),w.value?(i(),d("div",{key:1,class:K(["alert mt-3",w.value.class])},[e("i",{class:K([w.value.icon,"me-2"])},null,2),e("strong",null,r(w.value.title)+":",1),m(" "+r(w.value.message)+" ",1),w.value.details?(i(),d("div",Ma,[e("small",null,r(w.value.details),1)])):_("",!0)],2)):_("",!0)])):(i(),d("div",Ya,[t[64]||(t[64]=e("h6",null,"Debug-Informationen:",-1)),e("ul",Ta,[e("li",null,[t[60]||(t[60]=e("strong",null,"Current Item ID:",-1)),m(" "+r(o.value?.id||"Nicht verf√ºgbar"),1)]),e("li",null,[t[61]||(t[61]=e("strong",null,"Is PDF:",-1)),m(" "+r(b.value),1)]),e("li",null,[t[62]||(t[62]=e("strong",null,"Is Video:",-1)),m(" "+r(h.value),1)]),e("li",null,[t[63]||(t[63]=e("strong",null,"Detected Media Type:",-1)),m(" "+r(o.value?J(x).detectMediaType(o.value):"N/A"),1)])])]))])])])]),e("div",Ca,[e("div",Ua,[e("button",{class:"btn btn-secondary",onClick:it}," √úberspringen "),e("div",Ba,[o.value&&(h.value||b.value)?(i(),d("button",{key:0,class:"btn btn-warning position-relative",onClick:ut,disabled:L.value,title:h.value?"Video-Korrektur: Maskierung, Frame-Entfernung, etc.":"PDF-Korrektur: Text-Annotation anpassen"},[t[65]||(t[65]=e("i",{class:"fas fa-edit me-1"},null,-1)),m(" "+r(h.value?"Video-Korrektur":"PDF-Korrektur")+" ",1),Xe.value?(i(),d("span",La," ! ")):_("",!0)],8,Ga)):_("",!0),e("button",{class:"btn btn-danger me-2",onClick:dt}," Ablehnen "),e("button",{class:"btn btn-success",onClick:ot,disabled:L.value||!be.value,title:fe.value},[L.value?(i(),d("span",Ra)):_("",!0),m(" "+r(L.value?"Wird best√§tigt...":"Best√§tigen"),1)],8,Ka),se.value?(i(),d("div",ja,[t[66]||(t[66]=e("strong",null," Bitte hier den Medientyp eingeben - Der mediaStore hat einen Fehler ",-1)),z(e("select",{"onUpdate:modelValue":t[15]||(t[15]=c=>Q.value=c)},[(i(),d(pe,null,xe(F,c=>e("option",{value:c.value},r(c.text),9,qa)),64))],512),[[$e,Q.value]])])):_("",!0),!be.value&&fe.value?(i(),d("div",Wa,[t[67]||(t[67]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[68]||(t[68]=e("strong",null,"Best√§tigung blockiert:",-1)),m(" "+r(fe.value),1)])):_("",!0)])])])],64)):_("",!0)])])}}}),ts=Fe(Ha,[["__scopeId","data-v-46a27823"]]);export{ts as default};
