import{M as Qe,h as f,e as y,d as _e,i as ke,w as De,c as u,j as x,a as e,x as et,p as xe,C as J,t as r,k as m,F as me,m as Ve,o,z as te,_ as $e,f as tt,g as at,K as nt,n as W,b as Se,D as st,r as it,l as X,I as lt,H as ee,v as rt,A as se,y as ot}from"./main.js";import{u as Me}from"./videoStore.js";import{u as ut}from"./patientStore.js";import{u as dt}from"./mediaTypeStore.js";import{T as ct}from"./Timeline.js";import{u as vt}from"./usePollingProtection.js";const mt=Qe("pdf",()=>{const w=f(null),i=f(!1),n=f(null),v=f(!1),l=f(null),F=y(()=>w.value!==null),$=y(()=>w.value?.status==="processing"),S=y(()=>w.value?.status==="done"),k=y(()=>n.value!==null||w.value?.error===!0),V=y(()=>w.value?.pdfStreamUrl?w.value.pdfStreamUrl:null);function I(g){return`/api/media/pdfs/${g}/stream`}async function c(g){i.value=!0,n.value=null;try{const d=await fetch("/api/anonymization/items/overview/");if(!d.ok)throw new Error(`Failed to fetch overview: ${d.status}`);const P=(await d.json()).pdfs?.filter(j=>j.status==="pending_validation"||j.status==="not_started")||[];if(P.length===0){w.value=null,l.value=null;return}let O;if(g){const j=P.findIndex(q=>q.id===g);O=P[j+1]||P[0]}else O=P[0];w.value=O,l.value=O.id,O.id&&w.value&&(w.value.pdfStreamUrl=I(O.id),v.value=!0)}catch(d){n.value=d instanceof Error?d.message:"Unknown error occurred",console.error("Error fetching next PDF:",d)}finally{i.value=!1}}async function G(g,d){if(!w.value)throw new Error("No current PDF to update");i.value=!0,n.value=null;try{const D=await fetch(`/api/media/pdfs/${g}/sensitive-metadata/`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":_()},body:JSON.stringify(d)});if(!D.ok)throw new Error(`Failed to update sensitive metadata: ${D.status}`);const P=await D.json();w.value.reportMeta&&(w.value.reportMeta={...w.value.reportMeta,...P})}catch(D){throw n.value=D instanceof Error?D.message:"Unknown error occurred",console.error("Error updating sensitive metadata:",D),D}finally{i.value=!1}}async function L(g,d){if(!w.value)throw new Error("No current PDF to update");i.value=!0,n.value=null;try{const D=await fetch(`/api/media/pdfs/${g}/sensitive-metadata/`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":_()},body:JSON.stringify({anonymized_text:d})});if(!D.ok)throw new Error(`Failed to update anonymized text: ${D.status}`);w.value.anonymizedText=d,w.value.status="done"}catch(D){throw n.value=D instanceof Error?D.message:"Unknown error occurred",console.error("Error updating anonymized text:",D),D}finally{i.value=!1}}async function M(){if(!w.value)throw new Error("No current PDF to approve");const g=w.value.id;i.value=!0,n.value=null;try{const d=await fetch(`/api/anonymization/${g}/validate/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":_()},body:JSON.stringify({validation_status:"approved"})});if(!d.ok)throw new Error(`Failed to approve PDF: ${d.status}`);l.value=g,await c(g)}catch(d){throw n.value=d instanceof Error?d.message:"Unknown error occurred",console.error("Error approving PDF:",d),d}finally{i.value=!1}}async function T(){if(!w.value)throw new Error("No current PDF to skip");const g=w.value.id;l.value=g,await c(g)}async function N(g){try{const d=await fetch(`/api/anonymization/${g}/status/`);if(!d.ok)throw new Error(`Failed to check status: ${d.status}`);return await d.json()}catch(d){throw n.value=d instanceof Error?d.message:"Unknown error occurred",console.error("Error checking anonymization status:",d),d}}function B(){v.value=!1}function U(){w.value=null,i.value=!1,n.value=null,v.value=!1,l.value=null}function _(){const g=document.querySelector("[name=csrfmiddlewaretoken]")?.getAttribute("value");if(!g)throw new Error("CSRF token not found");return g}return{currentPdf:w,loading:i,error:n,streamingActive:v,lastProcessedId:l,hasCurrentPdf:F,isProcessing:$,isDone:S,hasError:k,pdfStreamUrl:V,buildPdfStreamUrl:I,fetchNextPdf:c,updateSensitiveMeta:G,updateAnonymizedText:L,approvePdf:M,skipPdf:T,checkAnonymizationStatus:N,stopStreaming:B,clearState:U}}),ft={class:"video-with-outside-timeline"},gt={key:0,class:"validation-status mb-3"},pt={class:"row align-items-center"},bt={class:"col-md-8"},ht={class:"progress"},yt={class:"col-md-4 text-end"},wt=["disabled"],St={key:0,class:"spinner-border spinner-border-sm me-1"},_t={key:1,class:"fas fa-check-double me-1"},kt=["disabled"],Dt=["src"],xt={key:1,class:"segments-overview mb-3"},Vt={class:"segments-list"},$t={class:"ms-2 text-muted"},Mt={class:"ms-2 badge bg-secondary"},Et=["onClick","disabled"],At={key:1,class:"text-success"},Ft={key:2,class:"alert alert-info"},It=_e({__name:"OutsideSegmentComponent",props:{videoId:{}},emits:["segment-validated","validation-complete"],setup(w,{emit:i}){const n=w,v=i,l=f(null),F=f(""),$=f(0),S=f(0),k=f(!1),V=Me(),I=f(new Set),c=f(!1);async function G(h){const{data:p}=await te.get(`/api/media/videos/${h}/`);F.value=p.video_url,$.value=Number(p.duration??0)}async function L(h){await V.fetchAllSegments(h)}const M=y(()=>(V.allSegments??[]).filter(p=>(p.label??"").toLowerCase()==="outside").map(p=>({...p}))),T=y(()=>M.value.filter(h=>!I.value.has(h.id))),N=y(()=>M.value.length>0&&T.value.length===0);async function B(h){if(!(I.value.has(h.id)||c.value)){c.value=!0;try{I.value.add(h.id),v("segment-validated",h.id),console.log(`‚úÖ Segment ${h.id} validated`),N.value&&(v("validation-complete"),console.log("üéâ All outside segments validated!"))}catch(p){console.error("Error validating segment:",p),I.value.delete(h.id)}finally{c.value=!1}}}async function U(){for(const h of T.value)await B(h)}function _(){I.value.clear()}function g(h){const p=Math.floor(h/60),E=Math.floor(h%60);return`${p.toString().padStart(2,"0")}:${E.toString().padStart(2,"0")}`}ke(()=>{l.value&&(l.value.addEventListener("loadedmetadata",()=>{!$.value&&l.value&&($.value=l.value.duration||0)}),l.value.addEventListener("timeupdate",()=>{l.value&&(S.value=l.value.currentTime)}),l.value.addEventListener("play",()=>{k.value=!0}),l.value.addEventListener("pause",()=>{k.value=!1}))}),De(()=>n.videoId,async h=>{_(),await Promise.all([G(h),L(h)])},{immediate:!0});function d(...h){const[p]=h;l.value&&Number.isFinite(p)&&(l.value.currentTime=p),S.value=p}function D(){l.value&&(l.value.paused?l.value.play().catch(()=>{}):l.value.pause(),k.value=!l.value.paused)}function P(){}function O(){}function j(){}function q(){}function oe(){}function ue(){}function Z(){}return(h,p)=>(o(),u("div",ft,[M.value.length>0?(o(),u("div",gt,[e("div",pt,[e("div",bt,[e("div",ht,[e("div",{class:J(["progress-bar",N.value?"bg-success":"bg-warning"]),style:xe(`width: ${I.value.size/M.value.length*100}%`)},r(I.value.size)+" / "+r(M.value.length)+" validiert ",7)])]),e("div",yt,[e("button",{class:"btn btn-sm btn-success me-2",onClick:U,disabled:c.value||N.value},[c.value?(o(),u("span",St)):(o(),u("i",_t)),p[0]||(p[0]=m(" Alle validieren ",-1))],8,wt),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:_,disabled:c.value||I.value.size===0},[...p[1]||(p[1]=[e("i",{class:"fas fa-redo me-1"},null,-1),m(" Zur√ºcksetzen ",-1)])],8,kt)])])])):x("",!0),e("video",{ref_key:"videoEl",ref:l,src:F.value,controls:"",style:{width:"100%","max-height":"480px"}},null,8,Dt),M.value.length>0?(o(),u("div",xt,[e("h6",null,"Outside-Segmente ("+r(M.value.length)+")",1),e("div",Vt,[(o(!0),u(me,null,Ve(M.value,E=>(o(),u("div",{key:E.id,class:J(["segment-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded",{"border-success bg-success bg-opacity-10":I.value.has(E.id),"border-warning bg-warning bg-opacity-10":!I.value.has(E.id)}])},[e("div",null,[e("strong",null,"Segment "+r(E.id),1),e("span",$t,r(g(E.startTime))+" - "+r(g(E.endTime)),1),e("span",Mt,r(E.label),1)]),e("div",null,[I.value.has(E.id)?(o(),u("span",At,[...p[3]||(p[3]=[e("i",{class:"fas fa-check-circle me-1"},null,-1),m(" Validiert ",-1)])])):(o(),u("button",{key:0,class:"btn btn-sm btn-outline-success",onClick:fe=>B(E),disabled:c.value},[...p[2]||(p[2]=[e("i",{class:"fas fa-check me-1"},null,-1),m(" Validieren ",-1)])],8,Et))])],2))),128))])])):(o(),u("div",Ft,[p[4]||(p[4]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),m(' Keine "Outside"-Segmente f√ºr Video '+r(n.videoId)+" gefunden. ",1)])),M.value.length>0?(o(),et(ct,{key:3,video:{duration:$.value},segments:M.value,"current-time":S.value,"is-playing":k.value,"selection-mode":!1,onSeek:d,onPlayPause:D,onSegmentCreate:P,onSegmentResize:O,onSegmentMove:j,onTimeSelection:q,onSegmentSelect:oe,onSegmentEdit:ue,onSegmentDelete:Z},null,8,["video","segments","current-time","is-playing"])):x("",!0)]))}}),zt=$e(It,[["__scopeId","data-v-f646399d"]]);class z{static toISO(i){if(!i)return null;const n=i.trim().split(" ")[0],l=/^(\d{4})-(\d{2})-(\d{2})$/.exec(n);if(l){const[,S,k,V]=l;return this._isValidDate(parseInt(S),parseInt(k),parseInt(V))?n:null}const $=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(n);if($){const[,S,k,V]=$;return this._isValidDate(parseInt(V),parseInt(k),parseInt(S))?`${V}-${k}-${S}`:null}return null}static toGerman(i){if(!i)return"";const n=i.trim(),l=/^(\d{4})-(\d{2})-(\d{2})$/.exec(n);if(!l)return"";const[,F,$,S]=l;return this._isValidDate(parseInt(F),parseInt($),parseInt(S))?`${S}.${$}.${F}`:""}static validate(i,n){if(!i)return!1;const v=i.trim();if(n==="ISO"){const F=/^(\d{4})-(\d{2})-(\d{2})$/.exec(v);if(!F)return!1;const[,$,S,k]=F;return this._isValidDate(parseInt($),parseInt(S),parseInt(k))}if(n==="German"){const F=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(v);if(!F)return!1;const[,$,S,k]=F;return this._isValidDate(parseInt(k),parseInt(S),parseInt($))}return!1}static compare(i,n){if(!this.validate(i,"ISO")||!this.validate(n,"ISO"))return null;const v=new Date(i),l=new Date(n);return v<l?-1:v>l?1:0}static isBefore(i,n){return this.compare(i,n)===-1}static isAfter(i,n){return this.compare(i,n)===1}static isBeforeOrEqual(i,n){const v=this.compare(i,n);return v===-1||v===0}static isAfterOrEqual(i,n){const v=this.compare(i,n);return v===1||v===0}static today(){const i=new Date,n=i.getFullYear(),v=String(i.getMonth()+1).padStart(2,"0"),l=String(i.getDate()).padStart(2,"0");return`${n}-${v}-${l}`}static todayGerman(){return this.toGerman(this.today())}static _isValidDate(i,n,v){if(i<1900||i>2100||n<1||n>12||v<1||v>31)return!1;const l=new Date(i,n-1,v);return l.getFullYear()===i&&l.getMonth()===n-1&&l.getDate()===v}}class Pt{errors=new Map;addField(i,n,v){if(!n){this.errors.set(i,`${i}: Pflichtfeld (darf nicht leer sein)`);return}if(!z.validate(n,v)){const l=v==="ISO"?"YYYY-MM-DD":"DD.MM.YYYY";this.errors.set(i,`${i}: Ung√ºltiges Format (erwartet: ${l})`)}}addConstraint(i,n,v){n||this.errors.set(i,v)}hasErrors(){return this.errors.size>0}getErrors(){return Array.from(this.errors.values())}getSummary(){const i=this.errors.size;return i===0?"Alle Datumsfelder sind g√ºltig":i===1?"1 Datumsfehler gefunden":`${i} Datumsfehler gefunden`}clear(){this.errors.clear()}getErrorsAsHtml(){return this.errors.size===0?"":`<ul class="date-validation-errors">${this.getErrors().map(n=>`<li>${n}</li>`).join("")}</ul>`}}const Yt={class:"container-fluid py-4"},Nt={class:"card"},Ut={class:"card-body"},Ot={key:0,class:"text-center py-5"},Tt={key:1,class:"alert alert-danger",role:"alert"},Ct={key:3,class:"alert alert-warning mt-3"},Gt={class:"mt-2"},Bt={class:"row mb-3"},Lt={class:"col-12"},Rt={class:"alert alert-info d-flex align-items-center justify-content-between",role:"alert"},Kt={key:0,class:"text-end"},jt={class:"text-muted"},qt={class:"row mb-4"},Ht={class:"col-12"},Wt={class:"form-check"},Xt={key:0,class:"row mb-4"},Jt={class:"col-12"},Zt={class:"alert alert-danger alert-dismissible fade show",role:"alert"},Qt={class:"alert-heading"},ea={class:"mb-0"},ta={class:"row mb-4"},aa={class:"col-md-5"},na={class:"card bg-light mb-4"},sa={class:"card-body"},ia={class:"mb-3"},la={key:0,class:"invalid-feedback"},ra={class:"mb-3"},oa={key:0,class:"invalid-feedback"},ua={class:"mb-3"},da={class:"mb-3"},ca={class:"form-text text-muted"},va={key:0,class:"ms-2 badge bg-secondary"},ma={key:0,class:"invalid-feedback"},fa={class:"mb-3"},ga={class:"mb-3"},pa={class:"form-text text-muted"},ba={key:0,class:"ms-2 badge bg-secondary"},ha={key:0,class:"invalid-feedback"},ya={class:"mb-3"},wa={class:"card bg-light"},Sa={class:"card-body"},_a={key:0,class:"mt-3"},ka=["src"],Da={class:"mt-3"},xa={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},Va={class:"col-md-7"},$a={class:"card"},Ma={class:"card-header pb-0"},Ea={class:"mb-0"},Aa={class:"alert alert-info mt-2 mb-0"},Fa={key:0},Ia={key:1},za={key:2},Pa={class:"card-body media-viewer-container"},Ya=["src"],Na=["href"],Ua={key:1,class:"dual-video-container"},Oa={class:"row"},Ta={class:"col-md-6"},Ca={class:"video-section raw-video"},Ga=["src"],Ba={class:"mt-2 text-center"},La={class:"text-muted"},Ra={class:"col-md-6"},Ka={class:"video-section anonymized-video"},ja=["src"],qa={class:"mt-2 text-center"},Ha={class:"text-muted"},Wa={class:"video-controls mt-3 text-center"},Xa=["disabled"],Ja={key:0,class:"spinner-border spinner-border-sm me-1",role:"status"},Za={key:1,class:"fas fa-check me-1"},Qa={key:0,class:"outside-timeline-container mt-4"},en={class:"card border-warning"},tn={class:"card-header bg-warning bg-opacity-10"},an={class:"d-flex justify-content-between align-items-center"},nn={class:"mb-0 text-warning"},sn={class:"text-end"},ln={class:"badge bg-warning text-dark fs-6"},rn={class:"progress mt-2",style:{width:"200px",height:"8px"}},on=["aria-valuenow","aria-valuemax"],un={class:"text-muted"},dn={class:"card-body"},cn={key:0,class:"mt-2"},vn={key:2,class:"alert alert-warning"},mn={class:"mb-0"},fn={class:"row"},gn={class:"col-12 d-flex justify-content-between"},pn={class:"d-flex gap-2"},bn=["disabled","title"],hn={key:0,class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",style:{"font-size":"0.6em"},title:"Ungespeicherte √Ñnderungen"},yn=["disabled","title"],wn={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},Sn={key:1,class:"alert alert-warning mt-2 mb-0"},_n=_e({__name:"AnonymizationValidationComponent",setup(w){const i=vt(),n=tt(),v=ot(),l=at(),F=Me();ut();const $=mt(),S=dt(),k=f(""),V=f(""),I=f(!1),c=f({patientFirstName:"",patientLastName:"",patientGender:"",patientDob:"",casenumber:""}),G=f([]),L=f(""),M=f(""),T=f(""),N=f(""),B=f(!1),U=f(!1),_=f(null),g=f(0),d=f(0),D=f(""),P=f(""),O=f(!1),j=f(!1),q=f({anonymizedText:"",examinationDate:"",patient:{patientFirstName:"",patientLastName:"",patientGender:"",patientDob:"",casenumber:""}});function oe(a,t){return a.patientFirstName===t.patientFirstName&&a.patientLastName===t.patientLastName&&a.patientGender===t.patientGender&&a.patientDob===t.patientDob&&a.casenumber===t.casenumber}function ue(a){return{patient_first_name:c.value.patientFirstName||"",patient_last_name:c.value.patientLastName||"",patient_gender:c.value.patientGender||"",patient_dob:a,casenumber:c.value.casenumber||""}}const Z=y(()=>c.value.patientFirstName.trim().length>0),h=y(()=>c.value.patientLastName.trim().length>0),p=y(()=>z.toISO(c.value.patientDob)),E=y(()=>z.toISO(V.value)),fe=y(()=>{const a=G.value.length;return a===0?"Alle Felder sind g√ºltig":a===1?"1 Validierungsfehler gefunden":`${a} Validierungsfehler gefunden`}),ae=y(()=>!!p.value),ne=y(()=>E.value?p.value?z.isAfterOrEqual(E.value,p.value):!1:!0),ie=y(()=>Z.value&&h.value&&ae.value&&ne.value),Ee=y(()=>ie.value),de=y(()=>!(!ie.value||A.value&&U.value)),le=y(()=>{if(!ie.value){const a=[];return Z.value||a.push("Vorname"),h.value||a.push("Nachname"),ae.value||a.push("g√ºltiges Geburtsdatum"),ne.value||a.push("g√ºltiges Untersuchungsdatum"),`Bitte korrigieren Sie: ${a.join(", ")}`}return A.value&&U.value?`Bitte validieren Sie zuerst alle Outside-Segmente (${d.value-g.value} verbleibend)`:""}),ge=y(()=>d.value===0?0:Math.round(g.value/d.value*100)),s=y(()=>l.current),C=y(()=>s.value?S.detectMediaType(s.value)==="pdf":!1),A=y(()=>s.value?S.detectMediaType(s.value)==="video":!1),pe=y(()=>{if(!(!C.value||!s.value))return S.getPdfUrl(s.value)||$.pdfStreamUrl||$.buildPdfStreamUrl(s.value.id)});y(()=>{if(!(!A.value||!s.value))return S.getVideoUrl(s.value)});const ce=y(()=>!A.value||!s.value?void 0:`${window.location.origin}/api/media/videos/${s.value.id}/?type=raw`),ve=y(()=>!A.value||!s.value?void 0:`${window.location.origin}/api/media/videos/${s.value.id}/?type=processed`),R=f(null),K=f(null),Ae=a=>{console.error("Raw video error:",a)},Fe=()=>{console.log("Raw video load started")},Ie=()=>{console.log("Raw video can play")},ze=a=>{console.error("Anonymized video error:",a)},Pe=()=>{console.log("Anonymized video load started")},Ye=()=>{console.log("Anonymized video can play")},be=(a,t)=>{if(!R.value||!K.value)return;const Y=a==="raw"?R.value:K.value,b=a==="raw"?K.value:R.value;Math.abs(Y.currentTime-b.currentTime)>.5&&(b.currentTime=Y.currentTime)},Ne=()=>{if(!R.value||!K.value)return;const a=(R.value.currentTime+K.value.currentTime)/2;R.value.currentTime=a,K.value.currentTime=a,console.log("Videos synchronized to time:",a)},Ue=()=>{R.value&&R.value.pause(),K.value&&K.value.pause(),console.log("All videos paused")},Oe=async()=>{if(!s.value||!A.value){n.warning({text:"Kein Video zur Validierung ausgew√§hlt."});return}B.value=!0,U.value=!1,_.value=null;try{console.log(`üîç Validating video ${s.value.id} for segment annotation...`);const t=(await te.get(se(`media/videos/${s.value.id}/validation/segments/`))).data;if(console.log("Video validation response:",t),t.eligible){const b=(await te.get(se(`media/videos/${s.value.id}/segments/?label=outside`))).data;d.value=b.length,g.value=0,b.length>0?(U.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Segmentvalidierung erforderlich",message:`${b.length} "Outside"-Segmente gefunden, die validiert werden m√ºssen.`,details:"Verwenden Sie die Timeline unten, um die Segmente zu √ºberpr√ºfen und zu best√§tigen."}):_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Video bereit f√ºr Annotation",message:'Keine "Outside"-Segmente gefunden. Video ist bereit f√ºr die Segment-Annotation.',details:`Video ID: ${s.value.id} - Alle Validierungen bestanden.`}}else _.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Video nicht bereit",message:t.reasons?.join(", ")||"Video ist nicht f√ºr Segment-Annotation geeignet.",details:"√úberpr√ºfen Sie die Video-Verarbeitung und Metadaten-Extraktion."};n.info({text:`Video ${s.value.id} validiert`})}catch(a){console.error("Error validating video for segment annotation:",a);try{await F.fetchAllSegments(s.value.id);const t=F.allSegments.filter(Y=>Y.label==="outside");d.value=t.length,g.value=0,t.length>0?(U.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Outside-Segmente gefunden (Fallback)",message:`${t.length} "Outside"-Segmente zur Validierung gefunden.`,details:"Fallback-Validierung √ºber VideoStore. API-Endpoint nicht verf√ºgbar."}):_.value={class:"alert-info",icon:"fas fa-info-circle",title:"Fallback-Validierung",message:'Keine "Outside"-Segmente gefunden (√ºber VideoStore).',details:"API-Validierung fehlgeschlagen, Fallback verwendet."}}catch{_.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Validierung fehlgeschlagen",message:"Video konnte nicht f√ºr Segment-Annotation validiert werden.",details:a?.response?.data?.detail||a?.message||"Unbekannter Fehler"}}}finally{B.value=!1}},Te=a=>{g.value++,console.log(`‚úÖ Segment ${a} validated. Progress: ${g.value}/${d.value}`),_.value&&(_.value.message=`Fortschritt: ${g.value}/${d.value} Outside-Segmente validiert.`)},Ce=()=>{console.log("üéâ All outside segments validated!"),U.value=!1,_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Validierung abgeschlossen",message:"Alle Outside-Segmente wurden erfolgreich validiert.",details:`Video ${s.value?.id} ist jetzt bereit f√ºr die vollst√§ndige Segment-Annotation.`},n.success({text:"Outside-Segment Validierung abgeschlossen!"})},he=a=>{if(!a)return;U.value=!1,_.value=null,g.value=0,d.value=0,B.value=!1,k.value=a.anonymizedText||"";const t=a.reportMeta?.examinationDate||"",Y=a.reportMeta?.patientDob||"";V.value=z.toISO(t)||"";const b={patientFirstName:a.reportMeta?.patientFirstName||"",patientLastName:a.reportMeta?.patientLastName||"",patientGender:a.reportMeta?.patientGender||"",patientDob:z.toISO(Y)||"",casenumber:a.reportMeta?.casenumber||""};c.value={...b},q.value={anonymizedText:k.value,examinationDate:V.value,patient:{...b}}};De(s,a=>{a&&(S.setCurrentItem(a),he(a))},{immediate:!0});const re=async()=>{try{await l.fetchNext()}catch(a){console.error("Error fetching next item:",a)}},Ge=y(()=>k.value!==q.value.anonymizedText||V.value!==q.value.examinationDate||!oe(c.value,q.value.patient)),Be=y(()=>s.value&&!Q.value&&!H.value),Q=f(!1),H=f(!1),Le=()=>{O.value=!O.value};function ye(){const a=new Pt;if(G.value=[],L.value="",M.value="",c.value.patientDob){const t=c.value.patientDob;z.validate(t,"ISO")?T.value="ISO (YYYY-MM-DD)":z.validate(t,"German")?T.value="Deutsch (DD.MM.YYYY)":(T.value="",L.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",a.addField("Geburtsdatum",t,"German"))}else T.value="";if(V.value){const t=V.value;z.validate(t,"ISO")?N.value="ISO (YYYY-MM-DD)":z.validate(t,"German")?N.value="Deutsch (DD.MM.YYYY)":(N.value="",M.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",a.addField("Untersuchungsdatum",t,"ISO"))}else N.value="";p.value&&E.value&&a.addConstraint("DOB_BEFORE_EXAM",z.isBeforeOrEqual(p.value,E.value),"Geburtsdatum muss vor oder am selben Tag wie das Untersuchungsdatum liegen"),a.hasErrors()&&(G.value=a.getErrors(),a.getErrors().forEach(Y=>{Y.includes("Geburtsdatum")&&(L.value=Y.replace("Geburtsdatum: ","")),Y.includes("Untersuchungsdatum")&&(M.value=Y.replace("Untersuchungsdatum: ",""))}))}function Re(){const a=c.value.patientDob;if(!a)return;const t=z.toISO(a);t&&(c.value.patientDob=t,T.value="ISO (YYYY-MM-DD)"),ye()}function Ke(){const a=V.value;if(!a)return;const t=z.toISO(a);t&&(V.value=t,N.value="ISO (YYYY-MM-DD)"),ye()}function je(){G.value=[],L.value="",M.value=""}const qe=async()=>{s.value&&await re()},He=()=>{if(!s.value){n.error({text:"Kein Video zur Segmentierung ausgew√§hlt."});return}v.push({name:"Video-Untersuchung",query:{video:s.value.id.toString()}}),console.log(`üéØ Navigating to Video-Untersuchung with video ID: ${s.value.id}`)},We=async()=>{if(!(!s.value||!Be.value||H.value)){if(!de.value){const a=le.value;console.warn(`‚ùå Approval blocked: ${a}`),n.warning({text:a});return}if(A.value&&U.value){console.warn("‚ùå Outside segments still pending validation"),n.error({text:"Bitte validieren Sie zuerst alle Outside-Segmente, bevor Sie das Video best√§tigen."});return}H.value=!0;try{console.log(`Validating anonymization for file ${s.value.id}...`);try{await te.post(se(`anonymization/${s.value.id}/validate/`),{patient_first_name:c.value.patientFirstName,patient_last_name:c.value.patientLastName,patient_gender:c.value.patientGender,patient_dob:z.toGerman(p.value||"")||"",examination_date:z.toGerman(E.value||"")||"",casenumber:c.value.casenumber||"",anonymized_text:C.value?k.value:void 0,is_verified:!0,file_type:C.value?"pdf":A.value?"video":"unknown"}),console.log(`Anonymization validated successfully for file ${s.value.id}`),n.success({text:"Dokument best√§tigt und Anonymisierung validiert"})}catch(a){console.error("Error validating anonymization:",a),n.warning({text:"Dokument best√§tigt, aber Validierung fehlgeschlagen"})}i.validateAnonymizationSafeWithProtection(s.value.id,"pdf"),await He()}catch(a){console.error("Error approving item:",a),n.error({text:"Fehler beim Best√§tigen des Elements"})}finally{H.value=!1}}},Xe=async()=>{if(!Q.value){if(!Ee.value){if(!P.value||!D.value)n.error({text:"Bitte laden Sie zuerst Bilder hoch (Original und bearbeitetes Bild)."});else if(!ie.value){const a=[];Z.value||a.push("Vorname"),h.value||a.push("Nachname"),ae.value||a.push("g√ºltiges Geburtsdatum"),ne.value||a.push("g√ºltiges Untersuchungsdatum (darf nicht vor Geburtsdatum liegen)"),n.error({text:`Bitte korrigieren Sie: ${a.join(", ")}`})}return}Q.value=!0;try{const a={processed_image_url:P.value,patient_data:ue(z.toGerman(p.value||"")||""),examinationDate:z.toGerman(E.value||"")||"",anonymized_text:k.value};if(s.value&&A.value)await te.post(se("save-anonymization-annotation-video/"),{...a,itemId:s.value.id});else if(s.value&&C.value)await te.post(se("save-anonymization-annotation-pdf/"),a);else{n.error({text:"Keine g√ºltige Anonymisierung zum Speichern gefunden."});return}D.value="",P.value="",j.value=!1,n.success({text:"Annotation erfolgreich gespeichert"})}catch(a){console.error("Error saving annotation:",a),n.error({text:"Fehler beim Speichern der Annotation"})}finally{Q.value=!1}}},Je=async()=>{s.value&&await re()},Ze=async()=>{if(!s.value){n.error({text:"Kein Element zur Korrektur ausgew√§hlt."});return}try{v.push({name:"Anonymisierung Korrektur",params:{fileId:s.value.id.toString()}}),n.info({text:"√Ñnderungen gespeichert. Bitte w√§hlen Sie das Element erneut f√ºr die Korrektur aus."});return}catch{n.error({text:"Fehler beim Speichern. Korrektur-Navigation abgebrochen."});return}};return ke(async()=>{l.current?he(l.current):await re()}),nt(()=>{re()}),(a,t)=>{const Y=it("router-link");return o(),u("div",Yt,[e("div",Nt,[t[60]||(t[60]=e("div",{class:"card-header pb-0"},[e("h4",{class:"mb-0"},"Anonymisierungsvalidierung und Annotationen")],-1)),e("div",Ut,[W(l).loading?(o(),u("div",Ot,[...t[11]||(t[11]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Wird geladen...")],-1),e("p",{class:"mt-2"},"Anonymisierte Daten werden geladen...",-1)])])):W(l).error?(o(),u("div",Tt,[t[12]||(t[12]=e("strong",null,"Fehler:",-1)),m(" "+r(W(l).error),1)])):s.value?x("",!0):(o(),u("div",{key:2,class:"alert alert-info",role:"alert",onLoadstart:t[0]||(t[0]=b=>W(l).fetchNext())}," Alle Anonymisierungen wurden bearbeitet. ",32)),W(l).isAnyFileProcessing?(o(),u("div",Ct,[t[14]||(t[14]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("strong",null,r(W(l).processingFiles.length)+" Datei(en)",1),t[15]||(t[15]=m(" werden gerade anonymisiert. ",-1)),e("div",Gt,[Se(Y,{to:"/anonymisierung/uebersicht",class:"btn btn-sm btn-outline-primary"},{default:st(()=>[...t[13]||(t[13]=[e("i",{class:"fas fa-eye me-1"},null,-1),m(" Zur √úbersicht ",-1)])]),_:1})])])):x("",!0)]),s.value?(o(),u(me,{key:0},[e("div",Bt,[e("div",Lt,[e("div",Rt,[e("div",null,[t[17]||(t[17]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("span",null,[t[16]||(t[16]=e("strong",null,"Validierung:",-1)),m(" "+r(C.value?"PDF-Dokument":A.value?"Video-Datei":"Unbekanntes Format")+" "+r(s.value?.reportMeta?.centerName?`- ${s.value.reportMeta.centerName}`:""),1)])]),s.value&&(A.value||C.value)?(o(),u("div",Kt,[e("small",jt,[t[18]||(t[18]=e("i",{class:"fas fa-tools me-1"},null,-1)),m(" "+r(A.value?"Video-Korrektur verf√ºgbar":"Text-Korrektur verf√ºgbar"),1)])])):x("",!0)])])]),e("div",qt,[e("div",Ht,[e("div",Wt,[X(e("input",{type:"checkbox",class:"form-check-input",id:"noMoreNames","onUpdate:modelValue":t[1]||(t[1]=b=>I.value=b)},null,512),[[lt,I.value]]),t[19]||(t[19]=e("label",{class:"form-check-label",for:"noMoreNames"}," Keine weiteren Namen im Video oder PDF vorhanden ",-1))])])]),G.value.length>0?(o(),u("div",Xt,[e("div",Jt,[e("div",Zt,[e("h6",Qt,[t[20]||(t[20]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" "+r(fe.value),1)]),t[21]||(t[21]=e("hr",null,null,-1)),e("ul",ea,[(o(!0),u(me,null,Ve(G.value,(b,we)=>(o(),u("li",{key:we},r(b),1))),128))]),e("button",{type:"button",class:"btn-close",onClick:je,"aria-label":"Schlie√üen"})])])])):x("",!0),e("div",ta,[e("div",aa,[e("div",na,[e("div",sa,[t[34]||(t[34]=e("h5",{class:"card-title"},"Patienteninformationen",-1)),e("div",ia,[t[22]||(t[22]=e("label",{class:"form-label"},"Vorname:",-1)),X(e("input",{type:"text",class:J(["form-control",{"is-invalid":!Z.value}]),"onUpdate:modelValue":t[2]||(t[2]=b=>c.value.patientFirstName=b)},null,2),[[ee,c.value.patientFirstName]]),Z.value?x("",!0):(o(),u("div",la," Vorname ist erforderlich. "))]),e("div",ra,[t[23]||(t[23]=e("label",{class:"form-label"},"Nachname:",-1)),X(e("input",{type:"text",class:J(["form-control",{"is-invalid":!h.value}]),"onUpdate:modelValue":t[3]||(t[3]=b=>c.value.patientLastName=b)},null,2),[[ee,c.value.patientLastName]]),h.value?x("",!0):(o(),u("div",oa," Nachname ist erforderlich. "))]),e("div",ua,[t[25]||(t[25]=e("label",{class:"form-label"},"Geschlecht:",-1)),X(e("select",{class:"form-select","onUpdate:modelValue":t[4]||(t[4]=b=>c.value.patientGender=b)},[...t[24]||(t[24]=[e("option",{value:"male"},"M√§nnlich",-1),e("option",{value:"female"},"Weiblich",-1),e("option",{value:"other"},"Divers",-1)])],512),[[rt,c.value.patientGender]])]),e("div",da,[t[28]||(t[28]=e("label",{class:"form-label"},"Geburtsdatum:",-1)),X(e("input",{type:"date",class:J(["form-control",{"is-invalid":!ae.value}]),"onUpdate:modelValue":t[5]||(t[5]=b=>c.value.patientDob=b),onBlur:Re},null,34),[[ee,c.value.patientDob]]),e("small",ca,[t[26]||(t[26]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),t[27]||(t[27]=m(" Format: DD.MM.YYYY oder YYYY-MM-DD ",-1)),T.value?(o(),u("span",va,r(T.value),1)):x("",!0)]),ae.value?x("",!0):(o(),u("div",ma,r(L.value||"G√ºltiges Geburtsdatum ist erforderlich."),1))]),e("div",fa,[t[29]||(t[29]=e("label",{class:"form-label"},"Fallnummer:",-1)),X(e("input",{type:"text",class:"form-control","onUpdate:modelValue":t[6]||(t[6]=b=>c.value.casenumber=b)},null,512),[[ee,c.value.casenumber]])]),e("div",ga,[t[32]||(t[32]=e("label",{class:"form-label"},"Untersuchungsdatum:",-1)),X(e("input",{type:"date",class:J(["form-control",{"is-invalid":!ne.value}]),"onUpdate:modelValue":t[7]||(t[7]=b=>V.value=b),onBlur:Ke},null,34),[[ee,V.value]]),e("small",pa,[t[30]||(t[30]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),t[31]||(t[31]=m(" Format: DD.MM.YYYY oder YYYY-MM-DD ",-1)),N.value?(o(),u("span",ba,r(N.value),1)):x("",!0)]),ne.value?x("",!0):(o(),u("div",ha,r(M.value||"Das Untersuchungsdatum darf nicht vor dem Geburtsdatum liegen."),1))]),e("div",ya,[t[33]||(t[33]=e("label",{class:"form-label"},"Anonymisierter Text:",-1)),X(e("textarea",{class:"form-control",rows:"6","onUpdate:modelValue":t[8]||(t[8]=b=>k.value=b)},null,512),[[ee,k.value]])])])]),e("div",wa,[e("div",Sa,[t[35]||(t[35]=e("h5",{class:"card-title"},"Annotationen",-1)),P.value?(o(),u("div",_a,[e("img",{src:O.value?D.value:P.value,class:"img-fluid",alt:"Uploaded Image"},null,8,ka),e("button",{class:"btn btn-info btn-sm mt-2",onClick:Le},r(O.value?"Bearbeitetes Bild anzeigen":"Original anzeigen"),1)])):x("",!0),e("div",Da,[e("button",{class:"btn btn-primary",onClick:Xe},[Q.value?(o(),u("span",xa)):x("",!0),m(" "+r(Q.value?"Speichern...":"Annotation zwischenspeichern"),1)])])])])]),e("div",Va,[e("div",$a,[e("div",Ma,[e("h5",Ea,r(C.value?"PDF Vorschau":"Video Vorschau"),1),e("div",Aa,[t[36]||(t[36]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),t[37]||(t[37]=e("strong",null,"Datenformat:",-1)),C.value?(o(),u("span",Fa," PDF-Dokument ("+r(Math.round((s.value?.reportMeta?.file?.length||0)/1024)||"Unbekannt")+" KB) ",1)):A.value?(o(),u("span",Ia," Video-Datei (Raw: "+r(ce.value||"N/A")+" | Anonymized: "+r(ve.value||"N/A")+") ",1)):(o(),u("span",za," Unbekanntes Format - ID: "+r(s.value?.id),1))])]),e("div",Pa,[C.value?(o(),u("iframe",{key:0,src:pe.value,width:"100%",height:"800px",frameborder:"0",title:"PDF Vorschau"},[t[38]||(t[38]=m(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:pe.value},"hier herunterladen",8,Na),t[39]||(t[39]=m(". ",-1))],8,Ya)):A.value?(o(),u("div",Ua,[e("div",Oa,[e("div",Ta,[e("div",Ca,[t[40]||(t[40]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-eye me-1"}),m(" Original Video (Raw) ")],-1)),e("video",{ref_key:"rawVideoElement",ref:R,src:ce.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ae,onLoadstart:Fe,onCanplay:Ie,onTimeupdate:t[9]||(t[9]=b=>be("raw"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,Ga),e("div",Ba,[e("small",La," URL: "+r(ce.value||"Nicht verf√ºgbar"),1)])])]),e("div",Ra,[e("div",Ka,[t[41]||(t[41]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes Video (Processed) ")],-1)),e("video",{ref_key:"anonymizedVideoElement",ref:K,src:ve.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:ze,onLoadstart:Pe,onCanplay:Ye,onTimeupdate:t[10]||(t[10]=b=>be("anonymized"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,ja),e("div",qa,[e("small",Ha," URL: "+r(ve.value||"Nicht verf√ºgbar"),1)])])])]),e("div",Wa,[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Ne},[...t[42]||(t[42]=[e("i",{class:"fas fa-sync me-1"},null,-1),m(" Videos synchronisieren ",-1)])]),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:Ue},[...t[43]||(t[43]=[e("i",{class:"fas fa-pause me-1"},null,-1),m(" Alle pausieren ",-1)])]),e("button",{class:"btn btn-outline-info btn-sm ms-2",onClick:Oe,disabled:B.value},[B.value?(o(),u("span",Ja)):(o(),u("i",Za)),t[44]||(t[44]=m(" Segment-Annotation pr√ºfen ",-1))],8,Xa)]),U.value&&s.value?(o(),u("div",Qa,[e("div",en,[e("div",tn,[e("div",an,[e("div",null,[e("h6",nn,[t[45]||(t[45]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" Segmente zur Entfernung - Video ID: "+r(s.value.id),1)]),t[46]||(t[46]=e("small",{class:"text-muted"},' Diese Segmente wurden als "outside" klassifiziert und sollten aus dem Video entfernt werden. ',-1))]),e("div",sn,[e("div",ln,r(g.value)+" / "+r(d.value),1),e("div",rn,[e("div",{class:"progress-bar bg-success",role:"progressbar",style:xe({width:ge.value+"%"}),"aria-valuenow":g.value,"aria-valuemin":0,"aria-valuemax":d.value},null,12,on)]),e("small",un,r(ge.value)+"% validiert",1)])])]),e("div",dn,[Se(zt,{videoId:s.value.id,onSegmentValidated:Te,onValidationComplete:Ce},null,8,["videoId"])])])])):x("",!0),_.value?(o(),u("div",{key:1,class:J(["alert mt-3",_.value.class])},[e("i",{class:J([_.value.icon,"me-2"])},null,2),e("strong",null,r(_.value.title)+":",1),m(" "+r(_.value.message)+" ",1),_.value.details?(o(),u("div",cn,[e("small",null,r(_.value.details),1)])):x("",!0)],2)):x("",!0)])):(o(),u("div",vn,[t[56]||(t[56]=e("h6",null,"Debug-Informationen:",-1)),e("ul",mn,[e("li",null,[t[47]||(t[47]=e("strong",null,"Current Item ID:",-1)),m(" "+r(s.value?.id||"Nicht verf√ºgbar"),1)]),e("li",null,[t[48]||(t[48]=e("strong",null,"SensitiveMeta ID:",-1)),m(" "+r(s.value?.sensitiveMetaId||"Nicht verf√ºgbar"),1)]),e("li",null,[t[49]||(t[49]=e("strong",null,"Is PDF:",-1)),m(" "+r(C.value),1)]),e("li",null,[t[50]||(t[50]=e("strong",null,"Is Video:",-1)),m(" "+r(A.value),1)]),e("li",null,[t[51]||(t[51]=e("strong",null,"Detected Media Type:",-1)),m(" "+r(s.value?W(S).detectMediaType(s.value):"N/A"),1)]),e("li",null,[t[52]||(t[52]=e("strong",null,"Media URL:",-1)),m(" "+r(s.value?W(S).currentMediaUrl:"N/A"),1)]),e("li",null,[t[53]||(t[53]=e("strong",null,"PDF URL:",-1)),m(" "+r(s.value?.reportMeta?.pdfUrl||"Nicht verf√ºgbar"),1)]),e("li",null,[t[54]||(t[54]=e("strong",null,"Video URL:",-1)),m(" "+r(s.value?.videoUrl||"Nicht verf√ºgbar"),1)]),e("li",null,[t[55]||(t[55]=e("strong",null,"PDF Stream URL:",-1)),m(" "+r(s.value?.pdfStreamUrl||"Nicht verf√ºgbar"),1)])])]))])])])]),e("div",fn,[e("div",gn,[e("button",{class:"btn btn-secondary",onClick:qe}," √úberspringen "),e("div",pn,[s.value&&(A.value||C.value)?(o(),u("button",{key:0,class:"btn btn-warning position-relative",onClick:Ze,disabled:H.value,title:A.value?"Video-Korrektur: Maskierung, Frame-Entfernung, etc.":"PDF-Korrektur: Text-Annotation anpassen"},[t[57]||(t[57]=e("i",{class:"fas fa-edit me-1"},null,-1)),m(" "+r(A.value?"Video-Korrektur":"PDF-Korrektur")+" ",1),Ge.value?(o(),u("span",hn," ! ")):x("",!0)],8,bn)):x("",!0),e("button",{class:"btn btn-danger me-2",onClick:Je}," Ablehnen "),e("button",{class:"btn btn-success",onClick:We,disabled:H.value||!de.value,title:le.value},[H.value?(o(),u("span",wn)):x("",!0),m(" "+r(H.value?"Wird best√§tigt...":"Best√§tigen"),1)],8,yn),!de.value&&le.value?(o(),u("div",Sn,[t[58]||(t[58]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[59]||(t[59]=e("strong",null,"Best√§tigung blockiert:",-1)),m(" "+r(le.value),1)])):x("",!0)])])])],64)):x("",!0)])])}}}),En=$e(_n,[["__scopeId","data-v-a82e273a"]]);export{En as default};
