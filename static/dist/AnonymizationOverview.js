import{d as V,g as W,h as A,e as D,i as H,J as G,c as o,a as t,k as l,n as b,j as c,p as S,t as u,F as Q,m as X,o as i,y as Y,_ as M,b as Z}from"./main.js";import{u as I}from"./videoStore.js";import{useAnnotationStore as ee}from"./annotationStore.js";import{u as te}from"./mediaTypeStore.js";import{u as ne,a as se}from"./usePollingProtection.js";const ae={class:"container-fluid py-4"},oe={class:"card"},ie={class:"card-header pb-0 d-flex justify-content-between align-items-center"},re={class:"d-flex gap-2"},le=["disabled"],de={class:"card-body"},ce={key:0,class:"alert alert-danger",role:"alert"},ue={key:1,class:"text-center py-5"},me={key:2,class:"text-center py-5"},ge={key:3,class:"table-responsive"},pe={class:"table table-hover"},ye={class:"d-flex align-items-center"},ve={class:"fw-medium"},_e={key:0,class:"fas fa-spinner fa-spin me-1"},be={key:0,class:"text-success"},fe={key:1,class:"text-danger"},he={class:"text-muted"},we={class:"btn-group btn-group-sm",role:"group"},ke=["onClick","disabled"],Se=["onClick","disabled"],ze=["onClick","disabled"],Fe=["onClick","disabled"],Te=["onClick","disabled"],xe=["onClick","disabled"],Ce=["onClick","disabled"],Ae={key:6,class:"btn btn-outline-info",disabled:""},De={key:7,class:"btn btn-outline-info",disabled:""},Ve={key:4,class:"row mt-4"},Me={class:"col-md-12"},$e={class:"card bg-light"},Pe={class:"card-body"},Oe={class:"row text-center"},Be={class:"col-md-3"},Ee={class:"mb-2"},Ne={class:"badge bg-secondary fs-6"},Le={class:"col-md-3"},Re={class:"mb-2"},Ke={class:"badge bg-warning fs-6"},Ue={class:"col-md-3"},je={class:"mb-2"},qe={class:"badge bg-warning fs-6"},Je={class:"col-md-3"},We={class:"mb-2"},He={class:"badge bg-success fs-6"},Ge={class:"col-md-3"},Qe={class:"mb-2"},Xe={class:"badge bg-danger fs-6"},Ye={key:5,class:"alert alert-warning mt-3",role:"alert"},Ze=V({__name:"AnonymizationOverviewComponent",setup($){const w=Y(),r=W(),P=I();ee();const m=te(),k=ne(),O=se(),f=A(!1),g=A(new Set),d=D(()=>r.overview),z=D(()=>r.overview.length-d.value.length),v=async()=>{f.value=!0;try{await r.fetchOverview(),m.seedTypesFromOverview(r.overview)}finally{f.value=!1}},F=async n=>{const e=d.value.find(y=>y.id===n);if(!e){console.warn("File not found for anonymization:",n);return}const s=e.mediaType==="video"?"video":"pdf";(await k.startAnonymizationSafeWithProtection(n,s))?.success?(await v(),console.log("Anonymization started successfully for file",n)):console.warn("startAnonymization failed - staying on current page")},B=async n=>{const e=d.value.find(s=>s.id===n);if(e)m.setCurrentItem(e);else{console.warn("File not found for correction:",n);return}w.push({name:"Anonymisierung Korrektur",query:{fileId:String(n),mediaType:e.mediaType}})},E=n=>{const e=d.value.find(s=>s.id===n);return e?e.anonymizationStatus==="done_processing_anonymization"||e.anonymizationStatus==="not_started":!1},N=async(n,e)=>{if(g.value.add(n),!n){console.warn("File not found for validation:",n);return}try{if(await r.setCurrentForValidation(n,e)){const a=d.value.find(h=>h.id===n&&h.mediaType===e);if(!a){console.warn("File not found for validation with given mediaType:",{fileId:n,mediaType:e});return}m.setCurrentItem(a);const y=a.mediaType;try{m.rememberType(n,y,y)}catch(h){console.error("Error remembering media type for file:",n,h)}a.sensitiveMetaId&&m.rememberType(a.sensitiveMetaId,y,"meta"),sessionStorage.setItem("last:fileId",String(n)),sessionStorage.setItem("last:scope",y),console.log("File set for validation:",n,"file media type:",a.mediaType),w.push({name:"AnonymisierungValidierung",query:{fileId:String(n),mediaType:a.mediaType}})}}catch(s){console.error("Navigation to validation failed:",s)}finally{g.value.delete(n)}},L=async n=>{g.value.add(n);try{await r.reimportVideo(n)?(await v(),console.log("Video re-imported successfully:",n)):console.warn("Re-import failed - staying on current page")}finally{g.value.delete(n)}},R=async n=>{g.value.add(n);try{await r.reimportPdf(n)?(await v(),console.log("PDF re-imported successfully:",n)):console.warn("PDF re-import failed - staying on current page")}catch(e){console.error("PDF re-import failed:",e)}finally{g.value.delete(n)}},K=async n=>{const e=d.value.find(a=>a.id===n);if(!e){console.warn("File not found for deletion:",n);return}if(confirm(`Sind Sie sicher, dass Sie die Datei "${e.filename}" permanent löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.`)){g.value.add(n);try{await O.deleteMediaFile(n)?(await v(),console.log("File deleted successfully:",n)):console.warn("File deletion failed")}catch(a){console.error("File deletion failed:",a)}finally{g.value.delete(n)}}},p=n=>{const e=d.value.find(a=>a.id===n);if(!e)return!1;const s=m.detectMediaType(e);return s==="unknown"?g.value.has(n):g.value.has(n)||!k.canProcessMedia.value(n,s)},T=n=>n.mediaType==="video"?!n.metadataImported:n.mediaType==="pdf"?!n.metadataImported||n.anonymizationStatus==="failed"||n.anonymizationStatus==="not_started":!1,U=n=>m.getMediaTypeIcon(n),j=n=>m.getMediaTypeBadgeClass(n),x=n=>({not_started:"bg-secondary",processing_anonymization:"bg-warning",extracting_frames:"bg-info",predicting_segments:"bg-info",done_processing_anonymization:"bg-success",validated:"bg-success",failed:"bg-danger"})[n]||"bg-secondary",C=n=>({not_started:"Nicht gestartet",processing_anonymization:"Anonymisierung läuft",extracting_frames:"Frames extrahieren",predicting_segments:"Segmente vorhersagen",done_processing_anonymization:"Fertig",validated:"Validiert",failed:"Fehlgeschlagen"})[n]||n,q=n=>n?new Date(n).toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",_=n=>{const s={not_started:["not_started"],processing:["processing_anonymization","extracting_frames","predicting_segments"],done_processing_anonymization:["done_processing_anonymization","validated"],failed:["failed"]}[n]||[n];return d.value.filter(a=>s.includes(a.anonymizationStatus)).length},J=n=>n.mediaType==="video"?P.hasRawVideoFile?.valueOf()??!1:n.mediaType==="pdf"?!!(n.rawFile&&n.rawFile.trim()!==""):!0;return H(async()=>{await r.fetchOverview(),m.seedTypesFromOverview(r.overview),console.table(r.overview.map(e=>({id:e.id,fromOverview:e.mediaType,remembered:m.getType(e.id)})));const n=["processing_anonymization","extracting_frames","predicting_segments"];r.overview.forEach(e=>{n.includes(e.anonymizationStatus)?(console.log(`Starting polling for processing file ${e.id} (status: ${e.anonymizationStatus})`),r.startPolling(e.id)):console.log(`Skipping polling for file ${e.id} (status: ${e.anonymizationStatus})`)})}),G(()=>{r.stopAllPolling(),k.clearAllLocalLocks()}),(n,e)=>(i(),o("div",ae,[t("div",oe,[t("div",ie,[e[1]||(e[1]=t("h4",{class:"mb-0"},"Anonymisierungs-Übersicht",-1)),t("div",re,[t("button",{class:"btn btn-outline-primary btn-sm",onClick:v,disabled:f.value},[t("i",{class:b(["fas fa-sync-alt",{"fa-spin":f.value}])},null,2),e[0]||(e[0]=l(" Aktualisieren ",-1))],8,le)])]),t("div",de,[S(r).error?(i(),o("div",ce,[e[2]||(e[2]=t("strong",null,"Fehler:",-1)),l(" "+u(S(r).error),1)])):c("",!0),S(r).loading&&!d.value.length?(i(),o("div",ue,[...e[3]||(e[3]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Wird geladen...")],-1),t("p",{class:"mt-2"},"Dateien werden geladen...",-1)])])):d.value.length?(i(),o("div",ge,[t("table",pe,[e[16]||(e[16]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Dateiname"),t("th",null,"Typ"),t("th",null,"Anonymisierung"),t("th",null,"Annotation"),t("th",null,"Unverarbeitete Daten vorhanden"),t("th",null,"Erstellt"),t("th",null,"Aktionen")])],-1)),t("tbody",null,[(i(!0),o(Q,null,X(d.value,s=>(i(),o("tr",{key:`${s.mediaType}-${s.id}`},[t("td",null,[t("div",ye,[t("i",{class:b([U(s.mediaType),"me-2"])},null,2),t("span",ve,u(s.filename),1)])]),t("td",null,[t("span",{class:b([j(s.mediaType),"badge"])},u(s.mediaType.toUpperCase()),3)]),t("td",null,[t("span",{class:b([x(s.anonymizationStatus),"badge"])},[s.anonymizationStatus==="processing_anonymization"?(i(),o("i",_e)):c("",!0),l(" "+u(C(s.anonymizationStatus)),1)],2)]),t("td",null,[t("span",{class:b([x(s.annotationStatus),"badge"])},u(C(s.annotationStatus)),3)]),t("td",null,[J(s)?(i(),o("span",be,[...e[5]||(e[5]=[t("i",{class:"fas fa-check-circle me-1"},null,-1),l(" Ja ",-1)])])):(i(),o("span",fe,[...e[6]||(e[6]=[t("i",{class:"fas fa-times-circle me-1"},null,-1),l(" Nein ",-1)])]))]),t("td",null,[t("small",he,u(q(s.createdAt)),1)]),t("td",null,[t("div",we,[s.mediaType==="video"&&T(s)?(i(),o("button",{key:0,onClick:a=>L(s.id),class:"btn btn-outline-info",disabled:p(s.id),title:"Video erneut importieren und Metadaten aktualisieren"},[...e[7]||(e[7]=[t("i",{class:"fas fa-redo-alt"},null,-1),l(" Erneut importieren ",-1)])],8,ke)):c("",!0),s.mediaType==="pdf"&&T(s)?(i(),o("button",{key:1,onClick:a=>R(s.id),class:"btn btn-outline-info",disabled:p(s.id),title:"PDF erneut importieren und verarbeiten"},[...e[8]||(e[8]=[t("i",{class:"fas fa-redo-alt"},null,-1),l(" Erneut importieren ",-1)])],8,Se)):c("",!0),s.anonymizationStatus==="not_started"?(i(),o("button",{key:2,onClick:a=>F(s.id),class:"btn btn-outline-primary",disabled:p(s.id)},[...e[9]||(e[9]=[t("i",{class:"fas fa-play"},null,-1),l(" Starten ",-1)])],8,ze)):c("",!0),s.anonymizationStatus==="failed"?(i(),o("button",{key:3,onClick:a=>F(s.id),class:"btn btn-outline-warning",disabled:p(s.id)},[...e[10]||(e[10]=[t("i",{class:"fas fa-redo"},null,-1),l(" Erneut versuchen ",-1)])],8,Fe)):c("",!0),s.anonymizationStatus==="done_processing_anonymization"?(i(),o("button",{key:4,onClick:a=>N(s.id,s.mediaType),class:"btn btn-outline-success bg-success",disabled:!E(s.id)},[...e[11]||(e[11]=[t("i",{class:"fas fa-eye"},null,-1),l(" Validieren ",-1)])],8,Te)):c("",!0),s.mediaType==="video"&&(s.anonymizationStatus==="done_processing_anonymization"||s.anonymizationStatus==="validated")?(i(),o("button",{key:5,onClick:a=>B(s.id),class:"btn btn-outline-warning",disabled:p(s.id)},[...e[12]||(e[12]=[t("i",{class:"fas fa-edit"},null,-1),l(" Korrektur ",-1)])],8,xe)):c("",!0),t("button",{onClick:a=>K(s.id),class:"btn btn-outline-danger",disabled:p(s.id),title:"Datei permanent löschen"},[...e[13]||(e[13]=[t("i",{class:"fas fa-trash"},null,-1),l(" Löschen ",-1)])],8,Ce),s.anonymizationStatus==="processing_anonymization"?(i(),o("button",Ae,[...e[14]||(e[14]=[t("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),l(" Anonymisierung... ",-1)])])):c("",!0),s.anonymizationStatus==="extracting_frames"?(i(),o("button",De,[...e[15]||(e[15]=[t("i",{class:"fas fa-spinner fa-spin me-1"},null,-1),l(" Frames extrahieren... ",-1)])])):c("",!0)])])]))),128))])])])):(i(),o("div",me,[...e[4]||(e[4]=[t("div",{class:"mb-4"},[t("i",{class:"fas fa-folder-open fa-3x text-muted"})],-1),t("h5",{class:"text-muted"},"Keine Dateien vorhanden",-1),t("p",{class:"text-muted mb-4"}," Laden Sie Videos oder PDFs in den data Ordner oder den import ordner, um mit der Anonymisierung zu beginnen. ",-1)])])),d.value.length?(i(),o("div",Ve,[t("div",Me,[t("div",$e,[t("div",Pe,[e[22]||(e[22]=t("h6",{class:"card-title"},"Status-Übersicht",-1)),t("div",Oe,[t("div",Be,[t("div",Ee,[t("span",Ne,u(_("not_started")),1)]),e[17]||(e[17]=t("small",{class:"text-muted"},"Nicht gestartet",-1))]),t("div",Le,[t("div",Re,[t("span",Ke,u(_("processing")),1)]),e[18]||(e[18]=t("small",{class:"text-muted"},"In Bearbeitung",-1))]),t("div",Ue,[t("div",je,[t("span",qe,u(_("started")),1)]),e[19]||(e[19]=t("small",{class:"text-muted"},"Anonymisierung gestartet",-1))]),t("div",Je,[t("div",We,[t("span",He,u(_("done_processing_anonymization")),1)]),e[20]||(e[20]=t("small",{class:"text-muted"},"Fertig",-1))]),t("div",Ge,[t("div",Qe,[t("span",Xe,u(_("failed")),1)]),e[21]||(e[21]=t("small",{class:"text-muted"},"Fehlgeschlagen",-1))])])])])])])):c("",!0),z.value>0?(i(),o("div",Ye,[e[23]||(e[23]=t("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),e[24]||(e[24]=t("strong",null,"Hinweis:",-1)),l(" "+u(z.value)+" Datei(en) wurden ausgeblendet, da die ursprünglichen Dateien nicht mehr verfügbar sind. ",1)])):c("",!0)])])]))}}),Ie=M(Ze,[["__scopeId","data-v-eef41d7d"]]),et={class:"anonymization-overview-page"},tt=V({__name:"AnonymizationOverview",setup($){return(w,r)=>(i(),o("div",et,[Z(Ie)]))}}),rt=M(tt,[["__scopeId","data-v-4b00a75f"]]);export{rt as default};
