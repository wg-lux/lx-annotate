const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["annotationStore.js","main.js","main.css","authStore.js"])))=>i.map(i=>d[i]);
import{O as Ue,h,I as Me,e as p,M as _,z as m,A as g,f as Ne,P as H,Q as J,g as Le}from"./main.js";const Pe={appendix:"Appendix",blood:"Blut",diverticule:"Divertikel",grasper:"Greifer",ileocaecalvalve:"IleozÃ¤kalklappe",ileum:"Ileum",low_quality:"Niedrige BildqualitÃ¤t",nbi:"Narrow Band Imaging",needle:"Nadel",outside:"AuÃŸerhalb",polyp:"Polyp",snare:"Snare",water_jet:"Wasserstrahl",wound:"Wunde"};function E(a){return Pe[a]??a}const ke={outside:"#e74c3c",polyp:"#f39c12",needle:"#3498db",blood:"#e74c3c",snare:"#9b59b6",grasper:"#2ecc71",water_jet:"#1abc9c",appendix:"#f1c40f",ileum:"#e67e22",diverticule:"#34495e",ileocaecalvalve:"#95a5a6",nbi:"#8e44ad",low_quality:"#7f8c8d",wound:"#c0392b"};function x(a){return ke[a]??"#95a5a6"}const A=a=>{if(!a||a<0)return"00:00";const c=Math.floor(a/60),S=Math.floor(a%60);return`${c.toString().padStart(2,"0")}:${S.toString().padStart(2,"0")}`};function T(a){const c=a.labelName??a.labelDisplay??"unknown";let S;return a.timeSegments?.frames?.length&&(S=a.timeSegments.frames.reduce((s,d)=>(s[String(d.frameId)]=d,s),{})),{id:a.id,label:c,startTime:a.startTime,endTime:a.endTime,avgConfidence:1,videoID:a.videoId,labelID:a.labelId,startFrameNumber:a.startFrameNumber,endFrameNumber:a.endFrameNumber,frames:S}}const xe=h([]),C=Ne(),Ce={},je=1/50,X=5;let Oe=-1;const ze=Ue("video",()=>{const a=h(null),c=h(""),S=h(""),s=Me({...Ce}),d=h({videos:[],labels:[]}),D=h(null),j=h(null),F=h(0),i=h(null),$=h(null);function I(e){return`${window.location.origin}/api/media/videos/${e}/`}const Y=p(()=>!!a.value),U=p(()=>D.value?.duration?D.value.duration:0),Z=p(()=>a.value?.segments||[]),ee=p(()=>d.value?.labels||[]),O=p(()=>{const e={};return d.value.labels.forEach(t=>e[t.name]=t.id),e});function M(e){return{...e,labelID:e.labelID??O.value[e.label]??null}}const V=p(()=>{const e=[...a.value?.segments||[]];if(i.value){const t={id:i.value.id,label:i.value.label,startTime:i.value.startTime,endTime:i.value.endTime||i.value.startTime,avgConfidence:0,labelID:O.value[i.value.label]??null,isDraft:!0};e.push(t)}return e}),te=p(()=>V.value.map(e=>({id:e.id,label:E(e.label),startTime:e.startTime,endTime:e.endTime,display:`${E(e.label)}: ${A(e.startTime)} â€“ ${A(e.endTime)}`}))),ae=p(()=>V.value.find(e=>e.id===j.value)||null);async function ne(e){if(e||(e=a.value?.id||null),!e)return console.error(`Invalid video ID: ${e}`),!1;try{return await m.delete(`/api/media-management/${e}/force-remove/`),!0}catch(t){return console.error(`Failed to delete video ${e}:`,t),!1}}function oe(e){j.value=e}function re(e,t){t&&e.startTime&&(t.currentTime=e.startTime,t.play().catch(console.error))}function se(e,t){const n=e.startTime/t*100,o=(e.endTime-e.startTime)/t*100;return{left:`${n}%`,width:`${o}%`,backgroundColor:x(e.label)}}function N(e,t,n=!1){for(const o in s){const r=s[o].find(l=>l.id===e);if(r){Object.assign(r,t),n&&!r.isDraft&&(r.isDirty=!0);break}}}function le(){return te.value}function ie(){Object.keys(s).forEach(e=>{delete s[e]})}async function R(e){if(console.log(`[VideoStore] fetchAllSegments called with video ID: ${e}`),a.value||(console.log(`[VideoStore] No currentVideo found, creating basic video object for ID: ${e}`),a.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null}),await K(e),a.value){const t=[];Object.values(s).forEach(n=>{t.push(...n)}),a.value.segments=t,console.log(`[VideoStore] Timeline segments populated: ${t.length} segments for video ${e}`)}}async function ce(){console.log("Saving annotations...")}async function de(e){a.value&&(a.value.status=e)}async function ue(e){a.value&&(a.value.assignedUser=e)}async function z(){console.log("ðŸ·ï¸ [VideoStore] Fetching labels with high priority...");try{const t=(await m.get(g("media/videos/labels/list/"))).data.map(n=>({id:Number(n.id),name:String(n.name),color:n.color||x(n.name)}));return d.value.labels=t,console.log(`âœ… [VideoStore] Loaded ${t.length} labels`),t}catch(e){throw console.error("âŒ Error loading labels:",e),d.value.labels=[],e}}async function me(){console.log("Fetching all videos...");try{await z();const e=await m.get(g("media/videos/"));console.log("API Response:",e.data);const t=e.data.videos.map(r=>({id:parseInt(r.id),original_file_name:r.original_file_name,status:r.status||"available",assignedUser:r.assignedUser||null,anonymized:r.anonymized||!1,centerName:r.center_name||"Unbekannt",processorName:r.processor_name||"Unbekannt"})),n=d.value.labels;console.log("Fetching segments for",t.length,"videos...");const o=await Promise.all(t.map(async r=>{try{const l=await m.get(g(`media/videos/${r.id}/segments/`));console.log(`Video ${r.id}: Found ${l.data.length} segments`);const f=l.data.map(v=>M(T(v)));return{...r,segments:f}}catch(l){return console.warn(`Failed to load segments for video ${r.id}:`,l),{...r,segments:[]}}}));return d.value={videos:o,labels:n},console.log("âœ… Processed videos with segments:",d.value),d.value}catch(e){throw console.error("Error loading videos:",e),d.value={videos:[],labels:[]},e}}function ge(){a.value=null}function fe(e){a.value=e}function ve(e){const t=d.value.videos.find(n=>n.id===e)||null;return t?a.value={id:t.id,isAnnotated:!0,errorMessage:"",segments:[],videoUrl:I(t.id)+"?type=processed",status:t.status,assignedUser:t.assignedUser||null}:a.value=null,a.value}async function B(e){try{const t=e||a.value?.id;if(!t){console.warn("No video ID available for fetching video URL"),c.value="No video selected.";return}const n=await m.get(g(`media/videos/${t}/`),{headers:{Accept:"application/json"}});n.data.video_url?(S.value=n.data.video_url,console.log("Fetched video URL:",S.value)):(console.warn("No video URL returned from API response:",n.data),c.value="Video URL not available.")}catch(t){const n=t;console.error("Error loading video URL:",n.response?.data||n.message),c.value="Error loading video URL. Please check the API endpoint or try again later."}}const pe=p(()=>a.value?I(a.value.id)+"?type=processed":"");function he(){if(!a.value?.id){$.value=null;return}const e=a.value.id;m.get(g(`anonymization/${e}/has-raw/`)).then(t=>{$.value=t.data.has_raw_file,console.log(`Raw video file for ID ${e}:`,$.value)}).catch(t=>{console.error("Error checking raw video file:",t),$.value=null})}async function be(e,t="outside"){try{const o=(await m.get(g(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"},params:{label:t}})).data.map(r=>M(T(r)));s[t]=o,a.value&&(a.value.segments=Object.values(s).flat())}catch(n){const o=n;console.error("Error loading segments for label "+t+":",o.response?.data||o.message),c.value=`Error loading segments for label ${t}. Please check the API endpoint or try again later.`}}async function K(e){const t=++F.value;try{const n=await m.get(g(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"}});if(t!==F.value)return;Object.keys(s).forEach(r=>{delete s[r]}),console.log(`[VideoStore] Loading ${n.data.length} segments for video ${e}`),n.data.forEach(r=>{const l=M(T(r)),u=l.label;s[u]||(s[u]=[]),l.endTime-l.startTime<.1&&console.warn(`âš ï¸ Very short segment ${l.id}: ${l.endTime-l.startTime}s`),s[u].push(l)}),console.log("[VideoStore] Processed segments by label:",Object.keys(s).map(r=>`${r}: ${s[r].length}`))}catch(n){if(t===F.value){const o=n;console.error("Error loading video segments:",o.response?.data||o.message),c.value="Error loading video segments. Please try again later."}}}async function Se(e,t,n,o){try{const r=d.value.labels.find(L=>L.name===t);if(!r)return console.error(`Label ${t} not found in store`),c.value=`Label ${t} nicht gefunden`,null;const l=r.id,u=U.value>0&&D.value?.fps||30,f=Math.floor(n*u),v=Math.floor(o*u),y={video_file:e,label:l,start_frame_number:f,end_frame_number:v},b=(await m.post(g(`media/videos/${e}/segments/`),y)).data;let w=T(b);return w={...w,label:t,videoID:e,labelID:l},s[t]||(s[t]=[]),s[t].push(w),console.log("Created segment:",w),w}catch(r){const l=r;return console.error("Error creating segment:",l.response?.data||l.message),c.value="Error creating segment. Please try again.",null}}function ye(e,t,n,o={}){const r=D.value?.fps||30,l=Math.floor(t*r),u=Math.floor(n*r);return{start_time:t,end_time:n,start_frame_number:l,end_frame_number:u,...o}}async function we(e,t){try{const n=a.value?.id;if(!n)return console.error("[VideoStore] Cannot update segment without current video"),!1;const o=ye(e,t.startTime??t.start_time??0,t.endTime??t.end_time??0,t),r=g(`media/videos/${n}/segments/${e}/`),l=await m.patch(r,o),u=T(l.data);return N(e,u),console.log(`[VideoStore] Successfully updated segment ${e}`),!0}catch(n){const o=n;return console.error("Error updating segment:",o.response?.data||o.message),c.value="Error updating segment. Please try again.",C.success({text:"Segment aktualisiert"}),!1}}async function De(e){try{const t=a.value?.id;if(!t)return console.error("[VideoStore] Kann Segment nicht lÃ¶schen: Kein Video ausgewÃ¤hlt"),!1;const n=g(`media/videos/${t}/segments/${e}/`);await m.delete(n);for(const o in s){const r=s[o].findIndex(l=>l.id===e);if(r!==-1){s[o].splice(r,1);break}}return!0}catch(t){const n=t;return console.error("Error deleting segment:",n.response?.data||n.message),c.value="Error deleting segment. Please try again.",!1}}function _e(e){const t=Object.keys(s);for(const n of t)s[n]=s[n].filter(o=>o.id!==e)}function G(e,t){console.log(`[Draft] Starting draft: ${e} at ${A(t)}`),i.value={id:Oe--,label:e,startTime:t,endTime:null},console.log("[Draft] Created draft segment:",i.value)}function W(e){if(!i.value){console.warn("[Draft] Kein aktiver Draft gefunden zum Aktualisieren.");return}const t=i.value.startTime+je,n=Math.max(t,e);i.value.endTime=n,console.log(`[Draft] Draft-Ende aktualisiert: ${A(n)}, Duration: ${n-i.value.startTime}s`)}async function q(){if(console.log("[Draft] commitDraft() called, draftSegment:",i.value),console.log("[Draft] currentVideo:",a.value?.id),!i.value)return console.warn("[Draft] Kein Draft zum Committen gefunden - draftSegment.value ist null/undefined"),null;if(!a.value)return console.warn("[Draft] Kein currentVideo gefunden"),null;const e=i.value;if(e.endTime===null||e.endTime===void 0)return console.error("[Draft] Draft-Ende muss gesetzt sein vor dem Committen. Current endTime:",e.endTime),null;try{const t=d.value.labels.find(b=>b.name===e.label);if(!t)return console.error(`[Draft] Label ${e.label} not found in store`),console.log("[Draft] Available labels:",d.value.labels.map(b=>b.name)),c.value=`Label ${e.label} nicht gefunden`,null;const n=D.value?.fps||30,o=Math.floor(e.startTime*n),r=Math.floor(e.endTime*n),l={video_file:parseInt(a.value.id.toString()),label:t.id,start_frame_number:o,end_frame_number:r};console.log("[Draft] Committing Draft-Segment with payload:",l);const u=a.value?.id;if(!u)return console.error("[Draft] Cannot commit: no current video"),null;const f=await m.post(g(`media/videos/${u}/segments/`),l);console.log("[Draft] API response:",f.data);const v={id:f.data.id,label:e.label,startTime:f.data.startTime,endTime:f.data.endTime,avgConfidence:1,videoID:parseInt(a.value.id.toString()),labelID:t.id,startFrameNumber:f.data.startFrameNumber,endFrameNumber:f.data.endFrameNumber};a.value?.segments&&(a.value.segments.push(v),console.log("[Draft] Added segment to currentVideo.segments, new count:",a.value.segments.length));const y=e.label;s[y]||(s[y]=[]),s[y].push(v),console.log("[Draft] Added segment to segmentsByLabel["+y+"], new count:",s[y].length);try{const{useAnnotationStore:b}=await H(async()=>{const{useAnnotationStore:k}=await import("./annotationStore.js");return{useAnnotationStore:k}},__vite__mapDeps([0,1,2])),{useAuthStore:w}=await H(async()=>{const{useAuthStore:k}=await import("./authStore.js");return{useAuthStore:k}},__vite__mapDeps([3,1,2])),L=b(),P=w();P.initMockUser(),P.user?.id?(await L.createSegmentAnnotation(a.value.id.toString(),v,P.user.id),console.log(`âœ… Created annotation for segment ${v.id}`)):console.warn("No authenticated user found for annotation creation")}catch(b){console.error("Failed to create segment annotation:",b)}const Q={...i.value};return i.value=null,console.log("[Draft] Draft erfolgreich committed und gecleared:",Q,"-> New segment:",v),v}catch(t){return console.error("[Draft] Fehler beim Committen des Draft-Segments:",t),t instanceof J&&t.response?.data&&console.error("[Draft] Backend error details:",t.response.data),c.value=t instanceof J&&(t.response?.data?.detail||t.message)||"Unbekannter Fehler beim Speichern",null}}function Te(){if(!i.value){console.warn("[Draft] Kein Draft zum Abbrechen gefunden.");return}console.log("[Draft] Draft abgebrochen:",i.value),i.value=null}async function $e(e,t){const n=e,o=Math.min(e+X,U.value||e+X);return G(t,n),W(o),await q()}async function Ve(){if(!a.value?.id)return;const e=a.value.id,t=V.value.filter(o=>o.isDirty&&!o.isDraft);if(t.length===0)return;const n={segment_ids:t.map(o=>o.id),segments:t.map(o=>({id:o.id,start_time:o.startTime,end_time:o.endTime})),is_validated:!1,information_source_name:"manual_annotation"};try{await m.post(g(`media/videos/${e}/segments/validate-bulk/`),n),t.forEach(o=>o.isDirty=!1),C.success({text:"Ã„nderungen am Server gespeichert"})}catch(o){console.error("Save failed:",o),C.error({text:"Speichern der Ã„nderungen fehlgeschlagen"})}}async function Ee(e){if(console.log(`[VideoStore] loadVideo called with ID: ${e}`),!Le().overview.some(o=>o.id===Number(e)&&o.mediaType==="video"&&o.anonymizationStatus==="done_processing_anonymization"))throw new Error(`Video ${e} darf nicht annotiert werden, solange die Anonymisierung nicht abgeschlossen ist.`);try{a.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null};try{const r=(await m.get(g(`media/videos/${e}/`))).data;console.log("[VideoStore] Got video metadata:",r),a.value={id:r.id||e,videoUrl:r.video_url||"",status:r.status||"available",assignedUser:r.assignedUser||null,isAnnotated:r.isAnnotated||!1,errorMessage:"",segments:[],duration:r.duration,fps:r.fps}}catch(o){console.warn(`[VideoStore] Could not fetch video metadata for ${e}, using basic object:`,o)}await B(e),await R(e),console.log(`[VideoStore] Video ${e} successfully loaded with ${a.value?.segments?.length||0} segments`)}catch(o){const r=o;console.error(`[VideoStore] Error loading video ${e}:`,r.response?.data||r.message),c.value="Error loading video. Please try again."}}const Ae=p(()=>V.value.map(e=>({id:e.id,label:e.label,label_display:E(e.label),name:E(e.label),startTime:e.startTime,endTime:e.endTime,avgConfidence:e.avgConfidence,video_id:e.videoID,label_id:e.labelID})));function Fe(e,t){N(e,t,!0)}function Ie(e,t){i.value&&i.value.id===e&&Object.assign(i.value,t)}return{currentVideo:_(a),errorMessage:_(c),videoUrl:_(S),segmentsByLabel:s,videoList:_(d),videoMeta:_(D),videos:xe,allSegments:V,draftSegment:i,activeSegment:ae,duration:U,hasVideo:Y,segments:Z,labels:ee,videoStreamUrl:pe,timelineSegments:Ae,hasRawVideoFile:_($),buildVideoStreamUrl:I,setCurrentVideo:ve,clearVideo:ge,deleteVideo:ne,setVideo:fe,loadVideo:Ee,fetchVideoUrl:B,fetchAllSegments:R,fetchAllVideos:me,fetchLabels:z,fetchVideoSegments:K,fetchSegmentsByLabel:be,createSegment:Se,updateSegmentAPI:we,deleteSegment:De,removeSegment:_e,saveAnnotations:ce,getSegmentStyle:se,getColorForLabel:x,getTranslationForLabel:E,jumpToSegment:re,setActiveSegment:oe,updateVideoStatus:de,assignUserToVideo:ue,hasRawVideoFileFn:he,persistDirtySegments:Ve,updateSegmentInMemory:N,startDraft:G,updateDraftEnd:W,commitDraft:q,cancelDraft:Te,createFiveSecondSegment:$e,patchDraftSegment:Ie,patchSegmentLocally:Fe,backendSegmentToSegment:T,formatTime:A,getSegmentOptions:le,clearSegments:ie}});export{A as f,E as g,ze as u};
