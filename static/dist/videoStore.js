const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["annotationStore.js","main.js","main.css","authStore.js"])))=>i.map(i=>d[i]);
import{O as Le,h as b,I as Pe,e as p,M as D,z as m,A as f,f as Ce,P as J,Q as X,g as xe}from"./main.js";const Oe={appendix:"Appendix",blood:"Blut",diverticule:"Divertikel",grasper:"Greifer",ileocaecalvalve:"IleozÃ¤kalklappe",ileum:"Ileum",low_quality:"Niedrige BildqualitÃ¤t",nbi:"Narrow Band Imaging",needle:"Nadel",outside:"AuÃŸerhalb",polyp:"Polyp",snare:"Snare",water_jet:"Wasserstrahl",wound:"Wunde"};function V(a){return Oe[a]??a}const ke={outside:"#e74c3c",polyp:"#f39c12",needle:"#3498db",blood:"#e74c3c",snare:"#9b59b6",grasper:"#2ecc71",water_jet:"#1abc9c",appendix:"#f1c40f",ileum:"#e67e22",diverticule:"#34495e",ileocaecalvalve:"#95a5a6",nbi:"#8e44ad",low_quality:"#7f8c8d",wound:"#c0392b"};function x(a){return ke[a]??"#95a5a6"}const E=a=>{if(!a||a<0)return"00:00";const u=Math.floor(a/60),w=Math.floor(a%60);return`${u.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}`};function Y(a){return Array.isArray(a)?a:a&&Array.isArray(a.results)?a.results:[]}function T(a){const u=a.labelName??a.labelDisplay??"unknown";let w;return a.timeSegments?.frames?.length&&(w=a.timeSegments.frames.reduce((i,c)=>(i[String(c.frameId)]=c,i),{})),{id:a.id,label:u,startTime:a.startTime,endTime:a.endTime,avgConfidence:1,videoID:a.videoId??a.videoFile,labelID:a.labelId??(typeof a.label=="number"?a.label:null),startFrameNumber:a.startFrameNumber,endFrameNumber:a.endFrameNumber,frames:w}}const je=b([]),O=Ce(),ze={},Re=1/50,Z=5;let Be=-1;const We=Le("video",()=>{const a=b(null),u=b(""),w=b(""),i=Pe({...ze}),c=b({videos:[],labels:[]}),y=b(null),k=b(null),N=b(0),l=b(null),$=b(null);function F(e){return`${window.location.origin}/api/media/videos/${e}/`}const ee=p(()=>!!a.value),j=p(()=>y.value?.duration?y.value.duration:a.value?.duration?a.value.duration:0),I=()=>{const e=y.value?.fps??a.value?.fps??50;return Number.isFinite(e)&&e>0?e:50},te=p(()=>a.value?.segments||[]),ae=p(()=>c.value?.labels||[]),z=p(()=>{const e={};return c.value.labels.forEach(t=>e[t.name]=t.id),e});function M(e){return{...e,labelID:e.labelID??z.value[e.label]??null}}const A=p(()=>{const e=[...a.value?.segments||[]];if(l.value){const t={id:l.value.id,label:l.value.label,startTime:l.value.startTime,endTime:l.value.endTime||l.value.startTime,avgConfidence:0,labelID:z.value[l.value.label]??null,isDraft:!0};e.push(t)}return e}),ne=p(()=>A.value.map(e=>({id:e.id,label:V(e.label),startTime:e.startTime,endTime:e.endTime,display:`${V(e.label)}: ${E(e.startTime)} â€“ ${E(e.endTime)}`}))),re=p(()=>A.value.find(e=>e.id===k.value)||null);async function oe(e){if(e||(e=a.value?.id||null),!e)return console.error(`Invalid video ID: ${e}`),!1;try{return await m.delete(`/api/media-management/${e}/force-remove/`),!0}catch(t){return console.error(`Failed to delete video ${e}:`,t),!1}}function se(e){k.value=e}function ie(e,t){t&&e.startTime&&(t.currentTime=e.startTime,t.play().catch(console.error))}function le(e,t){const r=e.startTime/t*100,n=(e.endTime-e.startTime)/t*100;return{left:`${r}%`,width:`${n}%`,backgroundColor:x(e.label)}}function U(e,t,r=!1){for(const n in i){const o=i[n].find(s=>s.id===e);if(o){Object.assign(o,t),r&&!o.isDraft&&(o.isDirty=!0);break}}}function de(){return ne.value}function ce(){Object.keys(i).forEach(e=>{delete i[e]})}async function R(e){if(console.log(`[VideoStore] fetchAllSegments called with video ID: ${e}`),a.value||(console.log(`[VideoStore] No currentVideo found, creating basic video object for ID: ${e}`),a.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null}),await W(e),a.value){const t=[];Object.values(i).forEach(r=>{t.push(...r)}),a.value.segments=t,console.log(`[VideoStore] Timeline segments populated: ${t.length} segments for video ${e}`)}}async function ue(){console.log("Saving annotations...")}async function me(e){a.value&&(a.value.status=e)}async function fe(e){a.value&&(a.value.assignedUser=e)}async function B(){console.log("ðŸ·ï¸ [VideoStore] Fetching labels with high priority...");try{const t=(await m.get(f("media/videos/labels/list/"))).data.map(r=>({id:Number(r.id),name:String(r.name),color:r.color||x(r.name)}));return c.value.labels=t,console.log(`âœ… [VideoStore] Loaded ${t.length} labels`),t}catch(e){throw console.error("âŒ Error loading labels:",e),c.value.labels=[],e}}async function ge(){console.log("Fetching all videos...");try{await B();const e=await m.get(f("media/videos/"));console.log("API Response:",e.data);const r=(Array.isArray(e.data?.results)?e.data.results:Array.isArray(e.data?.videos)?e.data.videos:Array.isArray(e.data)?e.data:[]).map(s=>({id:parseInt(s.id),original_file_name:s.original_file_name,status:s.status||"available",assignedUser:s.assignedUser||null,anonymized:s.anonymized||!1,centerName:s.centerName||s.center_name||"Unbekannt",processorName:s.processorName||s.processor_name||"Unbekannt"})),n=c.value.labels;console.log("Fetching segments for",r.length,"videos...");const o=await Promise.all(r.map(async s=>{try{const d=await m.get(f(`media/videos/${s.id}/segments/`)),g=Array.isArray(d.data?.results)?d.data.results:Array.isArray(d.data)?d.data:[];console.log(`Video ${s.id}: Found ${g.length} segments`);const v=g.map(h=>M(T(h)));return{...s,segments:v}}catch(d){return console.warn(`Failed to load segments for video ${s.id}:`,d),{...s,segments:[]}}}));return c.value={videos:o,labels:n},console.log("âœ… Processed videos with segments:",c.value),c.value}catch(e){throw console.error("Error loading videos:",e),c.value={videos:[],labels:[]},e}}function ve(){a.value=null,y.value=null}function pe(e){a.value=e}function be(e){const t=c.value.videos.find(r=>r.id===e)||null;return t?a.value={id:t.id,isAnnotated:!0,errorMessage:"",segments:[],videoUrl:F(t.id)+"?type=processed",status:t.status,assignedUser:t.assignedUser||null}:a.value=null,a.value}async function he(e){try{const t=e||a.value?.id;if(!t){console.warn("No video ID available for fetching video metadata");return}const n=(await m.get(f(`media/videos/${t}/metadata/`),{headers:{Accept:"application/json"}})).data??{},o={id:Number(n.id??t),original_file_name:String(n.original_file_name??n.originalFileName??""),status:String(n.status??"available"),assignedUser:n.assignedUser==="BLANK"?null:n.assignedUser,anonymized:!!(n.anonymized??!1),duration:n.duration!==void 0?Number(n.duration):void 0,fps:n.fps!==void 0?Number(n.fps):50,hasROI:!!(n.hasROI??n.has_roi??!1),outsideFrameCount:Number(n.outsideFrameCount??n.outside_frame_count??0),centerName:String(n.centerName??n.center_name??"Unbekannt"),processorName:String(n.processorName??n.processor_name??"Unbekannt")};y.value=o,a.value&&(o.duration!==void 0&&o.duration>0&&(a.value.duration=o.duration),o.fps!==void 0&&o.fps>0&&(a.value.fps=o.fps)),console.log("[VideoStore] Video metadata loaded:",o)}catch(t){const r=t;console.error("Error loading video metadata:",r.response?.data||r.message)}}async function K(e){try{const t=e||a.value?.id;if(!t)return;const r=await m.get(f(`media/videos/${t}/`),{headers:{Accept:"application/json"}});r.data.video_url&&(w.value=r.data.video_url),a.value&&(r.data.duration&&!y.value?.duration&&(a.value.duration=Number(r.data.duration)),r.data.fps&&!y.value?.fps&&(a.value.fps=Number(r.data.fps)))}catch{console.error("Error loading video URL")}}const Se=p(()=>a.value?F(a.value.id)+"?type=processed":"");function ye(){if(!a.value?.id){$.value=null;return}const e=a.value.id;m.get(f(`anonymization/${e}/has-raw/`)).then(t=>{$.value=t.data.has_raw_file,console.log(`Raw video file for ID ${e}:`,$.value)}).catch(t=>{console.error("Error checking raw video file:",t),$.value=null})}async function we(e,t="outside"){try{const r=await m.get(f(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"},params:{label:t}}),o=Y(r.data).map(s=>M(T(s)));i[t]=o,a.value&&(a.value.segments=Object.values(i).flat())}catch(r){const n=r;console.error("Error loading segments for label "+t+":",n.response?.data||n.message),u.value=`Error loading segments for label ${t}. Please check the API endpoint or try again later.`}}async function W(e){const t=++N.value;try{const r=await m.get(f(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"}});if(t!==N.value)return;const n=Y(r.data);Object.keys(i).forEach(o=>{delete i[o]}),console.log(`[VideoStore] Loading ${n.length} segments for video ${e}`),n.forEach(o=>{const s=M(T(o)),d=s.label;i[d]||(i[d]=[]),s.endTime-s.startTime<.1&&console.warn(`âš ï¸ Very short segment ${s.id}: ${s.endTime-s.startTime}s`),i[d].push(s)}),console.log("[VideoStore] Processed segments by label:",Object.keys(i).map(o=>`${o}: ${i[o].length}`))}catch(r){if(t===N.value){const n=r;console.error("Error loading video segments:",n.response?.data||n.message),u.value="Error loading video segments. Please try again later."}}}async function _e(e,t,r,n){try{const o=c.value.labels.find(L=>L.name===t);if(!o)return console.error(`Label ${t} not found in store`),u.value=`Label ${t} nicht gefunden`,null;const s=o.id,d=I(),g=Math.floor(r*d),v=Math.floor(n*d),h={video_file:e,label:s,start_frame_number:g,end_frame_number:v},S=(await m.post(f(`media/videos/${e}/segments/`),h)).data;let _=T(S);return _={..._,label:t,videoID:e,labelID:s},i[t]||(i[t]=[]),i[t].push(_),console.log("Created segment:",_),_}catch(o){const s=o;return console.error("Error creating segment:",s.response?.data||s.message),u.value="Error creating segment. Please try again.",null}}function De(e,t,r,n={}){const o=I(),s=Math.floor(t*o),d=Math.floor(r*o);return{start_time:t,end_time:r,start_frame_number:s,end_frame_number:d,...n}}async function Te(e,t){try{const r=a.value?.id;if(!r)return console.error("[VideoStore] Cannot update segment without current video"),!1;const n=De(e,t.startTime??t.start_time??0,t.endTime??t.end_time??0,t),o=f(`media/videos/${r}/segments/${e}/`),s=await m.patch(o,n),d=T(s.data);return U(e,d),console.log(`[VideoStore] Successfully updated segment ${e}`),!0}catch(r){const n=r;return console.error("Error updating segment:",n.response?.data||n.message),u.value="Error updating segment. Please try again.",O.success({text:"Segment aktualisiert"}),!1}}async function $e(e){try{const t=a.value?.id;if(!t)return console.error("[VideoStore] Kann Segment nicht lÃ¶schen: Kein Video ausgewÃ¤hlt"),!1;const r=f(`media/videos/${t}/segments/${e}/`);await m.delete(r);for(const n in i){const o=i[n].findIndex(s=>s.id===e);if(o!==-1){i[n].splice(o,1);break}}return!0}catch(t){const r=t;return console.error("Error deleting segment:",r.response?.data||r.message),u.value="Error deleting segment. Please try again.",!1}}function Ae(e){const t=Object.keys(i);for(const r of t)i[r]=i[r].filter(n=>n.id!==e)}function q(e,t){console.log(`[Draft] Starting draft: ${e} at ${E(t)}`),l.value={id:Be--,label:e,startTime:t,endTime:null},console.log("[Draft] Created draft segment:",l.value)}function G(e){if(!l.value){console.warn("[Draft] Kein aktiver Draft gefunden zum Aktualisieren.");return}const t=l.value.startTime+Re,r=Math.max(t,e);l.value.endTime=r,console.log(`[Draft] Draft-Ende aktualisiert: ${E(r)}, Duration: ${r-l.value.startTime}s`)}async function Q(){if(console.log("[Draft] commitDraft() called, draftSegment:",l.value),console.log("[Draft] currentVideo:",a.value?.id),!l.value)return console.warn("[Draft] Kein Draft zum Committen gefunden - draftSegment.value ist null/undefined"),null;if(!a.value)return console.warn("[Draft] Kein currentVideo gefunden"),null;const e=l.value;if(e.endTime===null||e.endTime===void 0)return console.error("[Draft] Draft-Ende muss gesetzt sein vor dem Committen. Current endTime:",e.endTime),null;try{const t=c.value.labels.find(S=>S.name===e.label);if(!t)return console.error(`[Draft] Label ${e.label} not found in store`),console.log("[Draft] Available labels:",c.value.labels.map(S=>S.name)),u.value=`Label ${e.label} nicht gefunden`,null;const r=I(),n=Math.floor(e.startTime*r),o=Math.floor(e.endTime*r),s={video_file:parseInt(a.value.id.toString()),label:t.id,start_frame_number:n,end_frame_number:o};console.log("[Draft] Committing Draft-Segment with payload:",s);const d=a.value?.id;if(!d)return console.error("[Draft] Cannot commit: no current video"),null;const g=await m.post(f(`media/videos/${d}/segments/`),s);console.log("[Draft] API response:",g.data);const v={id:g.data.id,label:e.label,startTime:g.data.startTime,endTime:g.data.endTime,avgConfidence:1,videoID:parseInt(a.value.id.toString()),labelID:t.id,startFrameNumber:g.data.startFrameNumber,endFrameNumber:g.data.endFrameNumber};a.value?.segments&&(a.value.segments.push(v),console.log("[Draft] Added segment to currentVideo.segments, new count:",a.value.segments.length));const h=e.label;i[h]||(i[h]=[]),i[h].push(v),console.log("[Draft] Added segment to segmentsByLabel["+h+"], new count:",i[h].length);try{const{useAnnotationStore:S}=await J(async()=>{const{useAnnotationStore:C}=await import("./annotationStore.js");return{useAnnotationStore:C}},__vite__mapDeps([0,1,2])),{useAuthStore:_}=await J(async()=>{const{useAuthStore:C}=await import("./authStore.js");return{useAuthStore:C}},__vite__mapDeps([3,1,2])),L=S(),P=_();P.initMockUser(),P.user?.id?(await L.createSegmentAnnotation(a.value.id.toString(),v,P.user.id),console.log(`âœ… Created annotation for segment ${v.id}`)):console.warn("No authenticated user found for annotation creation")}catch(S){console.error("Failed to create segment annotation:",S)}const H={...l.value};return l.value=null,console.log("[Draft] Draft erfolgreich committed und gecleared:",H,"-> New segment:",v),v}catch(t){return console.error("[Draft] Fehler beim Committen des Draft-Segments:",t),t instanceof X&&t.response?.data&&console.error("[Draft] Backend error details:",t.response.data),u.value=t instanceof X&&(t.response?.data?.detail||t.message)||"Unbekannter Fehler beim Speichern",null}}function Ve(){if(!l.value){console.warn("[Draft] Kein Draft zum Abbrechen gefunden.");return}console.log("[Draft] Draft abgebrochen:",l.value),l.value=null}async function Ee(e,t){const r=e,n=Math.min(e+Z,j.value||e+Z);return q(t,r),G(n),await Q()}async function Ne(){if(!a.value?.id)return;const e=a.value.id,t=A.value.filter(n=>n.isDirty&&!n.isDraft);if(t.length===0)return;const r={segment_ids:t.map(n=>n.id),segments:t.map(n=>({id:n.id,start_time:n.startTime,end_time:n.endTime})),is_validated:!1,information_source_name:"manual_annotation"};try{await m.post(f(`media/videos/${e}/segments/validate-bulk/`),r),t.forEach(n=>n.isDirty=!1),O.success({text:"Ã„nderungen am Server gespeichert"})}catch(n){console.error("Save failed:",n),O.error({text:"Speichern der Ã„nderungen fehlgeschlagen"})}}async function Fe(e){if(console.log(`[VideoStore] loadVideo called with ID: ${e}`),!xe().overview.some(n=>n.id===Number(e)&&n.mediaType==="video"&&n.anonymizationStatus==="done_processing_anonymization"))throw new Error(`Video ${e} darf nicht annotiert werden, solange die Anonymisierung nicht abgeschlossen ist.`);try{a.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null,duration:0,fps:50},await Promise.all([he(e),K(e),R(e)]),console.log(`[VideoStore] Video ${e} loaded. Duration: ${a.value?.duration}s, FPS: ${a.value?.fps}, Segments: ${a.value?.segments?.length}`)}catch(n){const o=n;console.error(`[VideoStore] Error loading video ${e}:`,o.response?.data||o.message),u.value="Error loading video. Please try again."}}const Ie=p(()=>A.value.map(e=>({id:e.id,label:e.label,label_display:V(e.label),name:V(e.label),startTime:e.startTime,endTime:e.endTime,avgConfidence:e.avgConfidence,video_id:e.videoID,label_id:e.labelID})));function Me(e,t){U(e,t,!0)}function Ue(e,t){l.value&&l.value.id===e&&Object.assign(l.value,t)}return{currentVideo:D(a),errorMessage:D(u),videoUrl:D(w),segmentsByLabel:i,videoList:D(c),videoMeta:D(y),videos:je,allSegments:A,draftSegment:l,activeSegment:re,duration:j,hasVideo:ee,segments:te,labels:ae,videoStreamUrl:Se,timelineSegments:Ie,hasRawVideoFile:D($),buildVideoStreamUrl:F,setCurrentVideo:be,clearVideo:ve,deleteVideo:oe,setVideo:pe,loadVideo:Fe,fetchVideoUrl:K,fetchAllSegments:R,fetchAllVideos:ge,fetchLabels:B,fetchVideoSegments:W,fetchSegmentsByLabel:we,createSegment:_e,updateSegmentAPI:Te,deleteSegment:$e,removeSegment:Ae,saveAnnotations:ue,getSegmentStyle:le,getColorForLabel:x,getTranslationForLabel:V,jumpToSegment:ie,setActiveSegment:se,updateVideoStatus:me,assignUserToVideo:fe,hasRawVideoFileFn:ye,persistDirtySegments:Ne,updateSegmentInMemory:U,startDraft:q,updateDraftEnd:G,commitDraft:Q,cancelDraft:Ve,createFiveSecondSegment:Ee,patchDraftSegment:Ue,patchSegmentLocally:Me,backendSegmentToSegment:T,formatTime:E,getSegmentOptions:de,clearSegments:ce}});export{E as f,V as g,We as u};
