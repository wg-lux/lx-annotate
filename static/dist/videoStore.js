const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./annotationStore.js","./main.js","./main.css","./authStore.js"])))=>i.map(i=>d[i]);
import{O as Ie,h as b,I as Ue,e as p,M as T,z as m,A as g,P as H,Q as J,g as Me}from"./main.js";const Ne={appendix:"Appendix",blood:"Blut",diverticule:"Divertikel",grasper:"Greifer",ileocaecalvalve:"IleozÃ¤kalklappe",ileum:"Ileum",low_quality:"Niedrige BildqualitÃ¤t",nbi:"Narrow Band Imaging",needle:"Nadel",outside:"AuÃŸerhalb",polyp:"Polyp",snare:"Snare",water_jet:"Wasserstrahl",wound:"Wunde"};function E(n){return Ne[n]??n}const Le={outside:"#e74c3c",polyp:"#f39c12",needle:"#3498db",blood:"#e74c3c",snare:"#9b59b6",grasper:"#2ecc71",water_jet:"#1abc9c",appendix:"#f1c40f",ileum:"#e67e22",diverticule:"#34495e",ileocaecalvalve:"#95a5a6",nbi:"#8e44ad",low_quality:"#7f8c8d",wound:"#c0392b"};function C(n){return Le[n]??"#95a5a6"}const A=n=>{if(!n||n<0)return"00:00";const c=Math.floor(n/60),S=Math.floor(n%60);return`${c.toString().padStart(2,"0")}:${S.toString().padStart(2,"0")}`};function $(n){const c=n.labelName??n.labelDisplay??"unknown";let S;return n.timeSegments?.frames?.length&&(S=n.timeSegments.frames.reduce((s,d)=>(s[String(d.frameId)]=d,s),{})),{id:n.id,label:c,startTime:n.startTime,endTime:n.endTime,avgConfidence:1,videoID:n.videoId,labelID:n.labelId,startFrameNumber:n.startFrameNumber,endFrameNumber:n.endFrameNumber,frames:S}}const Pe=b([]),ke={},Ce=1/50,X=5;let xe=-1;const Oe=Ie("video",()=>{const n=b(null),c=b(""),S=b(""),s=Ue({...ke}),d=b({videos:[],labels:[]}),D=b(null),x=b(null),F=b(0),i=b(null),_=b(null);function I(e){return`${window.location.origin}/api/media/videos/${e}/`}const Y=p(()=>!!n.value),U=p(()=>D.value?.duration?D.value.duration:0),Z=p(()=>n.value?.segments||[]),ee=p(()=>d.value?.labels||[]),j=p(()=>{const e={};return d.value.labels.forEach(t=>e[t.name]=t.id),e});function M(e){return{...e,labelID:e.labelID??j.value[e.label]??null}}const V=p(()=>{const e=[...n.value?.segments||[]];if(i.value){const t={id:i.value.id,label:i.value.label,startTime:i.value.startTime,endTime:i.value.endTime||i.value.startTime,avgConfidence:0,labelID:j.value[i.value.label]??null,isDraft:!0};e.push(t)}return e}),te=p(()=>V.value.map(e=>({id:e.id,label:E(e.label),startTime:e.startTime,endTime:e.endTime,display:`${E(e.label)}: ${A(e.startTime)} â€“ ${A(e.endTime)}`}))),ne=p(()=>V.value.find(e=>e.id===x.value)||null);async function ae(e){if(e||(e=n.value?.id||null),!e)return console.error(`Invalid video ID: ${e}`),!1;try{return await m.delete(`/api/media-management/${e}/force-remove/`),!0}catch(t){return console.error(`Failed to delete video ${e}:`,t),!1}}function oe(e){x.value=e}function re(e,t){t&&e.startTime&&(t.currentTime=e.startTime,t.play().catch(console.error))}function se(e,t){const a=e.startTime/t*100,r=(e.endTime-e.startTime)/t*100;return{left:`${a}%`,width:`${r}%`,backgroundColor:C(e.label)}}function N(e,t,a=!1){for(const r in s){const o=s[r].find(l=>l.id===e);if(o){Object.assign(o,t),a&&!o.isDraft&&(o.isDirty=!0);break}}}function le(){return te.value}function ie(){Object.keys(s).forEach(e=>{delete s[e]})}async function O(e){if(console.log(`[VideoStore] fetchAllSegments called with video ID: ${e}`),n.value||(console.log(`[VideoStore] No currentVideo found, creating basic video object for ID: ${e}`),n.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null}),await B(e),n.value){const t=[];Object.values(s).forEach(a=>{t.push(...a)}),n.value.segments=t,console.log(`[VideoStore] Timeline segments populated: ${t.length} segments for video ${e}`)}}async function ce(){console.log("Saving annotations...")}async function de(e){n.value&&(n.value.status=e)}async function ue(e){n.value&&(n.value.assignedUser=e)}async function R(){console.log("ðŸ·ï¸ [VideoStore] Fetching labels with high priority...");try{const t=(await m.get(g("media/videos/labels/list/"))).data.map(a=>({id:Number(a.id),name:String(a.name),color:a.color||C(a.name)}));return d.value.labels=t,console.log(`âœ… [VideoStore] Loaded ${t.length} labels`),t}catch(e){throw console.error("âŒ Error loading labels:",e),d.value.labels=[],e}}async function me(){console.log("Fetching all videos...");try{await R();const e=await m.get(g("media/videos/"));console.log("API Response:",e.data);const t=e.data.videos.map(o=>({id:parseInt(o.id),original_file_name:o.original_file_name,status:o.status||"available",assignedUser:o.assignedUser||null,anonymized:o.anonymized||!1,centerName:o.center_name||"Unbekannt",processorName:o.processor_name||"Unbekannt"})),a=d.value.labels;console.log("Fetching segments for",t.length,"videos...");const r=await Promise.all(t.map(async o=>{try{const l=await m.get(g(`media/videos/${o.id}/segments/`));console.log(`Video ${o.id}: Found ${l.data.length} segments`);const f=l.data.map(v=>M($(v)));return{...o,segments:f}}catch(l){return console.warn(`Failed to load segments for video ${o.id}:`,l),{...o,segments:[]}}}));return d.value={videos:r,labels:a},console.log("âœ… Processed videos with segments:",d.value),d.value}catch(e){throw console.error("Error loading videos:",e),d.value={videos:[],labels:[]},e}}function ge(){n.value=null}function fe(e){n.value=e}function ve(e){const t=d.value.videos.find(a=>a.id===e)||null;return t?n.value={id:t.id,isAnnotated:!0,errorMessage:"",segments:[],videoUrl:I(t.id)+"?type=processed",status:t.status,assignedUser:t.assignedUser||null}:n.value=null,n.value}async function z(e){try{const t=e||n.value?.id;if(!t){console.warn("No video ID available for fetching video URL"),c.value="No video selected.";return}const a=await m.get(g(`media/videos/${t}/`),{headers:{Accept:"application/json"}});a.data.video_url?(S.value=a.data.video_url,console.log("Fetched video URL:",S.value)):(console.warn("No video URL returned from API response:",a.data),c.value="Video URL not available.")}catch(t){const a=t;console.error("Error loading video URL:",a.response?.data||a.message),c.value="Error loading video URL. Please check the API endpoint or try again later."}}const pe=p(()=>n.value?I(n.value.id)+"?type=processed":"");function be(){if(!n.value?.id){_.value=null;return}const e=n.value.id;m.get(g(`anonymization/${e}/has-raw/`)).then(t=>{_.value=t.data.has_raw_file,console.log(`Raw video file for ID ${e}:`,_.value)}).catch(t=>{console.error("Error checking raw video file:",t),_.value=null})}async function he(e,t="outside"){try{const r=(await m.get(g(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"},params:{label:t}})).data.map(o=>M($(o)));s[t]=r,n.value&&(n.value.segments=Object.values(s).flat())}catch(a){const r=a;console.error("Error loading segments for label "+t+":",r.response?.data||r.message),c.value=`Error loading segments for label ${t}. Please check the API endpoint or try again later.`}}async function B(e){const t=++F.value;try{const a=await m.get(g(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"}});if(t!==F.value)return;Object.keys(s).forEach(o=>{delete s[o]}),console.log(`[VideoStore] Loading ${a.data.length} segments for video ${e}`),a.data.forEach(o=>{const l=M($(o)),u=l.label;s[u]||(s[u]=[]),l.endTime-l.startTime<.1&&console.warn(`âš ï¸ Very short segment ${l.id}: ${l.endTime-l.startTime}s`),s[u].push(l)}),console.log("[VideoStore] Processed segments by label:",Object.keys(s).map(o=>`${o}: ${s[o].length}`))}catch(a){if(t===F.value){const r=a;console.error("Error loading video segments:",r.response?.data||r.message),c.value="Error loading video segments. Please try again later."}}}async function Se(e,t,a,r){try{const o=d.value.labels.find(L=>L.name===t);if(!o)return console.error(`Label ${t} not found in store`),c.value=`Label ${t} nicht gefunden`,null;const l=o.id,u=U.value>0&&D.value?.fps||30,f=Math.floor(a*u),v=Math.floor(r*u),y={video_file:e,label:l,start_frame_number:f,end_frame_number:v},h=(await m.post(g(`media/videos/${e}/segments/`),y)).data;let w=$(h);return w={...w,label:t,videoID:e,labelID:l},s[t]||(s[t]=[]),s[t].push(w),console.log("Created segment:",w),w}catch(o){const l=o;return console.error("Error creating segment:",l.response?.data||l.message),c.value="Error creating segment. Please try again.",null}}function ye(e,t,a,r={}){const o=D.value?.fps||30,l=Math.floor(t*o),u=Math.floor(a*o);return{start_time:t,end_time:a,start_frame_number:l,end_frame_number:u,...r}}async function G(e,t){try{const a=n.value?.id;if(!a)return console.error("[VideoStore] Cannot update segment without current video"),!1;const r=ye(e,t.startTime??t.start_time??0,t.endTime??t.end_time??0,t),o=g(`media/videos/${a}/segments/${e}/`),l=await m.patch(o,r),u=$(l.data);return N(e,u),console.log(`[VideoStore] Successfully updated segment ${e}`),!0}catch(a){const r=a;return console.error("Error updating segment:",r.response?.data||r.message),c.value="Error updating segment. Please try again.",!1}}async function we(e){try{const t=n.value?.id;if(!t)return console.error("[VideoStore] Cannot delete segment without current video"),!1;const a=g(`media/videos/${t}/segments/${e}/`);await m.delete(a);for(const r in s){const o=s[r].findIndex(l=>l.id===e);if(o!==-1){s[r].splice(o,1);break}}return!0}catch(t){const a=t;return console.error("Error deleting segment:",a.response?.data||a.message),c.value="Error deleting segment. Please try again.",!1}}function De(e){const t=Object.keys(s);for(const a of t)s[a]=s[a].filter(r=>r.id!==e)}function K(e,t){console.log(`[Draft] Starting draft: ${e} at ${A(t)}`),i.value={id:xe--,label:e,startTime:t,endTime:null},console.log("[Draft] Created draft segment:",i.value)}function W(e){if(!i.value){console.warn("[Draft] Kein aktiver Draft gefunden zum Aktualisieren.");return}const t=i.value.startTime+Ce,a=Math.max(t,e);i.value.endTime=a,console.log(`[Draft] Draft-Ende aktualisiert: ${A(a)}, Duration: ${a-i.value.startTime}s`)}async function q(){if(console.log("[Draft] commitDraft() called, draftSegment:",i.value),console.log("[Draft] currentVideo:",n.value?.id),!i.value)return console.warn("[Draft] Kein Draft zum Committen gefunden - draftSegment.value ist null/undefined"),null;if(!n.value)return console.warn("[Draft] Kein currentVideo gefunden"),null;const e=i.value;if(e.endTime===null||e.endTime===void 0)return console.error("[Draft] Draft-Ende muss gesetzt sein vor dem Committen. Current endTime:",e.endTime),null;try{const t=d.value.labels.find(h=>h.name===e.label);if(!t)return console.error(`[Draft] Label ${e.label} not found in store`),console.log("[Draft] Available labels:",d.value.labels.map(h=>h.name)),c.value=`Label ${e.label} nicht gefunden`,null;const a=D.value?.fps||30,r=Math.floor(e.startTime*a),o=Math.floor(e.endTime*a),l={video_file:parseInt(n.value.id.toString()),label:t.id,start_frame_number:r,end_frame_number:o};console.log("[Draft] Committing Draft-Segment with payload:",l);const u=n.value?.id;if(!u)return console.error("[Draft] Cannot commit: no current video"),null;const f=await m.post(g(`media/videos/${u}/segments/`),l);console.log("[Draft] API response:",f.data);const v={id:f.data.id,label:e.label,startTime:f.data.startTime,endTime:f.data.endTime,avgConfidence:1,videoID:parseInt(n.value.id.toString()),labelID:t.id,startFrameNumber:f.data.startFrameNumber,endFrameNumber:f.data.endFrameNumber};n.value?.segments&&(n.value.segments.push(v),console.log("[Draft] Added segment to currentVideo.segments, new count:",n.value.segments.length));const y=e.label;s[y]||(s[y]=[]),s[y].push(v),console.log("[Draft] Added segment to segmentsByLabel["+y+"], new count:",s[y].length);try{const{useAnnotationStore:h}=await H(async()=>{const{useAnnotationStore:k}=await import("./annotationStore.js");return{useAnnotationStore:k}},__vite__mapDeps([0,1,2]),import.meta.url),{useAuthStore:w}=await H(async()=>{const{useAuthStore:k}=await import("./authStore.js");return{useAuthStore:k}},__vite__mapDeps([3,1,2]),import.meta.url),L=h(),P=w();P.initMockUser(),P.user?.id?(await L.createSegmentAnnotation(n.value.id.toString(),v,P.user.id),console.log(`âœ… Created annotation for segment ${v.id}`)):console.warn("No authenticated user found for annotation creation")}catch(h){console.error("Failed to create segment annotation:",h)}const Q={...i.value};return i.value=null,console.log("[Draft] Draft erfolgreich committed und gecleared:",Q,"-> New segment:",v),v}catch(t){return console.error("[Draft] Fehler beim Committen des Draft-Segments:",t),t instanceof J&&t.response?.data&&console.error("[Draft] Backend error details:",t.response.data),c.value=t instanceof J&&(t.response?.data?.detail||t.message)||"Unbekannter Fehler beim Speichern",null}}function Te(){if(!i.value){console.warn("[Draft] Kein Draft zum Abbrechen gefunden.");return}console.log("[Draft] Draft abgebrochen:",i.value),i.value=null}async function $e(e,t){const a=e,r=Math.min(e+X,U.value||e+X);return K(t,a),W(r),await q()}async function _e(){const e=V.value.filter(t=>t.isDirty&&!t.isDraft);if(!e.length){console.log("[VideoStore] No dirty segments to persist");return}console.log(`[VideoStore] Persisting ${e.length} dirty segments...`);for(const t of e)await G(t.id,{startTime:t.startTime,endTime:t.endTime})&&(t.isDirty=!1)}async function Ve(e){if(console.log(`[VideoStore] loadVideo called with ID: ${e}`),!Me().overview.some(r=>r.id===Number(e)&&r.mediaType==="video"&&r.anonymizationStatus==="done_processing_anonymization"))throw new Error(`Video ${e} darf nicht annotiert werden, solange die Anonymisierung nicht abgeschlossen ist.`);try{n.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null};try{const o=(await m.get(g(`media/videos/${e}/`))).data;console.log("[VideoStore] Got video metadata:",o),n.value={id:o.id||e,videoUrl:o.video_url||"",status:o.status||"available",assignedUser:o.assignedUser||null,isAnnotated:o.isAnnotated||!1,errorMessage:"",segments:[],duration:o.duration,fps:o.fps}}catch(r){console.warn(`[VideoStore] Could not fetch video metadata for ${e}, using basic object:`,r)}await z(e),await O(e),console.log(`[VideoStore] Video ${e} successfully loaded with ${n.value?.segments?.length||0} segments`)}catch(r){const o=r;console.error(`[VideoStore] Error loading video ${e}:`,o.response?.data||o.message),c.value="Error loading video. Please try again."}}const Ee=p(()=>V.value.map(e=>({id:e.id,label:e.label,label_display:E(e.label),name:E(e.label),startTime:e.startTime,endTime:e.endTime,avgConfidence:e.avgConfidence,video_id:e.videoID,label_id:e.labelID})));function Ae(e,t){N(e,t,!0)}function Fe(e,t){i.value&&i.value.id===e&&Object.assign(i.value,t)}return{currentVideo:T(n),errorMessage:T(c),videoUrl:T(S),segmentsByLabel:s,videoList:T(d),videoMeta:T(D),videos:Pe,allSegments:V,draftSegment:i,activeSegment:ne,duration:U,hasVideo:Y,segments:Z,labels:ee,videoStreamUrl:pe,timelineSegments:Ee,hasRawVideoFile:T(_),buildVideoStreamUrl:I,setCurrentVideo:ve,clearVideo:ge,deleteVideo:ae,setVideo:fe,loadVideo:Ve,fetchVideoUrl:z,fetchAllSegments:O,fetchAllVideos:me,fetchLabels:R,fetchVideoSegments:B,fetchSegmentsByLabel:he,createSegment:Se,updateSegmentAPI:G,deleteSegment:we,removeSegment:De,saveAnnotations:ce,getSegmentStyle:se,getColorForLabel:C,getTranslationForLabel:E,jumpToSegment:re,setActiveSegment:oe,updateVideoStatus:de,assignUserToVideo:ue,hasRawVideoFileFn:be,persistDirtySegments:_e,updateSegmentInMemory:N,startDraft:K,updateDraftEnd:W,commitDraft:q,cancelDraft:Te,createFiveSecondSegment:$e,patchDraftSegment:Fe,patchSegmentLocally:Ae,backendSegmentToSegment:$,formatTime:A,getSegmentOptions:le,clearSegments:ie}});export{A as f,E as g,Oe as u};
