import{d as ke,h as g,e as b,i as Ve,w as Ie,c as d,j as h,a as e,x as it,q as $e,n as R,t as o,k as v,F as be,m as Ne,o as r,z as ae,_ as Ae,f as lt,g as ot,u as rt,J as dt,p as J,b as De,C as ut,r as ct,l as E,H as vt,G as Y,v as mt,A as de,y as ft}from"./main.js";import{u as ze}from"./videoStore.js";import{u as gt}from"./mediaTypeStore.js";import{T as pt}from"./Timeline.js";import{u as bt}from"./usePollingProtection.js";const ht={class:"video-with-outside-timeline"},yt={key:0,class:"validation-status mb-3"},_t={class:"row align-items-center"},xt={class:"col-md-8"},wt={class:"progress"},St={class:"col-md-4 text-end"},Dt=["disabled"],kt={key:0,class:"spinner-border spinner-border-sm me-1"},Vt={key:1,class:"fas fa-check-double me-1"},It=["disabled"],$t=["src"],Nt={key:1,class:"segments-overview mb-3"},At={class:"segments-list"},zt={class:"ms-2 text-muted"},Ft={class:"ms-2 badge bg-secondary"},Ot=["onClick","disabled"],Et={key:1,class:"text-success"},Pt={key:2,class:"alert alert-info"},Mt=ke({__name:"OutsideSegmentComponent",props:{videoId:{}},emits:["segment-validated","validation-complete"],setup(ue,{emit:i}){const n=ue,m=i,s=g(null),$=g(""),y=g(0),x=g(0),N=g(!1),V=ze(),D=g(new Set),w=g(!1);async function k(p){const{data:f}=await ae.get(`/api/media/videos/${p}/`);$.value=f.video_url,y.value=Number(f.duration??0)}async function G(p){await V.fetchAllSegments(p)}const _=b(()=>(V.allSegments??[]).filter(f=>(f.label??"").toLowerCase()==="outside").map(f=>({...f}))),ne=b(()=>_.value.filter(p=>!D.value.has(p.id))),c=b(()=>_.value.length>0&&ne.value.length===0);async function T(p){if(!(D.value.has(p.id)||w.value)){w.value=!0;try{D.value.add(p.id),m("segment-validated",p.id),console.log(`‚úÖ Segment ${p.id} validated`),c.value&&(m("validation-complete"),console.log("üéâ All outside segments validated!"))}catch(f){console.error("Error validating segment:",f),D.value.delete(p.id)}finally{w.value=!1}}}async function j(){for(const p of ne.value)await T(p)}function L(){D.value.clear()}function M(p){const f=Math.floor(p/60),z=Math.floor(p%60);return`${f.toString().padStart(2,"0")}:${z.toString().padStart(2,"0")}`}Ve(()=>{s.value&&(s.value.addEventListener("loadedmetadata",()=>{!y.value&&s.value&&(y.value=s.value.duration||0)}),s.value.addEventListener("timeupdate",()=>{s.value&&(x.value=s.value.currentTime)}),s.value.addEventListener("play",()=>{N.value=!0}),s.value.addEventListener("pause",()=>{N.value=!1}))}),Ie(()=>n.videoId,async p=>{L(),await Promise.all([k(p),G(p)])},{immediate:!0});function C(...p){const[f]=p;s.value&&Number.isFinite(f)&&(s.value.currentTime=f),x.value=f}function q(){s.value&&(s.value.paused?s.value.play().catch(()=>{}):s.value.pause(),N.value=!s.value.paused)}function P(){}function S(){}function F(){}function O(){}function se(){}function W(){}function Q(){}return(p,f)=>(r(),d("div",ht,[_.value.length>0?(r(),d("div",yt,[e("div",_t,[e("div",xt,[e("div",wt,[e("div",{class:R(["progress-bar",c.value?"bg-success":"bg-warning"]),style:$e(`width: ${D.value.size/_.value.length*100}%`)},o(D.value.size)+" / "+o(_.value.length)+" validiert ",7)])]),e("div",St,[e("button",{class:"btn btn-sm btn-success me-2",onClick:j,disabled:w.value||c.value},[w.value?(r(),d("span",kt)):(r(),d("i",Vt)),f[0]||(f[0]=v(" Alle validieren ",-1))],8,Dt),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:L,disabled:w.value||D.value.size===0},[...f[1]||(f[1]=[e("i",{class:"fas fa-redo me-1"},null,-1),v(" Zur√ºcksetzen ",-1)])],8,It)])])])):h("",!0),e("video",{ref_key:"videoEl",ref:s,src:$.value,controls:"",style:{width:"100%","max-height":"480px"}},null,8,$t),_.value.length>0?(r(),d("div",Nt,[e("h6",null,"Outside-Segmente ("+o(_.value.length)+")",1),e("div",At,[(r(!0),d(be,null,Ne(_.value,z=>(r(),d("div",{key:z.id,class:R(["segment-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded",{"border-success bg-success bg-opacity-10":D.value.has(z.id),"border-warning bg-warning bg-opacity-10":!D.value.has(z.id)}])},[e("div",null,[e("strong",null,"Segment "+o(z.id),1),e("span",zt,o(M(z.startTime))+" - "+o(M(z.endTime)),1),e("span",Ft,o(z.label),1)]),e("div",null,[D.value.has(z.id)?(r(),d("span",Et,[...f[3]||(f[3]=[e("i",{class:"fas fa-check-circle me-1"},null,-1),v(" Validiert ",-1)])])):(r(),d("button",{key:0,class:"btn btn-sm btn-outline-success",onClick:he=>T(z),disabled:w.value},[...f[2]||(f[2]=[e("i",{class:"fas fa-check me-1"},null,-1),v(" Validieren ",-1)])],8,Ot))])],2))),128))])])):(r(),d("div",Pt,[f[4]||(f[4]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),v(' Keine "Outside"-Segmente f√ºr Video '+o(n.videoId)+" gefunden. ",1)])),_.value.length>0?(r(),it(pt,{key:3,video:{duration:y.value},segments:_.value,"current-time":x.value,"is-playing":N.value,"selection-mode":!1,onSeek:C,onPlayPause:q,onSegmentCreate:P,onSegmentResize:S,onSegmentMove:F,onTimeSelection:O,onSegmentSelect:se,onSegmentEdit:W,onSegmentDelete:Q},null,8,["video","segments","current-time","is-playing"])):h("",!0)]))}}),Yt=Ae(Mt,[["__scopeId","data-v-f646399d"]]);class I{static toISO(i){if(!i)return null;const n=i.trim().split(" ")[0],s=/^(\d{4})-(\d{2})-(\d{2})$/.exec(n);if(s){const[,x,N,V]=s;return this._isValidDate(parseInt(x),parseInt(N),parseInt(V))?n:null}const y=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(n);if(y){const[,x,N,V]=y;return this._isValidDate(parseInt(V),parseInt(N),parseInt(x))?`${V}-${N}-${x}`:null}return null}static toGerman(i){if(!i)return"";const n=i.trim(),s=/^(\d{4})-(\d{2})-(\d{2})$/.exec(n);if(!s)return"";const[,$,y,x]=s;return this._isValidDate(parseInt($),parseInt(y),parseInt(x))?`${x}.${y}.${$}`:""}static validate(i,n){if(!i)return!1;const m=i.trim();if(n==="ISO"){const $=/^(\d{4})-(\d{2})-(\d{2})$/.exec(m);if(!$)return!1;const[,y,x,N]=$;return this._isValidDate(parseInt(y),parseInt(x),parseInt(N))}if(n==="German"){const $=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(m);if(!$)return!1;const[,y,x,N]=$;return this._isValidDate(parseInt(N),parseInt(x),parseInt(y))}return!1}static compare(i,n){if(!this.validate(i,"ISO")||!this.validate(n,"ISO"))return null;const m=new Date(i),s=new Date(n);return m<s?-1:m>s?1:0}static isBefore(i,n){return this.compare(i,n)===-1}static isAfter(i,n){return this.compare(i,n)===1}static isBeforeOrEqual(i,n){const m=this.compare(i,n);return m===-1||m===0}static isAfterOrEqual(i,n){const m=this.compare(i,n);return m===1||m===0}static today(){const i=new Date,n=i.getFullYear(),m=String(i.getMonth()+1).padStart(2,"0"),s=String(i.getDate()).padStart(2,"0");return`${n}-${m}-${s}`}static todayGerman(){return this.toGerman(this.today())}static _isValidDate(i,n,m){if(i<1900||i>2100||n<1||n>12||m<1||m>31)return!1;const s=new Date(i,n-1,m);return s.getFullYear()===i&&s.getMonth()===n-1&&s.getDate()===m}}class Tt{errors=new Map;addField(i,n,m){if(!n){this.errors.set(i,`${i}: Pflichtfeld (darf nicht leer sein)`);return}if(!I.validate(n,m)){const s=m==="ISO"?"YYYY-MM-DD":"DD.MM.YYYY";this.errors.set(i,`${i}: Ung√ºltiges Format (erwartet: ${s})`)}}addConstraint(i,n,m){n||this.errors.set(i,m)}hasErrors(){return this.errors.size>0}getErrors(){return Array.from(this.errors.values())}getSummary(){const i=this.errors.size;return i===0?"Alle Datumsfelder sind g√ºltig":i===1?"1 Datumsfehler gefunden":`${i} Datumsfehler gefunden`}clear(){this.errors.clear()}getErrorsAsHtml(){return this.errors.size===0?"":`<ul class="date-validation-errors">${this.getErrors().map(n=>`<li>${n}</li>`).join("")}</ul>`}}const Ct={class:"container-fluid py-4"},Ut={class:"card"},Bt={class:"card-body"},Gt={key:0,class:"text-center py-5"},Lt={key:1,class:"alert alert-danger",role:"alert"},Kt={key:3,class:"alert alert-warning mt-3"},Rt={class:"mt-2"},jt={class:"row mb-3"},qt={class:"col-12"},Wt={class:"alert alert-info d-flex align-items-center justify-content-between",role:"alert"},Ht={key:0,class:"text-end"},Zt={class:"text-muted"},Jt={class:"row mb-4"},Qt={class:"col-12"},Xt={class:"form-check"},ea={key:0,class:"row mb-4"},ta={class:"col-12"},aa={class:"alert alert-danger alert-dismissible fade show",role:"alert"},na={class:"alert-heading"},sa={class:"mb-0"},ia={class:"row mb-4"},la={class:"col-md-5"},oa={class:"card bg-light mb-4"},ra={class:"card-body"},da={class:"mb-3"},ua={key:0,class:"invalid-feedback"},ca={class:"mb-3"},va={key:0,class:"invalid-feedback"},ma={class:"mb-3"},fa={class:"mb-3"},ga={class:"form-text text-muted"},pa={key:0,class:"ms-2 badge bg-secondary"},ba={key:0,class:"invalid-feedback"},ha={class:"mb-3"},ya={class:"mb-3"},_a={class:"form-text text-muted"},xa={key:0,class:"ms-2 badge bg-secondary"},wa={key:0,class:"invalid-feedback"},Sa={class:"mb-3"},Da={class:"mb-3"},ka={class:"mb-3"},Va={class:"mb-3"},Ia={class:"mb-3"},$a={class:"card bg-light"},Na={class:"card-body"},Aa={key:0,class:"mt-3"},za=["src"],Fa={class:"mt-3"},Oa={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},Ea={class:"col-md-7"},Pa={class:"card"},Ma={class:"card-header pb-0"},Ya={class:"mb-0"},Ta={class:"alert alert-info mt-2 mb-0"},Ca={key:0},Ua={key:1},Ba={key:2},Ga={class:"card-body media-viewer-container"},La={key:0,class:"dual-pdf-container"},Ka={class:"row"},Ra={class:"col-md-6"},ja={class:"pdf-section raw-pdf"},qa=["src"],Wa=["href"],Ha={class:"mt-2 text-center"},Za={class:"text-muted"},Ja={class:"col-md-6"},Qa={class:"pdf-section anonymized-pdf"},Xa=["src"],en=["href"],tn={class:"mt-2 text-center"},an={class:"text-muted"},nn={key:1,class:"dual-video-container"},sn={class:"row"},ln={class:"col-md-6"},on={class:"video-section raw-video"},rn=["src"],dn={class:"mt-2 text-center"},un={class:"text-muted"},cn={class:"col-md-6"},vn={class:"video-section anonymized-video"},mn=["src"],fn={class:"mt-2 text-center"},gn={class:"text-muted"},pn={class:"video-controls mt-3 text-center"},bn=["disabled"],hn={key:0,class:"spinner-border spinner-border-sm me-1",role:"status"},yn={key:1,class:"fas fa-check me-1"},_n={key:0,class:"outside-timeline-container mt-4"},xn={class:"card border-warning"},wn={class:"card-header bg-warning bg-opacity-10"},Sn={class:"d-flex justify-content-between align-items-center"},Dn={class:"mb-0 text-warning"},kn={class:"text-end"},Vn={class:"badge bg-warning text-dark fs-6"},In={class:"progress mt-2",style:{width:"200px",height:"8px"}},$n=["aria-valuenow","aria-valuemax"],Nn={class:"text-muted"},An={class:"card-body"},zn={key:0,class:"mt-2"},Fn={key:2,class:"alert alert-warning"},On={class:"mb-0"},En={class:"row"},Pn={class:"col-12 d-flex justify-content-between"},Mn={class:"d-flex gap-2"},Yn=["disabled","title"],Tn={key:0,class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",style:{"font-size":"0.6em"},title:"Ungespeicherte √Ñnderungen"},Cn=["disabled","title"],Un={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},Bn={key:1,class:"alert alert-warning mt-2 mb-0"},Gn=ke({__name:"AnonymizationValidationComponent",setup(ue){const i=bt(),n=lt(),m=ft(),s=ot(),$=ze(),y=gt(),x=rt();function N(){const a=Number(sessionStorage.getItem("last:fileId")||""),t=sessionStorage.getItem("last:scope");return{fileId:Number.isFinite(a)?a:void 0,scope:t||void 0}}let V=Number(x.params.fileId??x.query.fileId),D=x.params.mediaType;if(D||(D=x.query.mediaType),!Number.isFinite(V)||!D){const a=N();Number.isFinite(V)||(V=a.fileId),D||(D=a.scope)}!Number.isFinite(V)||!D?console.error("Validation view: cannot determine fileId/scope; aborting mediaStore init."):y.setCurrentByKey(D,V);const w=b(()=>y.isPdf),k=b(()=>y.isVideo),G=g(""),_=g(""),ne=g(!1),c=g({patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:"",externalId:"",externalIdOrigin:"",centerName:"",text:"",anonymizedText:"",examinersDisplay:""}),T=g([]),j=g(""),L=g(""),M=g(""),C=g(""),q=g(!1),P=g(!1),S=g(null),F=g(0),O=g(0),se=g(""),W=g(""),Q=g(!1),p=g(!1),f=g({anonymizedText:"",examinationDate:"",patient:{patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:""}});function z(a,t){return a.patientFirstName===t.patientFirstName&&a.patientLastName===t.patientLastName&&a.patientGenderName===t.patientGenderName&&a.patientDob===t.patientDob&&a.casenumber===t.casenumber}function he(a){return{patient_first_name:c.value.patientFirstName||"",patient_last_name:c.value.patientLastName||"",patient_gender:c.value.patientGenderName||"",patient_dob:a,casenumber:c.value.casenumber||""}}const ie=b(()=>c.value.patientFirstName.trim().length>0),le=b(()=>c.value.patientLastName.trim().length>0),H=b(()=>I.toISO(c.value.patientDob)),X=b(()=>I.toISO(_.value)),Fe=b(()=>{const a=T.value.length;return a===0?"Alle Felder sind g√ºltig":a===1?"1 Validierungsfehler gefunden":`${a} Validierungsfehler gefunden`}),oe=b(()=>!!H.value),re=b(()=>X.value?H.value?I.isAfterOrEqual(X.value,H.value):!1:!0),ce=b(()=>ie.value&&le.value&&oe.value&&re.value),Oe=b(()=>ce.value),fe=b(()=>!(!ce.value||k.value&&P.value)),ve=b(()=>{if(!ce.value){const a=[];return ie.value||a.push("Vorname"),le.value||a.push("Nachname"),oe.value||a.push("g√ºltiges Geburtsdatum"),re.value||a.push("g√ºltiges Untersuchungsdatum"),`Bitte korrigieren Sie: ${a.join(", ")}`}return k.value&&P.value?`Bitte validieren Sie zuerst alle Outside-Segmente (${O.value-F.value} verbleibend)`:""}),ye=b(()=>O.value===0?0:Math.round(F.value/O.value*100)),u=b(()=>s.current),ge=b(()=>!k.value||!u.value?void 0:`${window.location.origin}/api/media/videos/${V}/?type=raw`),pe=b(()=>!k.value||!u.value?void 0:`${window.location.origin}/api/media/videos/${V}/?type=processed`),ee=b(()=>!w.value||!u.value?void 0:`${window.location.origin}/api/media/pdfs/${V}/stream/?type=raw`),Z=b(()=>!w.value||!u.value?void 0:`${window.location.origin}/api/media/pdfs/${V}/stream/?type=processed`),U=g(null),B=g(null),Ee=a=>{console.error("Raw video error:",a)},Pe=()=>{console.log("Raw video load started")},Me=()=>{console.log("Raw video can play")},Ye=a=>{console.error("Anonymized video error:",a)},Te=()=>{console.log("Anonymized video load started")},Ce=()=>{console.log("Anonymized video can play")},_e=(a,t)=>{if(!U.value||!B.value)return;const A=a==="raw"?U.value:B.value,l=a==="raw"?B.value:U.value;Math.abs(A.currentTime-l.currentTime)>.5&&(l.currentTime=A.currentTime)},Ue=()=>{if(!U.value||!B.value)return;const a=(U.value.currentTime+B.value.currentTime)/2;U.value.currentTime=a,B.value.currentTime=a,console.log("Videos synchronized to time:",a)},Be=()=>{U.value&&U.value.pause(),B.value&&B.value.pause(),console.log("All videos paused")},Ge=()=>{if(!ee.value){n.warning({text:"Original-PDF nicht verf√ºgbar."});return}window.open(ee.value,"_blank"),console.log("Downloading raw PDF:",ee.value)},Le=()=>{if(!Z.value){n.warning({text:"Anonymisiertes PDF nicht verf√ºgbar."});return}window.open(Z.value,"_blank"),console.log("Downloading anonymized PDF:",Z.value)},Ke=async()=>{if(!u.value||!k.value){n.warning({text:"Kein Video zur Validierung ausgew√§hlt."});return}q.value=!0,P.value=!1,S.value=null;try{console.log(`üîç Validating video ${u.value.id} for segment annotation...`);const t=(await ae.get(de(`media/videos/${u.value.id}/validation/segments/`))).data;if(console.log("Video validation response:",t),t.eligible){const l=(await ae.get(de(`media/videos/${u.value.id}/segments/?label=outside`))).data;O.value=l.length,F.value=0,l.length>0?(P.value=!0,S.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Segmentvalidierung erforderlich",message:`${l.length} "Outside"-Segmente gefunden, die validiert werden m√ºssen.`,details:"Verwenden Sie die Timeline unten, um die Segmente zu √ºberpr√ºfen und zu best√§tigen."}):S.value={class:"alert-success",icon:"fas fa-check-circle",title:"Video bereit f√ºr Annotation",message:'Keine "Outside"-Segmente gefunden. Video ist bereit f√ºr die Segment-Annotation.',details:`Video ID: ${u.value.id} - Alle Validierungen bestanden.`}}else S.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Video nicht bereit",message:t.reasons?.join(", ")||"Video ist nicht f√ºr Segment-Annotation geeignet.",details:"√úberpr√ºfen Sie die Video-Verarbeitung und Metadaten-Extraktion."};n.info({text:`Video ${u.value.id} validiert`})}catch(a){console.error("Error validating video for segment annotation:",a);try{await $.fetchAllSegments(u.value.id);const t=$.allSegments.filter(A=>A.label==="outside");O.value=t.length,F.value=0,t.length>0?(P.value=!0,S.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Outside-Segmente gefunden (Fallback)",message:`${t.length} "Outside"-Segmente zur Validierung gefunden.`,details:"Fallback-Validierung √ºber VideoStore. API-Endpoint nicht verf√ºgbar."}):S.value={class:"alert-info",icon:"fas fa-info-circle",title:"Fallback-Validierung",message:'Keine "Outside"-Segmente gefunden (√ºber VideoStore).',details:"API-Validierung fehlgeschlagen, Fallback verwendet."}}catch{S.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Validierung fehlgeschlagen",message:"Video konnte nicht f√ºr Segment-Annotation validiert werden.",details:a?.response?.data?.detail||a?.message||"Unbekannter Fehler"}}}finally{q.value=!1}},Re=a=>{F.value++,console.log(`‚úÖ Segment ${a} validated. Progress: ${F.value}/${O.value}`),S.value&&(S.value.message=`Fortschritt: ${F.value}/${O.value} Outside-Segmente validiert.`)},je=()=>{console.log("üéâ All outside segments validated!"),P.value=!1,S.value={class:"alert-success",icon:"fas fa-check-circle",title:"Validierung abgeschlossen",message:"Alle Outside-Segmente wurden erfolgreich validiert.",details:`Video ${u.value?.id} ist jetzt bereit f√ºr die vollst√§ndige Segment-Annotation.`},n.success({text:"Outside-Segment Validierung abgeschlossen!"})},xe=a=>{if(!a)return;P.value=!1,S.value=null,F.value=0,O.value=0,q.value=!1;const t=a.examinationDate||"",A=a.patientDob||"";_.value=I.toISO(t)||"";const l={patientFirstName:a.patientFirstName||"",patientLastName:a.patientLastName||"",patientGenderName:a.patientGenderName||"",patientDob:I.toISO(A)||"",casenumber:a.casenumber||"",externalId:a.externalId??"",externalIdOrigin:a.externalIdOrigin??"",centerName:a.centerName??"",text:a.text??"",anonymizedText:a.anonymizedText??""};c.value={...l,externalId:l.externalId??"",externalIdOrigin:l.externalIdOrigin??"",centerName:l.centerName??"",text:l.text??"",anonymizedText:l.anonymizedText??"",examinersDisplay:l.examinersDisplay??""},f.value={anonymizedText:G.value,examinationDate:_.value,patient:{...l}}};Ie(u,a=>{a&&xe(a)},{immediate:!0});const me=async()=>{try{await s.fetchNext()}catch(a){console.error("Error fetching next item:",a)}},qe=b(()=>G.value!==f.value.anonymizedText||_.value!==f.value.examinationDate||!z(c.value,f.value.patient)),We=b(()=>u.value&&!te.value&&!K.value),te=g(!1),K=g(!1),He=()=>{Q.value=!Q.value};function we(){const a=new Tt;if(T.value=[],j.value="",L.value="",c.value.patientDob){const t=c.value.patientDob;I.validate(t,"ISO")?M.value="ISO (YYYY-MM-DD)":I.validate(t,"German")?M.value="Deutsch (DD.MM.YYYY)":(M.value="",j.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",a.addField("Geburtsdatum",t,"German"))}else M.value="";if(_.value){const t=_.value;I.validate(t,"ISO")?C.value="ISO (YYYY-MM-DD)":I.validate(t,"German")?C.value="Deutsch (DD.MM.YYYY)":(C.value="",L.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",a.addField("Untersuchungsdatum",t,"ISO"))}else C.value="";H.value&&X.value&&a.addConstraint("DOB_BEFORE_EXAM",I.isBeforeOrEqual(H.value,X.value),"Geburtsdatum muss vor oder am selben Tag wie das Untersuchungsdatum liegen"),a.hasErrors()&&(T.value=a.getErrors(),a.getErrors().forEach(A=>{A.includes("Geburtsdatum")&&(j.value=A.replace("Geburtsdatum: ","")),A.includes("Untersuchungsdatum")&&(L.value=A.replace("Untersuchungsdatum: ",""))}))}function Ze(){const a=c.value.patientDob;if(!a)return;const t=I.toISO(a);t&&(c.value.patientDob=t,M.value="ISO (YYYY-MM-DD)"),we()}function Je(){const a=_.value;if(!a)return;const t=I.toISO(a);t&&(_.value=t,C.value="ISO (YYYY-MM-DD)"),we()}function Qe(){T.value=[],j.value="",L.value=""}const Xe=async()=>{u.value&&await me()},et=()=>{if(!u.value){n.error({text:"Kein Video zur Segmentierung ausgew√§hlt."});return}m.push({name:"Video-Untersuchung",query:{video:u.value.id.toString()}}),console.log(`üéØ Navigating to Video-Untersuchung with video ID: ${u.value.id}`)},tt=async()=>{if(!(!u.value||!We.value||K.value)){if(!fe.value){const a=ve.value;console.warn(`‚ùå Approval blocked: ${a}`),n.warning({text:a});return}if(k.value&&P.value){console.warn("‚ùå Outside segments still pending validation"),n.error({text:"Bitte validieren Sie zuerst alle Outside-Segmente, bevor Sie das Video best√§tigen."});return}K.value=!0;try{console.log(`Validating anonymization for file ${u.value.id}...`);try{await ae.post(de(`anonymization/${u.value.id}/validate/`),{patient_first_name:c.value.patientFirstName,patient_last_name:c.value.patientLastName,patient_gender:c.value.patientGenderName,patient_dob:I.toGerman(H.value||"")||"",examination_date:I.toGerman(X.value||"")||"",casenumber:c.value.casenumber||"",anonymized_text:w.value?G.value:void 0,is_verified:!0,file_type:w.value?"pdf":k.value?"video":"unknown"}),console.log(`Anonymization validated successfully for file ${u.value.id}`),n.success({text:"Dokument best√§tigt und Anonymisierung validiert"})}catch(a){console.error("Error validating anonymization:",a),n.warning({text:"Dokument best√§tigt, aber Validierung fehlgeschlagen"})}i.validateAnonymizationSafeWithProtection(u.value.id,"pdf"),await et()}catch(a){console.error("Error approving item:",a),n.error({text:"Fehler beim Best√§tigen des Elements"})}finally{K.value=!1}}},at=async()=>{if(!te.value){if(!Oe.value){if(!W.value||!se.value)n.error({text:"Bitte laden Sie zuerst Bilder hoch (Original und bearbeitetes Bild)."});else if(!ce.value){const a=[];ie.value||a.push("Vorname"),le.value||a.push("Nachname"),oe.value||a.push("g√ºltiges Geburtsdatum"),re.value||a.push("g√ºltiges Untersuchungsdatum (darf nicht vor Geburtsdatum liegen)"),n.error({text:`Bitte korrigieren Sie: ${a.join(", ")}`})}return}te.value=!0;try{const a={processed_image_url:W.value,patient_data:he(I.toGerman(H.value||"")||""),examinationDate:I.toGerman(X.value||"")||"",anonymized_text:G.value};if(u.value&&k.value)await ae.post(de("save-anonymization-annotation-video/"),{...a,itemId:u.value.id});else if(u.value&&w.value)await ae.post(de("save-anonymization-annotation-pdf/"),a);else{n.error({text:"Keine g√ºltige Anonymisierung zum Speichern gefunden."});return}se.value="",W.value="",p.value=!1,n.success({text:"Annotation erfolgreich gespeichert"})}catch(a){console.error("Error saving annotation:",a),n.error({text:"Fehler beim Speichern der Annotation"})}finally{te.value=!1}}},nt=async()=>{u.value&&await me()},st=async()=>{if(!u.value){n.error({text:"Kein Element zur Korrektur ausgew√§hlt."});return}try{m.push({name:"Anonymisierung Korrektur",params:{fileId:u.value.id.toString()}}),n.info({text:"√Ñnderungen gespeichert. Bitte w√§hlen Sie das Element erneut f√ºr die Korrektur aus."});return}catch{n.error({text:"Fehler beim Speichern. Korrektur-Navigation abgebrochen."});return}};return Ve(async()=>{const a=Number(V),t=y.currentMediaType??"unknown";y.setCurrentByKey(t,a),s.current?xe(s.current):await me()}),dt(()=>{me()}),(a,t)=>{const A=ct("router-link");return r(),d("div",Ct,[e("div",Ut,[t[67]||(t[67]=e("div",{class:"card-header pb-0"},[e("h4",{class:"mb-0"},"Anonymisierungsvalidierung und Annotationen")],-1)),e("div",Bt,[J(s).loading?(r(),d("div",Gt,[...t[15]||(t[15]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Wird geladen...")],-1),e("p",{class:"mt-2"},"Anonymisierte Daten werden geladen...",-1)])])):J(s).error?(r(),d("div",Lt,[t[16]||(t[16]=e("strong",null,"Fehler:",-1)),v(" "+o(J(s).error),1)])):u.value?h("",!0):(r(),d("div",{key:2,class:"alert alert-info",role:"alert",onLoadstart:t[0]||(t[0]=l=>J(s).fetchNext())}," Alle Anonymisierungen wurden bearbeitet. ",32)),J(s).isAnyFileProcessing?(r(),d("div",Kt,[t[18]||(t[18]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("strong",null,o(J(s).processingFiles.length)+" Datei(en)",1),t[19]||(t[19]=v(" werden gerade anonymisiert. ",-1)),e("div",Rt,[De(A,{to:"/anonymisierung/uebersicht",class:"btn btn-sm btn-outline-primary"},{default:ut(()=>[...t[17]||(t[17]=[e("i",{class:"fas fa-eye me-1"},null,-1),v(" Zur √úbersicht ",-1)])]),_:1})])])):h("",!0)]),u.value?(r(),d(be,{key:0},[e("div",jt,[e("div",qt,[e("div",Wt,[e("div",null,[t[21]||(t[21]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("span",null,[t[20]||(t[20]=e("strong",null,"Validierung:",-1)),v(" "+o(w.value?"PDF-Dokument":k.value?"Video-Datei":"Unbekanntes Format")+" "+o(u.value?.centerName?`- ${u.value.centerName}`:""),1)])]),u.value&&(k.value||w.value)?(r(),d("div",Ht,[e("small",Zt,[t[22]||(t[22]=e("i",{class:"fas fa-tools me-1"},null,-1)),v(" "+o(k.value?"Video-Korrektur verf√ºgbar":"Text-Korrektur verf√ºgbar"),1)])])):h("",!0)])])]),e("div",Jt,[e("div",Qt,[e("div",Xt,[E(e("input",{type:"checkbox",class:"form-check-input",id:"noMoreNames","onUpdate:modelValue":t[1]||(t[1]=l=>ne.value=l)},null,512),[[vt,ne.value]]),t[23]||(t[23]=e("label",{class:"form-check-label",for:"noMoreNames"}," Keine weiteren Namen im Video oder PDF vorhanden ",-1))])])]),T.value.length>0?(r(),d("div",ea,[e("div",ta,[e("div",aa,[e("h6",na,[t[24]||(t[24]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),v(" "+o(Fe.value),1)]),t[25]||(t[25]=e("hr",null,null,-1)),e("ul",sa,[(r(!0),d(be,null,Ne(T.value,(l,Se)=>(r(),d("li",{key:Se},o(l),1))),128))]),e("button",{type:"button",class:"btn-close",onClick:Qe,"aria-label":"Schlie√üen"})])])])):h("",!0),e("div",ia,[e("div",la,[e("div",oa,[e("div",ra,[t[40]||(t[40]=e("h5",{class:"card-title"},"Patienteninformationen",-1)),e("div",da,[t[26]||(t[26]=e("label",{class:"form-label"},"Vorname:",-1)),E(e("input",{type:"text",class:R(["form-control",{"is-invalid":!ie.value}]),"onUpdate:modelValue":t[2]||(t[2]=l=>c.value.patientFirstName=l)},null,2),[[Y,c.value.patientFirstName]]),ie.value?h("",!0):(r(),d("div",ua," Vorname ist erforderlich. "))]),e("div",ca,[t[27]||(t[27]=e("label",{class:"form-label"},"Nachname:",-1)),E(e("input",{type:"text",class:R(["form-control",{"is-invalid":!le.value}]),"onUpdate:modelValue":t[3]||(t[3]=l=>c.value.patientLastName=l)},null,2),[[Y,c.value.patientLastName]]),le.value?h("",!0):(r(),d("div",va," Nachname ist erforderlich. "))]),e("div",ma,[t[29]||(t[29]=e("label",{class:"form-label"},"Geschlecht:",-1)),E(e("select",{class:"form-select","onUpdate:modelValue":t[4]||(t[4]=l=>c.value.patientGenderName=l)},[...t[28]||(t[28]=[e("option",{value:"male"},"M√§nnlich",-1),e("option",{value:"female"},"Weiblich",-1),e("option",{value:"other"},"Divers",-1)])],512),[[mt,c.value.patientGenderName]])]),e("div",fa,[t[31]||(t[31]=e("label",{class:"form-label"},"Geburtsdatum:",-1)),E(e("input",{type:"date",class:R(["form-control",{"is-invalid":!oe.value}]),"onUpdate:modelValue":t[5]||(t[5]=l=>c.value.patientDob=l),onBlur:Ze},null,34),[[Y,c.value.patientDob]]),e("small",ga,[t[30]||(t[30]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),M.value?(r(),d("span",pa,o(M.value),1)):h("",!0)]),oe.value?h("",!0):(r(),d("div",ba,o(j.value||"G√ºltiges Geburtsdatum ist erforderlich."),1))]),e("div",ha,[t[32]||(t[32]=e("label",{class:"form-label"},"Fallnummer:",-1)),E(e("input",{type:"text",class:"form-control","onUpdate:modelValue":t[6]||(t[6]=l=>c.value.casenumber=l)},null,512),[[Y,c.value.casenumber]])]),e("div",ya,[t[34]||(t[34]=e("label",{class:"form-label"},"Untersuchungsdatum:",-1)),E(e("input",{type:"date",class:R(["form-control",{"is-invalid":!re.value}]),"onUpdate:modelValue":t[7]||(t[7]=l=>_.value=l),onBlur:Je},null,34),[[Y,_.value]]),e("small",_a,[t[33]||(t[33]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),C.value?(r(),d("span",xa,o(C.value),1)):h("",!0)]),re.value?h("",!0):(r(),d("div",wa,o(L.value||"Das Untersuchungsdatum darf nicht vor dem Geburtsdatum liegen."),1))]),e("div",Sa,[t[35]||(t[35]=e("label",{class:"form-label"},"Anonymisierter Text:",-1)),E(e("textarea",{class:"form-control",rows:"6","onUpdate:modelValue":t[8]||(t[8]=l=>G.value=l)},null,512),[[Y,G.value]])]),e("div",Da,[t[36]||(t[36]=e("label",{class:"form-label"},"Externe ID:",-1)),E(e("textarea",{class:"form-control","onUpdate:modelValue":t[9]||(t[9]=l=>c.value.externalId=l)},null,512),[[Y,c.value.externalId]])]),e("div",ka,[t[37]||(t[37]=e("label",{class:"form-label"},"Untersucher:",-1)),E(e("textarea",{class:"form-control","onUpdate:modelValue":t[10]||(t[10]=l=>c.value.examinersDisplay=l)},null,512),[[Y,c.value.examinersDisplay]])]),e("div",Va,[t[38]||(t[38]=e("label",{class:"form-label"},"Quelle der Daten:",-1)),E(e("textarea",{class:"form-control","onUpdate:modelValue":t[11]||(t[11]=l=>c.value.externalIdOrigin=l)},"                    ",512),[[Y,c.value.externalIdOrigin]])]),e("div",Ia,[t[39]||(t[39]=e("label",{class:"form-label"},"Zentrum:",-1)),E(e("textarea",{class:"form-control","onUpdate:modelValue":t[12]||(t[12]=l=>c.value.centerName=l)},"                    ",512),[[Y,c.value.centerName]])])]),e("div",$a,[e("div",Na,[t[41]||(t[41]=e("h5",{class:"card-title"},"Annotationen",-1)),W.value?(r(),d("div",Aa,[e("img",{src:Q.value?se.value:W.value,class:"img-fluid",alt:"Uploaded Image"},null,8,za),e("button",{class:"btn btn-info btn-sm mt-2",onClick:He},o(Q.value?"Bearbeitetes Bild anzeigen":"Original anzeigen"),1)])):h("",!0),e("div",Fa,[e("button",{class:"btn btn-primary",onClick:at},[te.value?(r(),d("span",Oa)):h("",!0),v(" "+o(te.value?"Speichern...":"Annotation zwischenspeichern"),1)])])])])])]),e("div",Ea,[e("div",Pa,[e("div",Ma,[e("h5",Ya,o(w.value?"PDF Vorschau":"Video Vorschau"),1),e("div",Ta,[t[42]||(t[42]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),t[43]||(t[43]=e("strong",null,"Datenformat:",-1)),w.value?(r(),d("span",Ca," PDF-Dokument ("+o(Math.round((Z.value?.length||0)/1024)||"Nicht Verf√ºgbar")+" KB) ",1)):k.value?(r(),d("span",Ua," Video-Datei (Raw: "+o(ge.value||"N/A")+" | Anonymized: "+o(pe.value||"N/A")+") ",1)):(r(),d("span",Ba," Unbekanntes Format - ID: "+o(u.value?.id),1))])]),e("div",Ga,[w.value?(r(),d("div",La,[e("div",Ka,[e("div",Ra,[e("div",ja,[t[46]||(t[46]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-file-pdf me-1"}),v(" Original PDF (Raw) ")],-1)),e("iframe",{src:ee.value,width:"100%",height:"700px",frameborder:"0",title:"Original PDF Vorschau"},[t[44]||(t[44]=v(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:ee.value},"hier herunterladen",8,Wa),t[45]||(t[45]=v(". ",-1))],8,qa),e("div",Ha,[e("small",Za," URL: "+o(ee.value||"Nicht verf√ºgbar"),1)])])]),e("div",Ja,[e("div",Qa,[t[49]||(t[49]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),v(" Anonymisiertes PDF (Processed) ")],-1)),e("iframe",{src:Z.value,width:"100%",height:"700px",frameborder:"0",title:"Anonymisiertes PDF Vorschau"},[t[47]||(t[47]=v(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:Z.value},"hier herunterladen",8,en),t[48]||(t[48]=v(". ",-1))],8,Xa),e("div",tn,[e("small",an," URL: "+o(Z.value||"Nicht verf√ºgbar"),1)])])])]),e("div",{class:"pdf-controls mt-3 text-center"},[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Ge},[...t[50]||(t[50]=[e("i",{class:"fas fa-download me-1"},null,-1),v(" Original herunterladen ",-1)])]),e("button",{class:"btn btn-outline-success btn-sm",onClick:Le},[...t[51]||(t[51]=[e("i",{class:"fas fa-download me-1"},null,-1),v(" Anonymisiert herunterladen ",-1)])])])])):k.value?(r(),d("div",nn,[e("div",sn,[e("div",ln,[e("div",on,[t[52]||(t[52]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-eye me-1"}),v(" Original Video (Raw) ")],-1)),e("video",{ref_key:"rawVideoElement",ref:U,src:ge.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ee,onLoadstart:Pe,onCanplay:Me,onTimeupdate:t[13]||(t[13]=l=>_e("raw"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,rn),e("div",dn,[e("small",un," URL: "+o(ge.value||"Nicht verf√ºgbar"),1)])])]),e("div",cn,[e("div",vn,[t[53]||(t[53]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),v(" Anonymisiertes Video (Processed) ")],-1)),e("video",{ref_key:"anonymizedVideoElement",ref:B,src:pe.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ye,onLoadstart:Te,onCanplay:Ce,onTimeupdate:t[14]||(t[14]=l=>_e("anonymized"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,mn),e("div",fn,[e("small",gn," URL: "+o(pe.value||"Nicht verf√ºgbar"),1)])])])]),e("div",pn,[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Ue},[...t[54]||(t[54]=[e("i",{class:"fas fa-sync me-1"},null,-1),v(" Videos synchronisieren ",-1)])]),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:Be},[...t[55]||(t[55]=[e("i",{class:"fas fa-pause me-1"},null,-1),v(" Alle pausieren ",-1)])]),e("button",{class:"btn btn-outline-info btn-sm ms-2",onClick:Ke,disabled:q.value},[q.value?(r(),d("span",hn)):(r(),d("i",yn)),t[56]||(t[56]=v(" Segment-Annotation pr√ºfen ",-1))],8,bn)]),P.value&&u.value?(r(),d("div",_n,[e("div",xn,[e("div",wn,[e("div",Sn,[e("div",null,[e("h6",Dn,[t[57]||(t[57]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),v(" Segmente zur Entfernung - Video ID: "+o(u.value.id),1)]),t[58]||(t[58]=e("small",{class:"text-muted"},' Diese Segmente wurden als "outside" klassifiziert und sollten aus dem Video entfernt werden. ',-1))]),e("div",kn,[e("div",Vn,o(F.value)+" / "+o(O.value),1),e("div",In,[e("div",{class:"progress-bar bg-success",role:"progressbar",style:$e({width:ye.value+"%"}),"aria-valuenow":F.value,"aria-valuemin":0,"aria-valuemax":O.value},null,12,$n)]),e("small",Nn,o(ye.value)+"% validiert",1)])])]),e("div",An,[De(Yt,{videoId:u.value.id,onSegmentValidated:Re,onValidationComplete:je},null,8,["videoId"])])])])):h("",!0),S.value?(r(),d("div",{key:1,class:R(["alert mt-3",S.value.class])},[e("i",{class:R([S.value.icon,"me-2"])},null,2),e("strong",null,o(S.value.title)+":",1),v(" "+o(S.value.message)+" ",1),S.value.details?(r(),d("div",zn,[e("small",null,o(S.value.details),1)])):h("",!0)],2)):h("",!0)])):(r(),d("div",Fn,[t[63]||(t[63]=e("h6",null,"Debug-Informationen:",-1)),e("ul",On,[e("li",null,[t[59]||(t[59]=e("strong",null,"Current Item ID:",-1)),v(" "+o(u.value?.id||"Nicht verf√ºgbar"),1)]),e("li",null,[t[60]||(t[60]=e("strong",null,"Is PDF:",-1)),v(" "+o(w.value),1)]),e("li",null,[t[61]||(t[61]=e("strong",null,"Is Video:",-1)),v(" "+o(k.value),1)]),e("li",null,[t[62]||(t[62]=e("strong",null,"Detected Media Type:",-1)),v(" "+o(u.value?J(y).detectMediaType(u.value):"N/A"),1)])])]))])])])]),e("div",En,[e("div",Pn,[e("button",{class:"btn btn-secondary",onClick:Xe}," √úberspringen "),e("div",Mn,[u.value&&(k.value||w.value)?(r(),d("button",{key:0,class:"btn btn-warning position-relative",onClick:st,disabled:K.value,title:k.value?"Video-Korrektur: Maskierung, Frame-Entfernung, etc.":"PDF-Korrektur: Text-Annotation anpassen"},[t[64]||(t[64]=e("i",{class:"fas fa-edit me-1"},null,-1)),v(" "+o(k.value?"Video-Korrektur":"PDF-Korrektur")+" ",1),qe.value?(r(),d("span",Tn," ! ")):h("",!0)],8,Yn)):h("",!0),e("button",{class:"btn btn-danger me-2",onClick:nt}," Ablehnen "),e("button",{class:"btn btn-success",onClick:tt,disabled:K.value||!fe.value,title:ve.value},[K.value?(r(),d("span",Un)):h("",!0),v(" "+o(K.value?"Wird best√§tigt...":"Best√§tigen"),1)],8,Cn),!fe.value&&ve.value?(r(),d("div",Bn,[t[65]||(t[65]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[66]||(t[66]=e("strong",null,"Best√§tigung blockiert:",-1)),v(" "+o(ve.value),1)])):h("",!0)])])])],64)):h("",!0)])])}}}),Wn=Ae(Gn,[["__scopeId","data-v-f7b369fc"]]);export{Wn as default};
