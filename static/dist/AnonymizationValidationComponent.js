import{d as $e,h as g,e as y,i as Ne,w as ye,c as r,j as x,a as e,x as lt,q as Ae,n as K,t as o,k as m,F as ve,m as we,o as i,z as me,_ as ze,f as ot,g as rt,u as dt,J as ut,p as H,b as Ve,C as ct,r as vt,l as z,H as mt,G as Y,v as Ie,A as he,y as ft}from"./main.js";import{u as Fe}from"./videoStore.js";import{u as gt}from"./mediaTypeStore.js";import{T as pt}from"./Timeline.js";import{u as bt}from"./usePollingProtection.js";const ht={class:"video-with-outside-timeline"},yt={key:0,class:"validation-status mb-3"},wt={class:"row align-items-center"},xt={class:"col-md-8"},_t={class:"progress"},Dt={class:"col-md-4 text-end"},St=["disabled"],kt={key:0,class:"spinner-border spinner-border-sm me-1"},Vt={key:1,class:"fas fa-check-double me-1"},It=["disabled"],$t=["src"],Nt={key:1,class:"segments-overview mb-3"},At={class:"segments-list"},zt={class:"ms-2 text-muted"},Ft={class:"ms-2 badge bg-secondary"},Ot=["onClick","disabled"],Et={key:1,class:"text-success"},Pt={key:2,class:"alert alert-info"},Mt=$e({__name:"OutsideSegmentComponent",props:{videoId:{}},emits:["segment-validated","validation-complete"],setup(ee,{emit:l}){const a=ee,f=l,s=g(null),S=g(""),w=g(0),D=g(0),b=g(!1),h=Fe(),N=g(new Set),P=g(!1);async function V(v){const{data:p}=await me.get(`/api/media/videos/${v}/`);S.value=p.video_url,w.value=Number(p.duration??0)}async function M(v){await h.fetchAllSegments(v)}const F=y(()=>(h.allSegments??[]).filter(p=>(p.label??"").toLowerCase()==="outside").map(p=>({...p}))),Z=y(()=>F.value.filter(v=>!N.value.has(v.id))),te=y(()=>F.value.length>0&&Z.value.length===0);async function J(v){if(!(N.value.has(v.id)||P.value)){P.value=!0;try{N.value.add(v.id),f("segment-validated",v.id),console.log(`‚úÖ Segment ${v.id} validated`),te.value&&(f("validation-complete"),console.log("üéâ All outside segments validated!"))}catch(p){console.error("Error validating segment:",p),N.value.delete(v.id)}finally{P.value=!1}}}async function A(){for(const v of Z.value)await J(v)}function ne(){N.value.clear()}function c(v){const p=Math.floor(v/60),I=Math.floor(v%60);return`${p.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}`}Ne(()=>{s.value&&(s.value.addEventListener("loadedmetadata",()=>{!w.value&&s.value&&(w.value=s.value.duration||0)}),s.value.addEventListener("timeupdate",()=>{s.value&&(D.value=s.value.currentTime)}),s.value.addEventListener("play",()=>{b.value=!0}),s.value.addEventListener("pause",()=>{b.value=!1}))}),ye(()=>a.videoId,async v=>{ne(),await Promise.all([V(v),M(v)])},{immediate:!0});function G(...v){const[p]=v;s.value&&Number.isFinite(p)&&(s.value.currentTime=p),D.value=p}function R(){s.value&&(s.value.paused?s.value.play().catch(()=>{}):s.value.pause(),b.value=!s.value.paused)}function j(){}function T(){}function C(){}function q(){}function E(){}function _(){}function O(){}return(v,p)=>(i(),r("div",ht,[F.value.length>0?(i(),r("div",yt,[e("div",wt,[e("div",xt,[e("div",_t,[e("div",{class:K(["progress-bar",te.value?"bg-success":"bg-warning"]),style:Ae(`width: ${N.value.size/F.value.length*100}%`)},o(N.value.size)+" / "+o(F.value.length)+" validiert ",7)])]),e("div",Dt,[e("button",{class:"btn btn-sm btn-success me-2",onClick:A,disabled:P.value||te.value},[P.value?(i(),r("span",kt)):(i(),r("i",Vt)),p[0]||(p[0]=m(" Alle validieren ",-1))],8,St),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:ne,disabled:P.value||N.value.size===0},[...p[1]||(p[1]=[e("i",{class:"fas fa-redo me-1"},null,-1),m(" Zur√ºcksetzen ",-1)])],8,It)])])])):x("",!0),e("video",{ref_key:"videoEl",ref:s,src:S.value,controls:"",style:{width:"100%","max-height":"480px"}},null,8,$t),F.value.length>0?(i(),r("div",Nt,[e("h6",null,"Outside-Segmente ("+o(F.value.length)+")",1),e("div",At,[(i(!0),r(ve,null,we(F.value,I=>(i(),r("div",{key:I.id,class:K(["segment-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded",{"border-success bg-success bg-opacity-10":N.value.has(I.id),"border-warning bg-warning bg-opacity-10":!N.value.has(I.id)}])},[e("div",null,[e("strong",null,"Segment "+o(I.id),1),e("span",zt,o(c(I.startTime))+" - "+o(c(I.endTime)),1),e("span",Ft,o(I.label),1)]),e("div",null,[N.value.has(I.id)?(i(),r("span",Et,[...p[3]||(p[3]=[e("i",{class:"fas fa-check-circle me-1"},null,-1),m(" Validiert ",-1)])])):(i(),r("button",{key:0,class:"btn btn-sm btn-outline-success",onClick:ae=>J(I),disabled:P.value},[...p[2]||(p[2]=[e("i",{class:"fas fa-check me-1"},null,-1),m(" Validieren ",-1)])],8,Ot))])],2))),128))])])):(i(),r("div",Pt,[p[4]||(p[4]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),m(' Keine "Outside"-Segmente f√ºr Video '+o(a.videoId)+" gefunden. ",1)])),F.value.length>0?(i(),lt(pt,{key:3,video:{duration:w.value},segments:F.value,"current-time":D.value,"is-playing":b.value,"selection-mode":!1,onSeek:G,onPlayPause:R,onSegmentCreate:j,onSegmentResize:T,onSegmentMove:C,onTimeSelection:q,onSegmentSelect:E,onSegmentEdit:_,onSegmentDelete:O},null,8,["video","segments","current-time","is-playing"])):x("",!0)]))}}),Yt=ze(Mt,[["__scopeId","data-v-f646399d"]]);class k{static toISO(l){if(!l)return null;const a=l.trim().split(" ")[0],s=/^(\d{4})-(\d{2})-(\d{2})$/.exec(a);if(s){const[,D,b,h]=s;return this._isValidDate(parseInt(D),parseInt(b),parseInt(h))?a:null}const w=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(a);if(w){const[,D,b,h]=w;return this._isValidDate(parseInt(h),parseInt(b),parseInt(D))?`${h}-${b}-${D}`:null}return null}static toGerman(l){if(!l)return"";const a=l.trim(),s=/^(\d{4})-(\d{2})-(\d{2})$/.exec(a);if(!s)return"";const[,S,w,D]=s;return this._isValidDate(parseInt(S),parseInt(w),parseInt(D))?`${D}.${w}.${S}`:""}static validate(l,a){if(!l)return!1;const f=l.trim();if(a==="ISO"){const S=/^(\d{4})-(\d{2})-(\d{2})$/.exec(f);if(!S)return!1;const[,w,D,b]=S;return this._isValidDate(parseInt(w),parseInt(D),parseInt(b))}if(a==="German"){const S=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(f);if(!S)return!1;const[,w,D,b]=S;return this._isValidDate(parseInt(b),parseInt(D),parseInt(w))}return!1}static compare(l,a){if(!this.validate(l,"ISO")||!this.validate(a,"ISO"))return null;const f=new Date(l),s=new Date(a);return f<s?-1:f>s?1:0}static isBefore(l,a){return this.compare(l,a)===-1}static isAfter(l,a){return this.compare(l,a)===1}static isBeforeOrEqual(l,a){const f=this.compare(l,a);return f===-1||f===0}static isAfterOrEqual(l,a){const f=this.compare(l,a);return f===1||f===0}static today(){const l=new Date,a=l.getFullYear(),f=String(l.getMonth()+1).padStart(2,"0"),s=String(l.getDate()).padStart(2,"0");return`${a}-${f}-${s}`}static todayGerman(){return this.toGerman(this.today())}static _isValidDate(l,a,f){if(l<1900||l>2100||a<1||a>12||f<1||f>31)return!1;const s=new Date(l,a-1,f);return s.getFullYear()===l&&s.getMonth()===a-1&&s.getDate()===f}}class Tt{errors=new Map;addField(l,a,f){if(!a){this.errors.set(l,`${l}: Pflichtfeld (darf nicht leer sein)`);return}if(!k.validate(a,f)){const s=f==="ISO"?"YYYY-MM-DD":"DD.MM.YYYY";this.errors.set(l,`${l}: Ung√ºltiges Format (erwartet: ${s})`)}}addConstraint(l,a,f){a||this.errors.set(l,f)}hasErrors(){return this.errors.size>0}getErrors(){return Array.from(this.errors.values())}getSummary(){const l=this.errors.size;return l===0?"Alle Datumsfelder sind g√ºltig":l===1?"1 Datumsfehler gefunden":`${l} Datumsfehler gefunden`}clear(){this.errors.clear()}getErrorsAsHtml(){return this.errors.size===0?"":`<ul class="date-validation-errors">${this.getErrors().map(a=>`<li>${a}</li>`).join("")}</ul>`}}const Ct={class:"container-fluid py-4"},Ut={class:"card"},Bt={class:"card-body"},Gt={key:0,class:"text-center py-5"},Lt={key:1,class:"alert alert-danger",role:"alert"},Kt={key:3,class:"alert alert-warning mt-3"},Rt={class:"mt-2"},jt={class:"row mb-3"},qt={class:"col-12"},Wt={class:"alert alert-info d-flex align-items-center justify-content-between",role:"alert"},Ht={key:0,class:"text-end"},Zt={class:"text-muted"},Jt={class:"row mb-4"},Qt={class:"col-12"},Xt={class:"form-check"},en={key:0,class:"row mb-4"},tn={class:"col-12"},nn={class:"alert alert-danger alert-dismissible fade show",role:"alert"},an={class:"alert-heading"},sn={class:"mb-0"},ln={class:"row mb-4"},on={class:"col-md-5"},rn={class:"card bg-light mb-4"},dn={class:"card-body"},un={class:"mb-3"},cn={key:0,class:"invalid-feedback"},vn={class:"mb-3"},mn={key:0,class:"invalid-feedback"},fn={class:"mb-3"},gn={class:"mb-3"},pn={class:"form-text text-muted"},bn={key:0,class:"ms-2 badge bg-secondary"},hn={key:0,class:"invalid-feedback"},yn={class:"mb-3"},wn={class:"mb-3"},xn={class:"form-text text-muted"},_n={key:0,class:"ms-2 badge bg-secondary"},Dn={key:0,class:"invalid-feedback"},Sn={class:"mb-3"},kn={class:"mb-3"},Vn={class:"mb-3"},In={class:"mb-3"},$n={class:"mb-3"},Nn={class:"card bg-light"},An={class:"card-body"},zn={key:0,class:"mt-3"},Fn=["src"],On={class:"col-md-7"},En={class:"card"},Pn={class:"card-header pb-0"},Mn={class:"mb-0"},Yn={class:"alert alert-info mt-2 mb-0"},Tn={key:0},Cn={key:1},Un={key:2},Bn={class:"card-body media-viewer-container"},Gn={key:0,class:"dual-pdf-container"},Ln={class:"row"},Kn={class:"col-md-6"},Rn={class:"pdf-section raw-pdf"},jn=["src"],qn=["href"],Wn={class:"mt-2 text-center"},Hn={class:"text-muted"},Zn={class:"col-md-6"},Jn={class:"pdf-section anonymized-pdf"},Qn=["src"],Xn=["href"],ea={class:"mt-2 text-center"},ta={class:"text-muted"},na={key:1,class:"dual-video-container"},aa={class:"row"},sa={class:"col-md-6"},ia={class:"video-section raw-video"},la=["src"],oa={class:"mt-2 text-center"},ra={class:"text-muted"},da={class:"col-md-6"},ua={class:"video-section anonymized-video"},ca=["src"],va={class:"mt-2 text-center"},ma={class:"text-muted"},fa={class:"video-controls mt-3 text-center"},ga=["disabled"],pa={key:0,class:"spinner-border spinner-border-sm me-1",role:"status"},ba={key:1,class:"fas fa-check me-1"},ha={key:0,class:"outside-timeline-container mt-4"},ya={class:"card border-warning"},wa={class:"card-header bg-warning bg-opacity-10"},xa={class:"d-flex justify-content-between align-items-center"},_a={class:"mb-0 text-warning"},Da={class:"text-end"},Sa={class:"badge bg-warning text-dark fs-6"},ka={class:"progress mt-2",style:{width:"200px",height:"8px"}},Va=["aria-valuenow","aria-valuemax"],Ia={class:"text-muted"},$a={class:"card-body"},Na={key:0,class:"mt-2"},Aa={key:2,class:"alert alert-warning"},za={class:"mb-0"},Fa={class:"row"},Oa={class:"col-12 d-flex justify-content-between"},Ea={class:"d-flex gap-2"},Pa=["disabled","title"],Ma={key:0,class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",style:{"font-size":"0.6em"},title:"Ungespeicherte √Ñnderungen"},Ya=["disabled","title"],Ta={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},Ca={key:1,class:"alert alert-warning mt-2 mb-0"},Ua=["value"],Ba={key:2,class:"alert alert-warning mt-2 mb-0"},Ga=$e({__name:"AnonymizationValidationComponent",props:{fileId:{},mediaType:{}},setup(ee){const l=bt(),a=ot(),f=ft(),s=rt(),S=Fe(),w=gt(),D=dt(),b=y(()=>w.isPdf),h=y(()=>w.isVideo);function N(){const n=Number(sessionStorage.getItem("last:fileId")||""),t=sessionStorage.getItem("last:scope");return{fileId:Number.isFinite(n)?n:void 0,scope:t||void 0}}const P=ee;let V=Number(P.fileId||D.query.fileId),M=P.mediaType||D.query.mediaType;if(console.log("fileid and scope",V,M),!Number.isFinite(V)||!M){const n=N();n.fileId!==void 0&&(V=n.fileId),n.scope&&(M=n.scope)}!Number.isFinite(V)||!M?console.error("Validation view: cannot determine fileId/scope; aborting mediaStore init.",{fileId:V,scope:M}):w.setCurrentByKey(M,V);const F=[{text:"Video",value:"video"},{text:"PDF",value:"pdf"}],Z=g(""),te=y(()=>!b.value&&!h.value);ye(Z,n=>{!n||!d.value||(w.rememberType(d.value.id,n,n),w.setCurrentByKey(n,d.value.id))});const J=g(""),A=g(""),ne=g(!1),c=g({patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:"",externalId:"",externalIdOrigin:"",centerName:"",text:"",anonymizedText:"",examinersDisplay:"",examinationDate:""}),G=g([]),R=g(""),j=g(""),T=g(""),C=g(""),q=g(!1),E=g(!1),_=g(null),O=g(0),v=g(0),p=g(""),I=g(""),ae=g(!1);g(!1);const ie=g({anonymizedText:"",examinationDate:"",patient:{patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:""}});function Oe(n,t){return n.patientFirstName===t.patientFirstName&&n.patientLastName===t.patientLastName&&n.patientGenderName===t.patientGenderName&&n.patientDob===t.patientDob&&n.casenumber===t.casenumber}const le=y(()=>c.value.patientFirstName.trim().length>0),oe=y(()=>c.value.patientLastName.trim().length>0),Q=y(()=>k.toISO(c.value.patientDob)),se=y(()=>k.toISO(A.value)),Ee=y(()=>{const n=G.value.length;return n===0?"Alle Felder sind g√ºltig":n===1?"1 Validierungsfehler gefunden":`${n} Validierungsfehler gefunden`}),re=y(()=>!!Q.value),de=y(()=>se.value?Q.value?k.isAfterOrEqual(se.value,Q.value):!1:!0),fe=y(()=>le.value&&oe.value&&re.value&&de.value);y(()=>fe.value);const ge=y(()=>!(!fe.value||h.value&&E.value)),ue=y(()=>{if(!fe.value){const n=[];return le.value||n.push("Vorname"),oe.value||n.push("Nachname"),re.value||n.push("g√ºltiges Geburtsdatum"),de.value||n.push("g√ºltiges Untersuchungsdatum"),`Bitte korrigieren Sie: ${n.join(", ")}`}return h.value&&E.value?`Bitte validieren Sie zuerst alle Outside-Segmente (${v.value-O.value} verbleibend)`:""}),xe=y(()=>v.value===0?0:Math.round(O.value/v.value*100)),d=y(()=>s.current),pe=y(()=>!h.value||!d.value?void 0:`${window.location.origin}/api/media/videos/${V}/?type=raw`),be=y(()=>!h.value||!d.value?void 0:`${window.location.origin}/api/media/videos/${V}/?type=processed`),X=y(()=>!b.value||!d.value?void 0:`${window.location.origin}/api/media/pdfs/${V}/stream/?type=raw`),W=y(()=>!b.value||!d.value?void 0:`${window.location.origin}/api/media/pdfs/${V}/stream/?type=processed`),U=g(null),B=g(null),Pe=n=>{console.error("Raw video error:",n)},Me=()=>{console.log("Raw video load started")},Ye=()=>{console.log("Raw video can play")},Te=n=>{console.error("Anonymized video error:",n)},Ce=()=>{console.log("Anonymized video load started")},Ue=()=>{console.log("Anonymized video can play")},_e=(n,t)=>{if(!U.value||!B.value)return;const $=n==="raw"?U.value:B.value,u=n==="raw"?B.value:U.value;Math.abs($.currentTime-u.currentTime)>.5&&(u.currentTime=$.currentTime)},Be=()=>{if(!U.value||!B.value)return;const n=(U.value.currentTime+B.value.currentTime)/2;U.value.currentTime=n,B.value.currentTime=n,console.log("Videos synchronized to time:",n)},Ge=()=>{U.value&&U.value.pause(),B.value&&B.value.pause(),console.log("All videos paused")},Le=()=>{if(!X.value){a.warning({text:"Original-PDF nicht verf√ºgbar."});return}window.open(X.value,"_blank"),console.log("Downloading raw PDF:",X.value)},Ke=()=>{if(!W.value){a.warning({text:"Anonymisiertes PDF nicht verf√ºgbar."});return}window.open(W.value,"_blank"),console.log("Downloading anonymized PDF:",W.value)},Re=async()=>{if(!d.value||!h.value){a.warning({text:"Kein Video zur Validierung ausgew√§hlt."});return}q.value=!0,E.value=!1,_.value=null;try{console.log(`üîç Validating video ${d.value.id} for segment annotation...`);const t=(await me.get(he(`media/videos/${d.value.id}/validation/segments/`))).data;if(console.log("Video validation response:",t),t.eligible){const u=(await me.get(he(`media/videos/${d.value.id}/segments/?label=outside`))).data;v.value=u.length,O.value=0,u.length>0?(E.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Segmentvalidierung erforderlich",message:`${u.length} "Outside"-Segmente gefunden, die validiert werden m√ºssen.`,details:"Verwenden Sie die Timeline unten, um die Segmente zu √ºberpr√ºfen und zu best√§tigen."}):_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Video bereit f√ºr Annotation",message:'Keine "Outside"-Segmente gefunden. Video ist bereit f√ºr die Segment-Annotation.',details:`Video ID: ${d.value.id} - Alle Validierungen bestanden.`}}else _.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Video nicht bereit",message:t.reasons?.join(", ")||"Video ist nicht f√ºr Segment-Annotation geeignet.",details:"√úberpr√ºfen Sie die Video-Verarbeitung und Metadaten-Extraktion."};a.info({text:`Video ${d.value.id} validiert`})}catch(n){console.error("Error validating video for segment annotation:",n);try{await S.fetchAllSegments(d.value.id);const t=S.allSegments.filter($=>$.label==="outside");v.value=t.length,O.value=0,t.length>0?(E.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Outside-Segmente gefunden (Fallback)",message:`${t.length} "Outside"-Segmente zur Validierung gefunden.`,details:"Fallback-Validierung √ºber VideoStore. API-Endpoint nicht verf√ºgbar."}):_.value={class:"alert-info",icon:"fas fa-info-circle",title:"Fallback-Validierung",message:'Keine "Outside"-Segmente gefunden (√ºber VideoStore).',details:"API-Validierung fehlgeschlagen, Fallback verwendet."}}catch{_.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Validierung fehlgeschlagen",message:"Video konnte nicht f√ºr Segment-Annotation validiert werden.",details:n?.response?.data?.detail||n?.message||"Unbekannter Fehler"}}}finally{q.value=!1}},je=n=>{O.value++,console.log(`‚úÖ Segment ${n} validated. Progress: ${O.value}/${v.value}`),_.value&&(_.value.message=`Fortschritt: ${O.value}/${v.value} Outside-Segmente validiert.`)},qe=()=>{console.log("üéâ All outside segments validated!"),E.value=!1,_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Validierung abgeschlossen",message:"Alle Outside-Segmente wurden erfolgreich validiert.",details:`Video ${d.value?.id} ist jetzt bereit f√ºr die vollst√§ndige Segment-Annotation.`},a.success({text:"Outside-Segment Validierung abgeschlossen!"})};function We(n){return n==null?"unknown":["male","m√§nnlich","m"].includes(n)?"male":["female","weiblich","f","w"].includes(n)?"female":["other","divers","d"].includes(n)?"unknown":n}function De(n){if(!n)return;E.value=!1,_.value=null,O.value=0,v.value=0,q.value=!1;const t=n.examinationDate||"",$=n.patientDobDisplay||n.patientDob;A.value=k.toISO(t)||"";const u=We(n.patientGenderName);c.value={patientFirstName:n.patientFirstName||"",patientLastName:n.patientLastName||"",patientGenderName:u||"",patientDob:k.toISO($)||"",casenumber:n.casenumber||"",externalId:n.externalId??"",externalIdOrigin:n.externalIdOrigin??"",centerName:n.centerName??"",text:n.text??"",anonymizedText:n.anonymizedText??"",examinersDisplay:n.examinersDisplay??"",examinationDate:A.value},ie.value={anonymizedText:c.value.anonymizedText??"",examinationDate:A.value,patient:{...c.value}},sessionStorage.setItem("last:fileId",String(n.id))}ye(d,n=>{n&&De(n)},{immediate:!0});const ce=async()=>{try{await s.fetchNext()}catch(n){console.error("Error fetching next item:",n)}},He=y(()=>J.value!==ie.value.anonymizedText||A.value!==ie.value.examinationDate||!Oe(c.value,ie.value.patient)),Ze=y(()=>d.value&&!L.value),L=g(!1),Je=()=>{ae.value=!ae.value};function Se(){const n=new Tt;if(G.value=[],R.value="",j.value="",c.value.patientDob){const t=c.value.patientDob;k.validate(t,"ISO")?T.value="ISO (YYYY-MM-DD)":k.validate(t,"German")?T.value="Deutsch (DD.MM.YYYY)":(T.value="",R.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",n.addField("Geburtsdatum",t,"German"))}else T.value="";if(A.value){const t=A.value;k.validate(t,"ISO")?C.value="ISO (YYYY-MM-DD)":k.validate(t,"German")?C.value="Deutsch (DD.MM.YYYY)":(C.value="",j.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",n.addField("Untersuchungsdatum",t,"ISO"))}else C.value="";Q.value&&se.value&&n.addConstraint("DOB_BEFORE_EXAM",k.isBeforeOrEqual(Q.value,se.value),"Geburtsdatum muss vor oder am selben Tag wie das Untersuchungsdatum liegen"),n.hasErrors()&&(G.value=n.getErrors(),n.getErrors().forEach($=>{$.includes("Geburtsdatum")&&(R.value=$.replace("Geburtsdatum: ","")),$.includes("Untersuchungsdatum")&&(j.value=$.replace("Untersuchungsdatum: ",""))}))}function Qe(){const n=c.value.patientDob;if(!n)return;const t=k.toISO(n);t&&(c.value.patientDob=t,T.value="ISO (YYYY-MM-DD)"),Se()}function Xe(){const n=A.value;if(!n)return;const t=k.toISO(n);t&&(A.value=t,C.value="ISO (YYYY-MM-DD)"),Se()}function et(){G.value=[],R.value="",j.value=""}const tt=async()=>{d.value&&await ce()},nt=()=>{if(!d.value){a.error({text:"Kein Video zur Segmentierung ausgew√§hlt."});return}f.push({name:"Video-Untersuchung",query:{video:d.value.id.toString()}}),console.log(`üéØ Navigating to Video-Untersuchung with video ID: ${d.value.id}`)},at=async()=>{if(!(!d.value||!Ze.value||L.value)){if(!ge.value){const n=ue.value;console.warn(`‚ùå Approval blocked: ${n}`),a.warning({text:n});return}if(h.value&&E.value){console.warn("‚ùå Outside segments still pending validation"),a.error({text:"Bitte validieren Sie zuerst alle Outside-Segmente, bevor Sie das Video best√§tigen."});return}L.value=!0;try{console.log(`Validating anonymization for file ${d.value.id}...`);try{await me.post(he(`anonymization/${d.value.id}/validate/`),{patient_first_name:c.value.patientFirstName,patient_last_name:c.value.patientLastName,patient_gender:c.value.patientGenderName,patient_dob:k.toGerman(Q.value||"")||"",examination_date:k.toGerman(se.value||"")||"",casenumber:c.value.casenumber||"",anonymized_text:c.value.anonymizedText||void 0,text:c.value.text||void 0,is_verified:"true",file_type:b.value?"pdf":h.value?"video":"unknown",center_name:c.value.centerName||"",external_id:c.value.externalId||"",external_id_origin:c.value.externalIdOrigin||""}),console.log(`Anonymization validated successfully for file ${d.value.id}`),a.success({text:"Dokument best√§tigt und Anonymisierung validiert"})}catch(t){console.error("Error validating anonymization:",t),a.warning({text:"Dokument best√§tigt, aber Validierung fehlgeschlagen"})}const n=b.value?"pdf":h.value?"video":"unknown";if(n==="unknown"){a.error({text:"Bitte Medientyp ausw√§hlen, bevor best√§tigt wird."});return}l.validateAnonymizationSafeWithProtection(d.value.id,n),await nt()}catch(n){console.error("Error approving item:",n),a.error({text:"Fehler beim Best√§tigen des Elements"})}finally{L.value=!1}}},st=async()=>{d.value&&await ce()},it=async()=>{if(!d.value){a.error({text:"Kein Element zur Korrektur ausgew√§hlt."});return}try{f.push({name:"Anonymisierung Korrektur",params:{fileId:d.value.id.toString()}}),a.info({text:"√Ñnderungen gespeichert. Bitte w√§hlen Sie das Element erneut f√ºr die Korrektur aus."});return}catch{a.error({text:"Fehler beim Speichern. Korrektur-Navigation abgebrochen."});return}};return Ne(async()=>{Number.isFinite(V)&&M&&w.setCurrentByKey(M,V),s.current?De(s.current):await ce()}),ut(()=>{ce()}),(n,t)=>{const $=vt("router-link");return i(),r("div",Ct,[e("div",Ut,[t[70]||(t[70]=e("div",{class:"card-header pb-0"},[e("h4",{class:"mb-0"},"Anonymisierungsvalidierung und Annotationen")],-1)),e("div",Bt,[H(s).loading?(i(),r("div",Gt,[...t[16]||(t[16]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Wird geladen...")],-1),e("p",{class:"mt-2"},"Anonymisierte Daten werden geladen...",-1)])])):H(s).error?(i(),r("div",Lt,[t[17]||(t[17]=e("strong",null,"Fehler:",-1)),m(" "+o(H(s).error),1)])):d.value?x("",!0):(i(),r("div",{key:2,class:"alert alert-info",role:"alert",onLoadstart:t[0]||(t[0]=u=>H(s).fetchNext())}," Alle Anonymisierungen wurden bearbeitet. ",32)),H(s).isAnyFileProcessing?(i(),r("div",Kt,[t[19]||(t[19]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("strong",null,o(H(s).processingFiles.length)+" Datei(en)",1),t[20]||(t[20]=m(" werden gerade anonymisiert. ",-1)),e("div",Rt,[Ve($,{to:"/anonymisierung/uebersicht",class:"btn btn-sm btn-outline-primary"},{default:ct(()=>[...t[18]||(t[18]=[e("i",{class:"fas fa-eye me-1"},null,-1),m(" Zur √úbersicht ",-1)])]),_:1})])])):x("",!0)]),d.value?(i(),r(ve,{key:0},[e("div",jt,[e("div",qt,[e("div",Wt,[e("div",null,[t[22]||(t[22]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("span",null,[t[21]||(t[21]=e("strong",null,"Validierung:",-1)),m(" "+o(b.value?"PDF-Dokument":h.value?"Video-Datei":"Unbekanntes Format")+" "+o(d.value?.centerName?`- ${d.value.centerName}`:""),1)])]),d.value&&(h.value||b.value)?(i(),r("div",Ht,[e("small",Zt,[t[23]||(t[23]=e("i",{class:"fas fa-tools me-1"},null,-1)),m(" "+o(h.value?"Video-Korrektur verf√ºgbar":"Text-Korrektur verf√ºgbar"),1)])])):x("",!0)])])]),e("div",Jt,[e("div",Qt,[e("div",Xt,[z(e("input",{type:"checkbox",class:"form-check-input",id:"noMoreNames","onUpdate:modelValue":t[1]||(t[1]=u=>ne.value=u)},null,512),[[mt,ne.value]]),t[24]||(t[24]=e("label",{class:"form-check-label",for:"noMoreNames"}," Keine weiteren Namen im Video oder PDF vorhanden ",-1))])])]),G.value.length>0?(i(),r("div",en,[e("div",tn,[e("div",nn,[e("h6",an,[t[25]||(t[25]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" "+o(Ee.value),1)]),t[26]||(t[26]=e("hr",null,null,-1)),e("ul",sn,[(i(!0),r(ve,null,we(G.value,(u,ke)=>(i(),r("li",{key:ke},o(u),1))),128))]),e("button",{type:"button",class:"btn-close",onClick:et,"aria-label":"Schlie√üen"})])])])):x("",!0),e("div",ln,[e("div",on,[e("div",rn,[e("div",dn,[t[41]||(t[41]=e("h5",{class:"card-title"},"Patienteninformationen",-1)),e("div",un,[t[27]||(t[27]=e("label",{class:"form-label"},"Vorname:",-1)),z(e("input",{type:"text",class:K(["form-control",{"is-invalid":!le.value}]),"onUpdate:modelValue":t[2]||(t[2]=u=>c.value.patientFirstName=u)},null,2),[[Y,c.value.patientFirstName]]),le.value?x("",!0):(i(),r("div",cn," Vorname ist erforderlich. "))]),e("div",vn,[t[28]||(t[28]=e("label",{class:"form-label"},"Nachname:",-1)),z(e("input",{type:"text",class:K(["form-control",{"is-invalid":!oe.value}]),"onUpdate:modelValue":t[3]||(t[3]=u=>c.value.patientLastName=u)},null,2),[[Y,c.value.patientLastName]]),oe.value?x("",!0):(i(),r("div",mn," Nachname ist erforderlich. "))]),e("div",fn,[t[30]||(t[30]=e("label",{class:"form-label"},"Geschlecht:",-1)),z(e("select",{class:"form-select","onUpdate:modelValue":t[4]||(t[4]=u=>c.value.patientGenderName=u)},[...t[29]||(t[29]=[e("option",{value:"male"},"M√§nnlich",-1),e("option",{value:"female"},"Weiblich",-1),e("option",{value:"unknown"},"Divers",-1)])],512),[[Ie,c.value.patientGenderName]])]),e("div",gn,[t[32]||(t[32]=e("label",{class:"form-label"},"Geburtsdatum:",-1)),z(e("input",{type:"date",class:K(["form-control",{"is-invalid":!re.value}]),"onUpdate:modelValue":t[5]||(t[5]=u=>c.value.patientDob=u),onBlur:Qe},null,34),[[Y,c.value.patientDob]]),e("small",pn,[t[31]||(t[31]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),T.value?(i(),r("span",bn,o(T.value),1)):x("",!0)]),re.value?x("",!0):(i(),r("div",hn,o(R.value||"G√ºltiges Geburtsdatum ist erforderlich."),1))]),e("div",yn,[t[33]||(t[33]=e("label",{class:"form-label"},"Fallnummer:",-1)),z(e("input",{type:"text",class:"form-control","onUpdate:modelValue":t[6]||(t[6]=u=>c.value.casenumber=u)},null,512),[[Y,c.value.casenumber]])]),e("div",wn,[t[35]||(t[35]=e("label",{class:"form-label"},"Untersuchungsdatum:",-1)),z(e("input",{type:"date",class:K(["form-control",{"is-invalid":!de.value}]),"onUpdate:modelValue":t[7]||(t[7]=u=>A.value=u),onBlur:Xe},null,34),[[Y,A.value]]),e("small",xn,[t[34]||(t[34]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),C.value?(i(),r("span",_n,o(C.value),1)):x("",!0)]),de.value?x("",!0):(i(),r("div",Dn,o(j.value||"Das Untersuchungsdatum darf nicht vor dem Geburtsdatum liegen."),1))]),e("div",Sn,[t[36]||(t[36]=e("label",{class:"form-label"},"Anonymisierter Text:",-1)),z(e("textarea",{class:"form-control",rows:"6","onUpdate:modelValue":t[8]||(t[8]=u=>J.value=u)},null,512),[[Y,J.value]])]),e("div",kn,[t[37]||(t[37]=e("label",{class:"form-label"},"Externe ID:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[9]||(t[9]=u=>c.value.externalId=u)},null,512),[[Y,c.value.externalId]])]),e("div",Vn,[t[38]||(t[38]=e("label",{class:"form-label"},"Untersucher:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[10]||(t[10]=u=>c.value.examinersDisplay=u)},null,512),[[Y,c.value.examinersDisplay]])]),e("div",In,[t[39]||(t[39]=e("label",{class:"form-label"},"Quelle der Daten:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[11]||(t[11]=u=>c.value.externalIdOrigin=u)},"                    ",512),[[Y,c.value.externalIdOrigin]])]),e("div",$n,[t[40]||(t[40]=e("label",{class:"form-label"},"Zentrum:",-1)),z(e("textarea",{class:"form-control","onUpdate:modelValue":t[12]||(t[12]=u=>c.value.centerName=u)},"                    ",512),[[Y,c.value.centerName]])])]),e("div",Nn,[e("div",An,[t[42]||(t[42]=e("h5",{class:"card-title"},"Annotationen",-1)),I.value?(i(),r("div",zn,[e("img",{src:ae.value?p.value:I.value,class:"img-fluid",alt:"Uploaded Image"},null,8,Fn),e("button",{class:"btn btn-info btn-sm mt-2",onClick:Je},o(ae.value?"Bearbeitetes Bild anzeigen":"Original anzeigen"),1)])):x("",!0),t[43]||(t[43]=e("div",{class:"mt-3"},null,-1))])])])]),e("div",On,[e("div",En,[e("div",Pn,[e("h5",Mn,o(b.value?"PDF Vorschau":"Video Vorschau"),1),e("div",Yn,[t[44]||(t[44]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),t[45]||(t[45]=e("strong",null,"Datenformat:",-1)),b.value?(i(),r("span",Tn," PDF-Dokument ("+o(Math.round((W.value?.length||0)/1024)||"Nicht Verf√ºgbar")+" KB) ",1)):h.value?(i(),r("span",Cn," Video-Datei (Raw: "+o(pe.value||"N/A")+" | Anonymized: "+o(be.value||"N/A")+") ",1)):(i(),r("span",Un," Unbekanntes Format - ID: "+o(d.value?.id),1))])]),e("div",Bn,[b.value?(i(),r("div",Gn,[e("div",Ln,[e("div",Kn,[e("div",Rn,[t[48]||(t[48]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-file-pdf me-1"}),m(" Original PDF (Raw) ")],-1)),e("iframe",{src:X.value,width:"100%",height:"700px",frameborder:"0",title:"Original PDF Vorschau"},[t[46]||(t[46]=m(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:X.value},"hier herunterladen",8,qn),t[47]||(t[47]=m(". ",-1))],8,jn),e("div",Wn,[e("small",Hn," URL: "+o(X.value||"Nicht verf√ºgbar"),1)])])]),e("div",Zn,[e("div",Jn,[t[51]||(t[51]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes PDF (Processed) ")],-1)),e("iframe",{src:W.value,width:"100%",height:"700px",frameborder:"0",title:"Anonymisiertes PDF Vorschau"},[t[49]||(t[49]=m(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:W.value},"hier herunterladen",8,Xn),t[50]||(t[50]=m(". ",-1))],8,Qn),e("div",ea,[e("small",ta," URL: "+o(W.value||"Nicht verf√ºgbar"),1)])])])]),e("div",{class:"pdf-controls mt-3 text-center"},[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Le},[...t[52]||(t[52]=[e("i",{class:"fas fa-download me-1"},null,-1),m(" Original herunterladen ",-1)])]),e("button",{class:"btn btn-outline-success btn-sm",onClick:Ke},[...t[53]||(t[53]=[e("i",{class:"fas fa-download me-1"},null,-1),m(" Anonymisiert herunterladen ",-1)])])])])):h.value?(i(),r("div",na,[e("div",aa,[e("div",sa,[e("div",ia,[t[54]||(t[54]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-eye me-1"}),m(" Original Video (Raw) ")],-1)),e("video",{ref_key:"rawVideoElement",ref:U,src:pe.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Pe,onLoadstart:Me,onCanplay:Ye,onTimeupdate:t[13]||(t[13]=u=>_e("raw"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,la),e("div",oa,[e("small",ra," URL: "+o(pe.value||"Nicht verf√ºgbar"),1)])])]),e("div",da,[e("div",ua,[t[55]||(t[55]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes Video (Processed) ")],-1)),e("video",{ref_key:"anonymizedVideoElement",ref:B,src:be.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Te,onLoadstart:Ce,onCanplay:Ue,onTimeupdate:t[14]||(t[14]=u=>_e("anonymized"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,ca),e("div",va,[e("small",ma," URL: "+o(be.value||"Nicht verf√ºgbar"),1)])])])]),e("div",fa,[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Be},[...t[56]||(t[56]=[e("i",{class:"fas fa-sync me-1"},null,-1),m(" Videos synchronisieren ",-1)])]),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:Ge},[...t[57]||(t[57]=[e("i",{class:"fas fa-pause me-1"},null,-1),m(" Alle pausieren ",-1)])]),e("button",{class:"btn btn-outline-info btn-sm ms-2",onClick:Re,disabled:q.value},[q.value?(i(),r("span",pa)):(i(),r("i",ba)),t[58]||(t[58]=m(" Segment-Annotation pr√ºfen ",-1))],8,ga)]),E.value&&d.value?(i(),r("div",ha,[e("div",ya,[e("div",wa,[e("div",xa,[e("div",null,[e("h6",_a,[t[59]||(t[59]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" Segmente zur Entfernung - Video ID: "+o(d.value.id),1)]),t[60]||(t[60]=e("small",{class:"text-muted"},' Diese Segmente wurden als "outside" klassifiziert und sollten aus dem Video entfernt werden. ',-1))]),e("div",Da,[e("div",Sa,o(O.value)+" / "+o(v.value),1),e("div",ka,[e("div",{class:"progress-bar bg-success",role:"progressbar",style:Ae({width:xe.value+"%"}),"aria-valuenow":O.value,"aria-valuemin":0,"aria-valuemax":v.value},null,12,Va)]),e("small",Ia,o(xe.value)+"% validiert",1)])])]),e("div",$a,[Ve(Yt,{videoId:d.value.id,onSegmentValidated:je,onValidationComplete:qe},null,8,["videoId"])])])])):x("",!0),_.value?(i(),r("div",{key:1,class:K(["alert mt-3",_.value.class])},[e("i",{class:K([_.value.icon,"me-2"])},null,2),e("strong",null,o(_.value.title)+":",1),m(" "+o(_.value.message)+" ",1),_.value.details?(i(),r("div",Na,[e("small",null,o(_.value.details),1)])):x("",!0)],2)):x("",!0)])):(i(),r("div",Aa,[t[65]||(t[65]=e("h6",null,"Debug-Informationen:",-1)),e("ul",za,[e("li",null,[t[61]||(t[61]=e("strong",null,"Current Item ID:",-1)),m(" "+o(d.value?.id||"Nicht verf√ºgbar"),1)]),e("li",null,[t[62]||(t[62]=e("strong",null,"Is PDF:",-1)),m(" "+o(b.value),1)]),e("li",null,[t[63]||(t[63]=e("strong",null,"Is Video:",-1)),m(" "+o(h.value),1)]),e("li",null,[t[64]||(t[64]=e("strong",null,"Detected Media Type:",-1)),m(" "+o(d.value?H(w).detectMediaType(d.value):"N/A"),1)])])]))])])])]),e("div",Fa,[e("div",Oa,[e("button",{class:"btn btn-secondary",onClick:tt}," √úberspringen "),e("div",Ea,[d.value&&(h.value||b.value)?(i(),r("button",{key:0,class:"btn btn-warning position-relative",onClick:it,disabled:L.value,title:h.value?"Video-Korrektur: Maskierung, Frame-Entfernung, etc.":"PDF-Korrektur: Text-Annotation anpassen"},[t[66]||(t[66]=e("i",{class:"fas fa-edit me-1"},null,-1)),m(" "+o(h.value?"Video-Korrektur":"PDF-Korrektur")+" ",1),He.value?(i(),r("span",Ma," ! ")):x("",!0)],8,Pa)):x("",!0),e("button",{class:"btn btn-danger me-2",onClick:st}," Ablehnen "),e("button",{class:"btn btn-success",onClick:at,disabled:L.value||!ge.value,title:ue.value},[L.value?(i(),r("span",Ta)):x("",!0),m(" "+o(L.value?"Wird best√§tigt...":"Best√§tigen"),1)],8,Ya),te.value?(i(),r("div",Ca,[t[67]||(t[67]=e("strong",null," Bitte hier den Medientyp eingeben - Der mediaStore hat einen Fehler ",-1)),z(e("select",{"onUpdate:modelValue":t[15]||(t[15]=u=>Z.value=u)},[(i(),r(ve,null,we(F,u=>e("option",{value:u.value},o(u.text),9,Ua)),64))],512),[[Ie,Z.value]])])):x("",!0),!ge.value&&ue.value?(i(),r("div",Ba,[t[68]||(t[68]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[69]||(t[69]=e("strong",null,"Best√§tigung blockiert:",-1)),m(" "+o(ue.value),1)])):x("",!0)])])])],64)):x("",!0)])])}}}),Wa=ze(Ga,[["__scopeId","data-v-2575cad0"]]);export{Wa as default};
