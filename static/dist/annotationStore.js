import{L as _,I as X,e as s,T as c,O as g}from"./main.js";import"./videoStore.js";var l;(function(t){t.TEXT="text",t.REGION="region",t.POINT="point",t.SEGMENT="segment",t.CLASSIFICATION="classification",t.DETECTION="detection"})(l||(l={}));const K=_("annotation",()=>{const t=X({annotations:[],currentAnnotation:null,selectedAnnotations:[],filter:{},isLoading:!1,error:null,currentVideoId:null,playbackTime:0,isEditing:!1,isDirty:!1}),m=s(()=>{let e=t.annotations;if(t.filter.videoId&&(e=e.filter(n=>n.videoId===t.filter.videoId)),t.filter.type&&(e=e.filter(n=>n.type===t.filter.type)),t.filter.userId&&(e=e.filter(n=>n.userId===t.filter.userId)),t.filter.tags&&t.filter.tags.length>0&&(e=e.filter(n=>t.filter.tags.some(o=>n.tags.includes(o)))),t.filter.timeRange){const{start:n,end:o}=t.filter.timeRange;e=e.filter(a=>a.startTime>=n&&a.endTime<=o)}return t.filter.isPublic!==void 0&&(e=e.filter(n=>n.isPublic===t.filter.isPublic)),e.sort((n,o)=>n.startTime-o.startTime)}),S=s(()=>t.currentVideoId?t.annotations.filter(e=>e.videoId===t.currentVideoId):[]);s(()=>t.currentVideoId?S.value.filter(e=>t.playbackTime>=e.startTime&&t.playbackTime<=e.endTime):[]),s(()=>t.annotations.length),s(()=>t.annotations.filter(e=>t.selectedAnnotations.includes(e.id)));const p=s(()=>t.selectedAnnotations.length>0),b=s(()=>p.value),I=s(()=>t.selectedAnnotations.length===1),D=s(()=>t.annotations.length);async function A(e){t.isLoading=!0,t.error=null;try{const n=e?`/api/annotations/?video_id=${e}`:"/api/annotations/",o=await fetch(n);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const a=await o.json();t.annotations=a.map(r=>({...r,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt)}))}catch(n){t.error=n instanceof Error?n.message:"Failed to load annotations",console.error("Error loading annotations:",n)}finally{t.isLoading=!1}}async function d(e){t.isLoading=!0,t.error=null;try{const n=await fetch("/api/annotations/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();return o.createdAt=new Date(o.createdAt),o.updatedAt=new Date(o.updatedAt),t.annotations.push(o),t.isDirty=!1,o}catch(n){throw t.error=n instanceof Error?n.message:"Failed to create annotation",console.error("Error creating annotation:",n),n}finally{t.isLoading=!1}}async function v(e,n){t.isLoading=!0,t.error=null;try{const o=await fetch(`/api/annotations/${e}/`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const a=await o.json();a.updatedAt=new Date(a.updatedAt);const r=t.annotations.findIndex(i=>i.id===e);return r!==-1&&(t.annotations[r]={...t.annotations[r],...a}),t.currentAnnotation?.id===e&&(t.currentAnnotation={...t.currentAnnotation,...a}),t.isDirty=!1,a}catch(o){throw t.error=o instanceof Error?o.message:"Failed to update annotation",console.error("Error updating annotation:",o),o}finally{t.isLoading=!1}}async function k(e){t.isLoading=!0,t.error=null;try{const n=await fetch(`/api/annotations/${e}/`,{method:"DELETE"});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);t.annotations=t.annotations.filter(o=>o.id!==e),t.selectedAnnotations=t.selectedAnnotations.filter(o=>o!==e),t.currentAnnotation?.id===e&&(t.currentAnnotation=null)}catch(n){throw t.error=n instanceof Error?n.message:"Failed to delete annotation",console.error("Error deleting annotation:",n),n}finally{t.isLoading=!1}}async function L(e){t.isLoading=!0,t.error=null;try{const n=await fetch("/api/annotations/bulk-delete/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:e})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);t.annotations=t.annotations.filter(o=>!e.includes(o.id)),t.selectedAnnotations=t.selectedAnnotations.filter(o=>!e.includes(o)),t.currentAnnotation&&e.includes(t.currentAnnotation.id)&&(t.currentAnnotation=null)}catch(n){throw t.error=n instanceof Error?n.message:"Failed to delete annotations",console.error("Error bulk deleting annotations:",n),n}finally{t.isLoading=!1}}function P(e){t.currentAnnotation=e,t.isEditing=!1,t.isDirty=!1}function V(e){t.selectedAnnotations.includes(e)||t.selectedAnnotations.push(e)}function C(){t.selectedAnnotations=m.value.map(e=>e.id)}function y(){t.selectedAnnotations=[]}function E(e){t.filter={...t.filter,...e}}function x(){t.filter={}}function u(e){t.currentVideoId=e,e&&E({videoId:e})}function T(e){t.playbackTime=e}function F(){t.isEditing=!0}function $(){t.isEditing=!1,t.isDirty=!1}function N(){t.isDirty=!0}function O(e){T(e.startTime),P(e)}async function j(e="json"){try{const n=new URLSearchParams;t.filter.videoId&&n.append("video_id",t.filter.videoId),t.filter.type&&n.append("type",t.filter.type),n.append("format",e);const o=await fetch(`/api/annotations/export/?${n}`);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const a=await o.blob(),r=window.URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=`annotations.${e}`,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(r)}catch(n){t.error=n instanceof Error?n.message:"Failed to export annotations",console.error("Error exporting annotations:",n)}}function R(){t.error=null}function H(){t.annotations=[],t.currentAnnotation=null,t.selectedAnnotations=[],t.filter={},t.isLoading=!1,t.error=null,t.currentVideoId=null,t.playbackTime=0,t.isEditing=!1,t.isDirty=!1}async function h(e,n,o){try{const a={videoId:e,startTime:n.startTime,endTime:n.endTime,type:l.SEGMENT,text:n.label||n.name||`Segment ${n.id}`,tags:[n.label||"segment"],userId:o,isPublic:!1,confidence:n.avgConfidence||n.confidence,metadata:{segmentId:n.id,labelId:n.labelID||n.label_id}},r=await d(a);return console.log(`✅ Created segment annotation for segment ${n.id}:`,r),r}catch(a){return console.error("Failed to create segment annotation:",a),t.error=a instanceof Error?a.message:"Failed to create segment annotation",null}}async function G(e,n,o,a,r){try{const i={videoId:e,startTime:n,endTime:n,type:l.CLASSIFICATION,text:o,tags:["examination",o],userId:r,isPublic:!1,metadata:{examinationId:a,examinationType:o}},w=await d(i);return console.log("✅ Created examination annotation:",w),w}catch(i){return console.error("Failed to create examination annotation:",i),t.error=i instanceof Error?i.message:"Failed to create examination annotation",null}}async function M(e,n){if(!t.currentVideoId)return console.warn("No current video ID set for annotation linking"),null;const o=t.annotations.find(a=>a.type===l.SEGMENT&&a.metadata?.segmentId===e.id&&a.videoId===t.currentVideoId);return o?(console.log(`Segment ${e.id} already has annotation:`,o),o):await h(t.currentVideoId,e,n)}function f(e){const{useVideoStore:n}=require("./videoStore"),a=n().segments;t.annotations=t.annotations.filter(r=>!(r.videoId===e&&r.type===l.SEGMENT)),a.value.forEach(r=>{t.annotations.push({id:`seg-${r.id}`,videoId:e,startTime:r.startTime,endTime:r.endTime,type:l.SEGMENT,text:r.label,tags:[r.label],createdAt:new Date,updatedAt:new Date,userId:"",isPublic:!1,confidence:r.avgConfidence,metadata:{segmentId:r.id,labelId:r.labelID}})})}async function U(e){try{const{useVideoStore:n}=require("./videoStore");return await n().loadVideo(String(e)),u(String(e)),f(String(e)),await A(String(e)),!0}catch(n){return console.error("validateSegments failed:",n),t.error=n instanceof Error?n.message:String(n),!1}}async function q(e){try{const{useVideoStore:n}=require("./videoStore");return await n().loadVideo(String(e)),u(String(e)),f(String(e)),!0}catch(n){return console.error("annotateSegments failed:",n),t.error=n instanceof Error?n.message:String(n),!1}}async function J(){if(t.selectedAnnotations.length!==0)try{await L(t.selectedAnnotations),y()}catch(e){console.error("Failed to delete selected annotations:",e)}}return{annotations:g(t.annotations),isLoading:c(t).isLoading,error:c(t).error,selectedAnnotations:g(t.selectedAnnotations),filter:g(t.filter),currentVideoId:c(t).currentVideoId,playbackTime:c(t).playbackTime,isEditing:c(t).isEditing,isDirty:c(t).isDirty,filteredAnnotations:m,hasSelection:p,canDelete:b,canEdit:I,annotationCount:D,loadAnnotations:A,createAnnotation:d,updateAnnotation:v,deleteAnnotation:k,deleteSelectedAnnotations:J,selectAnnotation:V,selectAllAnnotations:C,clearSelection:y,setFilter:E,clearFilter:x,setCurrentVideoId:u,setPlaybackTime:T,startEditing:F,stopEditing:$,markDirty:N,seekToAnnotation:O,exportAnnotations:j,clearError:R,reset:H,syncSegmentsFromVideoStore:f,createSegmentAnnotation:h,createExaminationAnnotation:G,linkSegmentAndAnnotation:M,validateSegmentsAndExaminations:U,annotateSegmentsAndExaminations:q}});export{l as AnnotationType,K as useAnnotationStore};
