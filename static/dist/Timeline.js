import{d as Me,f as Ee,h as v,w as _,e as R,i as Se,L as W,J as Le,c as f,a as s,j as I,n as J,t as N,q as b,F as Y,m as G,E as K,k as Q,o as h,_ as Ne}from"./main.js";import{u as Fe}from"./videoStore.js";function re(r){if(!Number.isFinite(r)||r<0)return"00:00";const d=Math.floor(r/60),y=Math.floor(r%60);return`${d.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}`}function ze(r,d,y){return!Number.isFinite(r)||!Number.isFinite(d)||!Number.isFinite(y)||y<=0||d<=r?0:(d-r)/y*100}function Pe(r,d){return!Number.isFinite(r)||!Number.isFinite(d)||d<=0?0:r/d*100}function De(){for(var r="0123456789ABCDEF",d="#",y=0;y<6;y++)d+=r[Math.floor(Math.random()*16)];return d}const $e={class:"timeline-container"},_e={class:"timeline-header"},Re={class:"timeline-controls"},We=["disabled"],Ie={class:"time-display"},Be={class:"zoom-controls"},Xe=["disabled"],He={class:"zoom-level"},Oe=["disabled"],Ve={class:"time-markers"},je={class:"marker-text"},Ue={class:"segments-container"},qe=["data-id","onClick","onContextmenu"],Ae={class:"segment-content"},Je={class:"segment-label"},Ye={class:"segment-duration"},Ge=["onClick"],Ke={key:0,class:"draft-indicator"},Qe={key:0,class:"waveform-container"},Ze=Me({__name:"Timeline",props:{video:{},segments:{},labels:{},currentTime:{},isPlaying:{type:Boolean},activeSegmentId:{},showWaveform:{type:Boolean},selectionMode:{type:Boolean},fps:{}},emits:["seek","play-pause","segment-select","segment-edit","segment-delete","segment-create","segment-resize","segment-move","time-selection"],setup(r,{emit:d}){const y=Ee(),Z=Fe(),T=r,p=d,M=v(null),V=v(null),z=v([]),x=v(1),P=v(!1),S=v(0),L=v(0),B=v([]);_(()=>T.segments,e=>{(e||[]).forEach(t=>{B.value.includes(t.label)||B.value.push(t.label)})},{immediate:!0});const w=v({visible:!1,x:0,y:0,segment:null}),X=v({visible:!1,x:0,y:0,text:""}),g=R(()=>T.video?.duration||0),ue=R(()=>{const e=g.value,t=T.currentTime??0;if(!e||!Number.isFinite(e)||!Number.isFinite(t)||t<0)return 0;const n=t/e*100;return Number.isFinite(n)?Math.max(0,Math.min(100,n)):0}),ce=R(()=>{const e=[],t=g.value;if(!t)return e;const i=10/x.value,l=Math.floor(t/i);for(let o=0;o<=l;o++){const a=o*i;a<=t&&e.push({time:a,position:a/t*100})}return e}),ee=e=>Z.getColorForLabel(e),de=e=>Z.getTranslationForLabel(e),me=e=>{const t=e.color??ee(e.label)??De();return{...e,start:e.startTime,end:e.endTime,color:t,avgConfidence:e.avgConfidence??0}},D=v(null),ve=e=>{D.value=e.label,p("segment-select",Number(e.id))},k=v([]);_(()=>T.segments,e=>{e&&e.length>0?(console.debug("[Timeline] Processing segments:",{count:e.length,sample:e.slice(0,2).map(t=>({id:t.id,label:t.label,startTime:t.startTime,endTime:t.endTime}))}),k.value=e.map(me),console.debug("[Timeline] Canonical segments created:",{count:k.value.length,sample:k.value.slice(0,2).map(t=>({id:t.id,label:t.label,start:t.start,end:t.end,startTime:t.startTime,endTime:t.endTime}))})):k.value=[]},{immediate:!0});const $=R(()=>{const e={};console.debug("[Timeline] segmentRows - processing segments:",{count:k.value.length,segments:k.value.map(i=>({id:i.id,label:i.label,start:i.start,end:i.end}))});for(const i of k.value){if(!i.label){console.error("[Timeline] Segment missing label property:",i);continue}(e[i.label]||=[]).push(i)}console.debug("[Timeline] Label buckets created:",{labels:Object.keys(e),counts:Object.entries(e).map(([i,l])=>`${i}:${l.length}`)});const t=D.value?[D.value,...B.value.filter(i=>i!==D.value)]:[...B.value],n=[];return t.forEach(i=>{if(!e[i])return;const l=e[i].sort((u,E)=>u.start-E.start);let o=0,a={key:`${i}-0`,label:i,rowNumber:n.length,segments:[],maxEndTime:0};for(const u of l)u.start<a.maxEndTime-1e-4&&(n.push(a),o+=1,a={key:`${i}-${o}`,label:i,rowNumber:n.length,segments:[],maxEndTime:0}),a.segments.push(u),a.maxEndTime=Math.max(a.maxEndTime,u.end);n.push(a)}),console.debug("[Timeline] Rows created:",{count:n.length,rows:n.map(i=>({key:i.key,label:i.label,segmentCount:i.segments.length}))}),n}),F=R(()=>60+$.value.length*45+10),j=e=>typeof e!="number"||isNaN(e)?"00:00":re(e),fe=(e,t)=>{const n=t-e;return re(n)},he=e=>{const t=Pe(e,g.value);return!Number.isFinite(t)||t<0?(console.error("[Timeline] Invalid segment position calculated:",{startTime:e,duration:g.value,position:t}),0):t},te=(e,t)=>{const n=ze(e,t,g.value);return!Number.isFinite(n)||n<=0?(console.error("[Timeline] Invalid segment width calculated:",{startTime:e,endTime:t,duration:g.value,width:n}),0):n};function pe(e,t){let n=null,i=0,l=0,o=0,a=0,u=0;const E=m=>m/t.trackPx()*t.duration();function ae(m){const C=m.target;if(C.closest(".segment-delete-btn"))return;m.stopPropagation();const c=C.closest(".resize-handle");c?.classList.contains("start-handle")?n="start":c?.classList.contains("end-handle")?n="end":n="drag",i=m.clientX,l=e.offsetLeft,o=e.offsetWidth,e.setPointerCapture(m.pointerId),m.preventDefault()}function A(m){if(!n)return;const C=m.clientX-i;if(n==="drag"){let c=Math.min(Math.max(0,l+C),t.trackPx()-o);e.style.left=c+"px",a=c,u=c+o}if(n==="start"){let c=Math.min(l+C,l+o-10),oe=o+(l-c);e.style.left=c+"px",e.style.width=oe+"px",a=c,u=c+oe}if(n==="end"){let c=Math.max(10,o+C);e.style.width=c+"px",e.style.left=l+"px",a=l,u=l+c}}function O(m){if(!n)return;A(m);const C=a,c=u;n==="drag"?t.onMove(E(C),E(c)):t.onResize(E(C),E(c),n),n=null,e.releasePointerCapture(m.pointerId),t.onDone()}return e.addEventListener("pointerdown",ae),e.addEventListener("pointermove",A),e.addEventListener("pointerup",O),e.addEventListener("pointercancel",O),()=>{e.removeEventListener("pointerdown",ae),e.removeEventListener("pointermove",A),e.removeEventListener("pointerup",O),e.removeEventListener("pointercancel",O)}}const ne=()=>{z.value.forEach(e=>e()),z.value=[],M.value&&W(()=>{$.value.forEach(e=>{e.segments.forEach(t=>{const n=document.querySelector(`[data-id="${t.id}"]`);if(!n)return;const i=pe(n,{trackPx:()=>M.value.offsetWidth,duration:()=>g.value,onMove:(l,o)=>{const a=k.value.find(u=>u.id===t.id);a&&(a.start=l,a.end=o,a.startTime=l,a.endTime=o),p("segment-move",Number(t.id),l,o)},onResize:(l,o,a)=>{const u=k.value.find(E=>E.id===t.id);u&&(u.start=l,u.end=o,u.startTime=l,u.endTime=o),p("segment-resize",Number(t.id),l,o,a)},onDone:()=>{const l=k.value.find(a=>a.id===t.id);if(!l)return;const o=Ce(t.id);o!==null&&p("segment-resize",o,l.start,l.end,"end",!0)}});z.value.push(i)})})})},ge=()=>{x.value<5&&(x.value=Math.min(5,x.value+.5))},be=()=>{x.value>1&&(x.value=Math.max(1,x.value-.5))},ye=()=>{p("play-pause")},xe=e=>{e&&(H(),p("segment-edit",e))},ie=e=>{e&&(H(),p("segment-delete",e))},ke=e=>{e&&(H(),p("seek",e.startTime||0),p("play-pause"))},Te=(e,t)=>{w.value={visible:!0,x:t.clientX,y:t.clientY,segment:e}},H=()=>{w.value.visible=!1},we=e=>{if(!M.value)return;const t=M.value.getBoundingClientRect(),n=e.clientX-t.left,i=n/t.width*g.value;T.selectionMode?(P.value=!0,S.value=n/t.width*100,L.value=S.value,document.addEventListener("mousemove",U),document.addEventListener("mouseup",q)):p("seek",i)},U=e=>{if(!P.value||!M.value)return;const t=M.value.getBoundingClientRect(),n=e.clientX-t.left;L.value=Math.max(0,Math.min(100,n/t.width*100))},q=e=>{if(!P.value||!M.value)return;const t=Math.min(S.value,L.value),n=Math.max(S.value,L.value),i=t/100*g.value,l=n/100*g.value;l-i>.1&&p("time-selection",{start:i,end:l}),P.value=!1,S.value=0,L.value=0,document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",q)},se=()=>{if(!V.value||!T.video)return;const e=V.value,t=e.getContext("2d");if(t){e.width=e.offsetWidth,e.height=e.offsetHeight,t.fillStyle="#e0e0e0",t.fillRect(0,0,e.width,e.height),t.strokeStyle="#2196F3",t.lineWidth=1,t.beginPath();for(let n=0;n<e.width;n+=2){const i=Math.random()*e.height*.8+e.height*.1;n===0?t.moveTo(n,i):t.lineTo(n,i)}t.stroke()}},le=e=>{w.value.visible&&!e.target?.closest(".context-menu")&&H()};_(()=>T.video,()=>{T.showWaveform&&W(()=>{se()})}),_($,()=>W(ne),{immediate:!0}),_($,e=>{e.forEach(t=>{t.segments.forEach(n=>{te(n.start,n.end)===0&&console.warn("[Timeline] Segment mit 0% Breite:",n)})})},{immediate:!0}),Se(()=>{document.addEventListener("click",le),W(()=>{ne()}),T.showWaveform&&W(()=>{se()}),y.success({text:"[Timeline] Component mounted and ready"})}),Le(()=>{document.removeEventListener("click",le),z.value.forEach(e=>e()),z.value=[],document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",q)});const Ce=e=>typeof e=="number"&&Number.isFinite(e)?e:(console.error("[Timeline] Unexpected segment ID:",e),null);return(e,t)=>(h(),f("div",$e,[s("div",_e,[s("div",Re,[s("button",{onClick:ye,class:"play-btn",disabled:!r.video},[s("i",{class:J(r.isPlaying?"fas fa-pause":"fas fa-play")},null,2)],8,We),s("span",Ie,N(j(r.currentTime))+" / "+N(j(g.value)),1)]),s("div",Be,[s("button",{onClick:be,disabled:x.value<=1},[...t[4]||(t[4]=[s("i",{class:"fas fa-search-minus"},null,-1)])],8,Xe),s("span",He,N(Math.round(x.value*100))+"%",1),s("button",{onClick:ge,disabled:x.value>=5},[...t[5]||(t[5]=[s("i",{class:"fas fa-search-plus"},null,-1)])],8,Oe)])]),s("div",{class:"timeline-wrapper",style:b({height:F.value+"px"})},[s("div",{class:"timeline",ref_key:"timeline",ref:M,onMousedown:we,style:b({height:F.value+"px"})},[s("div",Ve,[(h(!0),f(Y,null,G(ce.value,n=>(h(),f("div",{key:n.time,class:"time-marker",style:b({left:n.position+"%"})},[s("div",{class:"marker-line",style:b({height:F.value+"px"})},null,4),s("div",je,N(j(n.time)),1)],4))),128))]),s("div",Ue,[(h(!0),f(Y,null,G($.value,n=>(h(),f("div",{key:n.key,class:J(["segment-row",{active:n.label===D.value}]),style:b({top:n.rowNumber*45+"px",height:"40px"})},[(h(!0),f(Y,null,G(n.segments,i=>(h(),f("div",{key:i.id,class:J(["segment",{active:i.id===r.activeSegmentId,draft:i.isDraft}]),style:b({left:he(i.start)+"%",width:te(i.start,i.end)+"%",backgroundColor:i.color||ee(i.label),borderColor:i.isDraft?"#ff9800":"transparent"}),"data-id":i.id,onClick:l=>ve(i),onContextmenu:K(l=>Te(i,l),["prevent"])},[t[7]||(t[7]=s("div",{class:"resize-handle start-handle",title:"Segment-Start ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),s("div",Ae,[s("span",Je,N(de(i.label)),1),s("span",Ye,N(fe(i.start,i.end)),1)]),s("div",{class:"segment-delete-btn",onClick:K(l=>ie(i),["stop"]),title:"Segment löschen"},"X",8,Ge),t[8]||(t[8]=s("div",{class:"resize-handle end-handle",title:"Segment-Ende ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),i.isDraft?(h(),f("div",Ke,[...t[6]||(t[6]=[s("i",{class:"fas fa-edit"},null,-1)])])):I("",!0)],46,qe))),128))],6))),128))]),s("div",{class:"playhead",style:b({left:ue.value+"%",height:F.value+"px"})},[s("div",{class:"playhead-line",style:b({height:F.value+"px"})},null,4),t[9]||(t[9]=s("div",{class:"playhead-handle"},null,-1))],4),P.value?(h(),f("div",{key:0,class:"selection-overlay",style:b({left:Math.min(S.value,L.value)+"%",width:Math.abs(L.value-S.value)+"%",height:F.value+"px"})},null,4)):I("",!0)],36),r.showWaveform?(h(),f("div",Qe,[s("canvas",{ref_key:"waveformCanvas",ref:V,class:"waveform-canvas"},null,512)])):I("",!0)],4),w.value.visible?(h(),f("div",{key:0,class:"context-menu",style:b({left:w.value.x+"px",top:w.value.y+"px"}),onClick:t[3]||(t[3]=K(()=>{},["stop"]))},[s("div",{class:"context-menu-item",onClick:t[0]||(t[0]=n=>xe(w.value.segment))},[...t[10]||(t[10]=[s("i",{class:"fas fa-edit"},null,-1),Q(" Segment bearbeiten ",-1)])]),s("div",{class:"context-menu-item danger",onClick:t[1]||(t[1]=n=>ie(w.value.segment))},[...t[11]||(t[11]=[s("i",{class:"fas fa-trash"},null,-1),Q(" Segment löschen ",-1)])]),t[13]||(t[13]=s("div",{class:"context-menu-separator"},null,-1)),s("div",{class:"context-menu-item",onClick:t[2]||(t[2]=n=>ke(w.value.segment))},[...t[12]||(t[12]=[s("i",{class:"fas fa-play"},null,-1),Q(" Segment abspielen ",-1)])])],4)):I("",!0),X.value.visible?(h(),f("div",{key:1,class:"timeline-tooltip",style:b({left:X.value.x+"px",top:X.value.y+"px"})},N(X.value.text),5)):I("",!0)]))}}),nt=Ne(Ze,[["__scopeId","data-v-5a269f8e"]]);export{nt as T};
