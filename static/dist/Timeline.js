import{d as De,f as Pe,h as k,e as T,w as j,i as Ie,L as B,J as Re,c as m,a as s,j as N,n as J,t as F,q as p,F as K,m as Y,E as G,k as Q,o as v,_ as We}from"./main.js";import{u as $e}from"./videoStore.js";function de(r){if(!Number.isFinite(r)||r<0)return"00:00";const d=Math.floor(r/60),y=Math.floor(r%60);return`${d.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}`}function Be(r,d,y){return!Number.isFinite(r)||!Number.isFinite(d)||!Number.isFinite(y)||y<=0||d<=r?0:(d-r)/y*100}function Xe(r,d){return!Number.isFinite(r)||!Number.isFinite(d)||d<=0?0:r/d*100}function _e(){for(var r="0123456789ABCDEF",d="#",y=0;y<6;y++)d+=r[Math.floor(Math.random()*16)];return d}const He={class:"timeline-container"},Ae={class:"timeline-header"},Ve={class:"timeline-controls"},Ue=["disabled"],Oe=["disabled"],qe={class:"time-display"},je={class:"zoom-controls"},Je=["disabled"],Ke={class:"zoom-level"},Ye=["disabled"],Ge={class:"time-markers"},Qe={class:"marker-text"},Ze=["data-id","onClick","onContextmenu"],et={class:"segment-content"},tt={class:"segment-label"},nt={key:0,class:"segment-duration"},it=["onClick"],st={key:1,class:"draft-indicator"},ot={key:0,class:"waveform-container"},me=36,Z=56,at=48,lt=12,rt=1,ut=De({__name:"Timeline",props:{video:{},segments:{},labels:{},currentTime:{},isPlaying:{type:Boolean},activeSegmentId:{},showWaveform:{type:Boolean},selectionMode:{type:Boolean},fps:{}},emits:["seek","play-pause","segment-select","segment-edit","segment-delete","segment-create","segment-resize","segment-move","time-selection"],setup(r,{emit:d}){const y=Pe(),ee=$e(),g=r,f=d,S=k(null),A=k(null),I=k([]),x=k(1),R=k(!1),M=k(0),L=k(0),w=k({visible:!1,x:0,y:0,segment:null}),X=k({visible:!1,x:0,y:0,text:""}),b=T(()=>g.video?.duration||0),ve=T(()=>{const e=b.value,t=g.currentTime??0;if(!e||!Number.isFinite(e)||!Number.isFinite(t)||t<0)return 0;const n=t/e*100;return Number.isFinite(n)?Math.max(0,Math.min(100,n)):0}),fe=T(()=>{const e=[],t=b.value;if(!t)return e;const i=10/x.value,o=Math.floor(t/i);for(let l=0;l<=o;l++){const a=l*i;a<=t&&e.push({time:a,position:a/t*100})}return e}),te=e=>ee.getColorForLabel(e),he=e=>ee.getTranslationForLabel(e),pe=e=>{const t=e.color??te(e.label)??_e();return{...e,start:e.startTime,end:e.endTime,color:t,avgConfidence:e.avgConfidence??0}},z=T(()=>{const e=g.segments||[];return e.length===0?[]:e.map(pe)}),ne=T(()=>{const e=new Set;return z.value.forEach(t=>e.add(t.label)),Array.from(e).sort()}),W=k(null),ge=e=>{W.value=e.label,f("segment-select",Number(e.id))},D=T(()=>{const e={};for(const i of z.value)i.label&&(e[i.label]||=[]).push(i);const t=W.value?[W.value,...ne.value.filter(i=>i!==W.value)]:[...ne.value],n=[];return t.forEach(i=>{if(!e[i])return;const o=e[i].sort((u,C)=>u.start-C.start);let l=0,a={key:`${i}-0`,label:i,rowNumber:n.length,segments:[],maxEndTime:0};for(const u of o)u.start<a.maxEndTime-1e-4&&(n.push(a),l+=1,a={key:`${i}-${l}`,label:i,rowNumber:n.length,segments:[],maxEndTime:0}),a.segments.push(u),a.maxEndTime=Math.max(a.maxEndTime,u.end);n.push(a)}),n}),be=T(()=>D.value.length*Z),ye=T(()=>Math.max(1,Math.min(D.value.length,rt))),P=T(()=>me+ye.value*Z+lt),V=e=>typeof e!="number"||isNaN(e)?"00:00":de(e),xe=(e,t)=>{const n=t-e;return de(n)},ke=e=>{const t=Xe(e,b.value);return!Number.isFinite(t)||t<0?(console.error("[Timeline] Invalid segment position calculated:",{startTime:e,duration:b.value,position:t}),0):t},$=(e,t)=>{const n=Be(e,t,b.value);return!Number.isFinite(n)||n<=0?(console.error("[Timeline] Invalid segment width calculated:",{startTime:e,endTime:t,duration:b.value,width:n}),0):n};function we(e,t){let n=null,i=0,o=0,l=0,a=0,u=0;const C=h=>h/t.trackPx()*t.duration();function ue(h){const E=h.target;if(E.closest(".segment-delete-btn"))return;h.stopPropagation();const c=E.closest(".resize-handle");c?.classList.contains("start-handle")?n="start":c?.classList.contains("end-handle")?n="end":n="drag",i=h.clientX,o=e.offsetLeft,l=e.offsetWidth,e.setPointerCapture(h.pointerId),h.preventDefault()}function q(h){if(!n)return;const E=h.clientX-i;if(n==="drag"){let c=Math.min(Math.max(0,o+E),t.trackPx()-l);e.style.left=c+"px",a=c,u=c+l}if(n==="start"){let c=Math.min(o+E,o+l-10),ce=l+(o-c);e.style.left=c+"px",e.style.width=ce+"px",a=c,u=c+ce}if(n==="end"){let c=Math.max(10,l+E);e.style.width=c+"px",e.style.left=o+"px",a=o,u=o+c}}function H(h){if(!n)return;q(h);const E=a,c=u;n==="drag"?t.onMove(C(E),C(c)):t.onResize(C(E),C(c),n),n=null,e.releasePointerCapture(h.pointerId),t.onDone()}return e.addEventListener("pointerdown",ue),e.addEventListener("pointermove",q),e.addEventListener("pointerup",H),e.addEventListener("pointercancel",H),()=>{e.removeEventListener("pointerdown",ue),e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",H),e.removeEventListener("pointercancel",H)}}const ie=()=>{I.value.forEach(e=>e()),I.value=[],S.value&&B(()=>{D.value.forEach(e=>{e.segments.forEach(t=>{const n=document.querySelector(`[data-id="${t.id}"]`);if(!n)return;const i=we(n,{trackPx:()=>S.value.offsetWidth,duration:()=>b.value,onMove:(o,l)=>{const a=z.value.find(u=>u.id===t.id);a&&(a.start=o,a.end=l,a.startTime=o,a.endTime=l),f("segment-move",Number(t.id),o,l)},onResize:(o,l,a)=>{const u=z.value.find(C=>C.id===t.id);u&&(u.start=o,u.end=l,u.startTime=o,u.endTime=l),f("segment-resize",Number(t.id),o,l,a)},onDone:()=>{const o=z.value.find(a=>a.id===t.id);if(!o)return;const l=ze(t.id);l!==null&&f("segment-resize",l,o.start,o.end,"end",!0)}});I.value.push(i)})})})},Ee=()=>{x.value<5&&(x.value=Math.min(5,x.value+.5))},Te=()=>{x.value>1&&(x.value=Math.max(1,x.value-.5))},Se=()=>{f("play-pause")},Ce=e=>e instanceof HTMLElement?e.isContentEditable?!0:["INPUT","TEXTAREA","SELECT"].includes(e.tagName):!1,se=()=>{if(g.activeSegmentId==null)return;const e=z.value.find(t=>Number(t.id)===Number(g.activeSegmentId));e&&f("segment-delete",e)},oe=e=>{if(!Ce(e.target)&&(e.key==="Delete"||e.key==="Backspace")){if(g.activeSegmentId==null)return;e.preventDefault(),se()}},Me=e=>{e&&(_(),f("segment-edit",e))},ae=e=>{e&&(_(),f("segment-delete",e))},Le=e=>{e&&(_(),f("seek",e.startTime||0),f("play-pause"))},Ne=(e,t)=>{w.value={visible:!0,x:t.clientX,y:t.clientY,segment:e}},_=()=>{w.value.visible=!1},Fe=e=>{if(!S.value)return;const t=S.value.getBoundingClientRect(),n=e.clientX-t.left,i=n/t.width*b.value;g.selectionMode?(R.value=!0,M.value=n/t.width*100,L.value=M.value,document.addEventListener("mousemove",U),document.addEventListener("mouseup",O)):f("seek",i)},U=e=>{if(!R.value||!S.value)return;const t=S.value.getBoundingClientRect(),n=e.clientX-t.left;L.value=Math.max(0,Math.min(100,n/t.width*100))},O=e=>{if(!R.value||!S.value)return;const t=Math.min(M.value,L.value),n=Math.max(M.value,L.value),i=t/100*b.value,o=n/100*b.value;o-i>.1&&f("time-selection",{start:i,end:o}),R.value=!1,M.value=0,L.value=0,document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",O)},le=()=>{if(!A.value||!g.video)return;const e=A.value,t=e.getContext("2d");if(t){e.width=e.offsetWidth,e.height=e.offsetHeight,t.fillStyle="#e0e0e0",t.fillRect(0,0,e.width,e.height),t.strokeStyle="#2196F3",t.lineWidth=1,t.beginPath();for(let n=0;n<e.width;n+=2){const i=Math.random()*e.height*.8+e.height*.1;n===0?t.moveTo(n,i):t.lineTo(n,i)}t.stroke()}},re=e=>{w.value.visible&&!e.target?.closest(".context-menu")&&_()};j(()=>g.video,()=>{g.showWaveform&&B(()=>{le()})}),j(D,()=>B(ie),{immediate:!0}),j(D,e=>{e.forEach(t=>{t.segments.forEach(n=>{$(n.start,n.end)===0&&console.warn("[Timeline] Segment mit 0% Breite:",n)})})},{immediate:!0}),Ie(()=>{document.addEventListener("click",re),document.addEventListener("keydown",oe),B(()=>{ie()}),g.showWaveform&&B(()=>{le()}),y.success({text:"[Timeline] Component mounted and ready"})}),Re(()=>{document.removeEventListener("click",re),document.removeEventListener("keydown",oe),I.value.forEach(e=>e()),I.value=[],document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",O)});const ze=e=>typeof e=="number"&&Number.isFinite(e)?e:(console.error("[Timeline] Unexpected segment ID:",e),null);return(e,t)=>(v(),m("div",He,[s("div",Ae,[s("div",Ve,[s("button",{onClick:Se,class:"play-btn",disabled:!r.video},[s("i",{class:J(r.isPlaying?"fas fa-pause":"fas fa-play")},null,2)],8,Ue),s("button",{onClick:se,class:"control-btn danger",disabled:r.activeSegmentId==null,title:"Ausgewähltes Segment löschen (Entf)"},[...t[4]||(t[4]=[s("i",{class:"fas fa-trash"},null,-1)])],8,Oe),s("span",qe,F(V(r.currentTime))+" / "+F(V(b.value)),1)]),s("div",je,[s("button",{onClick:Te,disabled:x.value<=1},[...t[5]||(t[5]=[s("i",{class:"fas fa-search-minus"},null,-1)])],8,Je),s("span",Ke,F(Math.round(x.value*100))+"%",1),s("button",{onClick:Ee,disabled:x.value>=5},[...t[6]||(t[6]=[s("i",{class:"fas fa-search-plus"},null,-1)])],8,Ye)])]),s("div",{class:"timeline-wrapper",style:p({height:P.value+"px"})},[s("div",{class:"timeline",ref_key:"timeline",ref:S,onMousedown:Fe,style:p({height:P.value+"px"})},[s("div",Ge,[(v(!0),m(K,null,Y(fe.value,n=>(v(),m("div",{key:n.time,class:"time-marker",style:p({left:n.position+"%"})},[s("div",{class:"marker-line",style:p({height:P.value+"px"})},null,4),s("div",Qe,F(V(n.time)),1)],4))),128))]),s("div",{class:"segments-container",style:p({marginTop:me+"px",height:be.value+"px"})},[(v(!0),m(K,null,Y(D.value,n=>(v(),m("div",{key:n.key,class:J(["segment-row",{active:n.label===W.value}]),style:p({top:n.rowNumber*Z+"px",height:at+"px"})},[(v(!0),m(K,null,Y(n.segments,i=>(v(),m("div",{key:i.id,class:J(["segment",{active:i.id===r.activeSegmentId,draft:i.isDraft,"too-small":$(i.start,i.end)<5}]),style:p({left:ke(i.start)+"%",width:$(i.start,i.end)+"%",backgroundColor:i.color||te(i.label),borderColor:i.isDraft?"#ff9800":"transparent"}),"data-id":i.id,onClick:o=>ge(i),onContextmenu:G(o=>Ne(i,o),["prevent"])},[t[8]||(t[8]=s("div",{class:"resize-handle start-handle",title:"Segment-Start ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),s("div",et,[s("span",tt,F(he(i.label)),1),$(i.start,i.end)>=5?(v(),m("span",nt,F(xe(i.start,i.end)),1)):N("",!0)]),$(i.start,i.end)>=8?(v(),m("div",{key:0,class:"segment-delete-btn",onClick:G(o=>ae(i),["stop"]),title:"Segment löschen"}," X ",8,it)):N("",!0),t[9]||(t[9]=s("div",{class:"resize-handle end-handle",title:"Segment-Ende ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),i.isDraft?(v(),m("div",st,[...t[7]||(t[7]=[s("i",{class:"fas fa-edit"},null,-1)])])):N("",!0)],46,Ze))),128))],6))),128))],4),s("div",{class:"playhead",style:p({left:ve.value+"%",height:P.value+"px"})},[s("div",{class:"playhead-line",style:p({height:P.value+"px"})},null,4),t[10]||(t[10]=s("div",{class:"playhead-handle"},null,-1))],4),R.value?(v(),m("div",{key:0,class:"selection-overlay",style:p({left:Math.min(M.value,L.value)+"%",width:Math.abs(L.value-M.value)+"%",height:P.value+"px"})},null,4)):N("",!0)],36),r.showWaveform?(v(),m("div",ot,[s("canvas",{ref_key:"waveformCanvas",ref:A,class:"waveform-canvas"},null,512)])):N("",!0)],4),w.value.visible?(v(),m("div",{key:0,class:"context-menu",style:p({left:w.value.x+"px",top:w.value.y+"px"}),onClick:t[3]||(t[3]=G(()=>{},["stop"]))},[s("div",{class:"context-menu-item",onClick:t[0]||(t[0]=n=>Me(w.value.segment))},[...t[11]||(t[11]=[s("i",{class:"fas fa-edit"},null,-1),Q(" Segment bearbeiten ",-1)])]),s("div",{class:"context-menu-item danger",onClick:t[1]||(t[1]=n=>ae(w.value.segment))},[...t[12]||(t[12]=[s("i",{class:"fas fa-trash"},null,-1),Q(" Segment löschen ",-1)])]),t[14]||(t[14]=s("div",{class:"context-menu-separator"},null,-1)),s("div",{class:"context-menu-item",onClick:t[2]||(t[2]=n=>Le(w.value.segment))},[...t[13]||(t[13]=[s("i",{class:"fas fa-play"},null,-1),Q(" Segment abspielen ",-1)])])],4)):N("",!0),X.value.visible?(v(),m("div",{key:1,class:"timeline-tooltip",style:p({left:X.value.x+"px",top:X.value.y+"px"})},F(X.value.text),5)):N("",!0)]))}}),mt=We(ut,[["__scopeId","data-v-c1557bf7"]]);export{mt as T};
