import{h as y,P as k,z as M,e as g}from"./main.js";const c=M;class l{static async getStatusOverview(){return(await c.get("/api/media-management/status/")).data}static async performCleanup(e="unfinished",s=!1){return(await c.delete(`/api/media-management/cleanup/?type=${e}&force=${s}`)).data}static async forceRemoveMedia(e){return(await c.delete(`/api/media-management/force-remove/${e}/`)).data}static async resetProcessingStatus(e){return(await c.post(`/api/media-management/reset-status/${e}/`)).data}static async getPollingCoordinatorInfo(){return(await c.get("/api/anonymization/polling-info/")).data}static async clearProcessingLocks(e){const s=e?`?type=${e}`:"";return(await c.delete(`/api/anonymization/clear-locks/${s}`)).data}static async getAnonymizationStatusSafe(e,s){return(await c.get(`/api/anonymization/${e}/status/`)).data}static async startAnonymizationSafe(e){return(await c.post(`/api/anonymization/${e}/start/`)).data}static async validateAnonymizationSafe(e){return(await c.post(`/api/anonymization/${e}/validate/`)).data}static async reimportVideo(e){return(await c.post(`/api/media/videos/${e}/reimport/`)).data}static async reimportPdf(e){return(await c.post(`/api/media/pdfs/${e}/reimport/`)).data}static async deleteMediaFile(e){return(await c.delete(`/api/media-management/force-remove/${e}/`)).data}}function C(){const p=y(!1),e=y(null),s=async r=>{p.value=!0,e.value=null;try{return await r()}catch(i){return console.error("Media Management API Error:",i),i.response?.status===429?e.value="Zu viele Anfragen. Bitte warten Sie einen Moment.":i.response?.status===409?e.value="Datei wird bereits verarbeitet.":i.response?.data?.detail?e.value=i.response.data.detail:e.value="Ein unerwarteter Fehler ist aufgetreten.",null}finally{p.value=!1}};return{isLoading:k(p),error:k(e),clearError:()=>{e.value=null},getStatusOverview:()=>s(()=>l.getStatusOverview()),performCleanup:(r,i=!1)=>s(()=>l.performCleanup(r,i)),forceRemoveMedia:r=>s(()=>l.forceRemoveMedia(r)),resetProcessingStatus:r=>s(()=>l.resetProcessingStatus(r)),deleteMediaFile:r=>s(()=>l.deleteMediaFile(r)),reimportVideo:r=>s(()=>l.reimportVideo(r)),reimportPdf:r=>s(()=>l.reimportPdf(r)),getStatusSafe:(r,i)=>s(()=>l.getAnonymizationStatusSafe(r,i)),startAnonymizationSafe:r=>s(()=>l.startAnonymizationSafe(r)),validateAnonymizationSafe:r=>s(()=>l.validateAnonymizationSafe(r)),getPollingInfo:()=>s(()=>l.getPollingCoordinatorInfo()),clearAllLocks:r=>s(()=>l.clearProcessingLocks(r))}}function D(){const{getStatusSafe:p,startAnonymizationSafe:e,validateAnonymizationSafe:s,clearAllLocks:r}=C(),i=5e3,o=y(new Map),d=(t,a)=>`${a}:${t}`,v=()=>{const t=Date.now();o.value.forEach((a,n)=>{a<=t&&o.value.delete(n)})},A=g(()=>(t,a)=>{v();const n=d(t,a),u=o.value.get(n);return u?u<=Date.now()?(o.value.delete(n),!0):!1:!0}),f=(t,a,n=i)=>{v();const u=d(t,a),S=o.value.get(u);return S&&S>Date.now()?!1:(o.value.set(u,Date.now()+Math.max(1e3,n)),!0)},m=(t,a)=>{const n=d(t,a);o.value.delete(n)},h=async(t,a)=>{try{return await p(t,a)}catch(n){throw console.error(`Status check failed for ${a}:${t}:`,n),n}},P=async(t,a)=>{if(!f(t,a))throw new Error("Datei wird bereits verarbeitet");try{return await e(t)}catch(u){throw u}finally{m(t,a)}},L=async(t,a)=>{f(t,a);try{return await s(t)}catch(n){throw console.error(`Validation failed for ${a}:${t}:`,n),n}finally{m(t,a)}},w=()=>{const t=o.value.size;o.value.clear(),console.log(`Cleared ${t} local processing locks`)},$=async t=>{try{await r(t),t?Array.from(o.value.keys()).forEach(a=>{a.startsWith(`${t}:`)&&o.value.delete(a)}):w(),console.log("All processing locks cleared successfully")}catch(a){throw console.error("Failed to clear processing locks:",a),a}},z=g(()=>{const t=Array.from(o.value.entries()).map(([a,n])=>({key:a,expiresAt:n}));return{totalLocks:t.length,locks:t,videoLocks:t.filter(a=>a.key.startsWith("video:")),pdfLocks:t.filter(a=>a.key.startsWith("pdf:"))}});return{processingLocks:g(()=>Array.from(o.value.entries())),getProcessingLocksInfo:z,canProcessMedia:A,acquireProcessingLock:f,releaseProcessingLock:m,getStatusSafeWithProtection:h,startAnonymizationSafeWithProtection:P,validateAnonymizationSafeWithProtection:L,clearAllLocalLocks:w,clearAllProcessingLocks:$}}export{C as a,D as u};
