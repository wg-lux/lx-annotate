import{O as re,z as N,h as I,e as A,M as G,f as Fe,d as fe,i as _e,w as K,c as r,o,a as e,j as L,k as z,t as b,F as j,m as M,_ as Re,E as xe,n as Y,l as me,R as $e,q as Le,A as He,J as Je,v as Ce,x as qe,b as Pe,p as Be}from"./main.js";import{u as Ae}from"./patientStore.js";import{P as Ve}from"./PatientAdder2.js";const ve=re("examination",{state:()=>({loading:!1,error:null,exams:[],selectedExaminationId:null,findingsByExam:new Map,classificationsByFinding:new Map}),getters:{examinations(i){return i.exams},examinationsDropdown(i){return i.exams.map(a=>({id:a.id,name:a.name,displayName:a.displayName??a.name_de??a.name}))},selectedExamination(i){return i.exams.find(a=>a.id===i.selectedExaminationId)??null},availableFindings(i){const a=i.selectedExaminationId;return a?i.findingsByExam.get(a)??[]:[]}},actions:{setSelectedExamination(i){this.selectedExaminationId=i},async fetchExaminations(){this.loading=!0,this.error=null;try{const i=await N.get("/api/examinations/");this.exams=i.data.map(a=>({id:a.id,name:a.name,name_de:a.name_de,name_en:a.name_en,displayName:a.displayName??a.name_de??a.name_en??a.name}))}catch(i){this.error=i?.response?.data?.detail??i?.message??"Unbekannter Fehler"}finally{this.loading=!1}},async loadFindingsForExamination(i){if(!i)return[];this.loading=!0,this.error=null;try{const v=(await N.get(`/api/examinations/${i}/findings/`)).data;return this.findingsByExam.set(i,v),v}catch(a){return this.error=a?.response?.data?.detail??a?.message??"Unbekannter Fehler",[]}finally{this.loading=!1}},async getCurrentExaminationId(){return this.selectedExaminationId?this.selectedExaminationId:(await this.fetchExaminations(),this.selectedExaminationId)},async loadFindingClassifications(i){this.loading=!0,this.error=null;try{const v=(await N.get(`/api/findings/${i}/classifications/`)).data;return this.classificationsByFinding.set(i,v),v}catch(a){return this.error=a?.response?.data?.detail??a?.message??"Unbekannter Fehler",{locationClassifications:[],morphologyClassifications:[]}}finally{this.loading=!1}}}}),Ee=re("finding",()=>{const i=I([]),a=I(!1),v=I(null),w=I(null),q=I([]),$=I(new Map),S=I(new Map);ve();const P=async()=>{try{a.value=!0,v.value=null;const _=await N.get("/api/findings/");i.value=_.data.results||_.data}catch(_){v.value="Fehler beim Laden der Befunde: "+(_.response?.data?.detail||_.message),console.error("Fetch findings error:",_)}finally{a.value=!1}},k=async _=>{try{return(await N.get(`/api/findings/${_}/classifications/`)).data}catch(C){throw console.error(`Error fetching classifications for finding ${_}:`,C),C}},f=async _=>{try{if($.value.has(_))return $.value.get(_);S.value.set(_,!0);const U=(await N.get(`/api/examinations/${_}/findings/`)).data;return $.value.set(_,U),U}catch(C){throw console.error(`Error fetching findings for examination ${_}:`,C),C}finally{S.value.set(_,!1)}},s=async _=>{if(!_)return[];try{a.value=!0,v.value=null;const C=await N.get(`/api/patient-examinations/${_}/findings/`);return i.value=C.data.results||C.data,i.value}catch(C){return v.value="Fehler beim Laden der Befunde fÃ¼r die Patientenuntersuchung: "+(C.response?.data?.detail||C.message),console.error("Fetch findings by patient examination error:",C),[]}finally{a.value=!1}},c=async _=>{try{return(await N.get(`/api/examinations/${_}/classifications/`)).data}catch(C){throw console.error(`Error fetching classifications for examination ${_}:`,C),C}},g=_=>i.value.find(C=>C.id===_),x=_=>{w.value=_},T=A(()=>i.value.length>0),y=_=>$.value.has(_)?(console.log("Using cached findings for examination",_),$.value.get(_)):(console.log("No cached findings for examination",_),console.log("Using the following findings:"),i.value.filter(C=>(console.log(C),C.examinations&&C.examinations.includes(_.toString())))),p=_=>{const C=[];for(const U of i.value)U.PatientExaminationId===_&&C.push(U.id);return C},B=_=>$.value.has(_),J=_=>S.value.get(_)||!1,O=_=>{_?($.value.delete(_),S.value.delete(_)):($.value.clear(),S.value.clear())};return{findings:G(i),FindingClassification:q,loading:G(a),error:G(v),currentFinding:G(w),examinationFindings:G($),areFindingsLoaded:T,fetchFindings:P,fetchFindingClassifications:k,fetchFindingsByExamination:f,fetchExaminationClassifications:c,getFindingsByExamination:y,getFindingById:g,getFindingIdsByPatientExaminationId:p,setCurrentFinding:x,isExaminationFindingsLoaded:B,isExaminationFindingsLoading:J,clearExaminationFindingsCache:O,fetchFindingsByPatientExamination:s}}),Ge=re("requirement",()=>{const i=I([]),a=I(!1),v=I(null),w=I(null),q=I({}),$=I([]),S=d=>{w.value=d,$.value=d?[d.id]:[]},P=d=>{$.value=d,d.length!==1?w.value=null:w.value=C(d[0])||null},k=d=>{i.value=i.value.filter(F=>F.id!==d),w.value?.id===d&&(w.value=null,$.value=[]),delete q.value[d]},f=A(()=>i.value.every(d=>d.met)),s=A(()=>w.value?w.value.met:!1),c=A(()=>i.value.reduce((d,F)=>d+F.requirements.filter(E=>E.met).length,0)),g=A(()=>i.value.reduce((d,F)=>d+F.requirements.length,0)),x=async()=>{try{a.value=!0,v.value=null;const d=await N.get("/api/requirement-sets/");i.value=d.data.results||d.data}catch(d){v.value="Fehler beim Laden der AnforderungssÃ¤tze: "+(d.response?.data?.detail||d.message),console.error("Fetch requirement sets error:",d)}finally{a.value=!1}},T=async d=>{try{return(await N.get(`/api/requirement-sets/${d}/`)).data}catch(F){return console.error(`Error fetching requirement set ${d}:`,F),null}},y=async(d,F)=>{try{a.value=!0,v.value=null;const E={requirement_set_ids:d,patient_examination_id:F};F&&(E.patient_examination_id=F),d?E.requirementSetIds=d:E.requirementSetIds=i.value.map(l=>l.id);const u=(await N.post("/api/evaluate-requirements/",E)).data.results||[];if(u.length>0){const l=Fe(),m=u.filter(D=>!D.met);m.length>0?l.warning({text:`${m.length} von ${u.length} Anforderungen nicht erfÃ¼llt. ÃœberprÃ¼fen Sie die Patientendaten.`,timeout:5e3}):l.success({text:`Alle ${u.length} Anforderungen erfolgreich erfÃ¼llt!`,timeout:3e3})}return d?d.forEach(l=>{q.value[l]=u.filter(m=>i.value.find(D=>D.id===l)?.requirements.some(D=>D.name===m.requirement_name))}):u.forEach(l=>{const m=i.value.find(D=>D.requirements.some(V=>V.name===l.requirement_name))?.id;m&&(q.value[m]||(q.value[m]=[]),q.value[m].push(l))}),B(u),u}catch(E){throw v.value="Fehler bei der Evaluierung der Anforderungen: "+(E.response?.data?.detail||E.message),console.error("Evaluate requirements error:",E),Fe().error({text:"Fehler bei der Anforderungsevaluierung: "+(E.response?.data?.detail||E.message),timeout:5e3}),E}finally{a.value=!1}},p=async(d,F)=>{try{a.value=!0,v.value=null;const E=$.value.length>0?$.value:[d];d.valueOf.length>0&&E.push(d);const R={requirement_set_ids:E,patient_examination_id:F};F&&(R.patient_examination_id=F);const l=(await N.post("/api/evaluate-requirement-set/",R)).data.results||[];return q.value[d]=l,B(l),l}catch(E){throw v.value="Fehler bei der Evaluierung des Anforderungssatzes: "+(E.response?.data?.detail||E.message),console.error("Evaluate requirement set error:",E),E}finally{a.value=!1}},B=d=>{if(i.value.forEach(F=>{F.requirements.forEach(E=>{const R=d.find(u=>u.requirement_name===E.name);R&&(E.met=R.met,E.details=R.details)}),F.met=F.requirements.every(E=>E.met)}),w.value){const F=d.filter(E=>w.value.requirements.some(R=>R.name===E.requirement_name));w.value.requirements.forEach(E=>{const R=F.find(u=>u.requirement_name===E.name);R&&(E.met=R.met,E.details=R.details)}),w.value.met=w.value.requirements.every(E=>E.met)}},J=d=>({examinations:d.patientExaminationId?[d.patientExaminationId]:[],findings:d.availableFindings||[],finding_classifications:d.findingClassifications||[],examination_indications:d.examinationIndications||[],indication_choices:d.indicationChoices||[],lab_values:d.labValues||[],diseases:d.diseases||[],disease_classification_choices:d.diseaseClassificationChoices||[],events:d.events||[],medications:d.medications||[],medication_indications:d.medicationIndications||[],medication_intake_times:d.medicationIntakeTimes||[],medication_schedules:d.medicationSchedules||[],genders:d.genders||[]}),O=async(d,F)=>{const E=d.patientExaminationId;return await y(F,E)},_=async d=>{if(!w.value)throw new Error("No current requirement set selected");const F=d.patientExaminationId;return await p(w.value.id,F)},C=d=>i.value.find(F=>F.id===d);return{requirementSets:i,currentRequirementSet:w,evaluationResults:q,loading:a,error:v,isRequirementValidated:f,isRequirementSetValidated:s,metRequirementsCount:c,totalRequirementsCount:g,setCurrentRequirementSet:S,fetchRequirementSets:x,fetchRequirementSet:T,evaluateRequirements:y,evaluateRequirementSet:p,evaluateFromLookupData:O,evaluateCurrentSetFromLookupData:_,createRequirementLinksFromLookup:J,getRequirementSetById:C,getRequirementById:(d,F)=>C(d)?.requirements.find(R=>R.id===F),getRequirementSetEvaluationStatus:d=>{const F=C(d);if(!F)return null;const E=F.requirements.filter(u=>u.met).length,R=F.requirements.length;return{met:F.met,metRequirementsCount:E,totalRequirementsCount:R,completionPercentage:R>0?Math.round(E/R*100):0}},getRequirementEvaluationStatus:d=>{for(const F of i.value){const E=F.requirements.find(R=>R.id===d);if(E)return{met:E.met,details:E.details}}return null},loadRequirementSetsFromLookup:d=>{if(!d.requirementsBySet)return;const F=[];Object.entries(d.requirementsBySet).forEach(([E,R])=>{const u=d.requirementSets?.find(l=>l.id===parseInt(E));u&&F.push({id:parseInt(E),name:u.name,description:u.description,type:u.type,requirements:R.map(l=>({id:l.id,name:l.name,description:l.description,met:d.requirementStatus?.[l.id]||!1,details:null})),met:d.requirementSetStatus?.[E]||!1})}),i.value=F},clearError:()=>{v.value=null},setCurrentRequirementSetIds:P,deleteRequirementSetById:k,reset:()=>{i.value=[],w.value=null,q.value={},v.value=null}}}),Ne=re("patientExamination",{state:()=>({loading:!1,error:null,patientExaminations:[],selectedPatientExaminationId:null}),getters:{getPatientExaminationById:i=>a=>i.patientExaminations.find(v=>v.id===a)||null,isLoading:i=>i.loading,getError:i=>i.error,getAllPatientExaminations:i=>i.patientExaminations,getSelectedPatientExaminationId:i=>i.selectedPatientExaminationId},actions:{async doesPatientExaminationExist(i){try{this.loading=!0,this.error=null;const a=await N.get(`/api/check_pe_exist/${i}/`);return a.status===200&&typeof a.data.exists=="boolean"?a.data.exists:!0}catch(a){return this.error="Fehler beim ÃœberprÃ¼fen der Patientenuntersuchung: "+(a.response?.data?.detail||a.message),console.error("Check patient examination existence error:",a),!1}finally{this.loading=!1}},async fetchPatientExaminations(i){try{if(this.loading=!0,this.error=null,await this.doesPatientExaminationExist(i)===!1){this.patientExaminations=[];return}const a=await N.get(`/api/patient-examinations/?patient_id=${i}`);this.patientExaminations=a.data.results||a.data}catch(a){this.error="Fehler beim Laden der Patientenuntersuchungen: "+(a.response?.data?.detail||a.message),console.error("Fetch patient examinations error:",a)}finally{this.loading=!1}},async fetchPatientExaminationById(i){try{this.loading=!0,this.error=null;const v=(await N.get(`/api/get_patient_examination/${i}/`)).data;if(v){const w=this.patientExaminations.findIndex(q=>q.id===v.id);w!==-1?this.patientExaminations[w]=v:this.patientExaminations.push(v)}}catch(a){this.error="Fehler beim Laden der Patientenuntersuchung: "+(a.response?.data?.detail||a.message),console.error("Fetch patient examination by ID error:",a)}finally{this.loading=!1}},addPatientExamination(i){this.patientExaminations.push(i)},removePatientExamination(i){this.patientExaminations=this.patientExaminations.filter(a=>a.id!==i),this.selectedPatientExaminationId===i&&(this.selectedPatientExaminationId=null)},setCurrentPatientExaminationId(i){this.selectedPatientExaminationId=i},getCurrentPatientExaminationId(){return this.selectedPatientExaminationId},getCurrentPatientExaminationExaminationId(){const i=this.patientExaminations.find(a=>a.id===this.selectedPatientExaminationId);return i?i.examination.id:null}}}),ze=re("findingsClassificationStore",()=>{const i=I({}),a=I(!1),v=I(null),w=s=>{const c=i.value[s];return c?[...c.classifications||[],...c.location_classifications||[],...c.morphology_classifications||[]]:[]},q=A(()=>Object.values(i.value)),$=s=>(i.value[s]||q.value,i.value[s]),S=()=>{i.value={},v.value=null},P=s=>{v.value=s},k=s=>{a.value=s},f=s=>{const c={};s.forEach(g=>{c[g.id]=g}),i.value=c,console.log("ðŸ“‹ [FindingsClassificationStore] Set findings from lookup:",Object.keys(c).length,"findings")};return{findings:G(i),loading:G(a),error:G(v),getFindingById:$,getClassificationsForFinding:w,getAllFindings:q,clearFindings:S,setError:P,setLoading:k,setClassificationChoicesFromLookup:f}}),We={class:"finding-card card mb-3"},Ye={class:"card-body"},Xe={key:0,class:"text-center"},Ze={key:1,class:"text-center text-muted"},Qe={class:"row mb-3"},et={class:"col-md-6"},tt={class:"col-md-6"},nt={class:"text-muted"},it={class:"col-md-6"},at={class:"col-md-6"},st={key:0},lt={key:1},ot={class:"col-md-6"},rt={key:0,class:"mb-3"},dt={class:"classification-list"},ut={class:"d-flex justify-content-between align-items-center"},ct={key:0,class:"text-muted small"},gt={key:1,class:"mb-2"},mt={class:"d-flex flex-wrap gap-1 mt-1"},ft={key:2,class:"mb-2"},vt={class:"d-flex flex-wrap gap-1 mt-1"},pt={key:2},ht={key:0,class:"selected-classifications-summary mt-3 p-3 bg-light rounded"},bt={class:"mb-2"},yt={class:"row"},xt={class:"d-flex justify-content-between align-items-center"},_t={class:"text-muted"},Et={key:1,class:"mt-3 p-2 bg-light border rounded"},wt={class:"text-muted"},kt=fe({__name:"FindingsDetail",props:{findingId:{},isAddedToExamination:{type:Boolean,default:!1},patientExaminationId:{default:void 0}},emits:["added-to-examination","classification-updated","error-occurred"],setup(i,{emit:a}){const v=Ee(),w=ve(),q=ze(),$=A(()=>w.selectedExaminationId||void 0),S=i,P=I(!1),k=I([]),f=A(()=>{const y=q.getFindingById(S.findingId);return y||v.getFindingById(S.findingId)}),s=A(()=>k.value.filter(y=>y.required)),c=A(()=>{const y=q.getFindingById(S.findingId),p=v.getFindingById(S.findingId),B=y?"findingClassificationStore":p?"findingStore":"none";return{findingId:S.findingId,findingName:f.value?.nameDe||f.value?.name,totalClassifications:k.value.length,requiredClassifications:s.value.length,classificationsLoaded:k.value.length>0,dataSource:B}}),g=A(()=>{const y=q.getFindingById(S.findingId),p=v.getFindingById(S.findingId),B=y?"findingClassificationStore":p?"findingStore":"none";return{findingId:S.findingId,findingName:f.value?.nameDe||f.value?.name,findingDescription:f.value?.description||"Keine Beschreibung verfÃ¼gbar",totalClassifications:k.value.length,requiredClassifications:s.value.length,classificationsLoaded:k.value.length>0,dataSource:B}}),x=async()=>{if(!S.findingId){console.log("ðŸ“‹ [FindingsDetail] No findingId provided, skipping classifications load");return}try{P.value=!0;const y=q.getClassificationsForFinding(S.findingId);if(y.length>0)k.value=y,console.log("ðŸ“‹ [FindingsDetail] Loaded classifications from store:",y.length);else{const p=q.getFindingById(S.findingId);p?.FindingClassifications?(k.value=p.FindingClassifications,console.log("ðŸ“‹ [FindingsDetail] Loaded classifications from finding data:",p.FindingClassifications.length)):(console.warn("ðŸ“‹ [FindingsDetail] No classifications found for finding:",S.findingId),k.value=[])}}catch(y){console.error("Error loading classifications:",y),k.value=[]}finally{P.value=!1}},T=async()=>{await x()};return _e(()=>{console.log("ðŸš€ [FindingsDetail] Component mounted with props:",{findingId:S.findingId,patientExaminationId:S.patientExaminationId,isAddedToExamination:S.isAddedToExamination,findingStoreFindingsCount:v.findings.length,findingFromStore:v.getFindingById(S.findingId)}),T()}),K(()=>S.findingId,(y,p)=>{console.log("ðŸ‘€ [FindingsDetail] findingId changed:",{oldVal:p,newVal:y}),T()},{immediate:!0}),K(()=>q.getFindingById(S.findingId),(y,p)=>{y&&(console.log("ðŸ”„ [FindingsDetail] Finding data now available in findingClassificationStore, loading classifications",{findingId:y.id}),x())},{immediate:!0}),K(()=>v.findings,(y,p)=>{console.log("ðŸ“Š [FindingsDetail] findingStore.findings changed:",{oldCount:p?.length||0,newCount:y?.length||0,findingId:S.findingId}),y&&y.length>0&&(console.log("ðŸ”„ [FindingsDetail] Reloading classifications due to findings data change"),T())},{immediate:!0}),(y,p)=>(o(),r("div",We,[e("div",Ye,[P.value?(o(),r("div",Xe,[...p[0]||(p[0]=[e("div",{class:"spinner-border spinner-border-sm",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1),z(" Lade Details... ",-1)])])):!P.value&&f.value?(o(),r("div",Ze,[e("div",Qe,[e("div",et,[e("p",null,[p[1]||(p[1]=e("strong",null,"ID:",-1)),z(" "+b(f.value.id),1)]),e("p",null,[p[2]||(p[2]=e("strong",null,"Name (DE):",-1)),z(" "+b(g.value.findingName||"N/A"),1)])]),e("div",tt,[p[3]||(p[3]=e("p",null,[e("strong",null,"Beschreibung:")],-1)),e("p",nt,b(g.value.findingDescription||"Keine Beschreibung verfÃ¼gbar"),1)]),e("div",it,[e("p",null,[p[4]||(p[4]=e("strong",null,"Data Source:",-1)),z(" "+b(g.value.dataSource),1)])]),e("div",at,[e("p",null,[p[5]||(p[5]=e("strong",null,"Klassifikationen gesamt:",-1)),z(" "+b(g.value.totalClassifications)+" ("+b(g.value.requiredClassifications)+" erforderlich)",1)]),g.value.classificationsLoaded?(o(),r("p",st,"Die Klassifikationen wurden erfolgreich geladen.")):(o(),r("p",lt,"Die Klassifikationen konnten nicht geladen werden."))]),e("div",ot,[e("p",null,[p[6]||(p[6]=e("strong",null,"Erforderliche Klassifikationen:",-1)),z(" "+b(g.value.requiredClassifications),1)])])]),s.value.length>0?(o(),r("div",rt,[p[8]||(p[8]=e("h6",null,"Erforderliche Klassifikationen:",-1)),e("div",dt,[(o(!0),r(j,null,M(s.value,B=>(o(),r("div",{key:B.id,class:"classification-item mb-2 p-2 border rounded bg-light"},[e("div",ut,[e("div",null,[e("strong",null,b(B.name),1),B.description?(o(),r("div",ct,b(B.description),1)):L("",!0)]),p[7]||(p[7]=e("div",{class:"badge bg-warning"},"Erforderlich",-1))])]))),128))])])):L("",!0),f.value.findingTypes&&f.value.findingTypes.length?(o(),r("div",gt,[p[9]||(p[9]=e("strong",null,"Typen:",-1)),e("div",mt,[(o(!0),r(j,null,M(f.value.findingTypes,B=>(o(),r("span",{key:B,class:"badge bg-secondary"},b(B),1))),128))])])):L("",!0),f.value.findingInterventions&&f.value.findingInterventions.length?(o(),r("div",ft,[p[10]||(p[10]=e("strong",null,"Interventionen:",-1)),e("div",vt,[(o(!0),r(j,null,M(f.value.findingInterventions,B=>(o(),r("span",{key:B,class:"badge bg-info"},b(B),1))),128))])])):L("",!0)])):(o(),r("div",pt,[p[11]||(p[11]=e("p",null,"Befunde konnten nicht geladen werden...",-1)),e("small",null,"Finding ID: "+b(i.findingId),1),$.value?(o(),r("button",{key:0,class:"btn btn-primary mt-2",onClick:T},"Erneut versuchen")):L("",!0)]))]),s.value.length>0?(o(),r("div",ht,[e("h6",bt,[p[12]||(p[12]=e("i",{class:"fas fa-list-check"},null,-1)),z(" Erforderliche Klassifikationen ("+b(s.value.length)+") ",1)]),e("div",yt,[(o(!0),r(j,null,M(s.value,B=>(o(),r("div",{key:B.id,class:"col-md-6 mb-2"},[e("div",xt,[e("small",_t,b(B.name)+":",1),p[13]||(p[13]=e("span",{class:"badge bg-warning"},"Erforderlich",-1))])]))),128))])])):L("",!0),c.value.findingId?(o(),r("div",Et,[p[14]||(p[14]=e("h6",{class:"mb-2"},"ðŸ› Debug Info:",-1)),e("small",wt,[e("div",null,"Finding ID: "+b(c.value.findingId),1),e("div",null,"Finding Name: "+b(c.value.findingName||"Not loaded"),1),e("div",null,"Classifications: "+b(c.value.totalClassifications)+" ("+b(c.value.requiredClassifications)+" required)",1),e("div",null,"Classifications Loaded: "+b(c.value.classificationsLoaded),1),e("div",null,"Data Source: "+b(c.value.dataSource),1)])])):L("",!0)]))}}),St=Re(kt,[["__scopeId","data-v-abc7c9e3"]]),It=re("patientFinding",()=>{const i=I([]),a=I(!1),v=I(null),w=async k=>{if(!k){console.warn("fetchPatientFindings wurde ohne patientExaminationId aufgerufen."),i.value=[];return}try{a.value=!0,v.value=null;const f=await N.get("/api/patient-findings/",{params:{patient_examination:k}});i.value=f.data.results||f.data}catch(f){v.value="Fehler beim Laden der Patientenbefunde: "+(f.response?.data?.detail||f.message),console.error("Fetch patient findings error:",f)}finally{a.value=!1}},q=A(()=>{const f=Ae().getCurrentPatient();return f?i.value.filter(s=>s.patient.id===f.id):[]}),$=async k=>{try{a.value=!0,v.value=null;const s=(await N.post("/api/patient-findings/",k)).data;return i.value.push(s),s}catch(f){throw v.value="Fehler beim Erstellen des Patientenbefunds: "+(f.response?.data?.detail||f.message),console.error("Create patient finding error:",f),f}finally{a.value=!1}},S=async(k,f)=>{try{a.value=!0,v.value=null;const c=(await N.patch(`/api/patient-findings/${k}/`,f)).data,g=i.value.findIndex(x=>x.id===k);return g!==-1&&(i.value[g]=c),c}catch(s){throw v.value="Fehler beim Aktualisieren des Patientenbefunds: "+(s.response?.data?.detail||s.message),console.error("Update patient finding error:",s),s}finally{a.value=!1}},P=async k=>{try{a.value=!0,v.value=null,await N.delete(`/api/patient-findings/${k}/`),i.value=i.value.filter(f=>f.id!==k)}catch(f){throw v.value="Fehler beim LÃ¶schen des Patientenbefunds: "+(f.response?.data?.detail||f.message),console.error("Delete patient finding error:",f),f}finally{a.value=!1}};return{patientFindings:G(i),patientFindingsByCurrentPatient:q,loading:G(a),error:G(v),fetchPatientFindings:w,createPatientFinding:$,updatePatientFinding:S,deletePatientFinding:P}}),Ft={class:"addable-finding-card card mb-3 border-primary"},$t={class:"card-header d-flex justify-content-between align-items-center bg-light"},Ct={class:"nav nav-tabs card-header-tabs"},qt={class:"nav-item"},Pt={class:"badge rounded-pill bg-primary ms-1"},Bt={class:"nav-item"},Rt={class:"badge rounded-pill bg-success ms-1"},Lt={class:"card-body"},At={class:"d-flex justify-content-end mb-3"},Nt=["disabled"],zt={key:0,class:"mb-3 finding-selector"},Dt={key:0,class:"text-center py-3 text-muted"},Tt={key:1,class:"row g-3"},Ut=["onClick"],Kt={class:"card-body p-3"},jt={class:"card-title small fw-bold"},Mt={key:0,class:"card-text small text-muted mb-0"},Ot={key:1,class:"selected-finding-config mt-4 p-4 border rounded bg-light"},Ht={class:"d-flex justify-content-between align-items-center mb-3"},Jt={class:"mb-0"},Vt={key:0,class:"mb-3"},Gt={class:"classification-config-list"},Wt={class:"d-flex justify-content-between align-items-center mb-2"},Yt={class:"d-flex align-items-center gap-2"},Xt={key:0,class:"badge bg-warning text-dark",title:"Erforderlich"},Zt={key:1,class:"badge bg-success",title:"AusgewÃ¤hlt"},Qt={key:0,class:"text-muted small mb-2"},en=["value","onChange"],tn={key:0,value:"",disabled:""},nn=["value"],an={class:"classification-progress"},sn={class:"d-flex justify-content-between align-items-center mb-1"},ln={class:"progress",style:{height:"6px"}},on={class:"text-end mt-3"},rn=["disabled","title"],dn={key:0,class:"spinner-border spinner-border-sm me-2"},un={key:2,class:"text-center py-5 text-muted"},cn={key:0,class:"text-center py-5 text-muted"},gn={key:1,class:"row g-3"},mn={class:"card h-100 border-success"},fn={class:"card-body p-3"},vn={class:"d-flex align-items-start gap-2"},pn={class:"flex-grow-1"},hn={class:"card-title small fw-bold text-success"},bn={key:0,class:"card-text small text-muted mb-2"},yn={class:"badge bg-info text-dark small"},xn=fe({__name:"AddableFindingsDetail",props:{patientExaminationId:{default:void 0},examinationId:{default:void 0}},emits:["finding-added","finding-error"],setup(i,{emit:a}){const v=Ne(),w=ze(),q=v.getCurrentPatientExaminationId();v.setCurrentPatientExaminationId(q);const $=i;K(()=>v.getCurrentPatientExaminationId(),u=>{u&&!$.patientExaminationId&&(console.warn("[AddableFindingsDetail] Syncing patientExaminationId..."),R())},{immediate:!0});const S=a,P=Ee(),k=It(),f=ve(),s=I(!1),c=I("available"),g=I(!1),x=I(null),T=I([]),y=I({}),p=I([]),B=I([]),J=A(()=>p.value);A(async()=>{const u=v.getCurrentPatientExaminationId();return u?await P.fetchFindingsByPatientExamination(u)||[]:[]});async function O(){const u=v.getCurrentPatientExaminationId();if(!u){B.value=[];return}await k.fetchPatientFindings(u),B.value=k.patientFindings.map(l=>JSON.parse(JSON.stringify(l.finding)))}K(()=>v.getCurrentPatientExaminationId(),async u=>{u&&await O()},{immediate:!0});const _=A(()=>{if(x.value)return J.value.find(u=>u.id===x.value)||w.getFindingById(x.value)}),C=A(()=>T.value.length?T.value.filter(u=>u.required).every(u=>y.value[u.id]):!0),U=A(()=>x.value&&C.value&&$.patientExaminationId&&!s.value),ee=A(()=>{const u=T.value.filter(m=>m.required).length,l=T.value.filter(m=>m.required&&y.value[m.id]).length;return{required:u,selected:l,complete:l===u,percentage:u>0?Math.round(l/u*100):100}}),te=async u=>{x.value=u,g.value=!1,await se(u)},ae=()=>{x.value=null,T.value=[],y.value={}},se=async u=>{try{s.value=!0,T.value=w.getClassificationsForFinding(u)}catch(l){console.error("Error loading classifications:",l),S("finding-error","Fehler beim Laden der Klassifikationen")}finally{s.value=!1}},le=(u,l)=>{const m=l.target,D=m.value?parseInt(m.value):void 0;D?y.value[u]=D:delete y.value[u]},d=async()=>{if(!(!U.value||!_.value||!$.patientExaminationId||!x.value))try{s.value=!0;const u={patientExamination:$.patientExaminationId,finding:x.value,classifications:Object.entries(y.value).map(([de,ge])=>({classification:parseInt(de),choice:ge}))},m=(await k.createPatientFinding(u)).finding.id,D=w.getFindingById(m);D&&B.value.push(D);const V=_.value.nameDe||_.value.name;S("finding-added",x.value,V),ae(),g.value=!1}catch(u){console.error("Error adding finding to examination:",u);const l=k.error||u.response?.data?.error||u.response?.data?.detail||u.message||"Fehler beim HinzufÃ¼gen des Befunds";S("finding-error",l)}finally{s.value=!1}},F=async u=>{try{s.value=!0,w.getAllFindings.length;const m=(await N.get(`/api/examinations/${u}/findings`)).data;w.setClassificationChoicesFromLookup(m),console.log("Loaded findings for examination:",m.length)}catch(l){console.error("Error loading examination data:",l),S("finding-error","Fehler beim Laden der Untersuchungsdaten")}finally{s.value=!1}},E=async()=>{try{s.value=!0;let u=$.examinationId;if(!u&&$.patientExaminationId&&(u=v.getPatientExaminationById($.patientExaminationId)?.examination?.id),!u){console.warn("Keine Examination ID verfÃ¼gbar fÃ¼r Findings-Laden");return}const l=await f.loadFindingsForExamination(u);p.value=l,console.log("ðŸ“‹ [AddableFindingsDetail] Loaded findings for examinationId:",u,"findings count:",l.length)}catch(u){console.error("Error loading available findings:",u),S("finding-error","Fehler beim Laden der verfÃ¼gbaren Befunde")}finally{s.value=!1}},R=async()=>{await E(),$.examinationId&&await F($.examinationId)};return K(()=>$.patientExaminationId,async()=>{$.patientExaminationId&&await R()},{immediate:!0}),K(()=>$.examinationId,async()=>{$.examinationId&&await E()},{immediate:!0}),_e(async()=>{await R()}),(u,l)=>(o(),r("div",Ft,[e("div",$t,[l[7]||(l[7]=e("div",{class:"d-flex align-items-center gap-2"},[e("i",{class:"fas fa-plus-circle text-primary"}),e("h6",{class:"card-title mb-0"},"Befunde verwalten")],-1)),e("ul",Ct,[e("li",qt,[e("a",{class:Y(["nav-link",{active:c.value==="available"}]),onClick:l[0]||(l[0]=xe(m=>c.value="available",["prevent"])),href:"#"},[l[3]||(l[3]=e("i",{class:"fas fa-list me-1"},null,-1)),l[4]||(l[4]=z(" VerfÃ¼gbare Befunde ",-1)),e("span",Pt,b(J.value.length),1)],2)]),e("li",Bt,[e("a",{class:Y(["nav-link",{active:c.value==="added"}]),onClick:l[1]||(l[1]=xe(m=>c.value="added",["prevent"])),href:"#"},[l[5]||(l[5]=e("i",{class:"fas fa-check-circle me-1"},null,-1)),l[6]||(l[6]=z(" HinzugefÃ¼gte Befunde ",-1)),e("span",Rt,b(B.value.length),1)],2)])])]),e("div",Lt,[me(e("div",null,[e("div",At,[e("button",{class:"btn btn-sm btn-primary",onClick:l[2]||(l[2]=m=>g.value=!g.value),disabled:s.value},[e("i",{class:Y(["fas",g.value?"fa-minus":"fa-plus"])},null,2),z(" "+b(g.value?"Auswahl ausblenden":"Befund auswÃ¤hlen"),1)],8,Nt)]),g.value?(o(),r("div",zt,[l[9]||(l[9]=e("label",{class:"form-label fw-bold"},"VerfÃ¼gbare Befunde:",-1)),J.value.length===0?(o(),r("div",Dt,[...l[8]||(l[8]=[e("i",{class:"fas fa-info-circle fa-2x mb-2"},null,-1),e("p",null,"Keine Befunde fÃ¼r diese Untersuchung verfÃ¼gbar.",-1)])])):(o(),r("div",Tt,[(o(!0),r(j,null,M(J.value,m=>(o(),r("div",{key:m.id,class:"col-12 col-sm-6 col-md-4"},[e("div",{class:Y(["finding-option card h-100 cursor-pointer",{"border-primary shadow-sm":x.value===m.id}]),onClick:D=>te(m.id)},[e("div",Kt,[e("h6",jt,b(m.nameDe||m.name),1),m.description?(o(),r("p",Mt,b(m.description.length>80?m.description.substring(0,80)+"...":m.description),1)):L("",!0)])],10,Ut)]))),128))]))])):L("",!0),x.value?(o(),r("div",Ot,[e("div",Ht,[e("h6",Jt,[l[10]||(l[10]=e("i",{class:"fas fa-cog text-primary me-2"},null,-1)),l[11]||(l[11]=z(" Befund konfigurieren: ",-1)),e("strong",null,b(_.value?.nameDe||_.value?.name),1)]),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:ae,title:"Auswahl zurÃ¼cksetzen"},[...l[12]||(l[12]=[e("i",{class:"fas fa-times"},null,-1)])])]),T.value.length>0?(o(),r("div",Vt,[l[17]||(l[17]=e("h6",null,"Klassifikationen:",-1)),e("div",Gt,[(o(!0),r(j,null,M(T.value,m=>(o(),r("div",{key:m.id,class:"classification-config-item mb-3 p-3 border rounded"},[e("div",Wt,[e("strong",null,b(m.name),1),e("div",Yt,[m.required?(o(),r("span",Xt,[...l[13]||(l[13]=[e("i",{class:"fas fa-exclamation-triangle"},null,-1),z(" Erforderlich ",-1)])])):L("",!0),y.value[m.id]?(o(),r("span",Zt,[...l[14]||(l[14]=[e("i",{class:"fas fa-check"},null,-1),z(" AusgewÃ¤hlt ",-1)])])):L("",!0)])]),m.description?(o(),r("p",Qt,b(m.description),1)):L("",!0),e("select",{class:Y(["form-select form-select-sm",{"border-success":y.value[m.id],"border-warning":!y.value[m.id]&&m.required}]),value:y.value[m.id]||"",onChange:D=>le(m.id,D)},[l[15]||(l[15]=e("option",{value:""},"Bitte wÃ¤hlen...",-1)),!m.choices||m.choices.length===0?(o(),r("option",tn,"Keine Auswahl")):(o(!0),r(j,{key:1},M(m.choices,D=>(o(),r("option",{key:D.id,value:D.id},b(D.name),9,nn))),128))],42,en)]))),128))]),e("div",an,[e("div",sn,[l[16]||(l[16]=e("small",{class:"text-muted"},"Erforderliche Klassifikationen:",-1)),e("small",{class:Y(["fw-semibold",ee.value.complete?"text-success":"text-warning"])},b(ee.value.selected)+"/"+b(ee.value.required),3)]),e("div",ln,[e("div",{class:Y(["progress-bar",ee.value.complete?"bg-success":"bg-warning"]),style:Le({width:ee.value.percentage+"%"})},null,6)])])])):L("",!0),e("div",on,[e("button",{class:"btn btn-success",onClick:d,disabled:s.value||!U.value,title:U.value?"Befund zur Untersuchung hinzufÃ¼gen":"Bitte alle erforderlichen Klassifikationen auswÃ¤hlen"},[s.value?(o(),r("span",dn)):L("",!0),l[18]||(l[18]=e("i",{class:"fas fa-plus me-2"},null,-1)),l[19]||(l[19]=z(" Befund hinzufÃ¼gen ",-1))],8,rn)])])):g.value?L("",!0):(o(),r("div",un,[...l[20]||(l[20]=[e("i",{class:"fas fa-plus-circle fa-3x mb-3 opacity-50"},null,-1),e("p",null,'Klicken Sie auf "Befund auswÃ¤hlen", um einen neuen Befund hinzuzufÃ¼gen.',-1)])]))],512),[[$e,c.value==="available"]]),me(e("div",null,[B.value.length===0?(o(),r("div",cn,[...l[21]||(l[21]=[e("i",{class:"fas fa-folder-open fa-3x mb-3"},null,-1),e("p",null,"Noch keine Befunde zu dieser Untersuchung hinzugefÃ¼gt.",-1)])])):(o(),r("div",gn,[(o(!0),r(j,null,M(B.value,m=>(o(),r("div",{key:m.id,class:"col-12 col-sm-6 col-md-4 col-lg-3"},[e("div",mn,[e("div",fn,[e("div",vn,[l[22]||(l[22]=e("i",{class:"fas fa-check-circle text-success mt-1"},null,-1)),e("div",pn,[e("h6",hn,b(m.nameDe||m.name),1),m.description?(o(),r("p",bn,b(m.description.length>80?m.description.substring(0,80)+"...":m.description),1)):L("",!0),e("span",yn,"ID: "+b(m.id),1)])])])])]))),128))]))],512),[[$e,c.value==="added"]])])]))}}),_n={key:0,class:"container-fluid"},En={key:0,class:"alert alert-info"},wn={key:1,class:"alert alert-warning"},kn={class:"mb-1"},Sn={class:"mb-0 ps-3"},In={class:"fw-semibold"},Fn={class:"text-muted"},$n={key:0,class:"text-danger"},Cn={key:2,class:"alert alert-success"},qn=fe({__name:"RequirementIssues",props:{patientExaminationId:{},requirementSetIds:{},showOnlyUnmet:{type:Boolean}},setup(i,{expose:a}){const v=He("evaluate-requirements/"),w=i,q=I(!1),$=I(null),S=I([]);async function P(){if(!w.patientExaminationId){S.value=[];return}q.value=!0,$.value=null;try{const g={patient_examination_id:w.patientExaminationId};w.requirementSetIds&&w.requirementSetIds.length>0&&(g.requirement_set_ids=w.requirementSetIds);const{data:x}=await N.post(v,g);S.value=x.results??[],!x.ok&&x.errors?.length&&($.value=x.errors.join(" | "))}catch(g){$.value=g?.response?.data?.detail||g?.message||"Unbekannter Fehler bei der AnforderungsprÃ¼fung"}finally{q.value=!1}}const k=A(()=>!!w.patientExaminationId),f=A(()=>w.showOnlyUnmet??!0?S.value.filter(g=>!g.met||g.error):S.value),s=A(()=>f.value.length>0),c=A(()=>{const g={};for(const x of f.value){const T=x.requirement_set_name||"Allgemein";g[T]||(g[T]=[]),g[T].push(x)}return g});return K(()=>[w.patientExaminationId,w.requirementSetIds],()=>{k.value?P():S.value=[]},{deep:!0,immediate:!0}),a({reload:P}),(g,x)=>k.value?(o(),r("div",_n,[q.value?(o(),r("div",En,[...x[0]||(x[0]=[e("span",{class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},null,-1),z(" Anforderungen werden geprÃ¼ft... ",-1)])])):s.value?(o(),r("div",wn,[x[2]||(x[2]=e("strong",null,"Um den Report abzuschlieÃŸen, mÃ¼ssen die folgenden Voraussetzungen erfÃ¼llt sein:",-1)),(o(!0),r(j,null,M(c.value,(T,y)=>(o(),r("div",{key:y,class:"mt-3"},[e("h6",kn,[x[1]||(x[1]=e("i",{class:"fas fa-folder-open me-1"},null,-1)),z(" "+b(y),1)]),e("ul",Sn,[(o(!0),r(j,null,M(T,p=>(o(),r("li",{key:p.requirement_name},[e("span",In,b(p.requirement_name),1),e("span",Fn," â€“ "+b(p.details),1),p.error?(o(),r("span",$n," (Fehler: "+b(p.error)+") ",1)):L("",!0)]))),128))])]))),128))])):(o(),r("div",Cn,[...x[3]||(x[3]=[e("strong",null,"Alle ausgewÃ¤hlten Anforderungen sind erfÃ¼llt.",-1)])]))])):L("",!0)}}),Pn={class:"requirement-generator container-fluid py-4"},Bn={class:"card mb-3"},Rn={class:"card-body"},Ln={class:"row align-items-end"},An={class:"col-md-6"},Nn={class:"form-group"},zn=["disabled"],Dn={value:null,disabled:""},Tn=["value"],Un={key:0,class:"mt-2"},Kn={class:"col-md-6"},jn={class:"form-group"},Mn=["disabled"],On={value:null,disabled:""},Hn=["value"],Jn={class:"row mt-3"},Vn={class:"col-12"},Gn=["disabled"],Wn={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},Yn={key:1},Xn={key:2},Zn={key:0,class:"row g-3"},Qn={class:"col-12"},ei={class:"card"},ti={class:"card-body"},ni={class:"row"},ii={class:"col-md-4"},ai={class:"col-md-4"},si={class:"col-md-4"},li={class:"row mt-2"},oi={class:"col-md-6"},ri={class:"col-md-6"},di={class:"col-12 col-xl-6"},ui={class:"card h-100"},ci={class:"card-header d-flex justify-content-between align-items-center"},gi={class:"text-muted"},mi={class:"d-flex gap-2"},fi=["disabled"],vi=["disabled"],pi=["disabled"],hi=["disabled"],bi={key:0,class:"row g-3 mt-3 card-body pre-scrollable",style:{"max-height":"70vh",overflow:"auto"}},yi={class:"col-12"},xi={class:"card"},_i={class:"card-body"},Ei={class:"list-group list-group-flush"},wi={class:"flex-grow-1"},ki={class:"d-flex justify-content-between align-items-center"},Si={class:"fw-semibold"},Ii={class:"d-flex align-items-center gap-2"},Fi=["onClick","disabled"],$i={class:"text-muted d-block"},Ci={key:0,class:"mt-2"},qi={class:"text-muted"},Pi={class:"form-check form-switch ms-3"},Bi=["checked","onChange"],Ri={key:0,class:"list-group-item text-muted"},Li={key:1,class:"mt-3 p-3 bg-light rounded"},Ai={class:"progress mb-2",style:{height:"10px"}},Ni={class:"text-muted"},zi={class:"mt-2"},Di=["disabled"],Ti={class:"card-body"},Ui={key:0,class:"mb-3"},Ki={class:"col-12 col-xl-6"},ji={class:"card h-100"},Mi={class:"card-header d-flex justify-content-between align-items-center"},Oi={key:0,class:"d-flex align-items-center gap-2"},Hi={class:"text-muted"},Ji=["disabled"],Vi={class:"card-body pre-scrollable",style:{"max-height":"70vh",overflow:"auto"}},Gi={key:0,class:"text-center py-4"},Wi={key:1,class:"findings-container"},Yi={key:2,class:"text-center py-4"},Xi={key:1,class:"alert alert-success alert-dismissible"},Zi={class:"modal-content"},Qi={class:"modal-body"},ea={key:3,class:"d-flex align-items-center gap-2"},Z="/api/lookup",W="lookupToken",Q="currentPatientExaminationId",ta=fe({__name:"RequirementGenerator",setup(i){const a=Ae(),v=ve(),w=Ee(),q=Ge(),$=Ne(),S=I(!1),P=I(null),k=I(null),f=I(null),s=I(null),c=I(null),g=I(null),x=I(!1),T=I(!1),y=I(null),p=I(!1);g!==null?S.value=!0:S.value=!1;const B=A(()=>{const n=a.patientsWithDisplayName;return console.log("Patients with displayName:",n),n}),J=A(()=>a.loading),O=A(()=>{const n=v.examinationsDropdown;return console.log("Examinations dropdown:",n),n}),_=A(()=>v.loading),C=A(()=>{const n=c.value?.requirementSets??[];return console.log("Computing requirementSets:",n),n}),U=A({get:()=>c.value?.selectedRequirementSetIds??[],set:n=>{c.value&&(c.value.selectedRequirementSetIds=n)}}),ee=A(()=>new Set(U.value)),te=A(()=>c.value?.availableFindings??[]),ae=I(!1);K(c,(n,t)=>{ae.value||(ae.value=!0,console.log("Lookup changed:",{newVal:n,oldVal:t}),n&&n.patientExaminationId!==f.value&&(f.value=n.patientExaminationId,console.log("Updated currentPatientExaminationId to:",f.value)),ae.value=!1)},{deep:!0});const se=I(!1);K(U,(n,t)=>{se.value||(se.value=!0,console.log("Selected Requirement Set IDs changed:",{newVal:n,oldVal:t}),n!==t&&q.setCurrentRequirementSetIds(n),se.value=!1)});const le=I(!1);K(f,(n,t)=>{le.value||(le.value=!0,console.log("Current Examination ID changed:",{newVal:n,oldVal:t}),n!==t&&$.setCurrentPatientExaminationId(n),le.value=!1)}),A(()=>JSON.stringify({token:s.value,selectedRequirementSetIds:U.value},null,2));const d=n=>c.value?!!w.getFindingIdsByPatientExaminationId(c.value.patientExaminationId).includes(n):!1,F=(n,t)=>{let h,H,ne=[],ie=null;typeof n=="number"?(h=n,H=t||w.getFindingById(h)?.name||`Befund ${h}`):(h=n.findingId,H=n.findingName||w.getFindingById(h)?.name||`Befund ${h}`,ne=n.selectedClassifications||[],ie=n.response),console.log("Finding added to examination:",{findingId:h,name:H,selectedClassifications:ne.length,hasResponse:!!ie});const ce=ne.length,ye=ce>0?`Befund "${H}" wurde erfolgreich hinzugefÃ¼gt mit ${ce} Klassifikation${ce!==1?"en":""}!`:`Befund "${H}" wurde erfolgreich hinzugefÃ¼gt!`;y.value=ye,setTimeout(()=>{y.value=null},5e3),setTimeout(()=>{u()},500)},E=(n,t,h)=>{console.log("Classification updated:",{findingId:n,classificationId:t,choiceId:h});const ne=w.getFindingById(n)?.name||`Befund ${n}`,ie=h?`Klassifikation fÃ¼r "${ne}" wurde erfolgreich ausgewÃ¤hlt!`:`Klassifikation fÃ¼r "${ne}" wurde zurÃ¼ckgesetzt!`;y.value=ie,setTimeout(()=>{y.value=null},3e3),setTimeout(()=>{u()},300)},R=async()=>{w.findings.length===0&&await w.fetchFindings()},u=async()=>{if(!c.value||!s.value){console.log("Skipping evaluation: lookup or token not available");return}if(!c.value.patientExaminationId){console.log("Skipping evaluation: patientExaminationId not available in lookup",c.value);return}try{console.log("Evaluating requirements based on current lookup data..."),await q.evaluateFromLookupData(c.value),console.log("Requirements evaluated successfully"),y.value="Anforderungen wurden erfolgreich evaluiert!",setTimeout(()=>{y.value=null},3e3)}catch(n){console.error("Error evaluating requirements:",n),g.value="Fehler bei der Evaluierung der Anforderungen: "+(n instanceof Error?n.message:String(n))}},l=async n=>{if(!(!c.value||!s.value))try{console.log("Evaluating requirement set:",n),await q.evaluateRequirementSet(n,c.value.patientExaminationId),console.log("Requirement set evaluated successfully")}catch(t){console.error("Error evaluating requirement set:",t),g.value="Fehler bei der Evaluierung des Anforderungssets: "+(t instanceof Error?t.message:String(t))}},m=n=>q.getRequirementSetEvaluationStatus(n),D=A(()=>{if(!c.value)return null;const n=C.value.length,t=C.value.filter(h=>q.getRequirementSetEvaluationStatus(h.id)).length;return{totalSets:n,evaluatedSets:t,completionPercentage:n>0?Math.round(t/n*100):0}});function V(n){return n?.response?.data?.detail?n.response.data.detail:n?.message?n.message:"Unbekannter Fehler"}function de(n){c.value?c.value={...c.value,...n}:c.value=n}async function ge(){if(p.value){console.log("Restart already in progress, skipping createPatientExaminationAndInitLookup...");return}if(!P.value||!k.value){console.error("Missing required selections:",{selectedPatientId:P.value,selectedExaminationId:k.value}),g.value="Bitte wÃ¤hlen Sie sowohl einen Patienten als auch eine Untersuchung aus.";return}const n=O.value.find(t=>t.id===k.value);if(!n){console.error("Selected examination not found in dropdown:",{selectedExaminationId:k.value,availableExams:O.value.map(t=>({id:t.id,name:t.name}))}),g.value="AusgewÃ¤hlte Untersuchung nicht gefunden.";return}console.log("Creating PatientExamination with:",{patientId:P.value,examinationName:n.name,examinationId:n.id}),g.value=null,x.value=!0;try{const t=new Date().toISOString().split("T")[0],h=a.getPatientById(P.value);if(!h)throw new Error("Selected patient not found");const H=O.value.find(ye=>ye.id===k.value);if(!H)throw new Error("Selected examination not found");const ne=h.dob?new Date(h.dob).toISOString().split("T")[0]:null,ie=await N.post("/api/patient-examinations/",{patient:h.patientHash||`patient_${h.id}`,examination:H.name,date_start:t,patient_birth_date:ne,patient_gender:h.gender||null});$.addPatientExamination(ie.data),console.log("PatientExamination created:",ie.data),f.value=ie.data.id;const ce=await N.post(`${Z}/init/`,{patientExaminationId:f.value});s.value=ce.data.token,console.log("Lookup initialized with token:",s.value),be(),await R(),await oe()}catch(t){g.value=V(t)}finally{x.value=!1}}async function oe(){if(s.value){g.value=null,x.value=!0;try{const n=await N.get(`${Z}/${s.value}/all/?skip_recompute=true`);console.log("Lookup API response:",n.data),de(n.data)}catch(n){n?.response?.status===404?(g.value="Lookup-Sitzung ist abgelaufen. Starte neu...",s.value=null,c.value=null,X(),localStorage.removeItem(W),localStorage.removeItem(Q),await he()||(g.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie manuell neu.")):g.value=V(n)}finally{x.value=!1}}}async function De(n){if(!s.value||!n.length)return;g.value=null,x.value=!0;const t=encodeURIComponent(n.join(","));try{const h=await N.get(`${Z}/${s.value}/parts/?keys=${t}`);de(h.data)}catch(h){h?.response?.status===404?(g.value="Lookup-Sitzung ist abgelaufen. Starte neu...",s.value=null,c.value=null,X(),localStorage.removeItem(W),localStorage.removeItem(Q),await he()||(g.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie manuell neu.")):g.value=V(h)}finally{x.value=!1}}async function Te(n){if(s.value)try{await N.patch(`${Z}/${s.value}/parts/`,{updates:n}),await De(["availableFindings","requiredFindings"])}catch(t){t?.response?.status===404?(g.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie erneut.",s.value=null,c.value=null,X(),localStorage.removeItem(W),localStorage.removeItem(Q)):g.value=V(t)}}function Ue(n,t){const h=new Set(U.value);t?h.add(n):h.delete(n),U.value=Array.from(h),Te({selectedRequirementSetIds:U.value}),q.setCurrentRequirementSetIds(U.value),s.value&&we()}async function we(){if(a.currentPatient&&a.currentPatient.id!==P.value&&console.warn("Selected patient ID does not match patient store name. Reloading..."),!!s.value)try{console.log("Triggering recomputation for selected requirement sets:",U.value);const n=await N.post(`${Z}/${s.value}/recompute/`);console.log("Recompute response:",n.data),n.data.updates&&de(n.data.updates),await oe(),U.value.length>0&&await u()}catch(n){console.error("Error during recomputation:",n),g.value="Fehler bei der Neuberechnung: "+V(n)}}function pe(){T.value=!1,a.clearError()}function Ke(n){P.value=n.id||null,T.value=!1,a.clearError(),y.value=`Patient "${n.firstName} ${n.lastName}" wurde erfolgreich erstellt und ausgewÃ¤hlt!`,setTimeout(()=>{y.value=null},5e3)}async function ke(){if(!s.value)return!1;try{return await N.get(`${Z}/${s.value}/parts/?keys=patientExaminationId`),!0}catch(n){return n?.response?.status===404&&(console.log("Token validation failed with 404, attempting restart..."),s.value=null,c.value=null,g.value="Lookup-Sitzung ist abgelaufen. Starte neu...",await he()||(g.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie manuell neu.")),!1}}function je(){s.value&&(x.value=!0,g.value=null,N.get(`${Z}/${s.value}/parts/?keys=patientExaminationId`).then(()=>N.patch(`${Z}/${s.value}/parts/`,{updates:{}})).then(()=>{oe()}).catch(n=>{g.value=V(n),n?.response?.status===404&&(s.value=null,c.value=null,g.value="Lookup-Session ist abgelaufen. Bitte starten Sie erneut.",X())}).finally(()=>{x.value=!1}))}function Me(){s.value=null,c.value=null,f.value=null,g.value=null,y.value=null,X(),localStorage.removeItem(W),localStorage.removeItem(Q)}async function Oe(){console.log("Resetting session for new patient..."),s.value=null,c.value=null,f.value=null,g.value=null,y.value=null,X(),localStorage.removeItem(W),localStorage.removeItem(Q),q.reset(),console.log("Session reset complete for new patient")}async function he(){if(p.value)return console.log("Restart already in progress, skipping..."),!1;console.log("Attempting to restart lookup session..."),p.value=!0;try{if(s.value=null,c.value=null,X(),localStorage.removeItem(W),await new Promise(n=>setTimeout(n,500)),f.value&&P.value&&k.value){console.log("Reusing existing patient examination:",f.value),console.log("selectedPatientId:",P.value),console.log("selectedExaminationId:",k.value);const n=await N.post(`${Z}/init/`,{patientExaminationId:f.value});return s.value=n.data.token,be(),await oe(),y.value="Lookup-Session wurde erfolgreich neu gestartet!",setTimeout(()=>{y.value=null},3e3),!0}else return console.log("No existing patient examination, creating new one"),console.log("currentPatientExaminationId:",f.value),console.log("selectedPatientId:",P.value),console.log("selectedExaminationId:",k.value),!P.value||!k.value?(g.value="Kann Session nicht automatisch neu starten: Patient oder Untersuchung fehlt.",!1):(await ge(),!0)}catch(n){return console.error("Failed to restart lookup session:",n),g.value="Fehler beim Neustart der Lookup-Session: "+V(n),!1}finally{p.value=!1}}let ue=null;function be(){ue||(ue=window.setInterval(async()=>{s.value&&!p.value&&await ke()},900*1e3))}function X(){ue&&(clearInterval(ue),ue=null)}I(!1);const Se=localStorage.getItem(W),Ie=localStorage.getItem(Q);return Se&&(s.value=Se),Ie&&(f.value=parseInt(Ie)),K(s,n=>{n?localStorage.setItem(W,n):localStorage.removeItem(W)}),K(f,n=>{n?localStorage.setItem(Q,n.toString()):localStorage.removeItem(Q)}),K(k,n=>{console.log("Examination selection changed:",{newId:n,selectedPatientId:P.value,availableExams:O.value.map(t=>({id:t.id,name:t.name}))}),v.setSelectedExamination(n),n&&v.loadFindingsForExamination(n)}),K(P,async(n,t)=>{console.log("Patient selection changed:",{oldPatientId:t,newPatientId:n,currentExaminationsCount:O.value.length}),k.value=null,t&&n!==t&&(console.log("Patient changed, resetting session for new overview..."),await Oe())}),K(U,async(n,t)=>{n.length!==t.length&&c.value&&(console.log("Requirement set selection changed, triggering evaluation..."),await u())},{deep:!0}),K(c,async(n,t)=>{n&&n!==t&&U.value.length>0&&(console.log("Lookup data changed, triggering evaluation..."),setTimeout(()=>{u()},1e3))},{deep:!0}),K(c,n=>{n&&n.requirementsBySet&&(console.log("Loading requirement sets from lookup data..."),q.loadRequirementSetsFromLookup(n))},{immediate:!0}),_e(async()=>{console.log("Component mounted, starting data loading..."),await Promise.all([a.fetchPatients(),v.fetchExaminations()]),console.log("Data loading completed:",{patientsCount:B.value.length,examinationsCount:O.value.length}),await a.initializeLookupData(),s.value&&(console.log("Validating existing token:",s.value),await ke()?(await oe(),be()):(s.value=null,c.value=null,f.value=null,X(),localStorage.removeItem(W),localStorage.removeItem(Q))),await R()}),Je(()=>{X()}),(n,t)=>(o(),r("div",Pn,[e("div",Bn,[t[10]||(t[10]=e("div",{class:"card-header"},[e("h2",{class:"h5 mb-0"},"1. Patient und Untersuchung auswÃ¤hlen")],-1)),e("div",Rn,[e("div",Ln,[e("div",An,[e("div",Nn,[t[8]||(t[8]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{for:"patient-select"},"Patient auswÃ¤hlen")],-1)),me(e("select",{id:"patient-select","onUpdate:modelValue":t[0]||(t[0]=h=>P.value=h),class:"form-control",disabled:J.value||x.value},[e("option",Dn,b(J.value?"Lade Patienten...":"Bitte wÃ¤hlen Sie einen Patienten"),1),(o(!0),r(j,null,M(B.value,h=>(o(),r("option",{key:h.id,value:h.id},b(h.displayName),9,Tn))),128))],8,zn),[[Ce,P.value]]),P.value?(o(),r("div",Un,[...t[7]||(t[7]=[e("small",{class:"text-muted"},[e("i",{class:"fas fa-info-circle"}),z(" Bei Patientenwechsel wird automatisch eine neue Ãœbersicht generiert. ")],-1)])])):L("",!0)])]),e("div",Kn,[e("div",jn,[t[9]||(t[9]=e("label",{for:"examination-select"},"Untersuchung auswÃ¤hlen",-1)),me(e("select",{id:"examination-select","onUpdate:modelValue":t[1]||(t[1]=h=>k.value=h),class:"form-control",disabled:_.value||!P.value||x.value},[e("option",On,b(_.value?"Lade Untersuchungen...":"Bitte wÃ¤hlen Sie eine Untersuchung"),1),(o(!0),r(j,null,M(O.value,h=>(o(),r("option",{key:h.id,value:h.id},b(h.displayName),9,Hn))),128))],8,Mn),[[Ce,k.value]])])])]),e("div",Jn,[e("div",Vn,[e("button",{class:"btn btn-primary",disabled:!P.value||!k.value||x.value||!!s.value,onClick:ge},[x.value?(o(),r("span",Wn)):L("",!0),s.value?(o(),r("span",Xn,"Anforderungsbericht bereits aktiv")):(o(),r("span",Yn,"2. Anforderungsbericht erstellen"))],8,Gn)])])])]),c.value&&S.value?(o(),r("div",Zn,[e("div",Qn,[e("div",ei,[t[16]||(t[16]=e("div",{class:"card-header"},[e("h2",{class:"h6 mb-0"},"Debug: Aktuelle Lookup-Daten")],-1)),e("div",ti,[e("div",ni,[e("div",ii,[t[11]||(t[11]=e("strong",null,"Patient Examination ID:",-1)),z(" "+b(c.value.patientExaminationId||"Nicht verfÃ¼gbar"),1)]),e("div",ai,[t[12]||(t[12]=e("strong",null,"Token:",-1)),z(" "+b(s.value),1)]),e("div",si,[t[13]||(t[13]=e("strong",null,"Requirement Sets:",-1)),z(" "+b(C.value.length),1)])]),e("div",li,[e("div",oi,[t[14]||(t[14]=e("strong",null,"AusgewÃ¤hlte Sets:",-1)),z(" "+b(U.value.join(", ")||"Keine"),1)]),e("div",ri,[t[15]||(t[15]=e("strong",null,"VerfÃ¼gbare Findings:",-1)),z(" "+b(te.value.length),1)])])])])]),e("div",di,[e("div",ui,[e("div",ci,[e("div",null,[t[17]||(t[17]=e("h2",{class:"h5 mb-0"},"3. Requirement Sets anpassen",-1)),e("small",gi,"Token: "+b(s.value),1)]),e("div",mi,[e("button",{class:"btn btn-sm btn-outline-secondary",onClick:oe,disabled:x.value}," Aktualisieren ",8,fi),e("button",{class:"btn btn-sm btn-outline-info",onClick:we,disabled:x.value||!s.value}," Neu berechnen ",8,vi),e("button",{class:"btn btn-sm btn-outline-info",onClick:je,disabled:x.value||!s.value}," Session erneuern ",8,pi),e("button",{class:"btn btn-sm btn-outline-danger",onClick:Me,disabled:x.value||!s.value}," Session zurÃ¼cksetzen ",8,hi)])]),c.value?(o(),r("div",bi,[e("div",yi,[e("div",xi,[t[18]||(t[18]=e("div",{class:"card-header"},[e("h2",{class:"h5 mb-0"},"Befunde in der aktuellen Untersuchung")],-1)),e("div",_i,[Pe(xn,{"examination-id":k.value||void 0,"patient-examination-id":f.value||void 0,onFindingAdded:F,onFindingError:t[2]||(t[2]=h=>g.value=h)},null,8,["examination-id","patient-examination-id"])])])])])):L("",!0),e("ul",Ei,[(o(!0),r(j,null,M(C.value,h=>(o(),r("li",{key:h.id,class:"list-group-item d-flex justify-content-between align-items-center"},[e("div",wi,[e("div",ki,[e("span",Si,b(h.name),1),e("div",Ii,[m(h.id)?(o(),r("span",{key:0,class:Y(["badge",m(h.id).met?"bg-success":"bg-warning"])},[e("i",{class:Y(["fas",m(h.id).met?"fa-check":"fa-exclamation-triangle"])},null,2),z(" "+b(m(h.id).met?"ErfÃ¼llt":"Nicht erfÃ¼llt"),1)],2)):L("",!0),e("button",{class:"btn btn-sm btn-outline-info",onClick:H=>l(h.id),disabled:x.value,title:"Anforderungsset evaluieren"},[...t[19]||(t[19]=[e("i",{class:"fas fa-calculator"},null,-1)])],8,Fi)])]),e("small",$i,"type: "+b(h.type),1),m(h.id)?(o(),r("div",Ci,[e("small",qi," ErfÃ¼llte Anforderungen: "+b(m(h.id)?.metRequirementsCount)+" / "+b(m(h.id)?.totalRequirementsCount),1)])):L("",!0)]),e("div",Pi,[e("input",{class:"form-check-input",type:"checkbox",checked:ee.value.has(h.id),onChange:H=>Ue(h.id,H.target.checked)},null,40,Bi)])]))),128)),C.value.length?L("",!0):(o(),r("li",Ri,"Keine Sets gefunden."))]),D.value&&D.value.totalSets>0?(o(),r("div",Li,[t[21]||(t[21]=e("h6",{class:"mb-2"},"EvaluierungsÃ¼bersicht",-1)),e("div",Ai,[e("div",{class:Y(["progress-bar",D.value.completionPercentage===100?"bg-success":"bg-info"]),style:Le({width:D.value.completionPercentage+"%"})},null,6)]),e("small",Ni,b(D.value.evaluatedSets)+" von "+b(D.value.totalSets)+" Sets evaluiert ("+b(D.value.completionPercentage)+"%) ",1),e("div",zi,[e("button",{class:"btn btn-sm btn-primary",onClick:u,disabled:x.value},[...t[20]||(t[20]=[e("i",{class:"fas fa-sync"},null,-1),z(" Alle evaluieren ",-1)])],8,Di)])])):L("",!0),c.value?(o(),qe(qn,{key:2,"patient-examination-id":c.value.patientExaminationId||null,"requirement-set-ids":U.value,"show-only-unmet":!0},null,8,["patient-examination-id","requirement-set-ids"])):L("",!0),e("div",Ti,[c.value?(o(),r("div",Ui,[t[22]||(t[22]=e("strong",null,"Debug Info:",-1)),t[23]||(t[23]=e("br",null,null,-1)),z(" Lookup exists: "+b(!!c.value),1),t[24]||(t[24]=e("br",null,null,-1)),z(" Requirement sets count: "+b(C.value.length),1),t[25]||(t[25]=e("br",null,null,-1)),t[26]||(t[26]=z(" Raw lookup data: ",-1)),e("pre",null,b(JSON.stringify(c.value,null,2)),1)])):L("",!0)])])]),e("div",Ki,[e("div",ji,[e("div",Mi,[t[28]||(t[28]=e("h2",{class:"h5 mb-0"},"Um die Untersuchung abzuschlieÃŸen, mÃ¼ssen die folgenden Befunde vorhanden sein.",-1)),t[29]||(t[29]=e("p",{class:"text-muted mb-0"},"Hinweis: Ã„ndern Sie die Klassifikationen auf ihr bevorzugtes Format.",-1)),te.value.length>0?(o(),r("div",Oi,[e("small",Hi,b(te.value.length)+" verfÃ¼gbar",1),e("button",{class:"btn btn-sm btn-outline-info",onClick:t[3]||(t[3]=h=>R()),disabled:x.value,title:"Befunde aktualisieren"},[...t[27]||(t[27]=[e("i",{class:"fas fa-sync-alt"},null,-1)])],8,Ji)])):L("",!0)]),e("div",Vi,[Be(w).loading?(o(),r("div",Gi,[...t[30]||(t[30]=[e("div",{class:"spinner-border",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1),e("p",{class:"mt-2 text-muted"},"Lade Befunde...",-1)])])):te.value.length?(o(),r("div",Wi,[(o(!0),r(j,null,M(te.value,h=>(o(),qe(St,{key:h,"finding-id":h,"is-added-to-examination":d(h),"patient-examination-id":c.value?.patientExaminationId||void 0,onAddedToExamination:F,onClassificationUpdated:E},null,8,["finding-id","is-added-to-examination","patient-examination-id"]))),128))])):(o(),r("div",Yi,[...t[31]||(t[31]=[e("i",{class:"fas fa-info-circle fa-2x text-muted mb-3"},null,-1),e("p",{class:"text-muted"},"Keine Befunde verfÃ¼gbar fÃ¼r die Auswahl.",-1),e("small",{class:"text-muted"},"WÃ¤hlen Sie eine Untersuchung aus, um verfÃ¼gbare Befunde zu laden.",-1)])]))])]),t[32]||(t[32]=z("alert ",-1))])])):L("",!0),y.value?(o(),r("div",Xi,[t[33]||(t[33]=e("strong",null,"Erfolg:",-1)),z(" "+b(y.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:t[4]||(t[4]=h=>y.value=null)})])):L("",!0),T.value?(o(),r("div",{key:2,class:"modal-overlay",onClick:pe},[e("div",{class:"modal-dialog",onClick:t[5]||(t[5]=xe(()=>{},["stop"]))},[e("div",Zi,[e("div",{class:"modal-header"},[t[34]||(t[34]=e("h5",{class:"modal-title"},"Neuen Patienten erstellen",-1)),e("button",{type:"button",class:"btn-close",onClick:pe})]),e("div",Qi,[Pe(Ve,{onPatientCreated:Ke,onCancel:pe})])])])])):L("",!0),P.value?(o(),r("div",ea,[t[36]||(t[36]=e("span",{class:"badge bg-info"},[e("i",{class:"fas fa-user"}),z(" Aktiv ")],-1)),t[37]||(t[37]=e("strong",null,"ZurÃ¼cksetzen:",-1)),e("button",{type:"button",class:"btn btn-sm btn-outline-secondary",onClick:t[6]||(t[6]=h=>Be(a).clearCurrentPatient()),title:"Patientenauswahl zurÃ¼cksetzen"},[...t[35]||(t[35]=[e("i",{class:"fas fa-times"},null,-1)])])])):L("",!0)]))}}),sa=Re(ta,[["__scopeId","data-v-6364a105"]]);export{sa as R};
