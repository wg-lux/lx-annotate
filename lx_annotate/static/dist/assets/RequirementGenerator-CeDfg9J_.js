import{O as ce,z as U,h as $,e as T,M as ee,f as Be,d as pe,i as we,w as H,c as d,a as e,j as D,k as K,t as y,F as X,m as Z,o as r,_ as De,E as ke,n as ne,l as ve,R as Re,q as Te,A as Ge,J as We,v as Le,x as Ae,b as Ne,p as ze}from"./main-DethiONo.js";import{u as Ue}from"./patientStore-BazAFCNw.js";import{P as Ye}from"./PatientAdder-BlwvntXl.js";const he=ce("examination",{state:()=>({loading:!1,error:null,exams:[],selectedExaminationId:null,findingsByExam:new Map,classificationsByFinding:new Map}),getters:{examinations(i){return i.exams},examinationsDropdown(i){return i.exams.map(c=>({id:c.id,name:c.name,displayName:c.displayName??c.name_de??c.name}))},selectedExamination(i){return i.exams.find(c=>c.id===i.selectedExaminationId)??null},availableFindings(i){const c=i.selectedExaminationId;return c?i.findingsByExam.get(c)??[]:[]}},actions:{setSelectedExamination(i){this.selectedExaminationId=i},async fetchExaminations(){var i,c;this.loading=!0,this.error=null;try{const u=await U.get("/api/examinations/");this.exams=u.data.map(a=>({id:a.id,name:a.name,name_de:a.name_de,name_en:a.name_en,displayName:a.displayName??a.name_de??a.name_en??a.name}))}catch(u){this.error=((c=(i=u==null?void 0:u.response)==null?void 0:i.data)==null?void 0:c.detail)??(u==null?void 0:u.message)??"Unbekannter Fehler"}finally{this.loading=!1}},async loadFindingsForExamination(i){var c,u;if(!i)return[];this.loading=!0,this.error=null;try{const F=(await U.get(`/api/examinations/${i}/findings/`)).data;return this.findingsByExam.set(i,F),F}catch(a){return this.error=((u=(c=a==null?void 0:a.response)==null?void 0:c.data)==null?void 0:u.detail)??(a==null?void 0:a.message)??"Unbekannter Fehler",[]}finally{this.loading=!1}},async getCurrentExaminationId(){return this.selectedExaminationId?this.selectedExaminationId:(await this.fetchExaminations(),this.selectedExaminationId)},async loadFindingClassifications(i){var c,u;this.loading=!0,this.error=null;try{const F=(await U.get(`/api/findings/${i}/classifications/`)).data;return this.classificationsByFinding.set(i,F),F}catch(a){return this.error=((u=(c=a==null?void 0:a.response)==null?void 0:c.data)==null?void 0:u.detail)??(a==null?void 0:a.message)??"Unbekannter Fehler",{locationClassifications:[],morphologyClassifications:[]}}finally{this.loading=!1}}}}),Se=ce("finding",()=>{const i=$([]),c=$(!1),u=$(null),a=$(null),F=$([]),C=$(new Map),S=$(new Map);he();const B=async()=>{var E,P;try{c.value=!0,u.value=null;const R=await U.get("/api/findings/");i.value=R.data.results||R.data}catch(R){u.value="Fehler beim Laden der Befunde: "+(((P=(E=R.response)==null?void 0:E.data)==null?void 0:P.detail)||R.message),console.error("Fetch findings error:",R)}finally{c.value=!1}},w=async E=>{try{return(await U.get(`/api/findings/${E}/classifications/`)).data}catch(P){throw console.error(`Error fetching classifications for finding ${E}:`,P),P}},_=async E=>{try{if(C.value.has(E))return C.value.get(E);S.value.set(E,!0);const R=(await U.get(`/api/examinations/${E}/findings/`)).data;return C.value.set(E,R),R}catch(P){throw console.error(`Error fetching findings for examination ${E}:`,P),P}finally{S.value.set(E,!1)}},s=async E=>{var P,R;if(!E)return[];try{c.value=!0,u.value=null;const W=await U.get(`/api/patient-examinations/${E}/findings/`);return i.value=W.data.results||W.data,i.value}catch(W){return u.value="Fehler beim Laden der Befunde fÃ¼r die Patientenuntersuchung: "+(((R=(P=W.response)==null?void 0:P.data)==null?void 0:R.detail)||W.message),console.error("Fetch findings by patient examination error:",W),[]}finally{c.value=!1}},l=async E=>{try{return(await U.get(`/api/examinations/${E}/classifications/`)).data}catch(P){throw console.error(`Error fetching classifications for examination ${E}:`,P),P}},m=E=>i.value.find(P=>P.id===E),x=E=>{a.value=E},L=T(()=>i.value.length>0),f=E=>C.value.has(E)?(console.log("Using cached findings for examination",E),C.value.get(E)):(console.log("No cached findings for examination",E),console.log("Using the following findings:"),i.value.filter(P=>(console.log(P),P.examinations&&P.examinations.includes(E.toString())))),v=E=>{const P=[];for(const R of i.value)R.PatientExaminationId===E&&P.push(R.id);return P},z=E=>C.value.has(E),J=E=>S.value.get(E)||!1,O=E=>{E?(C.value.delete(E),S.value.delete(E)):(C.value.clear(),S.value.clear())};return{findings:ee(i),FindingClassification:F,loading:ee(c),error:ee(u),currentFinding:ee(a),examinationFindings:ee(C),areFindingsLoaded:L,fetchFindings:B,fetchFindingClassifications:w,fetchFindingsByExamination:_,fetchExaminationClassifications:l,getFindingsByExamination:f,getFindingById:m,getFindingIdsByPatientExaminationId:v,setCurrentFinding:x,isExaminationFindingsLoaded:z,isExaminationFindingsLoading:J,clearExaminationFindingsCache:O,fetchFindingsByPatientExamination:s}}),Xe=ce("requirement",()=>{const i=$([]),c=$(!1),u=$(null),a=$(null),F=$({}),C=$([]),S=g=>{a.value=g,C.value=g?[g.id]:[]},B=g=>{C.value=g,g.length!==1?a.value=null:a.value=P(g[0])||null},w=g=>{var I;i.value=i.value.filter(k=>k.id!==g),((I=a.value)==null?void 0:I.id)===g&&(a.value=null,C.value=[]),delete F.value[g]},_=T(()=>i.value.every(g=>g.met)),s=T(()=>a.value?a.value.met:!1),l=T(()=>i.value.reduce((g,I)=>g+I.requirements.filter(k=>k.met).length,0)),m=T(()=>i.value.reduce((g,I)=>g+I.requirements.length,0)),x=async()=>{var g,I;try{c.value=!0,u.value=null;const k=await U.get("/api/requirement-sets/");i.value=k.data.results||k.data}catch(k){u.value="Fehler beim Laden der AnforderungssÃ¤tze: "+(((I=(g=k.response)==null?void 0:g.data)==null?void 0:I.detail)||k.message),console.error("Fetch requirement sets error:",k)}finally{c.value=!1}},L=async g=>{try{return(await U.get(`/api/requirement-sets/${g}/`)).data}catch(I){return console.error(`Error fetching requirement set ${g}:`,I),null}},f=async(g,I)=>{var k,A,h,o;try{c.value=!0,u.value=null;const q={requirement_set_ids:g,patient_examination_id:I};I&&(q.patient_examination_id=I),g?q.requirementSetIds=g:q.requirementSetIds=i.value.map(M=>M.id);const b=(await U.post("/api/evaluate-requirements/",q)).data.results||[];if(b.length>0){const M=Be(),Y=b.filter(G=>!G.met);Y.length>0?M.warning({text:`${Y.length} von ${b.length} Anforderungen nicht erfÃ¼llt. ÃœberprÃ¼fen Sie die Patientendaten.`,timeout:5e3}):M.success({text:`Alle ${b.length} Anforderungen erfolgreich erfÃ¼llt!`,timeout:3e3})}return g?g.forEach(M=>{F.value[M]=b.filter(Y=>{var G;return(G=i.value.find(ie=>ie.id===M))==null?void 0:G.requirements.some(ie=>ie.name===Y.requirement_name)})}):b.forEach(M=>{var G;const Y=(G=i.value.find(ie=>ie.requirements.some(ge=>ge.name===M.requirement_name)))==null?void 0:G.id;Y&&(F.value[Y]||(F.value[Y]=[]),F.value[Y].push(M))}),z(b),b}catch(q){throw u.value="Fehler bei der Evaluierung der Anforderungen: "+(((A=(k=q.response)==null?void 0:k.data)==null?void 0:A.detail)||q.message),console.error("Evaluate requirements error:",q),Be().error({text:"Fehler bei der Anforderungsevaluierung: "+(((o=(h=q.response)==null?void 0:h.data)==null?void 0:o.detail)||q.message),timeout:5e3}),q}finally{c.value=!1}},v=async(g,I)=>{var k,A;try{c.value=!0,u.value=null;const h=C.value.length>0?C.value:[g];g.valueOf.length>0&&h.push(g);const o={requirement_set_ids:h,patient_examination_id:I};I&&(o.patient_examination_id=I);const N=(await U.post("/api/evaluate-requirement-set/",o)).data.results||[];return F.value[g]=N,z(N),N}catch(h){throw u.value="Fehler bei der Evaluierung des Anforderungssatzes: "+(((A=(k=h.response)==null?void 0:k.data)==null?void 0:A.detail)||h.message),console.error("Evaluate requirement set error:",h),h}finally{c.value=!1}},z=g=>{if(i.value.forEach(I=>{I.requirements.forEach(k=>{const A=g.find(h=>h.requirement_name===k.name);A&&(k.met=A.met,k.details=A.details)}),I.met=I.requirements.every(k=>k.met)}),a.value){const I=g.filter(k=>a.value.requirements.some(A=>A.name===k.requirement_name));a.value.requirements.forEach(k=>{const A=I.find(h=>h.requirement_name===k.name);A&&(k.met=A.met,k.details=A.details)}),a.value.met=a.value.requirements.every(k=>k.met)}},J=g=>({examinations:g.patientExaminationId?[g.patientExaminationId]:[],findings:g.availableFindings||[],finding_classifications:g.findingClassifications||[],examination_indications:g.examinationIndications||[],indication_choices:g.indicationChoices||[],lab_values:g.labValues||[],diseases:g.diseases||[],disease_classification_choices:g.diseaseClassificationChoices||[],events:g.events||[],medications:g.medications||[],medication_indications:g.medicationIndications||[],medication_intake_times:g.medicationIntakeTimes||[],medication_schedules:g.medicationSchedules||[],genders:g.genders||[]}),O=async(g,I)=>{const k=g.patientExaminationId;return await f(I,k)},E=async g=>{if(!a.value)throw new Error("No current requirement set selected");const I=g.patientExaminationId;return await v(a.value.id,I)},P=g=>i.value.find(I=>I.id===g);return{requirementSets:i,currentRequirementSet:a,evaluationResults:F,loading:c,error:u,isRequirementValidated:_,isRequirementSetValidated:s,metRequirementsCount:l,totalRequirementsCount:m,setCurrentRequirementSet:S,fetchRequirementSets:x,fetchRequirementSet:L,evaluateRequirements:f,evaluateRequirementSet:v,evaluateFromLookupData:O,evaluateCurrentSetFromLookupData:E,createRequirementLinksFromLookup:J,getRequirementSetById:P,getRequirementById:(g,I)=>{const k=P(g);return k==null?void 0:k.requirements.find(A=>A.id===I)},getRequirementSetEvaluationStatus:g=>{const I=P(g);if(!I)return null;const k=I.requirements.filter(h=>h.met).length,A=I.requirements.length;return{met:I.met,metRequirementsCount:k,totalRequirementsCount:A,completionPercentage:A>0?Math.round(k/A*100):0}},getRequirementEvaluationStatus:g=>{for(const I of i.value){const k=I.requirements.find(A=>A.id===g);if(k)return{met:k.met,details:k.details}}return null},loadRequirementSetsFromLookup:g=>{if(!g.requirementsBySet)return;const I=[];Object.entries(g.requirementsBySet).forEach(([k,A])=>{var o,q;const h=(o=g.requirementSets)==null?void 0:o.find(N=>N.id===parseInt(k));h&&I.push({id:parseInt(k),name:h.name,description:h.description,type:h.type,requirements:A.map(N=>{var b;return{id:N.id,name:N.name,description:N.description,met:((b=g.requirementStatus)==null?void 0:b[N.id])||!1,details:null}}),met:((q=g.requirementSetStatus)==null?void 0:q[k])||!1})}),i.value=I},clearError:()=>{u.value=null},setCurrentRequirementSetIds:B,deleteRequirementSetById:w,reset:()=>{i.value=[],a.value=null,F.value={},u.value=null}}}),Ke=ce("patientExamination",{state:()=>({loading:!1,error:null,patientExaminations:[],selectedPatientExaminationId:null}),getters:{getPatientExaminationById:i=>c=>i.patientExaminations.find(u=>u.id===c)||null,isLoading:i=>i.loading,getError:i=>i.error,getAllPatientExaminations:i=>i.patientExaminations,getSelectedPatientExaminationId:i=>i.selectedPatientExaminationId},actions:{async doesPatientExaminationExist(i){var c,u;try{this.loading=!0,this.error=null;const a=await U.get(`/api/check_pe_exist/${i}/`);return a.status===200&&typeof a.data.exists=="boolean"?a.data.exists:!0}catch(a){return this.error="Fehler beim ÃœberprÃ¼fen der Patientenuntersuchung: "+(((u=(c=a.response)==null?void 0:c.data)==null?void 0:u.detail)||a.message),console.error("Check patient examination existence error:",a),!1}finally{this.loading=!1}},async fetchPatientExaminations(i){var c,u;try{if(this.loading=!0,this.error=null,await this.doesPatientExaminationExist(i)===!1){this.patientExaminations=[];return}const a=await U.get(`/api/patient-examinations/?patient_id=${i}`);this.patientExaminations=a.data.results||a.data}catch(a){this.error="Fehler beim Laden der Patientenuntersuchungen: "+(((u=(c=a.response)==null?void 0:c.data)==null?void 0:u.detail)||a.message),console.error("Fetch patient examinations error:",a)}finally{this.loading=!1}},async fetchPatientExaminationById(i){var c,u;try{this.loading=!0,this.error=null;const F=(await U.get(`/api/get_patient_examination/${i}/`)).data;if(F){const C=this.patientExaminations.findIndex(S=>S.id===F.id);C!==-1?this.patientExaminations[C]=F:this.patientExaminations.push(F)}}catch(a){this.error="Fehler beim Laden der Patientenuntersuchung: "+(((u=(c=a.response)==null?void 0:c.data)==null?void 0:u.detail)||a.message),console.error("Fetch patient examination by ID error:",a)}finally{this.loading=!1}},addPatientExamination(i){this.patientExaminations.push(i)},removePatientExamination(i){this.patientExaminations=this.patientExaminations.filter(c=>c.id!==i),this.selectedPatientExaminationId===i&&(this.selectedPatientExaminationId=null)},setCurrentPatientExaminationId(i){this.selectedPatientExaminationId=i},getCurrentPatientExaminationId(){return this.selectedPatientExaminationId},getCurrentPatientExaminationExaminationId(){const i=this.patientExaminations.find(c=>c.id===this.selectedPatientExaminationId);return i?i.examination.id:null}}}),je=ce("findingsClassificationStore",()=>{const i=$({}),c=$(!1),u=$(null),a=s=>{const l=i.value[s];return l?[...l.classifications||[],...l.location_classifications||[],...l.morphology_classifications||[]]:[]},F=T(()=>Object.values(i.value)),C=s=>(i.value[s]||F.value,i.value[s]),S=()=>{i.value={},u.value=null},B=s=>{u.value=s},w=s=>{c.value=s},_=s=>{const l={};s.forEach(m=>{l[m.id]=m}),i.value=l,console.log("ðŸ“‹ [FindingsClassificationStore] Set findings from lookup:",Object.keys(l).length,"findings")};return{findings:ee(i),loading:ee(c),error:ee(u),getFindingById:C,getClassificationsForFinding:a,getAllFindings:F,clearFindings:S,setError:B,setLoading:w,setClassificationChoicesFromLookup:_}}),Ze={class:"finding-card card mb-3"},Qe={class:"card-body"},Ve={key:0,class:"text-center"},et={key:1,class:"text-center text-muted"},tt={class:"row mb-3"},nt={class:"col-md-6"},it={class:"col-md-6"},at={class:"text-muted"},st={class:"col-md-6"},lt={class:"col-md-6"},ot={key:0},rt={key:1},dt={class:"col-md-6"},ut={key:0,class:"mb-3"},ct={class:"classification-list"},gt={class:"d-flex justify-content-between align-items-center"},mt={key:0,class:"text-muted small"},ft={key:1,class:"mb-2"},vt={class:"d-flex flex-wrap gap-1 mt-1"},pt={key:2,class:"mb-2"},ht={class:"d-flex flex-wrap gap-1 mt-1"},bt={key:2},yt={key:0,class:"selected-classifications-summary mt-3 p-3 bg-light rounded"},xt={class:"mb-2"},_t={class:"row"},Et={class:"d-flex justify-content-between align-items-center"},kt={class:"text-muted"},wt={key:1,class:"mt-3 p-2 bg-light border rounded"},St={class:"text-muted"},It=pe({__name:"FindingsDetail",props:{findingId:{},isAddedToExamination:{type:Boolean,default:!1},patientExaminationId:{default:void 0}},emits:["added-to-examination","classification-updated","error-occurred"],setup(i,{emit:c}){const u=Se(),a=he(),F=je(),C=T(()=>a.selectedExaminationId||void 0),S=i,B=$(!1),w=$([]),_=T(()=>{const f=F.getFindingById(S.findingId);return f||u.getFindingById(S.findingId)}),s=T(()=>w.value.filter(f=>f.required)),l=T(()=>{var J,O;const f=F.getFindingById(S.findingId),v=u.getFindingById(S.findingId),z=f?"findingClassificationStore":v?"findingStore":"none";return{findingId:S.findingId,findingName:((J=_.value)==null?void 0:J.nameDe)||((O=_.value)==null?void 0:O.name),totalClassifications:w.value.length,requiredClassifications:s.value.length,classificationsLoaded:w.value.length>0,dataSource:z}}),m=T(()=>{var J,O,E;const f=F.getFindingById(S.findingId),v=u.getFindingById(S.findingId),z=f?"findingClassificationStore":v?"findingStore":"none";return{findingId:S.findingId,findingName:((J=_.value)==null?void 0:J.nameDe)||((O=_.value)==null?void 0:O.name),findingDescription:((E=_.value)==null?void 0:E.description)||"Keine Beschreibung verfÃ¼gbar",totalClassifications:w.value.length,requiredClassifications:s.value.length,classificationsLoaded:w.value.length>0,dataSource:z}}),x=async()=>{if(!S.findingId){console.log("ðŸ“‹ [FindingsDetail] No findingId provided, skipping classifications load");return}try{B.value=!0;const f=F.getClassificationsForFinding(S.findingId);if(f.length>0)w.value=f,console.log("ðŸ“‹ [FindingsDetail] Loaded classifications from store:",f.length);else{const v=F.getFindingById(S.findingId);v!=null&&v.FindingClassifications?(w.value=v.FindingClassifications,console.log("ðŸ“‹ [FindingsDetail] Loaded classifications from finding data:",v.FindingClassifications.length)):(console.warn("ðŸ“‹ [FindingsDetail] No classifications found for finding:",S.findingId),w.value=[])}}catch(f){console.error("Error loading classifications:",f),w.value=[]}finally{B.value=!1}},L=async()=>{await x()};return we(()=>{console.log("ðŸš€ [FindingsDetail] Component mounted with props:",{findingId:S.findingId,patientExaminationId:S.patientExaminationId,isAddedToExamination:S.isAddedToExamination,findingStoreFindingsCount:u.findings.length,findingFromStore:u.getFindingById(S.findingId)}),L()}),H(()=>S.findingId,(f,v)=>{console.log("ðŸ‘€ [FindingsDetail] findingId changed:",{oldVal:v,newVal:f}),L()},{immediate:!0}),H(()=>F.getFindingById(S.findingId),(f,v)=>{f&&(console.log("ðŸ”„ [FindingsDetail] Finding data now available in findingClassificationStore, loading classifications",{findingId:f.id}),x())},{immediate:!0}),H(()=>u.findings,(f,v)=>{console.log("ðŸ“Š [FindingsDetail] findingStore.findings changed:",{oldCount:(v==null?void 0:v.length)||0,newCount:(f==null?void 0:f.length)||0,findingId:S.findingId}),f&&f.length>0&&(console.log("ðŸ”„ [FindingsDetail] Reloading classifications due to findings data change"),L())},{immediate:!0}),(f,v)=>(r(),d("div",Ze,[e("div",Qe,[B.value?(r(),d("div",Ve,[...v[0]||(v[0]=[e("div",{class:"spinner-border spinner-border-sm",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1),K(" Lade Details... ",-1)])])):!B.value&&_.value?(r(),d("div",et,[e("div",tt,[e("div",nt,[e("p",null,[v[1]||(v[1]=e("strong",null,"ID:",-1)),K(" "+y(_.value.id),1)]),e("p",null,[v[2]||(v[2]=e("strong",null,"Name (DE):",-1)),K(" "+y(m.value.findingName||"N/A"),1)])]),e("div",it,[v[3]||(v[3]=e("p",null,[e("strong",null,"Beschreibung:")],-1)),e("p",at,y(m.value.findingDescription||"Keine Beschreibung verfÃ¼gbar"),1)]),e("div",st,[e("p",null,[v[4]||(v[4]=e("strong",null,"Data Source:",-1)),K(" "+y(m.value.dataSource),1)])]),e("div",lt,[e("p",null,[v[5]||(v[5]=e("strong",null,"Klassifikationen gesamt:",-1)),K(" "+y(m.value.totalClassifications)+" ("+y(m.value.requiredClassifications)+" erforderlich)",1)]),m.value.classificationsLoaded?(r(),d("p",ot,"Die Klassifikationen wurden erfolgreich geladen.")):(r(),d("p",rt,"Die Klassifikationen konnten nicht geladen werden."))]),e("div",dt,[e("p",null,[v[6]||(v[6]=e("strong",null,"Erforderliche Klassifikationen:",-1)),K(" "+y(m.value.requiredClassifications),1)])])]),s.value.length>0?(r(),d("div",ut,[v[8]||(v[8]=e("h6",null,"Erforderliche Klassifikationen:",-1)),e("div",ct,[(r(!0),d(X,null,Z(s.value,z=>(r(),d("div",{key:z.id,class:"classification-item mb-2 p-2 border rounded bg-light"},[e("div",gt,[e("div",null,[e("strong",null,y(z.name),1),z.description?(r(),d("div",mt,y(z.description),1)):D("",!0)]),v[7]||(v[7]=e("div",{class:"badge bg-warning"},"Erforderlich",-1))])]))),128))])])):D("",!0),_.value.findingTypes&&_.value.findingTypes.length?(r(),d("div",ft,[v[9]||(v[9]=e("strong",null,"Typen:",-1)),e("div",vt,[(r(!0),d(X,null,Z(_.value.findingTypes,z=>(r(),d("span",{key:z,class:"badge bg-secondary"},y(z),1))),128))])])):D("",!0),_.value.findingInterventions&&_.value.findingInterventions.length?(r(),d("div",pt,[v[10]||(v[10]=e("strong",null,"Interventionen:",-1)),e("div",ht,[(r(!0),d(X,null,Z(_.value.findingInterventions,z=>(r(),d("span",{key:z,class:"badge bg-info"},y(z),1))),128))])])):D("",!0)])):(r(),d("div",bt,[v[11]||(v[11]=e("p",null,"Befunde konnten nicht geladen werden...",-1)),e("small",null,"Finding ID: "+y(i.findingId),1),C.value?(r(),d("button",{key:0,class:"btn btn-primary mt-2",onClick:L},"Erneut versuchen")):D("",!0)]))]),s.value.length>0?(r(),d("div",yt,[e("h6",xt,[v[12]||(v[12]=e("i",{class:"fas fa-list-check"},null,-1)),K(" Erforderliche Klassifikationen ("+y(s.value.length)+") ",1)]),e("div",_t,[(r(!0),d(X,null,Z(s.value,z=>(r(),d("div",{key:z.id,class:"col-md-6 mb-2"},[e("div",Et,[e("small",kt,y(z.name)+":",1),v[13]||(v[13]=e("span",{class:"badge bg-warning"},"Erforderlich",-1))])]))),128))])])):D("",!0),l.value.findingId?(r(),d("div",wt,[v[14]||(v[14]=e("h6",{class:"mb-2"},"ðŸ› Debug Info:",-1)),e("small",St,[e("div",null,"Finding ID: "+y(l.value.findingId),1),e("div",null,"Finding Name: "+y(l.value.findingName||"Not loaded"),1),e("div",null,"Classifications: "+y(l.value.totalClassifications)+" ("+y(l.value.requiredClassifications)+" required)",1),e("div",null,"Classifications Loaded: "+y(l.value.classificationsLoaded),1),e("div",null,"Data Source: "+y(l.value.dataSource),1)])])):D("",!0)]))}}),Ft=De(It,[["__scopeId","data-v-abc7c9e3"]]),$t=ce("patientFinding",()=>{const i=$([]),c=$(!1),u=$(null),a=async w=>{var _,s;if(!w){console.warn("fetchPatientFindings wurde ohne patientExaminationId aufgerufen."),i.value=[];return}try{c.value=!0,u.value=null;const l=await U.get("/api/patient-findings/",{params:{patient_examination:w}});i.value=l.data.results||l.data}catch(l){u.value="Fehler beim Laden der Patientenbefunde: "+(((s=(_=l.response)==null?void 0:_.data)==null?void 0:s.detail)||l.message),console.error("Fetch patient findings error:",l)}finally{c.value=!1}},F=T(()=>{const _=Ue().getCurrentPatient();return _?i.value.filter(s=>s.patient.id===_.id):[]}),C=async w=>{var _,s;try{c.value=!0,u.value=null;const m=(await U.post("/api/patient-findings/",w)).data;return i.value.push(m),m}catch(l){throw u.value="Fehler beim Erstellen des Patientenbefunds: "+(((s=(_=l.response)==null?void 0:_.data)==null?void 0:s.detail)||l.message),console.error("Create patient finding error:",l),l}finally{c.value=!1}},S=async(w,_)=>{var s,l;try{c.value=!0,u.value=null;const x=(await U.patch(`/api/patient-findings/${w}/`,_)).data,L=i.value.findIndex(f=>f.id===w);return L!==-1&&(i.value[L]=x),x}catch(m){throw u.value="Fehler beim Aktualisieren des Patientenbefunds: "+(((l=(s=m.response)==null?void 0:s.data)==null?void 0:l.detail)||m.message),console.error("Update patient finding error:",m),m}finally{c.value=!1}},B=async w=>{var _,s;try{c.value=!0,u.value=null,await U.delete(`/api/patient-findings/${w}/`),i.value=i.value.filter(l=>l.id!==w)}catch(l){throw u.value="Fehler beim LÃ¶schen des Patientenbefunds: "+(((s=(_=l.response)==null?void 0:_.data)==null?void 0:s.detail)||l.message),console.error("Delete patient finding error:",l),l}finally{c.value=!1}};return{patientFindings:ee(i),patientFindingsByCurrentPatient:F,loading:ee(c),error:ee(u),fetchPatientFindings:a,createPatientFinding:C,updatePatientFinding:S,deletePatientFinding:B}}),Ct={class:"addable-finding-card card mb-3 border-primary"},qt={class:"card-header d-flex justify-content-between align-items-center bg-light"},Pt={class:"nav nav-tabs card-header-tabs"},Bt={class:"nav-item"},Rt={class:"badge rounded-pill bg-primary ms-1"},Lt={class:"nav-item"},At={class:"badge rounded-pill bg-success ms-1"},Nt={class:"card-body"},zt={class:"d-flex justify-content-end mb-3"},Dt=["disabled"],Tt={key:0,class:"mb-3 finding-selector"},Ut={key:0,class:"text-center py-3 text-muted"},Kt={key:1,class:"row g-3"},jt=["onClick"],Mt={class:"card-body p-3"},Ot={class:"card-title small fw-bold"},Ht={key:0,class:"card-text small text-muted mb-0"},Jt={key:1,class:"selected-finding-config mt-4 p-4 border rounded bg-light"},Gt={class:"d-flex justify-content-between align-items-center mb-3"},Wt={class:"mb-0"},Yt={key:0,class:"mb-3"},Xt={class:"classification-config-list"},Zt={class:"d-flex justify-content-between align-items-center mb-2"},Qt={class:"d-flex align-items-center gap-2"},Vt={key:0,class:"badge bg-warning text-dark",title:"Erforderlich"},en={key:1,class:"badge bg-success",title:"AusgewÃ¤hlt"},tn={key:0,class:"text-muted small mb-2"},nn=["value","onChange"],an={key:0,value:"",disabled:""},sn=["value"],ln={class:"classification-progress"},on={class:"d-flex justify-content-between align-items-center mb-1"},rn={class:"progress",style:{height:"6px"}},dn={class:"text-end mt-3"},un=["disabled","title"],cn={key:0,class:"spinner-border spinner-border-sm me-2"},gn={key:2,class:"text-center py-5 text-muted"},mn={key:0,class:"text-center py-5 text-muted"},fn={key:1,class:"row g-3"},vn={class:"card h-100 border-success"},pn={class:"card-body p-3"},hn={class:"d-flex align-items-start gap-2"},bn={class:"flex-grow-1"},yn={class:"card-title small fw-bold text-success"},xn={key:0,class:"card-text small text-muted mb-2"},_n={class:"badge bg-info text-dark small"},En=pe({__name:"AddableFindingsDetail",props:{patientExaminationId:{default:void 0},examinationId:{default:void 0}},emits:["finding-added","finding-error"],setup(i,{emit:c}){const u=Ke(),a=je(),F=u.getCurrentPatientExaminationId();u.setCurrentPatientExaminationId(F);const C=i;H(()=>u.getCurrentPatientExaminationId(),h=>{h&&!C.patientExaminationId&&(console.warn("[AddableFindingsDetail] Syncing patientExaminationId..."),A())},{immediate:!0});const S=c,B=Se(),w=$t(),_=he(),s=$(!1),l=$("available"),m=$(!1),x=$(null),L=$([]),f=$({}),v=$([]),z=$([]),J=T(()=>v.value);T(async()=>{const h=u.getCurrentPatientExaminationId();return h?await B.fetchFindingsByPatientExamination(h)||[]:[]});async function O(){const h=u.getCurrentPatientExaminationId();if(!h){z.value=[];return}await w.fetchPatientFindings(h),z.value=w.patientFindings.map(o=>JSON.parse(JSON.stringify(o.finding)))}H(()=>u.getCurrentPatientExaminationId(),async h=>{h&&await O()},{immediate:!0});const E=T(()=>{if(x.value)return J.value.find(h=>h.id===x.value)||a.getFindingById(x.value)}),P=T(()=>L.value.length?L.value.filter(h=>h.required).every(h=>f.value[h.id]):!0),R=T(()=>x.value&&P.value&&C.patientExaminationId&&!s.value),W=T(()=>{const h=L.value.filter(q=>q.required).length,o=L.value.filter(q=>q.required&&f.value[q.id]).length;return{required:h,selected:o,complete:o===h,percentage:h>0?Math.round(o/h*100):100}}),oe=async h=>{x.value=h,m.value=!1,await de(h)},re=()=>{x.value=null,L.value=[],f.value={}},de=async h=>{try{s.value=!0,L.value=a.getClassificationsForFinding(h)}catch(o){console.error("Error loading classifications:",o),S("finding-error","Fehler beim Laden der Klassifikationen")}finally{s.value=!1}},ue=(h,o)=>{const q=o.target,N=q.value?parseInt(q.value):void 0;N?f.value[h]=N:delete f.value[h]},g=async()=>{var h,o,q,N;if(!(!R.value||!E.value||!C.patientExaminationId||!x.value))try{s.value=!0;const b={patientExamination:C.patientExaminationId,finding:x.value,classifications:Object.entries(f.value).map(([ge,be])=>({classification:parseInt(ge),choice:be}))},Y=(await w.createPatientFinding(b)).finding.id,G=a.getFindingById(Y);G&&z.value.push(G);const ie=E.value.nameDe||E.value.name;S("finding-added",x.value,ie),re(),m.value=!1}catch(b){console.error("Error adding finding to examination:",b);const M=w.error||((o=(h=b.response)==null?void 0:h.data)==null?void 0:o.error)||((N=(q=b.response)==null?void 0:q.data)==null?void 0:N.detail)||b.message||"Fehler beim HinzufÃ¼gen des Befunds";S("finding-error",M)}finally{s.value=!1}},I=async h=>{try{s.value=!0,a.getAllFindings.length;const q=(await U.get(`/api/examinations/${h}/findings`)).data;a.setClassificationChoicesFromLookup(q),console.log("Loaded findings for examination:",q.length)}catch(o){console.error("Error loading examination data:",o),S("finding-error","Fehler beim Laden der Untersuchungsdaten")}finally{s.value=!1}},k=async()=>{var h;try{s.value=!0;let o=C.examinationId;if(!o&&C.patientExaminationId){const N=u.getPatientExaminationById(C.patientExaminationId);o=(h=N==null?void 0:N.examination)==null?void 0:h.id}if(!o){console.warn("Keine Examination ID verfÃ¼gbar fÃ¼r Findings-Laden");return}const q=await _.loadFindingsForExamination(o);v.value=q,console.log("ðŸ“‹ [AddableFindingsDetail] Loaded findings for examinationId:",o,"findings count:",q.length)}catch(o){console.error("Error loading available findings:",o),S("finding-error","Fehler beim Laden der verfÃ¼gbaren Befunde")}finally{s.value=!1}},A=async()=>{await k(),C.examinationId&&await I(C.examinationId)};return H(()=>C.patientExaminationId,async()=>{C.patientExaminationId&&await A()},{immediate:!0}),H(()=>C.examinationId,async()=>{C.examinationId&&await k()},{immediate:!0}),we(async()=>{await A()}),(h,o)=>{var q,N;return r(),d("div",Ct,[e("div",qt,[o[7]||(o[7]=e("div",{class:"d-flex align-items-center gap-2"},[e("i",{class:"fas fa-plus-circle text-primary"}),e("h6",{class:"card-title mb-0"},"Befunde verwalten")],-1)),e("ul",Pt,[e("li",Bt,[e("a",{class:ne(["nav-link",{active:l.value==="available"}]),onClick:o[0]||(o[0]=ke(b=>l.value="available",["prevent"])),href:"#"},[o[3]||(o[3]=e("i",{class:"fas fa-list me-1"},null,-1)),o[4]||(o[4]=K(" VerfÃ¼gbare Befunde ",-1)),e("span",Rt,y(J.value.length),1)],2)]),e("li",Lt,[e("a",{class:ne(["nav-link",{active:l.value==="added"}]),onClick:o[1]||(o[1]=ke(b=>l.value="added",["prevent"])),href:"#"},[o[5]||(o[5]=e("i",{class:"fas fa-check-circle me-1"},null,-1)),o[6]||(o[6]=K(" HinzugefÃ¼gte Befunde ",-1)),e("span",At,y(z.value.length),1)],2)])])]),e("div",Nt,[ve(e("div",null,[e("div",zt,[e("button",{class:"btn btn-sm btn-primary",onClick:o[2]||(o[2]=b=>m.value=!m.value),disabled:s.value},[e("i",{class:ne(["fas",m.value?"fa-minus":"fa-plus"])},null,2),K(" "+y(m.value?"Auswahl ausblenden":"Befund auswÃ¤hlen"),1)],8,Dt)]),m.value?(r(),d("div",Tt,[o[9]||(o[9]=e("label",{class:"form-label fw-bold"},"VerfÃ¼gbare Befunde:",-1)),J.value.length===0?(r(),d("div",Ut,[...o[8]||(o[8]=[e("i",{class:"fas fa-info-circle fa-2x mb-2"},null,-1),e("p",null,"Keine Befunde fÃ¼r diese Untersuchung verfÃ¼gbar.",-1)])])):(r(),d("div",Kt,[(r(!0),d(X,null,Z(J.value,b=>(r(),d("div",{key:b.id,class:"col-12 col-sm-6 col-md-4"},[e("div",{class:ne(["finding-option card h-100 cursor-pointer",{"border-primary shadow-sm":x.value===b.id}]),onClick:M=>oe(b.id)},[e("div",Mt,[e("h6",Ot,y(b.nameDe||b.name),1),b.description?(r(),d("p",Ht,y(b.description.length>80?b.description.substring(0,80)+"...":b.description),1)):D("",!0)])],10,jt)]))),128))]))])):D("",!0),x.value?(r(),d("div",Jt,[e("div",Gt,[e("h6",Wt,[o[10]||(o[10]=e("i",{class:"fas fa-cog text-primary me-2"},null,-1)),o[11]||(o[11]=K(" Befund konfigurieren: ",-1)),e("strong",null,y(((q=E.value)==null?void 0:q.nameDe)||((N=E.value)==null?void 0:N.name)),1)]),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:re,title:"Auswahl zurÃ¼cksetzen"},[...o[12]||(o[12]=[e("i",{class:"fas fa-times"},null,-1)])])]),L.value.length>0?(r(),d("div",Yt,[o[17]||(o[17]=e("h6",null,"Klassifikationen:",-1)),e("div",Xt,[(r(!0),d(X,null,Z(L.value,b=>(r(),d("div",{key:b.id,class:"classification-config-item mb-3 p-3 border rounded"},[e("div",Zt,[e("strong",null,y(b.name),1),e("div",Qt,[b.required?(r(),d("span",Vt,[...o[13]||(o[13]=[e("i",{class:"fas fa-exclamation-triangle"},null,-1),K(" Erforderlich ",-1)])])):D("",!0),f.value[b.id]?(r(),d("span",en,[...o[14]||(o[14]=[e("i",{class:"fas fa-check"},null,-1),K(" AusgewÃ¤hlt ",-1)])])):D("",!0)])]),b.description?(r(),d("p",tn,y(b.description),1)):D("",!0),e("select",{class:ne(["form-select form-select-sm",{"border-success":f.value[b.id],"border-warning":!f.value[b.id]&&b.required}]),value:f.value[b.id]||"",onChange:M=>ue(b.id,M)},[o[15]||(o[15]=e("option",{value:""},"Bitte wÃ¤hlen...",-1)),!b.choices||b.choices.length===0?(r(),d("option",an,"Keine Auswahl")):(r(!0),d(X,{key:1},Z(b.choices,M=>(r(),d("option",{key:M.id,value:M.id},y(M.name),9,sn))),128))],42,nn)]))),128))]),e("div",ln,[e("div",on,[o[16]||(o[16]=e("small",{class:"text-muted"},"Erforderliche Klassifikationen:",-1)),e("small",{class:ne(["fw-semibold",W.value.complete?"text-success":"text-warning"])},y(W.value.selected)+"/"+y(W.value.required),3)]),e("div",rn,[e("div",{class:ne(["progress-bar",W.value.complete?"bg-success":"bg-warning"]),style:Te({width:W.value.percentage+"%"})},null,6)])])])):D("",!0),e("div",dn,[e("button",{class:"btn btn-success",onClick:g,disabled:s.value||!R.value,title:R.value?"Befund zur Untersuchung hinzufÃ¼gen":"Bitte alle erforderlichen Klassifikationen auswÃ¤hlen"},[s.value?(r(),d("span",cn)):D("",!0),o[18]||(o[18]=e("i",{class:"fas fa-plus me-2"},null,-1)),o[19]||(o[19]=K(" Befund hinzufÃ¼gen ",-1))],8,un)])])):m.value?D("",!0):(r(),d("div",gn,[...o[20]||(o[20]=[e("i",{class:"fas fa-plus-circle fa-3x mb-3 opacity-50"},null,-1),e("p",null,'Klicken Sie auf "Befund auswÃ¤hlen", um einen neuen Befund hinzuzufÃ¼gen.',-1)])]))],512),[[Re,l.value==="available"]]),ve(e("div",null,[z.value.length===0?(r(),d("div",mn,[...o[21]||(o[21]=[e("i",{class:"fas fa-folder-open fa-3x mb-3"},null,-1),e("p",null,"Noch keine Befunde zu dieser Untersuchung hinzugefÃ¼gt.",-1)])])):(r(),d("div",fn,[(r(!0),d(X,null,Z(z.value,b=>(r(),d("div",{key:b.id,class:"col-12 col-sm-6 col-md-4 col-lg-3"},[e("div",vn,[e("div",pn,[e("div",hn,[o[22]||(o[22]=e("i",{class:"fas fa-check-circle text-success mt-1"},null,-1)),e("div",bn,[e("h6",yn,y(b.nameDe||b.name),1),b.description?(r(),d("p",xn,y(b.description.length>80?b.description.substring(0,80)+"...":b.description),1)):D("",!0),e("span",_n,"ID: "+y(b.id),1)])])])])]))),128))]))],512),[[Re,l.value==="added"]])])])}}}),kn={key:0,class:"container-fluid"},wn={key:0,class:"alert alert-info"},Sn={key:1,class:"alert alert-warning"},In={class:"mb-1"},Fn={class:"mb-0 ps-3"},$n={class:"fw-semibold"},Cn={class:"text-muted"},qn={key:0,class:"text-danger"},Pn={key:2,class:"alert alert-success"},Bn=pe({__name:"RequirementIssues",props:{patientExaminationId:{},requirementSetIds:{},showOnlyUnmet:{type:Boolean}},setup(i,{expose:c}){const u=Ge("evaluate-requirements/"),a=i,F=$(!1),C=$(null),S=$([]);async function B(){var m,x,L;if(!a.patientExaminationId){S.value=[];return}F.value=!0,C.value=null;try{const f={patient_examination_id:a.patientExaminationId};a.requirementSetIds&&a.requirementSetIds.length>0&&(f.requirement_set_ids=a.requirementSetIds);const{data:v}=await U.post(u,f);S.value=v.results??[],!v.ok&&((m=v.errors)!=null&&m.length)&&(C.value=v.errors.join(" | "))}catch(f){C.value=((L=(x=f==null?void 0:f.response)==null?void 0:x.data)==null?void 0:L.detail)||(f==null?void 0:f.message)||"Unbekannter Fehler bei der AnforderungsprÃ¼fung"}finally{F.value=!1}}const w=T(()=>!!a.patientExaminationId),_=T(()=>a.showOnlyUnmet??!0?S.value.filter(m=>!m.met||m.error):S.value),s=T(()=>_.value.length>0),l=T(()=>{const m={};for(const x of _.value){const L=x.requirement_set_name||"Allgemein";m[L]||(m[L]=[]),m[L].push(x)}return m});return H(()=>[a.patientExaminationId,a.requirementSetIds],()=>{w.value?B():S.value=[]},{deep:!0,immediate:!0}),c({reload:B}),(m,x)=>w.value?(r(),d("div",kn,[F.value?(r(),d("div",wn,[...x[0]||(x[0]=[e("span",{class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},null,-1),K(" Anforderungen werden geprÃ¼ft... ",-1)])])):s.value?(r(),d("div",Sn,[x[2]||(x[2]=e("strong",null,"Um den Report abzuschlieÃŸen, mÃ¼ssen die folgenden Voraussetzungen erfÃ¼llt sein:",-1)),(r(!0),d(X,null,Z(l.value,(L,f)=>(r(),d("div",{key:f,class:"mt-3"},[e("h6",In,[x[1]||(x[1]=e("i",{class:"fas fa-folder-open me-1"},null,-1)),K(" "+y(f),1)]),e("ul",Fn,[(r(!0),d(X,null,Z(L,v=>(r(),d("li",{key:v.requirement_name},[e("span",$n,y(v.requirement_name),1),e("span",Cn," â€“ "+y(v.details),1),v.error?(r(),d("span",qn," (Fehler: "+y(v.error)+") ",1)):D("",!0)]))),128))])]))),128))])):(r(),d("div",Pn,[...x[3]||(x[3]=[e("strong",null,"Alle ausgewÃ¤hlten Anforderungen sind erfÃ¼llt.",-1)])]))])):D("",!0)}}),Rn={class:"requirement-generator container-fluid py-4"},Ln={class:"card mb-3"},An={class:"card-body"},Nn={class:"row align-items-end"},zn={class:"col-md-6"},Dn={class:"form-group"},Tn=["disabled"],Un={value:null,disabled:""},Kn=["value"],jn={key:0,class:"mt-2"},Mn={class:"col-md-6"},On={class:"form-group"},Hn=["disabled"],Jn={value:null,disabled:""},Gn=["value"],Wn={class:"row mt-3"},Yn={class:"col-12"},Xn=["disabled"],Zn={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},Qn={key:1},Vn={key:2},ei={key:0,class:"row g-3"},ti={class:"col-12"},ni={class:"card"},ii={class:"card-body"},ai={class:"row"},si={class:"col-md-4"},li={class:"col-md-4"},oi={class:"col-md-4"},ri={class:"row mt-2"},di={class:"col-md-6"},ui={class:"col-md-6"},ci={class:"col-12 col-xl-6"},gi={class:"card h-100"},mi={class:"card-header d-flex justify-content-between align-items-center"},fi={class:"text-muted"},vi={class:"d-flex gap-2"},pi=["disabled"],hi=["disabled"],bi=["disabled"],yi=["disabled"],xi={key:0,class:"row g-3 mt-3 card-body pre-scrollable",style:{"max-height":"70vh",overflow:"auto"}},_i={class:"col-12"},Ei={class:"card"},ki={class:"card-body"},wi={class:"list-group list-group-flush"},Si={class:"flex-grow-1"},Ii={class:"d-flex justify-content-between align-items-center"},Fi={class:"fw-semibold"},$i={class:"d-flex align-items-center gap-2"},Ci=["onClick","disabled"],qi={class:"text-muted d-block"},Pi={key:0,class:"mt-2"},Bi={class:"text-muted"},Ri={class:"form-check form-switch ms-3"},Li=["checked","onChange"],Ai={key:0,class:"list-group-item text-muted"},Ni={key:1,class:"mt-3 p-3 bg-light rounded"},zi={class:"progress mb-2",style:{height:"10px"}},Di={class:"text-muted"},Ti={class:"mt-2"},Ui=["disabled"],Ki={class:"card-body"},ji={key:0,class:"mb-3"},Mi={class:"col-12 col-xl-6"},Oi={class:"card h-100"},Hi={class:"card-header d-flex justify-content-between align-items-center"},Ji={key:0,class:"d-flex align-items-center gap-2"},Gi={class:"text-muted"},Wi=["disabled"],Yi={class:"card-body pre-scrollable",style:{"max-height":"70vh",overflow:"auto"}},Xi={key:0,class:"text-center py-4"},Zi={key:1,class:"findings-container"},Qi={key:2,class:"text-center py-4"},Vi={key:1,class:"alert alert-success alert-dismissible"},ea={class:"modal-content"},ta={class:"modal-body"},na={key:3,class:"d-flex align-items-center gap-2"},se="/api/lookup",te="lookupToken",le="currentPatientExaminationId",ia=pe({__name:"RequirementGenerator",setup(i){const c=Ue(),u=he(),a=Se(),F=Xe(),C=Ke(),S=$(!1),B=$(null),w=$(null),_=$(null),s=$(null),l=$(null),m=$(null),x=$(!1),L=$(!1),f=$(null),v=$(!1);m!==null?S.value=!0:S.value=!1;const z=T(()=>{const n=c.patientsWithDisplayName;return console.log("Patients with displayName:",n),n}),J=T(()=>c.loading),O=T(()=>{const n=u.examinationsDropdown;return console.log("Examinations dropdown:",n),n}),E=T(()=>u.loading),P=T(()=>{var t;const n=((t=l.value)==null?void 0:t.requirementSets)??[];return console.log("Computing requirementSets:",n),n}),R=T({get:()=>{var n;return((n=l.value)==null?void 0:n.selectedRequirementSetIds)??[]},set:n=>{l.value&&(l.value.selectedRequirementSetIds=n)}}),W=T(()=>new Set(R.value)),oe=T(()=>{var n;return((n=l.value)==null?void 0:n.availableFindings)??[]}),re=$(!1);H(l,(n,t)=>{re.value||(re.value=!0,console.log("Lookup changed:",{newVal:n,oldVal:t}),n&&n.patientExaminationId!==_.value&&(_.value=n.patientExaminationId,console.log("Updated currentPatientExaminationId to:",_.value)),re.value=!1)},{deep:!0});const de=$(!1);H(R,(n,t)=>{de.value||(de.value=!0,console.log("Selected Requirement Set IDs changed:",{newVal:n,oldVal:t}),n!==t&&F.setCurrentRequirementSetIds(n),de.value=!1)});const ue=$(!1);H(_,(n,t)=>{ue.value||(ue.value=!0,console.log("Current Examination ID changed:",{newVal:n,oldVal:t}),n!==t&&C.setCurrentPatientExaminationId(n),ue.value=!1)}),T(()=>JSON.stringify({token:s.value,selectedRequirementSetIds:R.value},null,2));const g=n=>l.value?!!a.getFindingIdsByPatientExaminationId(l.value.patientExaminationId).includes(n):!1,I=(n,t)=>{var qe,Pe;let p,j,Q=[],V=null;typeof n=="number"?(p=n,j=t||((qe=a.getFindingById(p))==null?void 0:qe.name)||`Befund ${p}`):(p=n.findingId,j=n.findingName||((Pe=a.getFindingById(p))==null?void 0:Pe.name)||`Befund ${p}`,Q=n.selectedClassifications||[],V=n.response),console.log("Finding added to examination:",{findingId:p,name:j,selectedClassifications:Q.length,hasResponse:!!V});const fe=Q.length,Ee=fe>0?`Befund "${j}" wurde erfolgreich hinzugefÃ¼gt mit ${fe} Klassifikation${fe!==1?"en":""}!`:`Befund "${j}" wurde erfolgreich hinzugefÃ¼gt!`;f.value=Ee,setTimeout(()=>{f.value=null},5e3),setTimeout(()=>{h()},500)},k=(n,t,p)=>{console.log("Classification updated:",{findingId:n,classificationId:t,choiceId:p});const j=a.getFindingById(n),Q=(j==null?void 0:j.name)||`Befund ${n}`,V=p?`Klassifikation fÃ¼r "${Q}" wurde erfolgreich ausgewÃ¤hlt!`:`Klassifikation fÃ¼r "${Q}" wurde zurÃ¼ckgesetzt!`;f.value=V,setTimeout(()=>{f.value=null},3e3),setTimeout(()=>{h()},300)},A=async()=>{a.findings.length===0&&await a.fetchFindings()},h=async()=>{if(!l.value||!s.value){console.log("Skipping evaluation: lookup or token not available");return}if(!l.value.patientExaminationId){console.log("Skipping evaluation: patientExaminationId not available in lookup",l.value);return}try{console.log("Evaluating requirements based on current lookup data..."),await F.evaluateFromLookupData(l.value),console.log("Requirements evaluated successfully"),f.value="Anforderungen wurden erfolgreich evaluiert!",setTimeout(()=>{f.value=null},3e3)}catch(n){console.error("Error evaluating requirements:",n),m.value="Fehler bei der Evaluierung der Anforderungen: "+(n instanceof Error?n.message:String(n))}},o=async n=>{if(!(!l.value||!s.value))try{console.log("Evaluating requirement set:",n),await F.evaluateRequirementSet(n,l.value.patientExaminationId),console.log("Requirement set evaluated successfully")}catch(t){console.error("Error evaluating requirement set:",t),m.value="Fehler bei der Evaluierung des Anforderungssets: "+(t instanceof Error?t.message:String(t))}},q=n=>F.getRequirementSetEvaluationStatus(n),N=T(()=>{if(!l.value)return null;const n=P.value.length,t=P.value.filter(p=>F.getRequirementSetEvaluationStatus(p.id)).length;return{totalSets:n,evaluatedSets:t,completionPercentage:n>0?Math.round(t/n*100):0}});function b(n){var t,p;return(p=(t=n==null?void 0:n.response)==null?void 0:t.data)!=null&&p.detail?n.response.data.detail:n!=null&&n.message?n.message:"Unbekannter Fehler"}function M(n){l.value?l.value={...l.value,...n}:l.value=n}async function Y(){if(v.value){console.log("Restart already in progress, skipping createPatientExaminationAndInitLookup...");return}if(!B.value||!w.value){console.error("Missing required selections:",{selectedPatientId:B.value,selectedExaminationId:w.value}),m.value="Bitte wÃ¤hlen Sie sowohl einen Patienten als auch eine Untersuchung aus.";return}const n=O.value.find(t=>t.id===w.value);if(!n){console.error("Selected examination not found in dropdown:",{selectedExaminationId:w.value,availableExams:O.value.map(t=>({id:t.id,name:t.name}))}),m.value="AusgewÃ¤hlte Untersuchung nicht gefunden.";return}console.log("Creating PatientExamination with:",{patientId:B.value,examinationName:n.name,examinationId:n.id}),m.value=null,x.value=!0;try{const t=new Date().toISOString().split("T")[0],p=c.getPatientById(B.value);if(!p)throw new Error("Selected patient not found");const j=O.value.find(Ee=>Ee.id===w.value);if(!j)throw new Error("Selected examination not found");const Q=p.dob?new Date(p.dob).toISOString().split("T")[0]:null,V=await U.post("/api/patient-examinations/",{patient:p.patientHash||`patient_${p.id}`,examination:j.name,date_start:t,patient_birth_date:Q,patient_gender:p.gender||null});C.addPatientExamination(V.data),console.log("PatientExamination created:",V.data),_.value=V.data.id;const fe=await U.post(`${se}/init/`,{patientExaminationId:_.value});s.value=fe.data.token,console.log("Lookup initialized with token:",s.value),_e(),await A(),await G()}catch(t){m.value=b(t)}finally{x.value=!1}}async function G(){var n;if(s.value){m.value=null,x.value=!0;try{const t=await U.get(`${se}/${s.value}/all/?skip_recompute=true`);console.log("Lookup API response:",t.data),M(t.data)}catch(t){((n=t==null?void 0:t.response)==null?void 0:n.status)===404?(m.value="Lookup-Sitzung ist abgelaufen. Starte neu...",s.value=null,l.value=null,ae(),localStorage.removeItem(te),localStorage.removeItem(le),await xe()||(m.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie manuell neu.")):m.value=b(t)}finally{x.value=!1}}}async function ie(n){var p;if(!s.value||!n.length)return;m.value=null,x.value=!0;const t=encodeURIComponent(n.join(","));try{const j=await U.get(`${se}/${s.value}/parts/?keys=${t}`);M(j.data)}catch(j){((p=j==null?void 0:j.response)==null?void 0:p.status)===404?(m.value="Lookup-Sitzung ist abgelaufen. Starte neu...",s.value=null,l.value=null,ae(),localStorage.removeItem(te),localStorage.removeItem(le),await xe()||(m.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie manuell neu.")):m.value=b(j)}finally{x.value=!1}}async function ge(n){var t;if(s.value)try{await U.patch(`${se}/${s.value}/parts/`,{updates:n}),await ie(["availableFindings","requiredFindings"])}catch(p){((t=p==null?void 0:p.response)==null?void 0:t.status)===404?(m.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie erneut.",s.value=null,l.value=null,ae(),localStorage.removeItem(te),localStorage.removeItem(le)):m.value=b(p)}}function be(n,t){const p=new Set(R.value);t?p.add(n):p.delete(n),R.value=Array.from(p),ge({selectedRequirementSetIds:R.value}),F.setCurrentRequirementSetIds(R.value),s.value&&Ie()}async function Ie(){if(c.currentPatient&&c.currentPatient.id!==B.value&&console.warn("Selected patient ID does not match patient store name. Reloading..."),!!s.value)try{console.log("Triggering recomputation for selected requirement sets:",R.value);const n=await U.post(`${se}/${s.value}/recompute/`);console.log("Recompute response:",n.data),n.data.updates&&M(n.data.updates),await G(),R.value.length>0&&await h()}catch(n){console.error("Error during recomputation:",n),m.value="Fehler bei der Neuberechnung: "+b(n)}}function ye(){L.value=!1,c.clearError()}function Me(n){B.value=n.id||null,L.value=!1,c.clearError(),f.value=`Patient "${n.firstName} ${n.lastName}" wurde erfolgreich erstellt und ausgewÃ¤hlt!`,setTimeout(()=>{f.value=null},5e3)}async function Fe(){var n;if(!s.value)return!1;try{return await U.get(`${se}/${s.value}/parts/?keys=patientExaminationId`),!0}catch(t){return((n=t==null?void 0:t.response)==null?void 0:n.status)===404&&(console.log("Token validation failed with 404, attempting restart..."),s.value=null,l.value=null,m.value="Lookup-Sitzung ist abgelaufen. Starte neu...",await xe()||(m.value="Lookup-Sitzung ist abgelaufen. Bitte starten Sie manuell neu.")),!1}}function Oe(){s.value&&(x.value=!0,m.value=null,U.get(`${se}/${s.value}/parts/?keys=patientExaminationId`).then(()=>U.patch(`${se}/${s.value}/parts/`,{updates:{}})).then(()=>{G()}).catch(n=>{var t;m.value=b(n),((t=n==null?void 0:n.response)==null?void 0:t.status)===404&&(s.value=null,l.value=null,m.value="Lookup-Session ist abgelaufen. Bitte starten Sie erneut.",ae())}).finally(()=>{x.value=!1}))}function He(){s.value=null,l.value=null,_.value=null,m.value=null,f.value=null,ae(),localStorage.removeItem(te),localStorage.removeItem(le)}async function Je(){console.log("Resetting session for new patient..."),s.value=null,l.value=null,_.value=null,m.value=null,f.value=null,ae(),localStorage.removeItem(te),localStorage.removeItem(le),F.reset(),console.log("Session reset complete for new patient")}async function xe(){if(v.value)return console.log("Restart already in progress, skipping..."),!1;console.log("Attempting to restart lookup session..."),v.value=!0;try{if(s.value=null,l.value=null,ae(),localStorage.removeItem(te),await new Promise(n=>setTimeout(n,500)),_.value&&B.value&&w.value){console.log("Reusing existing patient examination:",_.value),console.log("selectedPatientId:",B.value),console.log("selectedExaminationId:",w.value);const n=await U.post(`${se}/init/`,{patientExaminationId:_.value});return s.value=n.data.token,_e(),await G(),f.value="Lookup-Session wurde erfolgreich neu gestartet!",setTimeout(()=>{f.value=null},3e3),!0}else return console.log("No existing patient examination, creating new one"),console.log("currentPatientExaminationId:",_.value),console.log("selectedPatientId:",B.value),console.log("selectedExaminationId:",w.value),!B.value||!w.value?(m.value="Kann Session nicht automatisch neu starten: Patient oder Untersuchung fehlt.",!1):(await Y(),!0)}catch(n){return console.error("Failed to restart lookup session:",n),m.value="Fehler beim Neustart der Lookup-Session: "+b(n),!1}finally{v.value=!1}}let me=null;function _e(){me||(me=window.setInterval(async()=>{s.value&&!v.value&&await Fe()},900*1e3))}function ae(){me&&(clearInterval(me),me=null)}$(!1);const $e=localStorage.getItem(te),Ce=localStorage.getItem(le);return $e&&(s.value=$e),Ce&&(_.value=parseInt(Ce)),H(s,n=>{n?localStorage.setItem(te,n):localStorage.removeItem(te)}),H(_,n=>{n?localStorage.setItem(le,n.toString()):localStorage.removeItem(le)}),H(w,n=>{console.log("Examination selection changed:",{newId:n,selectedPatientId:B.value,availableExams:O.value.map(t=>({id:t.id,name:t.name}))}),u.setSelectedExamination(n),n&&u.loadFindingsForExamination(n)}),H(B,async(n,t)=>{console.log("Patient selection changed:",{oldPatientId:t,newPatientId:n,currentExaminationsCount:O.value.length}),w.value=null,t&&n!==t&&(console.log("Patient changed, resetting session for new overview..."),await Je())}),H(R,async(n,t)=>{n.length!==t.length&&l.value&&(console.log("Requirement set selection changed, triggering evaluation..."),await h())},{deep:!0}),H(l,async(n,t)=>{n&&n!==t&&R.value.length>0&&(console.log("Lookup data changed, triggering evaluation..."),setTimeout(()=>{h()},1e3))},{deep:!0}),H(l,n=>{n&&n.requirementsBySet&&(console.log("Loading requirement sets from lookup data..."),F.loadRequirementSetsFromLookup(n))},{immediate:!0}),we(async()=>{console.log("Component mounted, starting data loading..."),await Promise.all([c.fetchPatients(),u.fetchExaminations()]),console.log("Data loading completed:",{patientsCount:z.value.length,examinationsCount:O.value.length}),await c.initializeLookupData(),s.value&&(console.log("Validating existing token:",s.value),await Fe()?(await G(),_e()):(s.value=null,l.value=null,_.value=null,ae(),localStorage.removeItem(te),localStorage.removeItem(le))),await A()}),We(()=>{ae()}),(n,t)=>(r(),d("div",Rn,[e("div",Ln,[t[10]||(t[10]=e("div",{class:"card-header"},[e("h2",{class:"h5 mb-0"},"1. Patient und Untersuchung auswÃ¤hlen")],-1)),e("div",An,[e("div",Nn,[e("div",zn,[e("div",Dn,[t[8]||(t[8]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{for:"patient-select"},"Patient auswÃ¤hlen")],-1)),ve(e("select",{id:"patient-select","onUpdate:modelValue":t[0]||(t[0]=p=>B.value=p),class:"form-control",disabled:J.value||x.value},[e("option",Un,y(J.value?"Lade Patienten...":"Bitte wÃ¤hlen Sie einen Patienten"),1),(r(!0),d(X,null,Z(z.value,p=>(r(),d("option",{key:p.id,value:p.id},y(p.displayName),9,Kn))),128))],8,Tn),[[Le,B.value]]),B.value?(r(),d("div",jn,[...t[7]||(t[7]=[e("small",{class:"text-muted"},[e("i",{class:"fas fa-info-circle"}),K(" Bei Patientenwechsel wird automatisch eine neue Ãœbersicht generiert. ")],-1)])])):D("",!0)])]),e("div",Mn,[e("div",On,[t[9]||(t[9]=e("label",{for:"examination-select"},"Untersuchung auswÃ¤hlen",-1)),ve(e("select",{id:"examination-select","onUpdate:modelValue":t[1]||(t[1]=p=>w.value=p),class:"form-control",disabled:E.value||!B.value||x.value},[e("option",Jn,y(E.value?"Lade Untersuchungen...":"Bitte wÃ¤hlen Sie eine Untersuchung"),1),(r(!0),d(X,null,Z(O.value,p=>(r(),d("option",{key:p.id,value:p.id},y(p.displayName),9,Gn))),128))],8,Hn),[[Le,w.value]])])])]),e("div",Wn,[e("div",Yn,[e("button",{class:"btn btn-primary",disabled:!B.value||!w.value||x.value||!!s.value,onClick:Y},[x.value?(r(),d("span",Zn)):D("",!0),s.value?(r(),d("span",Vn,"Anforderungsbericht bereits aktiv")):(r(),d("span",Qn,"2. Anforderungsbericht erstellen"))],8,Xn)])])])]),l.value&&S.value?(r(),d("div",ei,[e("div",ti,[e("div",ni,[t[16]||(t[16]=e("div",{class:"card-header"},[e("h2",{class:"h6 mb-0"},"Debug: Aktuelle Lookup-Daten")],-1)),e("div",ii,[e("div",ai,[e("div",si,[t[11]||(t[11]=e("strong",null,"Patient Examination ID:",-1)),K(" "+y(l.value.patientExaminationId||"Nicht verfÃ¼gbar"),1)]),e("div",li,[t[12]||(t[12]=e("strong",null,"Token:",-1)),K(" "+y(s.value),1)]),e("div",oi,[t[13]||(t[13]=e("strong",null,"Requirement Sets:",-1)),K(" "+y(P.value.length),1)])]),e("div",ri,[e("div",di,[t[14]||(t[14]=e("strong",null,"AusgewÃ¤hlte Sets:",-1)),K(" "+y(R.value.join(", ")||"Keine"),1)]),e("div",ui,[t[15]||(t[15]=e("strong",null,"VerfÃ¼gbare Findings:",-1)),K(" "+y(oe.value.length),1)])])])])]),e("div",ci,[e("div",gi,[e("div",mi,[e("div",null,[t[17]||(t[17]=e("h2",{class:"h5 mb-0"},"3. Requirement Sets anpassen",-1)),e("small",fi,"Token: "+y(s.value),1)]),e("div",vi,[e("button",{class:"btn btn-sm btn-outline-secondary",onClick:G,disabled:x.value}," Aktualisieren ",8,pi),e("button",{class:"btn btn-sm btn-outline-info",onClick:Ie,disabled:x.value||!s.value}," Neu berechnen ",8,hi),e("button",{class:"btn btn-sm btn-outline-info",onClick:Oe,disabled:x.value||!s.value}," Session erneuern ",8,bi),e("button",{class:"btn btn-sm btn-outline-danger",onClick:He,disabled:x.value||!s.value}," Session zurÃ¼cksetzen ",8,yi)])]),l.value?(r(),d("div",xi,[e("div",_i,[e("div",Ei,[t[18]||(t[18]=e("div",{class:"card-header"},[e("h2",{class:"h5 mb-0"},"Befunde in der aktuellen Untersuchung")],-1)),e("div",ki,[Ne(En,{"examination-id":w.value||void 0,"patient-examination-id":_.value||void 0,onFindingAdded:I,onFindingError:t[2]||(t[2]=p=>m.value=p)},null,8,["examination-id","patient-examination-id"])])])])])):D("",!0),e("ul",wi,[(r(!0),d(X,null,Z(P.value,p=>{var j,Q;return r(),d("li",{key:p.id,class:"list-group-item d-flex justify-content-between align-items-center"},[e("div",Si,[e("div",Ii,[e("span",Fi,y(p.name),1),e("div",$i,[q(p.id)?(r(),d("span",{key:0,class:ne(["badge",q(p.id).met?"bg-success":"bg-warning"])},[e("i",{class:ne(["fas",q(p.id).met?"fa-check":"fa-exclamation-triangle"])},null,2),K(" "+y(q(p.id).met?"ErfÃ¼llt":"Nicht erfÃ¼llt"),1)],2)):D("",!0),e("button",{class:"btn btn-sm btn-outline-info",onClick:V=>o(p.id),disabled:x.value,title:"Anforderungsset evaluieren"},[...t[19]||(t[19]=[e("i",{class:"fas fa-calculator"},null,-1)])],8,Ci)])]),e("small",qi,"type: "+y(p.type),1),q(p.id)?(r(),d("div",Pi,[e("small",Bi," ErfÃ¼llte Anforderungen: "+y((j=q(p.id))==null?void 0:j.metRequirementsCount)+" / "+y((Q=q(p.id))==null?void 0:Q.totalRequirementsCount),1)])):D("",!0)]),e("div",Ri,[e("input",{class:"form-check-input",type:"checkbox",checked:W.value.has(p.id),onChange:V=>be(p.id,V.target.checked)},null,40,Li)])])}),128)),P.value.length?D("",!0):(r(),d("li",Ai,"Keine Sets gefunden."))]),N.value&&N.value.totalSets>0?(r(),d("div",Ni,[t[21]||(t[21]=e("h6",{class:"mb-2"},"EvaluierungsÃ¼bersicht",-1)),e("div",zi,[e("div",{class:ne(["progress-bar",N.value.completionPercentage===100?"bg-success":"bg-info"]),style:Te({width:N.value.completionPercentage+"%"})},null,6)]),e("small",Di,y(N.value.evaluatedSets)+" von "+y(N.value.totalSets)+" Sets evaluiert ("+y(N.value.completionPercentage)+"%) ",1),e("div",Ti,[e("button",{class:"btn btn-sm btn-primary",onClick:h,disabled:x.value},[...t[20]||(t[20]=[e("i",{class:"fas fa-sync"},null,-1),K(" Alle evaluieren ",-1)])],8,Ui)])])):D("",!0),l.value?(r(),Ae(Bn,{key:2,"patient-examination-id":l.value.patientExaminationId||null,"requirement-set-ids":R.value,"show-only-unmet":!0},null,8,["patient-examination-id","requirement-set-ids"])):D("",!0),e("div",Ki,[l.value?(r(),d("div",ji,[t[22]||(t[22]=e("strong",null,"Debug Info:",-1)),t[23]||(t[23]=e("br",null,null,-1)),K(" Lookup exists: "+y(!!l.value),1),t[24]||(t[24]=e("br",null,null,-1)),K(" Requirement sets count: "+y(P.value.length),1),t[25]||(t[25]=e("br",null,null,-1)),t[26]||(t[26]=K(" Raw lookup data: ",-1)),e("pre",null,y(JSON.stringify(l.value,null,2)),1)])):D("",!0)])])]),e("div",Mi,[e("div",Oi,[e("div",Hi,[t[28]||(t[28]=e("h2",{class:"h5 mb-0"},"Um die Untersuchung abzuschlieÃŸen, mÃ¼ssen die folgenden Befunde vorhanden sein.",-1)),t[29]||(t[29]=e("p",{class:"text-muted mb-0"},"Hinweis: Ã„ndern Sie die Klassifikationen auf ihr bevorzugtes Format.",-1)),oe.value.length>0?(r(),d("div",Ji,[e("small",Gi,y(oe.value.length)+" verfÃ¼gbar",1),e("button",{class:"btn btn-sm btn-outline-info",onClick:t[3]||(t[3]=p=>A()),disabled:x.value,title:"Befunde aktualisieren"},[...t[27]||(t[27]=[e("i",{class:"fas fa-sync-alt"},null,-1)])],8,Wi)])):D("",!0)]),e("div",Yi,[ze(a).loading?(r(),d("div",Xi,[...t[30]||(t[30]=[e("div",{class:"spinner-border",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1),e("p",{class:"mt-2 text-muted"},"Lade Befunde...",-1)])])):oe.value.length?(r(),d("div",Zi,[(r(!0),d(X,null,Z(oe.value,p=>{var j;return r(),Ae(Ft,{key:p,"finding-id":p,"is-added-to-examination":g(p),"patient-examination-id":((j=l.value)==null?void 0:j.patientExaminationId)||void 0,onAddedToExamination:I,onClassificationUpdated:k},null,8,["finding-id","is-added-to-examination","patient-examination-id"])}),128))])):(r(),d("div",Qi,[...t[31]||(t[31]=[e("i",{class:"fas fa-info-circle fa-2x text-muted mb-3"},null,-1),e("p",{class:"text-muted"},"Keine Befunde verfÃ¼gbar fÃ¼r die Auswahl.",-1),e("small",{class:"text-muted"},"WÃ¤hlen Sie eine Untersuchung aus, um verfÃ¼gbare Befunde zu laden.",-1)])]))])]),t[32]||(t[32]=K("alert ",-1))])])):D("",!0),f.value?(r(),d("div",Vi,[t[33]||(t[33]=e("strong",null,"Erfolg:",-1)),K(" "+y(f.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:t[4]||(t[4]=p=>f.value=null)})])):D("",!0),L.value?(r(),d("div",{key:2,class:"modal-overlay",onClick:ye},[e("div",{class:"modal-dialog",onClick:t[5]||(t[5]=ke(()=>{},["stop"]))},[e("div",ea,[e("div",{class:"modal-header"},[t[34]||(t[34]=e("h5",{class:"modal-title"},"Neuen Patienten erstellen",-1)),e("button",{type:"button",class:"btn-close",onClick:ye})]),e("div",ta,[Ne(Ye,{onPatientCreated:Me,onCancel:ye})])])])])):D("",!0),B.value?(r(),d("div",na,[t[36]||(t[36]=e("span",{class:"badge bg-info"},[e("i",{class:"fas fa-user"}),K(" Aktiv ")],-1)),t[37]||(t[37]=e("strong",null,"ZurÃ¼cksetzen:",-1)),e("button",{type:"button",class:"btn btn-sm btn-outline-secondary",onClick:t[6]||(t[6]=p=>ze(c).clearCurrentPatient()),title:"Patientenauswahl zurÃ¼cksetzen"},[...t[35]||(t[35]=[e("i",{class:"fas fa-times"},null,-1)])])])):D("",!0)]))}}),oa=De(ia,[["__scopeId","data-v-6364a105"]]);export{oa as R};
