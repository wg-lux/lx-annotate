var ct=Object.defineProperty;var vt=(M,s,a)=>s in M?ct(M,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):M[s]=a;var Ne=(M,s,a)=>vt(M,typeof s!="symbol"?s+"":s,a);import{d as Fe,h as g,e as y,i as Oe,w as De,c as r,j as x,a as e,x as mt,q as Ee,n as q,t as o,k as m,F as pe,m as Se,o as l,z as be,_ as Pe,f as ft,g as gt,u as pt,J as bt,p as Q,b as Ae,C as ht,r as yt,l as F,H as wt,G as U,v as ze,A as _e,y as xt}from"./main-DethiONo.js";import{u as Me}from"./videoStore-ClqdABXQ.js";import{u as _t}from"./mediaTypeStore-D6KIykKn.js";import{T as Dt}from"./Timeline-CMheelus.js";import{u as St}from"./usePollingProtection-5vxQa-Ko.js";const kt={class:"video-with-outside-timeline"},Vt={key:0,class:"validation-status mb-3"},It={class:"row align-items-center"},$t={class:"col-md-8"},Nt={class:"progress"},At={class:"col-md-4 text-end"},zt=["disabled"],Ft={key:0,class:"spinner-border spinner-border-sm me-1"},Ot={key:1,class:"fas fa-check-double me-1"},Et=["disabled"],Pt=["src"],Mt={key:1,class:"segments-overview mb-3"},Yt={class:"segments-list"},Tt={class:"ms-2 text-muted"},Ct={class:"ms-2 badge bg-secondary"},Ut=["onClick","disabled"],Bt={key:1,class:"text-success"},Gt={key:2,class:"alert alert-info"},Lt=Fe({__name:"OutsideSegmentComponent",props:{videoId:{}},emits:["segment-validated","validation-complete"],setup(M,{emit:s}){const a=M,f=s,i=g(null),k=g(""),w=g(0),D=g(0),b=g(!1),h=Me(),A=g(new Set),T=g(!1);async function I(c){const{data:p}=await be.get(`/api/media/videos/${c}/`);k.value=p.video_url,w.value=Number(p.duration??0)}async function C(c){await h.fetchAllSegments(c)}const O=y(()=>(h.allSegments??[]).filter(p=>(p.label??"").toLowerCase()==="outside").map(p=>({...p}))),X=y(()=>O.value.filter(c=>!A.value.has(c.id))),se=y(()=>O.value.length>0&&X.value.length===0);async function ee(c){if(!(A.value.has(c.id)||T.value)){T.value=!0;try{A.value.add(c.id),f("segment-validated",c.id),console.log(`‚úÖ Segment ${c.id} validated`),se.value&&(f("validation-complete"),console.log("üéâ All outside segments validated!"))}catch(p){console.error("Error validating segment:",p),A.value.delete(c.id)}finally{T.value=!1}}}async function z(){for(const c of X.value)await ee(c)}function ie(){A.value.clear()}function u(c){const p=Math.floor(c/60),$=Math.floor(c%60);return`${p.toString().padStart(2,"0")}:${$.toString().padStart(2,"0")}`}Oe(()=>{i.value&&(i.value.addEventListener("loadedmetadata",()=>{!w.value&&i.value&&(w.value=i.value.duration||0)}),i.value.addEventListener("timeupdate",()=>{i.value&&(D.value=i.value.currentTime)}),i.value.addEventListener("play",()=>{b.value=!0}),i.value.addEventListener("pause",()=>{b.value=!1}))}),De(()=>a.videoId,async c=>{ie(),await Promise.all([I(c),C(c)])},{immediate:!0});function R(...c){const[p]=c;i.value&&Number.isFinite(p)&&(i.value.currentTime=p),D.value=p}function W(){i.value&&(i.value.paused?i.value.play().catch(()=>{}):i.value.pause(),b.value=!i.value.paused)}function H(){}function B(){}function G(){}function Z(){}function Y(){}function _(){}function E(){}return(c,p)=>(l(),r("div",kt,[O.value.length>0?(l(),r("div",Vt,[e("div",It,[e("div",$t,[e("div",Nt,[e("div",{class:q(["progress-bar",se.value?"bg-success":"bg-warning"]),style:Ee(`width: ${A.value.size/O.value.length*100}%`)},o(A.value.size)+" / "+o(O.value.length)+" validiert ",7)])]),e("div",At,[e("button",{class:"btn btn-sm btn-success me-2",onClick:z,disabled:T.value||se.value},[T.value?(l(),r("span",Ft)):(l(),r("i",Ot)),p[0]||(p[0]=m(" Alle validieren ",-1))],8,zt),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:ie,disabled:T.value||A.value.size===0},[...p[1]||(p[1]=[e("i",{class:"fas fa-redo me-1"},null,-1),m(" Zur√ºcksetzen ",-1)])],8,Et)])])])):x("",!0),e("video",{ref_key:"videoEl",ref:i,src:k.value,controls:"",style:{width:"100%","max-height":"480px"}},null,8,Pt),O.value.length>0?(l(),r("div",Mt,[e("h6",null,"Outside-Segmente ("+o(O.value.length)+")",1),e("div",Yt,[(l(!0),r(pe,null,Se(O.value,$=>(l(),r("div",{key:$.id,class:q(["segment-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded",{"border-success bg-success bg-opacity-10":A.value.has($.id),"border-warning bg-warning bg-opacity-10":!A.value.has($.id)}])},[e("div",null,[e("strong",null,"Segment "+o($.id),1),e("span",Tt,o(u($.startTime))+" - "+o(u($.endTime)),1),e("span",Ct,o($.label),1)]),e("div",null,[A.value.has($.id)?(l(),r("span",Bt,[...p[3]||(p[3]=[e("i",{class:"fas fa-check-circle me-1"},null,-1),m(" Validiert ",-1)])])):(l(),r("button",{key:0,class:"btn btn-sm btn-outline-success",onClick:le=>ee($),disabled:T.value},[...p[2]||(p[2]=[e("i",{class:"fas fa-check me-1"},null,-1),m(" Validieren ",-1)])],8,Ut))])],2))),128))])])):(l(),r("div",Gt,[p[4]||(p[4]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),m(' Keine "Outside"-Segmente f√ºr Video '+o(a.videoId)+" gefunden. ",1)])),O.value.length>0?(l(),mt(Dt,{key:3,video:{duration:w.value},segments:O.value,"current-time":D.value,"is-playing":b.value,"selection-mode":!1,onSeek:R,onPlayPause:W,onSegmentCreate:H,onSegmentResize:B,onSegmentMove:G,onTimeSelection:Z,onSegmentSelect:Y,onSegmentEdit:_,onSegmentDelete:E},null,8,["video","segments","current-time","is-playing"])):x("",!0)]))}}),Kt=Pe(Lt,[["__scopeId","data-v-f646399d"]]);class V{static toISO(s){if(!s)return null;const a=s.trim().split(" ")[0],i=/^(\d{4})-(\d{2})-(\d{2})$/.exec(a);if(i){const[,D,b,h]=i;return this._isValidDate(parseInt(D),parseInt(b),parseInt(h))?a:null}const w=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(a);if(w){const[,D,b,h]=w;return this._isValidDate(parseInt(h),parseInt(b),parseInt(D))?`${h}-${b}-${D}`:null}return null}static toGerman(s){if(!s)return"";const a=s.trim(),i=/^(\d{4})-(\d{2})-(\d{2})$/.exec(a);if(!i)return"";const[,k,w,D]=i;return this._isValidDate(parseInt(k),parseInt(w),parseInt(D))?`${D}.${w}.${k}`:""}static validate(s,a){if(!s)return!1;const f=s.trim();if(a==="ISO"){const k=/^(\d{4})-(\d{2})-(\d{2})$/.exec(f);if(!k)return!1;const[,w,D,b]=k;return this._isValidDate(parseInt(w),parseInt(D),parseInt(b))}if(a==="German"){const k=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(f);if(!k)return!1;const[,w,D,b]=k;return this._isValidDate(parseInt(b),parseInt(D),parseInt(w))}return!1}static compare(s,a){if(!this.validate(s,"ISO")||!this.validate(a,"ISO"))return null;const f=new Date(s),i=new Date(a);return f<i?-1:f>i?1:0}static isBefore(s,a){return this.compare(s,a)===-1}static isAfter(s,a){return this.compare(s,a)===1}static isBeforeOrEqual(s,a){const f=this.compare(s,a);return f===-1||f===0}static isAfterOrEqual(s,a){const f=this.compare(s,a);return f===1||f===0}static today(){const s=new Date,a=s.getFullYear(),f=String(s.getMonth()+1).padStart(2,"0"),i=String(s.getDate()).padStart(2,"0");return`${a}-${f}-${i}`}static todayGerman(){return this.toGerman(this.today())}static _isValidDate(s,a,f){if(s<1900||s>2100||a<1||a>12||f<1||f>31)return!1;const i=new Date(s,a-1,f);return i.getFullYear()===s&&i.getMonth()===a-1&&i.getDate()===f}}class Rt{constructor(){Ne(this,"errors",new Map)}addField(s,a,f){if(!a){this.errors.set(s,`${s}: Pflichtfeld (darf nicht leer sein)`);return}if(!V.validate(a,f)){const i=f==="ISO"?"YYYY-MM-DD":"DD.MM.YYYY";this.errors.set(s,`${s}: Ung√ºltiges Format (erwartet: ${i})`)}}addConstraint(s,a,f){a||this.errors.set(s,f)}hasErrors(){return this.errors.size>0}getErrors(){return Array.from(this.errors.values())}getSummary(){const s=this.errors.size;return s===0?"Alle Datumsfelder sind g√ºltig":s===1?"1 Datumsfehler gefunden":`${s} Datumsfehler gefunden`}clear(){this.errors.clear()}getErrorsAsHtml(){return this.errors.size===0?"":`<ul class="date-validation-errors">${this.getErrors().map(a=>`<li>${a}</li>`).join("")}</ul>`}}const jt={class:"container-fluid py-4"},qt={class:"card"},Wt={class:"card-body"},Ht={key:0,class:"text-center py-5"},Zt={key:1,class:"alert alert-danger",role:"alert"},Jt={key:3,class:"alert alert-warning mt-3"},Qt={class:"mt-2"},Xt={class:"row mb-3"},en={class:"col-12"},tn={class:"alert alert-info d-flex align-items-center justify-content-between",role:"alert"},nn={key:0,class:"text-end"},an={class:"text-muted"},sn={class:"row mb-4"},ln={class:"col-12"},on={class:"form-check"},rn={key:0,class:"row mb-4"},dn={class:"col-12"},un={class:"alert alert-danger alert-dismissible fade show",role:"alert"},cn={class:"alert-heading"},vn={class:"mb-0"},mn={class:"row mb-4"},fn={class:"col-md-5"},gn={class:"card bg-light mb-4"},pn={class:"card-body"},bn={class:"mb-3"},hn={key:0,class:"invalid-feedback"},yn={class:"mb-3"},wn={key:0,class:"invalid-feedback"},xn={class:"mb-3"},_n={class:"mb-3"},Dn={class:"form-text text-muted"},Sn={key:0,class:"ms-2 badge bg-secondary"},kn={key:0,class:"invalid-feedback"},Vn={class:"mb-3"},In={class:"mb-3"},$n={class:"form-text text-muted"},Nn={key:0,class:"ms-2 badge bg-secondary"},An={key:0,class:"invalid-feedback"},zn={class:"mb-3"},Fn={class:"mb-3"},On={class:"mb-3"},En={class:"mb-3"},Pn={class:"mb-3"},Mn={class:"card bg-light"},Yn={class:"card-body"},Tn={key:0,class:"mt-3"},Cn=["src"],Un={class:"col-md-7"},Bn={class:"card"},Gn={class:"card-header pb-0"},Ln={class:"mb-0"},Kn={class:"alert alert-info mt-2 mb-0"},Rn={key:0},jn={key:1},qn={key:2},Wn={class:"card-body media-viewer-container"},Hn={key:0,class:"dual-pdf-container"},Zn={class:"row"},Jn={class:"col-md-6"},Qn={class:"pdf-section raw-pdf"},Xn=["src"],ea=["href"],ta={class:"mt-2 text-center"},na={class:"text-muted"},aa={class:"col-md-6"},sa={class:"pdf-section anonymized-pdf"},ia=["src"],la=["href"],oa={class:"mt-2 text-center"},ra={class:"text-muted"},da={key:1,class:"dual-video-container"},ua={class:"row"},ca={class:"col-md-6"},va={class:"video-section raw-video"},ma=["src"],fa={class:"mt-2 text-center"},ga={class:"text-muted"},pa={class:"col-md-6"},ba={class:"video-section anonymized-video"},ha=["src"],ya={class:"mt-2 text-center"},wa={class:"text-muted"},xa={class:"video-controls mt-3 text-center"},_a=["disabled"],Da={key:0,class:"spinner-border spinner-border-sm me-1",role:"status"},Sa={key:1,class:"fas fa-check me-1"},ka={key:0,class:"outside-timeline-container mt-4"},Va={class:"card border-warning"},Ia={class:"card-header bg-warning bg-opacity-10"},$a={class:"d-flex justify-content-between align-items-center"},Na={class:"mb-0 text-warning"},Aa={class:"text-end"},za={class:"badge bg-warning text-dark fs-6"},Fa={class:"progress mt-2",style:{width:"200px",height:"8px"}},Oa=["aria-valuenow","aria-valuemax"],Ea={class:"text-muted"},Pa={class:"card-body"},Ma={key:0,class:"mt-2"},Ya={key:2,class:"alert alert-warning"},Ta={class:"mb-0"},Ca={class:"row"},Ua={class:"col-12 d-flex justify-content-between"},Ba={class:"d-flex gap-2"},Ga=["disabled","title"],La={key:0,class:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",style:{"font-size":"0.6em"},title:"Ungespeicherte √Ñnderungen"},Ka=["disabled","title"],Ra={key:0,class:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"},ja={key:1,class:"alert alert-warning mt-2 mb-0"},qa=["value"],Wa={key:2,class:"alert alert-warning mt-2 mb-0"},Ha=Fe({__name:"AnonymizationValidationComponent",props:{fileId:{},mediaType:{}},setup(M){const s=St(),a=ft(),f=xt(),i=gt(),k=Me(),w=_t(),D=pt(),b=y(()=>w.isPdf),h=y(()=>w.isVideo);function A(){const n=Number(sessionStorage.getItem("last:fileId")||""),t=sessionStorage.getItem("last:scope");return{fileId:Number.isFinite(n)?n:void 0,scope:t||void 0}}const T=M;let I=Number(T.fileId||D.query.fileId),C=T.mediaType||D.query.mediaType;if(console.log("fileid and scope",I,C),!Number.isFinite(I)||!C){const n=A();n.fileId!==void 0&&(I=n.fileId),n.scope&&(C=n.scope)}!Number.isFinite(I)||!C?console.error("Validation view: cannot determine fileId/scope; aborting mediaStore init.",{fileId:I,scope:C}):w.setCurrentByKey(C,I);const O=[{text:"Video",value:"video"},{text:"PDF",value:"pdf"}],X=g(""),se=y(()=>!b.value&&!h.value);De(X,n=>{!n||!d.value||(w.rememberType(d.value.id,n,n),w.setCurrentByKey(n,d.value.id))});const ee=g(""),z=g(""),ie=g(!1),u=g({patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:"",externalId:"",externalIdOrigin:"",centerName:"",text:"",anonymizedText:"",examinersDisplay:"",examinationDate:""}),R=g([]),W=g(""),H=g(""),B=g(""),G=g(""),Z=g(!1),Y=g(!1),_=g(null),E=g(0),c=g(0),p=g(""),$=g(""),le=g(!1);g(!1);const de=g({anonymizedText:"",examinationDate:"",patient:{patientFirstName:"",patientLastName:"",patientGenderName:"",patientDob:"",casenumber:""}});function Ye(n,t){return n.patientFirstName===t.patientFirstName&&n.patientLastName===t.patientLastName&&n.patientGenderName===t.patientGenderName&&n.patientDob===t.patientDob&&n.casenumber===t.casenumber}const ue=y(()=>u.value.patientFirstName.trim().length>0),ce=y(()=>u.value.patientLastName.trim().length>0),te=y(()=>V.toISO(u.value.patientDob)),oe=y(()=>V.toISO(z.value)),Te=y(()=>{const n=R.value.length;return n===0?"Alle Felder sind g√ºltig":n===1?"1 Validierungsfehler gefunden":`${n} Validierungsfehler gefunden`}),ve=y(()=>!!te.value),me=y(()=>oe.value?te.value?V.isAfterOrEqual(oe.value,te.value):!1:!0),he=y(()=>ue.value&&ce.value&&ve.value&&me.value);y(()=>he.value);const ye=y(()=>!(!he.value||h.value&&Y.value)),fe=y(()=>{if(!he.value){const n=[];return ue.value||n.push("Vorname"),ce.value||n.push("Nachname"),ve.value||n.push("g√ºltiges Geburtsdatum"),me.value||n.push("g√ºltiges Untersuchungsdatum"),`Bitte korrigieren Sie: ${n.join(", ")}`}return h.value&&Y.value?`Bitte validieren Sie zuerst alle Outside-Segmente (${c.value-E.value} verbleibend)`:""}),ke=y(()=>c.value===0?0:Math.round(E.value/c.value*100)),d=y(()=>i.current),we=y(()=>!h.value||!d.value?void 0:`${window.location.origin}/api/media/videos/${I}/?type=raw`),xe=y(()=>!h.value||!d.value?void 0:`${window.location.origin}/api/media/videos/${I}/?type=processed`),ne=y(()=>!b.value||!d.value?void 0:`${window.location.origin}/api/media/pdfs/${I}/stream/?type=raw`),J=y(()=>!b.value||!d.value?void 0:`${window.location.origin}/api/media/pdfs/${I}/stream/?type=processed`),L=g(null),K=g(null),Ce=n=>{console.error("Raw video error:",n)},Ue=()=>{console.log("Raw video load started")},Be=()=>{console.log("Raw video can play")},Ge=n=>{console.error("Anonymized video error:",n)},Le=()=>{console.log("Anonymized video load started")},Ke=()=>{console.log("Anonymized video can play")},Ve=(n,t)=>{if(!L.value||!K.value)return;const N=n==="raw"?L.value:K.value,S=n==="raw"?K.value:L.value;Math.abs(N.currentTime-S.currentTime)>.5&&(S.currentTime=N.currentTime)},Re=()=>{if(!L.value||!K.value)return;const n=(L.value.currentTime+K.value.currentTime)/2;L.value.currentTime=n,K.value.currentTime=n,console.log("Videos synchronized to time:",n)},je=()=>{L.value&&L.value.pause(),K.value&&K.value.pause(),console.log("All videos paused")},qe=()=>{if(!ne.value){a.warning({text:"Original-PDF nicht verf√ºgbar."});return}window.open(ne.value,"_blank"),console.log("Downloading raw PDF:",ne.value)},We=()=>{if(!J.value){a.warning({text:"Anonymisiertes PDF nicht verf√ºgbar."});return}window.open(J.value,"_blank"),console.log("Downloading anonymized PDF:",J.value)},He=async()=>{var n,t,N;if(!d.value||!h.value){a.warning({text:"Kein Video zur Validierung ausgew√§hlt."});return}Z.value=!0,Y.value=!1,_.value=null;try{console.log(`üîç Validating video ${d.value.id} for segment annotation...`);const P=(await be.get(_e(`media/videos/${d.value.id}/validation/segments/`))).data;if(console.log("Video validation response:",P),P.eligible){const ae=(await be.get(_e(`media/videos/${d.value.id}/segments/?label=outside`))).data;c.value=ae.length,E.value=0,ae.length>0?(Y.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Segmentvalidierung erforderlich",message:`${ae.length} "Outside"-Segmente gefunden, die validiert werden m√ºssen.`,details:"Verwenden Sie die Timeline unten, um die Segmente zu √ºberpr√ºfen und zu best√§tigen."}):_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Video bereit f√ºr Annotation",message:'Keine "Outside"-Segmente gefunden. Video ist bereit f√ºr die Segment-Annotation.',details:`Video ID: ${d.value.id} - Alle Validierungen bestanden.`}}else _.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Video nicht bereit",message:((n=P.reasons)==null?void 0:n.join(", "))||"Video ist nicht f√ºr Segment-Annotation geeignet.",details:"√úberpr√ºfen Sie die Video-Verarbeitung und Metadaten-Extraktion."};a.info({text:`Video ${d.value.id} validiert`})}catch(S){console.error("Error validating video for segment annotation:",S);try{await k.fetchAllSegments(d.value.id);const P=k.allSegments.filter(re=>re.label==="outside");c.value=P.length,E.value=0,P.length>0?(Y.value=!0,_.value={class:"alert-warning",icon:"fas fa-exclamation-triangle",title:"Outside-Segmente gefunden (Fallback)",message:`${P.length} "Outside"-Segmente zur Validierung gefunden.`,details:"Fallback-Validierung √ºber VideoStore. API-Endpoint nicht verf√ºgbar."}):_.value={class:"alert-info",icon:"fas fa-info-circle",title:"Fallback-Validierung",message:'Keine "Outside"-Segmente gefunden (√ºber VideoStore).',details:"API-Validierung fehlgeschlagen, Fallback verwendet."}}catch{_.value={class:"alert-danger",icon:"fas fa-times-circle",title:"Validierung fehlgeschlagen",message:"Video konnte nicht f√ºr Segment-Annotation validiert werden.",details:((N=(t=S==null?void 0:S.response)==null?void 0:t.data)==null?void 0:N.detail)||(S==null?void 0:S.message)||"Unbekannter Fehler"}}}finally{Z.value=!1}},Ze=n=>{E.value++,console.log(`‚úÖ Segment ${n} validated. Progress: ${E.value}/${c.value}`),_.value&&(_.value.message=`Fortschritt: ${E.value}/${c.value} Outside-Segmente validiert.`)},Je=()=>{var n;console.log("üéâ All outside segments validated!"),Y.value=!1,_.value={class:"alert-success",icon:"fas fa-check-circle",title:"Validierung abgeschlossen",message:"Alle Outside-Segmente wurden erfolgreich validiert.",details:`Video ${(n=d.value)==null?void 0:n.id} ist jetzt bereit f√ºr die vollst√§ndige Segment-Annotation.`},a.success({text:"Outside-Segment Validierung abgeschlossen!"})};function Qe(n){return n==null?"unknown":["male","m√§nnlich","m"].includes(n)?"male":["female","weiblich","f","w"].includes(n)?"female":["other","divers","d"].includes(n)?"unknown":n}function Ie(n){if(!n)return;Y.value=!1,_.value=null,E.value=0,c.value=0,Z.value=!1;const t=n.examinationDate||"",N=n.patientDobDisplay||n.patientDob;z.value=V.toISO(t)||"";const S=Qe(n.patientGenderName);u.value={patientFirstName:n.patientFirstName||"",patientLastName:n.patientLastName||"",patientGenderName:S||"",patientDob:V.toISO(N)||"",casenumber:n.casenumber||"",externalId:n.externalId??"",externalIdOrigin:n.externalIdOrigin??"",centerName:n.centerName??"",text:n.text??"",anonymizedText:n.anonymizedText??"",examinersDisplay:n.examinersDisplay??"",examinationDate:z.value},de.value={anonymizedText:u.value.anonymizedText??"",examinationDate:z.value,patient:{...u.value}},sessionStorage.setItem("last:fileId",String(n.id))}De(d,n=>{n&&Ie(n)},{immediate:!0});const ge=async()=>{try{await i.fetchNext()}catch(n){console.error("Error fetching next item:",n)}},Xe=y(()=>ee.value!==de.value.anonymizedText||z.value!==de.value.examinationDate||!Ye(u.value,de.value.patient)),et=y(()=>d.value&&!j.value),j=g(!1),tt=()=>{le.value=!le.value};function $e(){const n=new Rt;if(R.value=[],W.value="",H.value="",u.value.patientDob){const t=u.value.patientDob;V.validate(t,"ISO")?B.value="ISO (YYYY-MM-DD)":V.validate(t,"German")?B.value="Deutsch (DD.MM.YYYY)":(B.value="",W.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",n.addField("Geburtsdatum",t,"German"))}else B.value="";if(z.value){const t=z.value;V.validate(t,"ISO")?G.value="ISO (YYYY-MM-DD)":V.validate(t,"German")?G.value="Deutsch (DD.MM.YYYY)":(G.value="",H.value="Ung√ºltiges Format. Verwenden Sie DD.MM.YYYY oder YYYY-MM-DD",n.addField("Untersuchungsdatum",t,"ISO"))}else G.value="";te.value&&oe.value&&n.addConstraint("DOB_BEFORE_EXAM",V.isBeforeOrEqual(te.value,oe.value),"Geburtsdatum muss vor oder am selben Tag wie das Untersuchungsdatum liegen"),n.hasErrors()&&(R.value=n.getErrors(),n.getErrors().forEach(N=>{N.includes("Geburtsdatum")&&(W.value=N.replace("Geburtsdatum: ","")),N.includes("Untersuchungsdatum")&&(H.value=N.replace("Untersuchungsdatum: ",""))}))}function nt(){const n=u.value.patientDob;if(!n)return;const t=V.toISO(n);t&&(u.value.patientDob=t,B.value="ISO (YYYY-MM-DD)"),$e()}function at(){const n=z.value;if(!n)return;const t=V.toISO(n);t&&(z.value=t,G.value="ISO (YYYY-MM-DD)"),$e()}function st(){R.value=[],W.value="",H.value=""}const it=async()=>{d.value&&await ge()},lt=()=>{if(!d.value){a.error({text:"Kein Video zur Segmentierung ausgew√§hlt."});return}f.push({name:"Video-Untersuchung",query:{video:d.value.id.toString()}}),console.log(`üéØ Navigating to Video-Untersuchung with video ID: ${d.value.id}`)},ot=async()=>{if(!(!d.value||!et.value||j.value)){if(!ye.value){const n=fe.value;console.warn(`‚ùå Approval blocked: ${n}`),a.warning({text:n});return}if(h.value&&Y.value){console.warn("‚ùå Outside segments still pending validation"),a.error({text:"Bitte validieren Sie zuerst alle Outside-Segmente, bevor Sie das Video best√§tigen."});return}j.value=!0;try{console.log(`Validating anonymization for file ${d.value.id}...`);try{await be.post(_e(`anonymization/${d.value.id}/validate/`),{patient_first_name:u.value.patientFirstName,patient_last_name:u.value.patientLastName,patient_gender:u.value.patientGenderName,patient_dob:V.toGerman(te.value||"")||"",examination_date:V.toGerman(oe.value||"")||"",casenumber:u.value.casenumber||"",anonymized_text:u.value.anonymizedText||void 0,text:u.value.text||void 0,is_verified:"true",file_type:b.value?"pdf":h.value?"video":"unknown",center_name:u.value.centerName||"",external_id:u.value.externalId||"",external_id_origin:u.value.externalIdOrigin||""}),console.log(`Anonymization validated successfully for file ${d.value.id}`),a.success({text:"Dokument best√§tigt und Anonymisierung validiert"})}catch(t){console.error("Error validating anonymization:",t),a.warning({text:"Dokument best√§tigt, aber Validierung fehlgeschlagen"})}const n=b.value?"pdf":h.value?"video":"unknown";if(n==="unknown"){a.error({text:"Bitte Medientyp ausw√§hlen, bevor best√§tigt wird."});return}s.validateAnonymizationSafeWithProtection(d.value.id,n),await lt()}catch(n){console.error("Error approving item:",n),a.error({text:"Fehler beim Best√§tigen des Elements"})}finally{j.value=!1}}},rt=async()=>{d.value&&await ge()},dt=async()=>{if(!d.value){a.error({text:"Kein Element zur Korrektur ausgew√§hlt."});return}try{f.push({name:"Anonymisierung Korrektur",params:{fileId:d.value.id.toString()}}),a.info({text:"√Ñnderungen gespeichert. Bitte w√§hlen Sie das Element erneut f√ºr die Korrektur aus."});return}catch{a.error({text:"Fehler beim Speichern. Korrektur-Navigation abgebrochen."});return}};return Oe(async()=>{Number.isFinite(I)&&C&&w.setCurrentByKey(C,I),i.current?Ie(i.current):await ge()}),bt(()=>{ge()}),(n,t)=>{var S,P,re,ae;const N=yt("router-link");return l(),r("div",jt,[e("div",qt,[t[70]||(t[70]=e("div",{class:"card-header pb-0"},[e("h4",{class:"mb-0"},"Anonymisierungsvalidierung und Annotationen")],-1)),e("div",Wt,[Q(i).loading?(l(),r("div",Ht,[...t[16]||(t[16]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Wird geladen...")],-1),e("p",{class:"mt-2"},"Anonymisierte Daten werden geladen...",-1)])])):Q(i).error?(l(),r("div",Zt,[t[17]||(t[17]=e("strong",null,"Fehler:",-1)),m(" "+o(Q(i).error),1)])):d.value?x("",!0):(l(),r("div",{key:2,class:"alert alert-info",role:"alert",onLoadstart:t[0]||(t[0]=v=>Q(i).fetchNext())}," Alle Anonymisierungen wurden bearbeitet. ",32)),Q(i).isAnyFileProcessing?(l(),r("div",Jt,[t[19]||(t[19]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("strong",null,o(Q(i).processingFiles.length)+" Datei(en)",1),t[20]||(t[20]=m(" werden gerade anonymisiert. ",-1)),e("div",Qt,[Ae(N,{to:"/anonymisierung/uebersicht",class:"btn btn-sm btn-outline-primary"},{default:ht(()=>[...t[18]||(t[18]=[e("i",{class:"fas fa-eye me-1"},null,-1),m(" Zur √úbersicht ",-1)])]),_:1})])])):x("",!0)]),d.value?(l(),r(pe,{key:0},[e("div",Xt,[e("div",en,[e("div",tn,[e("div",null,[t[22]||(t[22]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),e("span",null,[t[21]||(t[21]=e("strong",null,"Validierung:",-1)),m(" "+o(b.value?"PDF-Dokument":h.value?"Video-Datei":"Unbekanntes Format")+" "+o((S=d.value)!=null&&S.centerName?`- ${d.value.centerName}`:""),1)])]),d.value&&(h.value||b.value)?(l(),r("div",nn,[e("small",an,[t[23]||(t[23]=e("i",{class:"fas fa-tools me-1"},null,-1)),m(" "+o(h.value?"Video-Korrektur verf√ºgbar":"Text-Korrektur verf√ºgbar"),1)])])):x("",!0)])])]),e("div",sn,[e("div",ln,[e("div",on,[F(e("input",{type:"checkbox",class:"form-check-input",id:"noMoreNames","onUpdate:modelValue":t[1]||(t[1]=v=>ie.value=v)},null,512),[[wt,ie.value]]),t[24]||(t[24]=e("label",{class:"form-check-label",for:"noMoreNames"}," Keine weiteren Namen im Video oder PDF vorhanden ",-1))])])]),R.value.length>0?(l(),r("div",rn,[e("div",dn,[e("div",un,[e("h6",cn,[t[25]||(t[25]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" "+o(Te.value),1)]),t[26]||(t[26]=e("hr",null,null,-1)),e("ul",vn,[(l(!0),r(pe,null,Se(R.value,(v,ut)=>(l(),r("li",{key:ut},o(v),1))),128))]),e("button",{type:"button",class:"btn-close",onClick:st,"aria-label":"Schlie√üen"})])])])):x("",!0),e("div",mn,[e("div",fn,[e("div",gn,[e("div",pn,[t[41]||(t[41]=e("h5",{class:"card-title"},"Patienteninformationen",-1)),e("div",bn,[t[27]||(t[27]=e("label",{class:"form-label"},"Vorname:",-1)),F(e("input",{type:"text",class:q(["form-control",{"is-invalid":!ue.value}]),"onUpdate:modelValue":t[2]||(t[2]=v=>u.value.patientFirstName=v)},null,2),[[U,u.value.patientFirstName]]),ue.value?x("",!0):(l(),r("div",hn," Vorname ist erforderlich. "))]),e("div",yn,[t[28]||(t[28]=e("label",{class:"form-label"},"Nachname:",-1)),F(e("input",{type:"text",class:q(["form-control",{"is-invalid":!ce.value}]),"onUpdate:modelValue":t[3]||(t[3]=v=>u.value.patientLastName=v)},null,2),[[U,u.value.patientLastName]]),ce.value?x("",!0):(l(),r("div",wn," Nachname ist erforderlich. "))]),e("div",xn,[t[30]||(t[30]=e("label",{class:"form-label"},"Geschlecht:",-1)),F(e("select",{class:"form-select","onUpdate:modelValue":t[4]||(t[4]=v=>u.value.patientGenderName=v)},[...t[29]||(t[29]=[e("option",{value:"male"},"M√§nnlich",-1),e("option",{value:"female"},"Weiblich",-1),e("option",{value:"unknown"},"Divers",-1)])],512),[[ze,u.value.patientGenderName]])]),e("div",_n,[t[32]||(t[32]=e("label",{class:"form-label"},"Geburtsdatum:",-1)),F(e("input",{type:"date",class:q(["form-control",{"is-invalid":!ve.value}]),"onUpdate:modelValue":t[5]||(t[5]=v=>u.value.patientDob=v),onBlur:nt},null,34),[[U,u.value.patientDob]]),e("small",Dn,[t[31]||(t[31]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),B.value?(l(),r("span",Sn,o(B.value),1)):x("",!0)]),ve.value?x("",!0):(l(),r("div",kn,o(W.value||"G√ºltiges Geburtsdatum ist erforderlich."),1))]),e("div",Vn,[t[33]||(t[33]=e("label",{class:"form-label"},"Fallnummer:",-1)),F(e("input",{type:"text",class:"form-control","onUpdate:modelValue":t[6]||(t[6]=v=>u.value.casenumber=v)},null,512),[[U,u.value.casenumber]])]),e("div",In,[t[35]||(t[35]=e("label",{class:"form-label"},"Untersuchungsdatum:",-1)),F(e("input",{type:"date",class:q(["form-control",{"is-invalid":!me.value}]),"onUpdate:modelValue":t[7]||(t[7]=v=>z.value=v),onBlur:at},null,34),[[U,z.value]]),e("small",$n,[t[34]||(t[34]=e("i",{class:"fas fa-info-circle me-1"},null,-1)),G.value?(l(),r("span",Nn,o(G.value),1)):x("",!0)]),me.value?x("",!0):(l(),r("div",An,o(H.value||"Das Untersuchungsdatum darf nicht vor dem Geburtsdatum liegen."),1))]),e("div",zn,[t[36]||(t[36]=e("label",{class:"form-label"},"Anonymisierter Text:",-1)),F(e("textarea",{class:"form-control",rows:"6","onUpdate:modelValue":t[8]||(t[8]=v=>ee.value=v)},null,512),[[U,ee.value]])]),e("div",Fn,[t[37]||(t[37]=e("label",{class:"form-label"},"Externe ID:",-1)),F(e("textarea",{class:"form-control","onUpdate:modelValue":t[9]||(t[9]=v=>u.value.externalId=v)},null,512),[[U,u.value.externalId]])]),e("div",On,[t[38]||(t[38]=e("label",{class:"form-label"},"Untersucher:",-1)),F(e("textarea",{class:"form-control","onUpdate:modelValue":t[10]||(t[10]=v=>u.value.examinersDisplay=v)},null,512),[[U,u.value.examinersDisplay]])]),e("div",En,[t[39]||(t[39]=e("label",{class:"form-label"},"Quelle der Daten:",-1)),F(e("textarea",{class:"form-control","onUpdate:modelValue":t[11]||(t[11]=v=>u.value.externalIdOrigin=v)},"                    ",512),[[U,u.value.externalIdOrigin]])]),e("div",Pn,[t[40]||(t[40]=e("label",{class:"form-label"},"Zentrum:",-1)),F(e("textarea",{class:"form-control","onUpdate:modelValue":t[12]||(t[12]=v=>u.value.centerName=v)},"                    ",512),[[U,u.value.centerName]])])]),e("div",Mn,[e("div",Yn,[t[42]||(t[42]=e("h5",{class:"card-title"},"Annotationen",-1)),$.value?(l(),r("div",Tn,[e("img",{src:le.value?p.value:$.value,class:"img-fluid",alt:"Uploaded Image"},null,8,Cn),e("button",{class:"btn btn-info btn-sm mt-2",onClick:tt},o(le.value?"Bearbeitetes Bild anzeigen":"Original anzeigen"),1)])):x("",!0),t[43]||(t[43]=e("div",{class:"mt-3"},null,-1))])])])]),e("div",Un,[e("div",Bn,[e("div",Gn,[e("h5",Ln,o(b.value?"PDF Vorschau":"Video Vorschau"),1),e("div",Kn,[t[44]||(t[44]=e("i",{class:"fas fa-info-circle me-2"},null,-1)),t[45]||(t[45]=e("strong",null,"Datenformat:",-1)),b.value?(l(),r("span",Rn," PDF-Dokument ("+o(Math.round((((P=J.value)==null?void 0:P.length)||0)/1024)||"Nicht Verf√ºgbar")+" KB) ",1)):h.value?(l(),r("span",jn," Video-Datei (Raw: "+o(we.value||"N/A")+" | Anonymized: "+o(xe.value||"N/A")+") ",1)):(l(),r("span",qn," Unbekanntes Format - ID: "+o((re=d.value)==null?void 0:re.id),1))])]),e("div",Wn,[b.value?(l(),r("div",Hn,[e("div",Zn,[e("div",Jn,[e("div",Qn,[t[48]||(t[48]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-file-pdf me-1"}),m(" Original PDF (Raw) ")],-1)),e("iframe",{src:ne.value,width:"100%",height:"700px",frameborder:"0",title:"Original PDF Vorschau"},[t[46]||(t[46]=m(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:ne.value},"hier herunterladen",8,ea),t[47]||(t[47]=m(". ",-1))],8,Xn),e("div",ta,[e("small",na," URL: "+o(ne.value||"Nicht verf√ºgbar"),1)])])]),e("div",aa,[e("div",sa,[t[51]||(t[51]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes PDF (Processed) ")],-1)),e("iframe",{src:J.value,width:"100%",height:"700px",frameborder:"0",title:"Anonymisiertes PDF Vorschau"},[t[49]||(t[49]=m(" Ihr Browser unterst√ºtzt keine eingebetteten PDFs. Sie k√∂nnen die Datei ",-1)),e("a",{href:J.value},"hier herunterladen",8,la),t[50]||(t[50]=m(". ",-1))],8,ia),e("div",oa,[e("small",ra," URL: "+o(J.value||"Nicht verf√ºgbar"),1)])])])]),e("div",{class:"pdf-controls mt-3 text-center"},[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:qe},[...t[52]||(t[52]=[e("i",{class:"fas fa-download me-1"},null,-1),m(" Original herunterladen ",-1)])]),e("button",{class:"btn btn-outline-success btn-sm",onClick:We},[...t[53]||(t[53]=[e("i",{class:"fas fa-download me-1"},null,-1),m(" Anonymisiert herunterladen ",-1)])])])])):h.value?(l(),r("div",da,[e("div",ua,[e("div",ca,[e("div",va,[t[54]||(t[54]=e("h6",{class:"text-center mb-3 text-danger"},[e("i",{class:"fas fa-eye me-1"}),m(" Original Video (Raw) ")],-1)),e("video",{ref_key:"rawVideoElement",ref:L,src:we.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ce,onLoadstart:Ue,onCanplay:Be,onTimeupdate:t[13]||(t[13]=v=>Ve("raw"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,ma),e("div",fa,[e("small",ga," URL: "+o(we.value||"Nicht verf√ºgbar"),1)])])]),e("div",pa,[e("div",ba,[t[55]||(t[55]=e("h6",{class:"text-center mb-3 text-success"},[e("i",{class:"fas fa-shield-alt me-1"}),m(" Anonymisiertes Video (Processed) ")],-1)),e("video",{ref_key:"anonymizedVideoElement",ref:K,src:xe.value,controls:"",style:{width:"100%","max-height":"350px"},preload:"metadata",onError:Ge,onLoadstart:Le,onCanplay:Ke,onTimeupdate:t[14]||(t[14]=v=>Ve("anonymized"))}," Ihr Browser unterst√ºtzt dieses Video-Format nicht. ",40,ha),e("div",ya,[e("small",wa," URL: "+o(xe.value||"Nicht verf√ºgbar"),1)])])])]),e("div",xa,[e("button",{class:"btn btn-outline-primary btn-sm me-2",onClick:Re},[...t[56]||(t[56]=[e("i",{class:"fas fa-sync me-1"},null,-1),m(" Videos synchronisieren ",-1)])]),e("button",{class:"btn btn-outline-secondary btn-sm",onClick:je},[...t[57]||(t[57]=[e("i",{class:"fas fa-pause me-1"},null,-1),m(" Alle pausieren ",-1)])]),e("button",{class:"btn btn-outline-info btn-sm ms-2",onClick:He,disabled:Z.value},[Z.value?(l(),r("span",Da)):(l(),r("i",Sa)),t[58]||(t[58]=m(" Segment-Annotation pr√ºfen ",-1))],8,_a)]),Y.value&&d.value?(l(),r("div",ka,[e("div",Va,[e("div",Ia,[e("div",$a,[e("div",null,[e("h6",Na,[t[59]||(t[59]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),m(" Segmente zur Entfernung - Video ID: "+o(d.value.id),1)]),t[60]||(t[60]=e("small",{class:"text-muted"},' Diese Segmente wurden als "outside" klassifiziert und sollten aus dem Video entfernt werden. ',-1))]),e("div",Aa,[e("div",za,o(E.value)+" / "+o(c.value),1),e("div",Fa,[e("div",{class:"progress-bar bg-success",role:"progressbar",style:Ee({width:ke.value+"%"}),"aria-valuenow":E.value,"aria-valuemin":0,"aria-valuemax":c.value},null,12,Oa)]),e("small",Ea,o(ke.value)+"% validiert",1)])])]),e("div",Pa,[Ae(Kt,{videoId:d.value.id,onSegmentValidated:Ze,onValidationComplete:Je},null,8,["videoId"])])])])):x("",!0),_.value?(l(),r("div",{key:1,class:q(["alert mt-3",_.value.class])},[e("i",{class:q([_.value.icon,"me-2"])},null,2),e("strong",null,o(_.value.title)+":",1),m(" "+o(_.value.message)+" ",1),_.value.details?(l(),r("div",Ma,[e("small",null,o(_.value.details),1)])):x("",!0)],2)):x("",!0)])):(l(),r("div",Ya,[t[65]||(t[65]=e("h6",null,"Debug-Informationen:",-1)),e("ul",Ta,[e("li",null,[t[61]||(t[61]=e("strong",null,"Current Item ID:",-1)),m(" "+o(((ae=d.value)==null?void 0:ae.id)||"Nicht verf√ºgbar"),1)]),e("li",null,[t[62]||(t[62]=e("strong",null,"Is PDF:",-1)),m(" "+o(b.value),1)]),e("li",null,[t[63]||(t[63]=e("strong",null,"Is Video:",-1)),m(" "+o(h.value),1)]),e("li",null,[t[64]||(t[64]=e("strong",null,"Detected Media Type:",-1)),m(" "+o(d.value?Q(w).detectMediaType(d.value):"N/A"),1)])])]))])])])]),e("div",Ca,[e("div",Ua,[e("button",{class:"btn btn-secondary",onClick:it}," √úberspringen "),e("div",Ba,[d.value&&(h.value||b.value)?(l(),r("button",{key:0,class:"btn btn-warning position-relative",onClick:dt,disabled:j.value,title:h.value?"Video-Korrektur: Maskierung, Frame-Entfernung, etc.":"PDF-Korrektur: Text-Annotation anpassen"},[t[66]||(t[66]=e("i",{class:"fas fa-edit me-1"},null,-1)),m(" "+o(h.value?"Video-Korrektur":"PDF-Korrektur")+" ",1),Xe.value?(l(),r("span",La," ! ")):x("",!0)],8,Ga)):x("",!0),e("button",{class:"btn btn-danger me-2",onClick:rt}," Ablehnen "),e("button",{class:"btn btn-success",onClick:ot,disabled:j.value||!ye.value,title:fe.value},[j.value?(l(),r("span",Ra)):x("",!0),m(" "+o(j.value?"Wird best√§tigt...":"Best√§tigen"),1)],8,Ka),se.value?(l(),r("div",ja,[t[67]||(t[67]=e("strong",null," Bitte hier den Medientyp eingeben - Der mediaStore hat einen Fehler ",-1)),F(e("select",{"onUpdate:modelValue":t[15]||(t[15]=v=>X.value=v)},[(l(),r(pe,null,Se(O,v=>e("option",{value:v.value},o(v.text),9,qa)),64))],512),[[ze,X.value]])])):x("",!0),!ye.value&&fe.value?(l(),r("div",Wa,[t[68]||(t[68]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[69]||(t[69]=e("strong",null,"Best√§tigung blockiert:",-1)),m(" "+o(fe.value),1)])):x("",!0)])])])],64)):x("",!0)])])}}}),ns=Pe(Ha,[["__scopeId","data-v-2575cad0"]]);export{ns as default};
