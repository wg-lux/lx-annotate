import{h as w,M as A,z as M,e as v}from"./main-DethiONo.js";const i=M;class c{static async getStatusOverview(){return(await i.get("/api/media-management/status/")).data}static async performCleanup(e="unfinished",s=!1){return(await i.delete(`/api/media-management/cleanup/?type=${e}&force=${s}`)).data}static async forceRemoveMedia(e){return(await i.delete(`/api/media-management/force-remove/${e}/`)).data}static async resetProcessingStatus(e){return(await i.post(`/api/media-management/reset-status/${e}/`)).data}static async getPollingCoordinatorInfo(){return(await i.get("/api/anonymization/polling-info/")).data}static async clearProcessingLocks(e){const s=e?`?type=${e}`:"";return(await i.delete(`/api/anonymization/clear-locks/${s}`)).data}static async getAnonymizationStatusSafe(e,s){return(await i.get(`/api/anonymization/${e}/status/`)).data}static async startAnonymizationSafe(e){return(await i.post(`/api/anonymization/${e}/start/`)).data}static async validateAnonymizationSafe(e){return(await i.post(`/api/anonymization/${e}/validate/`)).data}static async reimportVideo(e){return(await i.post(`/api/media/videos/${e}/reimport/`)).data}static async reimportPdf(e){return(await i.post(`/api/media/pdfs/${e}/reimport/`)).data}static async deleteMediaFile(e){return(await i.delete(`/api/media-management/force-remove/${e}/`)).data}}function C(){const d=w(!1),e=w(null),s=async r=>{var l,o,f,m;d.value=!0,e.value=null;try{return await r()}catch(u){return console.error("Media Management API Error:",u),((l=u.response)==null?void 0:l.status)===429?e.value="Zu viele Anfragen. Bitte warten Sie einen Moment.":((o=u.response)==null?void 0:o.status)===409?e.value="Datei wird bereits verarbeitet.":(m=(f=u.response)==null?void 0:f.data)!=null&&m.detail?e.value=u.response.data.detail:e.value="Ein unerwarteter Fehler ist aufgetreten.",null}finally{d.value=!1}};return{isLoading:A(d),error:A(e),clearError:()=>{e.value=null},getStatusOverview:()=>s(()=>c.getStatusOverview()),performCleanup:(r,l=!1)=>s(()=>c.performCleanup(r,l)),forceRemoveMedia:r=>s(()=>c.forceRemoveMedia(r)),resetProcessingStatus:r=>s(()=>c.resetProcessingStatus(r)),deleteMediaFile:r=>s(()=>c.deleteMediaFile(r)),reimportVideo:r=>s(()=>c.reimportVideo(r)),reimportPdf:r=>s(()=>c.reimportPdf(r)),getStatusSafe:(r,l)=>s(()=>c.getAnonymizationStatusSafe(r,l)),startAnonymizationSafe:r=>s(()=>c.startAnonymizationSafe(r)),validateAnonymizationSafe:r=>s(()=>c.validateAnonymizationSafe(r)),getPollingInfo:()=>s(()=>c.getPollingCoordinatorInfo()),clearAllLocks:r=>s(()=>c.clearProcessingLocks(r))}}function D(){const{getStatusSafe:d,startAnonymizationSafe:e,validateAnonymizationSafe:s,clearAllLocks:r}=C(),l=5e3,o=w(new Map),f=(t,a)=>`${a}:${t}`,m=()=>{const t=Date.now();o.value.forEach((a,n)=>{a<=t&&o.value.delete(n)})},u=v(()=>(t,a)=>{m();const n=f(t,a),p=o.value.get(n);return p?p<=Date.now()?(o.value.delete(n),!0):!1:!0}),g=(t,a,n=l)=>{m();const p=f(t,a),k=o.value.get(p);return k&&k>Date.now()?!1:(o.value.set(p,Date.now()+Math.max(1e3,n)),!0)},y=(t,a)=>{const n=f(t,a);o.value.delete(n)},h=async(t,a)=>{try{return await d(t,a)}catch(n){throw console.error(`Status check failed for ${a}:${t}:`,n),n}},P=async(t,a)=>{if(!g(t,a))throw new Error("Datei wird bereits verarbeitet");try{return await e(t)}catch(p){throw p}finally{y(t,a)}},L=async(t,a)=>{g(t,a);try{return await s(t)}catch(n){throw console.error(`Validation failed for ${a}:${t}:`,n),n}finally{y(t,a)}},S=()=>{const t=o.value.size;o.value.clear(),console.log(`Cleared ${t} local processing locks`)},$=async t=>{try{await r(t),t?Array.from(o.value.keys()).forEach(a=>{a.startsWith(`${t}:`)&&o.value.delete(a)}):S(),console.log("All processing locks cleared successfully")}catch(a){throw console.error("Failed to clear processing locks:",a),a}},z=v(()=>{const t=Array.from(o.value.entries()).map(([a,n])=>({key:a,expiresAt:n}));return{totalLocks:t.length,locks:t,videoLocks:t.filter(a=>a.key.startsWith("video:")),pdfLocks:t.filter(a=>a.key.startsWith("pdf:"))}});return{processingLocks:v(()=>Array.from(o.value.entries())),getProcessingLocksInfo:z,canProcessMedia:u,acquireProcessingLock:g,releaseProcessingLock:y,getStatusSafeWithProtection:h,startAnonymizationSafeWithProtection:P,validateAnonymizationSafeWithProtection:L,clearAllLocalLocks:S,clearAllProcessingLocks:$}}export{C as a,D as u};
