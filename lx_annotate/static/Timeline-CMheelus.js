import{d as Me,f as Ee,h as f,w as _,e as R,i as Se,L as W,J as Le,c as p,a as s,j as I,n as Y,t as N,q as y,F as G,m as K,E as Q,k as Z,o as h,_ as Ne}from"./main-DethiONo.js";import{u as Fe}from"./videoStore-ClqdABXQ.js";function re(u){if(!Number.isFinite(u)||u<0)return"00:00";const d=Math.floor(u/60),x=Math.floor(u%60);return`${d.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`}function ze(u,d,x){return!Number.isFinite(u)||!Number.isFinite(d)||!Number.isFinite(x)||x<=0||d<=u?0:(d-u)/x*100}function Pe(u,d){return!Number.isFinite(u)||!Number.isFinite(d)||d<=0?0:u/d*100}function De(){for(var u="0123456789ABCDEF",d="#",x=0;x<6;x++)d+=u[Math.floor(Math.random()*16)];return d}const $e={class:"timeline-container"},_e={class:"timeline-header"},Re={class:"timeline-controls"},We=["disabled"],Ie={class:"time-display"},Be={class:"zoom-controls"},Xe=["disabled"],He={class:"zoom-level"},Oe=["disabled"],Ve={class:"time-markers"},je={class:"marker-text"},Ue={class:"segments-container"},qe=["data-id","onClick","onContextmenu"],Ae={class:"segment-content"},Je={class:"segment-label"},Ye={class:"segment-duration"},Ge=["onClick"],Ke={key:0,class:"draft-indicator"},Qe={key:0,class:"waveform-container"},Ze=Me({__name:"Timeline",props:{video:{},segments:{},labels:{},currentTime:{},isPlaying:{type:Boolean},activeSegmentId:{},showWaveform:{type:Boolean},selectionMode:{type:Boolean},fps:{}},emits:["seek","play-pause","segment-select","segment-edit","segment-delete","segment-create","segment-resize","segment-move","time-selection"],setup(u,{emit:d}){const x=Ee(),ee=Fe(),w=u,g=d,E=f(null),j=f(null),z=f([]),T=f(1),P=f(!1),S=f(0),L=f(0),B=f([]);_(()=>w.segments,e=>{(e||[]).forEach(t=>{B.value.includes(t.label)||B.value.push(t.label)})},{immediate:!0});const C=f({visible:!1,x:0,y:0,segment:null}),X=f({visible:!1,x:0,y:0,text:""}),b=R(()=>{var e;return((e=w.video)==null?void 0:e.duration)||0}),ue=R(()=>{const e=b.value,t=w.currentTime??0;if(!e||!Number.isFinite(e)||!Number.isFinite(t)||t<0)return 0;const n=t/e*100;return Number.isFinite(n)?Math.max(0,Math.min(100,n)):0}),ce=R(()=>{const e=[],t=b.value;if(!t)return e;const l=10/T.value,i=Math.floor(t/l);for(let a=0;a<=i;a++){const o=a*l;o<=t&&e.push({time:o,position:o/t*100})}return e}),te=e=>ee.getColorForLabel(e),de=e=>ee.getTranslationForLabel(e),me=e=>{const t=e.color??te(e.label)??De();return{...e,start:e.startTime,end:e.endTime,color:t,avgConfidence:e.avgConfidence??0}},D=f(null),ve=e=>{D.value=e.label,g("segment-select",Number(e.id))},k=f([]);_(()=>w.segments,e=>{e&&e.length>0?(console.debug("[Timeline] Processing segments:",{count:e.length,sample:e.slice(0,2).map(t=>({id:t.id,label:t.label,startTime:t.startTime,endTime:t.endTime}))}),k.value=e.map(me),console.debug("[Timeline] Canonical segments created:",{count:k.value.length,sample:k.value.slice(0,2).map(t=>({id:t.id,label:t.label,start:t.start,end:t.end,startTime:t.startTime,endTime:t.endTime}))})):k.value=[]},{immediate:!0});const $=R(()=>{var l;const e={};console.debug("[Timeline] segmentRows - processing segments:",{count:k.value.length,segments:k.value.map(i=>({id:i.id,label:i.label,start:i.start,end:i.end}))});for(const i of k.value){if(!i.label){console.error("[Timeline] Segment missing label property:",i);continue}(e[l=i.label]||(e[l]=[])).push(i)}console.debug("[Timeline] Label buckets created:",{labels:Object.keys(e),counts:Object.entries(e).map(([i,a])=>`${i}:${a.length}`)});const t=D.value?[D.value,...B.value.filter(i=>i!==D.value)]:[...B.value],n=[];return t.forEach(i=>{if(!e[i])return;const a=e[i].sort((m,O)=>m.start-O.start);let o=0,c={key:`${i}-0`,label:i,rowNumber:n.length,segments:[],maxEndTime:0};for(const m of a)m.start<c.maxEndTime-1e-4&&(n.push(c),o+=1,c={key:`${i}-${o}`,label:i,rowNumber:n.length,segments:[],maxEndTime:0}),c.segments.push(m),c.maxEndTime=Math.max(c.maxEndTime,m.end);n.push(c)}),console.debug("[Timeline] Rows created:",{count:n.length,rows:n.map(i=>({key:i.key,label:i.label,segmentCount:i.segments.length}))}),n}),F=R(()=>60+$.value.length*45+10),U=e=>typeof e!="number"||isNaN(e)?"00:00":re(e),fe=(e,t)=>{const n=t-e;return re(n)},pe=e=>{const t=Pe(e,b.value);return!Number.isFinite(t)||t<0?(console.error("[Timeline] Invalid segment position calculated:",{startTime:e,duration:b.value,position:t}),0):t},ne=(e,t)=>{const n=ze(e,t,b.value);return!Number.isFinite(n)||n<=0?(console.error("[Timeline] Invalid segment width calculated:",{startTime:e,endTime:t,duration:b.value,width:n}),0):n};function he(e,t){let n=null,l=0,i=0,a=0,o=0,c=0;const m=v=>v/t.trackPx()*t.duration();function O(v){const M=v.target;if(M.closest(".segment-delete-btn"))return;v.stopPropagation();const r=M.closest(".resize-handle");r!=null&&r.classList.contains("start-handle")?n="start":r!=null&&r.classList.contains("end-handle")?n="end":n="drag",l=v.clientX,i=e.offsetLeft,a=e.offsetWidth,e.setPointerCapture(v.pointerId),v.preventDefault()}function J(v){if(!n)return;const M=v.clientX-l;if(n==="drag"){let r=Math.min(Math.max(0,i+M),t.trackPx()-a);e.style.left=r+"px",o=r,c=r+a}if(n==="start"){let r=Math.min(i+M,i+a-10),oe=a+(i-r);e.style.left=r+"px",e.style.width=oe+"px",o=r,c=r+oe}if(n==="end"){let r=Math.max(10,a+M);e.style.width=r+"px",e.style.left=i+"px",o=i,c=i+r}}function V(v){if(!n)return;J(v);const M=o,r=c;n==="drag"?t.onMove(m(M),m(r)):t.onResize(m(M),m(r),n),n=null,e.releasePointerCapture(v.pointerId),t.onDone()}return e.addEventListener("pointerdown",O),e.addEventListener("pointermove",J),e.addEventListener("pointerup",V),e.addEventListener("pointercancel",V),()=>{e.removeEventListener("pointerdown",O),e.removeEventListener("pointermove",J),e.removeEventListener("pointerup",V),e.removeEventListener("pointercancel",V)}}const ie=()=>{z.value.forEach(e=>e()),z.value=[],E.value&&W(()=>{$.value.forEach(e=>{e.segments.forEach(t=>{const n=document.querySelector(`[data-id="${t.id}"]`);if(!n)return;const l=he(n,{trackPx:()=>E.value.offsetWidth,duration:()=>b.value,onMove:(i,a)=>{const o=k.value.find(c=>c.id===t.id);o&&(o.start=i,o.end=a,o.startTime=i,o.endTime=a),g("segment-move",Number(t.id),i,a)},onResize:(i,a,o)=>{const c=k.value.find(m=>m.id===t.id);c&&(c.start=i,c.end=a,c.startTime=i,c.endTime=a),g("segment-resize",Number(t.id),i,a,o)},onDone:()=>{const i=k.value.find(o=>o.id===t.id);if(!i)return;const a=Ce(t.id);a!==null&&g("segment-resize",a,i.start,i.end,"end",!0)}});z.value.push(l)})})})},ge=()=>{T.value<5&&(T.value=Math.min(5,T.value+.5))},be=()=>{T.value>1&&(T.value=Math.max(1,T.value-.5))},ye=()=>{g("play-pause")},xe=e=>{e&&(H(),g("segment-edit",e))},se=e=>{e&&(H(),g("segment-delete",e))},Te=e=>{e&&(H(),g("seek",e.startTime||0),g("play-pause"))},ke=(e,t)=>{C.value={visible:!0,x:t.clientX,y:t.clientY,segment:e}},H=()=>{C.value.visible=!1},we=e=>{if(!E.value)return;const t=E.value.getBoundingClientRect(),n=e.clientX-t.left,l=n/t.width*b.value;w.selectionMode?(P.value=!0,S.value=n/t.width*100,L.value=S.value,document.addEventListener("mousemove",q),document.addEventListener("mouseup",A)):g("seek",l)},q=e=>{if(!P.value||!E.value)return;const t=E.value.getBoundingClientRect(),n=e.clientX-t.left;L.value=Math.max(0,Math.min(100,n/t.width*100))},A=e=>{if(!P.value||!E.value)return;const t=Math.min(S.value,L.value),n=Math.max(S.value,L.value),l=t/100*b.value,i=n/100*b.value;i-l>.1&&g("time-selection",{start:l,end:i}),P.value=!1,S.value=0,L.value=0,document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",A)},le=()=>{if(!j.value||!w.video)return;const e=j.value,t=e.getContext("2d");if(t){e.width=e.offsetWidth,e.height=e.offsetHeight,t.fillStyle="#e0e0e0",t.fillRect(0,0,e.width,e.height),t.strokeStyle="#2196F3",t.lineWidth=1,t.beginPath();for(let n=0;n<e.width;n+=2){const l=Math.random()*e.height*.8+e.height*.1;n===0?t.moveTo(n,l):t.lineTo(n,l)}t.stroke()}},ae=e=>{var t;C.value.visible&&!((t=e.target)!=null&&t.closest(".context-menu"))&&H()};_(()=>w.video,()=>{w.showWaveform&&W(()=>{le()})}),_($,()=>W(ie),{immediate:!0}),_($,e=>{e.forEach(t=>{t.segments.forEach(n=>{ne(n.start,n.end)===0&&console.warn("[Timeline] Segment mit 0% Breite:",n)})})},{immediate:!0}),Se(()=>{document.addEventListener("click",ae),W(()=>{ie()}),w.showWaveform&&W(()=>{le()}),x.success({text:"[Timeline] Component mounted and ready"})}),Le(()=>{document.removeEventListener("click",ae),z.value.forEach(e=>e()),z.value=[],document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",A)});const Ce=e=>typeof e=="number"&&Number.isFinite(e)?e:(console.error("[Timeline] Unexpected segment ID:",e),null);return(e,t)=>(h(),p("div",$e,[s("div",_e,[s("div",Re,[s("button",{onClick:ye,class:"play-btn",disabled:!u.video},[s("i",{class:Y(u.isPlaying?"fas fa-pause":"fas fa-play")},null,2)],8,We),s("span",Ie,N(U(u.currentTime))+" / "+N(U(b.value)),1)]),s("div",Be,[s("button",{onClick:be,disabled:T.value<=1},[...t[4]||(t[4]=[s("i",{class:"fas fa-search-minus"},null,-1)])],8,Xe),s("span",He,N(Math.round(T.value*100))+"%",1),s("button",{onClick:ge,disabled:T.value>=5},[...t[5]||(t[5]=[s("i",{class:"fas fa-search-plus"},null,-1)])],8,Oe)])]),s("div",{class:"timeline-wrapper",style:y({height:F.value+"px"})},[s("div",{class:"timeline",ref_key:"timeline",ref:E,onMousedown:we,style:y({height:F.value+"px"})},[s("div",Ve,[(h(!0),p(G,null,K(ce.value,n=>(h(),p("div",{key:n.time,class:"time-marker",style:y({left:n.position+"%"})},[s("div",{class:"marker-line",style:y({height:F.value+"px"})},null,4),s("div",je,N(U(n.time)),1)],4))),128))]),s("div",Ue,[(h(!0),p(G,null,K($.value,n=>(h(),p("div",{key:n.key,class:Y(["segment-row",{active:n.label===D.value}]),style:y({top:n.rowNumber*45+"px",height:"40px"})},[(h(!0),p(G,null,K(n.segments,l=>(h(),p("div",{key:l.id,class:Y(["segment",{active:l.id===u.activeSegmentId,draft:l.isDraft}]),style:y({left:pe(l.start)+"%",width:ne(l.start,l.end)+"%",backgroundColor:l.color||te(l.label),borderColor:l.isDraft?"#ff9800":"transparent"}),"data-id":l.id,onClick:i=>ve(l),onContextmenu:Q(i=>ke(l,i),["prevent"])},[t[7]||(t[7]=s("div",{class:"resize-handle start-handle",title:"Segment-Start ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),s("div",Ae,[s("span",Je,N(de(l.label)),1),s("span",Ye,N(fe(l.start,l.end)),1)]),s("div",{class:"segment-delete-btn",onClick:Q(i=>se(l),["stop"]),title:"Segment löschen"},"X",8,Ge),t[8]||(t[8]=s("div",{class:"resize-handle end-handle",title:"Segment-Ende ändern"},[s("i",{class:"fas fa-grip-lines-vertical"})],-1)),l.isDraft?(h(),p("div",Ke,[...t[6]||(t[6]=[s("i",{class:"fas fa-edit"},null,-1)])])):I("",!0)],46,qe))),128))],6))),128))]),s("div",{class:"playhead",style:y({left:ue.value+"%",height:F.value+"px"})},[s("div",{class:"playhead-line",style:y({height:F.value+"px"})},null,4),t[9]||(t[9]=s("div",{class:"playhead-handle"},null,-1))],4),P.value?(h(),p("div",{key:0,class:"selection-overlay",style:y({left:Math.min(S.value,L.value)+"%",width:Math.abs(L.value-S.value)+"%",height:F.value+"px"})},null,4)):I("",!0)],36),u.showWaveform?(h(),p("div",Qe,[s("canvas",{ref_key:"waveformCanvas",ref:j,class:"waveform-canvas"},null,512)])):I("",!0)],4),C.value.visible?(h(),p("div",{key:0,class:"context-menu",style:y({left:C.value.x+"px",top:C.value.y+"px"}),onClick:t[3]||(t[3]=Q(()=>{},["stop"]))},[s("div",{class:"context-menu-item",onClick:t[0]||(t[0]=n=>xe(C.value.segment))},[...t[10]||(t[10]=[s("i",{class:"fas fa-edit"},null,-1),Z(" Segment bearbeiten ",-1)])]),s("div",{class:"context-menu-item danger",onClick:t[1]||(t[1]=n=>se(C.value.segment))},[...t[11]||(t[11]=[s("i",{class:"fas fa-trash"},null,-1),Z(" Segment löschen ",-1)])]),t[13]||(t[13]=s("div",{class:"context-menu-separator"},null,-1)),s("div",{class:"context-menu-item",onClick:t[2]||(t[2]=n=>Te(C.value.segment))},[...t[12]||(t[12]=[s("i",{class:"fas fa-play"},null,-1),Z(" Segment abspielen ",-1)])])],4)):I("",!0),X.value.visible?(h(),p("div",{key:1,class:"timeline-tooltip",style:y({left:X.value.x+"px",top:X.value.y+"px"})},N(X.value.text),5)):I("",!0)]))}}),nt=Ne(Ze,[["__scopeId","data-v-5a269f8e"]]);export{nt as T};
