const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/annotationStore-DEHKjdKh.js","assets/main-DethiONo.js","assets/main-DGGk9Vng.css","assets/authStore-w8taChNC.js"])))=>i.map(i=>d[i]);
import{O as je,h,I as Oe,e as p,M as $,z as g,A as v,f as Re,P as ee,Q as te,g as ze}from"./main-DethiONo.js";const Be={appendix:"Appendix",blood:"Blut",diverticule:"Divertikel",grasper:"Greifer",ileocaecalvalve:"IleozÃ¤kalklappe",ileum:"Ileum",low_quality:"Niedrige BildqualitÃ¤t",nbi:"Narrow Band Imaging",needle:"Nadel",outside:"AuÃŸerhalb",polyp:"Polyp",snare:"Snare",water_jet:"Wasserstrahl",wound:"Wunde"};function U(n){return Be[n]??n}const Ke={outside:"#e74c3c",polyp:"#f39c12",needle:"#3498db",blood:"#e74c3c",snare:"#9b59b6",grasper:"#2ecc71",water_jet:"#1abc9c",appendix:"#f1c40f",ileum:"#e67e22",diverticule:"#34495e",ileocaecalvalve:"#95a5a6",nbi:"#8e44ad",low_quality:"#7f8c8d",wound:"#c0392b"};function B(n){return Ke[n]??"#95a5a6"}const M=n=>{if(!n||n<0)return"00:00";const u=Math.floor(n/60),y=Math.floor(n%60);return`${u.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}`};function V(n){var c,m;const u=n.labelName??n.labelDisplay??"unknown";let y;return(m=(c=n.timeSegments)==null?void 0:c.frames)!=null&&m.length&&(y=n.timeSegments.frames.reduce((b,E)=>(b[String(E.frameId)]=E,b),{})),{id:n.id,label:u,startTime:n.startTime,endTime:n.endTime,avgConfidence:1,videoID:n.videoId,labelID:n.labelId,startFrameNumber:n.startFrameNumber,endFrameNumber:n.endFrameNumber,frames:y}}const Ge=h([]),K=Re(),We={},qe=1/50,ae=5;let Qe=-1;const Je=je("video",()=>{const n=h(null),u=h(""),y=h(""),c=Oe({...We}),m=h({videos:[],labels:[]}),b=h(null),E=h(null),P=h(0),d=h(null),A=h(null);function k(e){return`${window.location.origin}/api/media/videos/${e}/`}const ne=p(()=>!!n.value),x=p(()=>{var e;return(e=b.value)!=null&&e.duration?b.value.duration:0}),oe=p(()=>{var e;return((e=n.value)==null?void 0:e.segments)||[]}),re=p(()=>{var e;return((e=m.value)==null?void 0:e.labels)||[]}),G=p(()=>{const e={};return m.value.labels.forEach(t=>e[t.name]=t.id),e});function C(e){return{...e,labelID:e.labelID??G.value[e.label]??null}}const F=p(()=>{var t;const e=[...((t=n.value)==null?void 0:t.segments)||[]];if(d.value){const o={id:d.value.id,label:d.value.label,startTime:d.value.startTime,endTime:d.value.endTime||d.value.startTime,avgConfidence:0,labelID:G.value[d.value.label]??null,isDraft:!0};e.push(o)}return e}),se=p(()=>F.value.map(e=>({id:e.id,label:U(e.label),startTime:e.startTime,endTime:e.endTime,display:`${U(e.label)}: ${M(e.startTime)} â€“ ${M(e.endTime)}`}))),le=p(()=>F.value.find(e=>e.id===E.value)||null);async function ie(e){var t;if(e||(e=((t=n.value)==null?void 0:t.id)||null),!e)return console.error(`Invalid video ID: ${e}`),!1;try{return await g.delete(`/api/media-management/${e}/force-remove/`),!0}catch(o){return console.error(`Failed to delete video ${e}:`,o),!1}}function ce(e){E.value=e}function de(e,t){t&&e.startTime&&(t.currentTime=e.startTime,t.play().catch(console.error))}function ue(e,t){const o=e.startTime/t*100,r=(e.endTime-e.startTime)/t*100;return{left:`${o}%`,width:`${r}%`,backgroundColor:B(e.label)}}function j(e,t,o=!1){for(const r in c){const a=c[r].find(s=>s.id===e);if(a){Object.assign(a,t),o&&!a.isDraft&&(a.isDirty=!0);break}}}function me(){return se.value}function ge(){Object.keys(c).forEach(e=>{delete c[e]})}async function W(e){if(console.log(`[VideoStore] fetchAllSegments called with video ID: ${e}`),n.value||(console.log(`[VideoStore] No currentVideo found, creating basic video object for ID: ${e}`),n.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null}),await H(e),n.value){const t=[];Object.values(c).forEach(o=>{t.push(...o)}),n.value.segments=t,console.log(`[VideoStore] Timeline segments populated: ${t.length} segments for video ${e}`)}}async function fe(){console.log("Saving annotations...")}async function ve(e){n.value&&(n.value.status=e)}async function pe(e){n.value&&(n.value.assignedUser=e)}async function q(){console.log("ðŸ·ï¸ [VideoStore] Fetching labels with high priority...");try{const t=(await g.get(v("media/videos/labels/list/"))).data.map(o=>({id:Number(o.id),name:String(o.name),color:o.color||B(o.name)}));return m.value.labels=t,console.log(`âœ… [VideoStore] Loaded ${t.length} labels`),t}catch(e){throw console.error("âŒ Error loading labels:",e),m.value.labels=[],e}}async function he(){console.log("Fetching all videos...");try{await q();const e=await g.get(v("media/videos/"));console.log("API Response:",e.data);const t=e.data.videos.map(a=>({id:parseInt(a.id),original_file_name:a.original_file_name,status:a.status||"available",assignedUser:a.assignedUser||null,anonymized:a.anonymized||!1,centerName:a.center_name||"Unbekannt",processorName:a.processor_name||"Unbekannt"})),o=m.value.labels;console.log("Fetching segments for",t.length,"videos...");const r=await Promise.all(t.map(async a=>{try{const s=await g.get(v(`media/videos/${a.id}/segments/`));console.log(`Video ${a.id}: Found ${s.data.length} segments`);const l=s.data.map(S=>C(V(S)));return{...a,segments:l}}catch(s){return console.warn(`Failed to load segments for video ${a.id}:`,s),{...a,segments:[]}}}));return m.value={videos:r,labels:o},console.log("âœ… Processed videos with segments:",m.value),m.value}catch(e){throw console.error("Error loading videos:",e),m.value={videos:[],labels:[]},e}}function be(){n.value=null}function Se(e){n.value=e}function ye(e){const t=m.value.videos.find(o=>o.id===e)||null;return t?n.value={id:t.id,isAnnotated:!0,errorMessage:"",segments:[],videoUrl:k(t.id)+"?type=processed",status:t.status,assignedUser:t.assignedUser||null}:n.value=null,n.value}async function Q(e){var t,o;try{const r=e||((t=n.value)==null?void 0:t.id);if(!r){console.warn("No video ID available for fetching video URL"),u.value="No video selected.";return}const a=await g.get(v(`media/videos/${r}/`),{headers:{Accept:"application/json"}});a.data.video_url?(y.value=a.data.video_url,console.log("Fetched video URL:",y.value)):(console.warn("No video URL returned from API response:",a.data),u.value="Video URL not available.")}catch(r){const a=r;console.error("Error loading video URL:",((o=a.response)==null?void 0:o.data)||a.message),u.value="Error loading video URL. Please check the API endpoint or try again later."}}const we=p(()=>n.value?k(n.value.id)+"?type=processed":"");function De(){var t;if(!((t=n.value)!=null&&t.id)){A.value=null;return}const e=n.value.id;g.get(v(`anonymization/${e}/has-raw/`)).then(o=>{A.value=o.data.has_raw_file,console.log(`Raw video file for ID ${e}:`,A.value)}).catch(o=>{console.error("Error checking raw video file:",o),A.value=null})}async function _e(e,t="outside"){var o;try{const a=(await g.get(v(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"},params:{label:t}})).data.map(s=>C(V(s)));c[t]=a,n.value&&(n.value.segments=Object.values(c).flat())}catch(r){const a=r;console.error("Error loading segments for label "+t+":",((o=a.response)==null?void 0:o.data)||a.message),u.value=`Error loading segments for label ${t}. Please check the API endpoint or try again later.`}}async function H(e){var o;const t=++P.value;try{const r=await g.get(v(`media/videos/${e}/segments/`),{headers:{Accept:"application/json"}});if(t!==P.value)return;Object.keys(c).forEach(s=>{delete c[s]}),console.log(`[VideoStore] Loading ${r.data.length} segments for video ${e}`),r.data.forEach(s=>{const i=C(V(s)),l=i.label;c[l]||(c[l]=[]),i.endTime-i.startTime<.1&&console.warn(`âš ï¸ Very short segment ${i.id}: ${i.endTime-i.startTime}s`),c[l].push(i)}),console.log("[VideoStore] Processed segments by label:",Object.keys(c).map(s=>`${s}: ${c[s].length}`))}catch(r){if(t===P.value){const a=r;console.error("Error loading video segments:",((o=a.response)==null?void 0:o.data)||a.message),u.value="Error loading video segments. Please try again later."}}}async function Te(e,t,o,r){var a,s;try{const i=m.value.labels.find(D=>D.name===t);if(!i)return console.error(`Label ${t} not found in store`),u.value=`Label ${t} nicht gefunden`,null;const l=i.id,S=x.value>0&&((a=b.value)==null?void 0:a.fps)||30,f=Math.floor(o*S),N=Math.floor(r*S),O={video_file:e,label:l,start_frame_number:f,end_frame_number:N},L=(await g.post(v(`media/videos/${e}/segments/`),O)).data;let w=V(L);return w={...w,label:t,videoID:e,labelID:l},c[t]||(c[t]=[]),c[t].push(w),console.log("Created segment:",w),w}catch(i){const l=i;return console.error("Error creating segment:",((s=l.response)==null?void 0:s.data)||l.message),u.value="Error creating segment. Please try again.",null}}function $e(e,t,o,r={}){var l;const a=((l=b.value)==null?void 0:l.fps)||30,s=Math.floor(t*a),i=Math.floor(o*a);return{start_time:t,end_time:o,start_frame_number:s,end_frame_number:i,...r}}async function Ve(e,t){var o,r;try{const a=(o=n.value)==null?void 0:o.id;if(!a)return console.error("[VideoStore] Cannot update segment without current video"),!1;const s=$e(e,t.startTime??t.start_time??0,t.endTime??t.end_time??0,t),i=v(`media/videos/${a}/segments/${e}/`),l=await g.patch(i,s),S=V(l.data);return j(e,S),console.log(`[VideoStore] Successfully updated segment ${e}`),!0}catch(a){const s=a;return console.error("Error updating segment:",((r=s.response)==null?void 0:r.data)||s.message),u.value="Error updating segment. Please try again.",K.success({text:"Segment aktualisiert"}),!1}}async function Ee(e){var t,o;try{const r=(t=n.value)==null?void 0:t.id;if(!r)return console.error("[VideoStore] Kann Segment nicht lÃ¶schen: Kein Video ausgewÃ¤hlt"),!1;const a=v(`media/videos/${r}/segments/${e}/`);await g.delete(a);for(const s in c){const i=c[s].findIndex(l=>l.id===e);if(i!==-1){c[s].splice(i,1);break}}return!0}catch(r){const a=r;return console.error("Error deleting segment:",((o=a.response)==null?void 0:o.data)||a.message),u.value="Error deleting segment. Please try again.",!1}}function Ae(e){const t=Object.keys(c);for(const o of t)c[o]=c[o].filter(r=>r.id!==e)}function J(e,t){console.log(`[Draft] Starting draft: ${e} at ${M(t)}`),d.value={id:Qe--,label:e,startTime:t,endTime:null},console.log("[Draft] Created draft segment:",d.value)}function X(e){if(!d.value){console.warn("[Draft] Kein aktiver Draft gefunden zum Aktualisieren.");return}const t=d.value.startTime+qe,o=Math.max(t,e);d.value.endTime=o,console.log(`[Draft] Draft-Ende aktualisiert: ${M(o)}, Duration: ${o-d.value.startTime}s`)}async function Y(){var t,o,r,a,s,i,l,S;if(console.log("[Draft] commitDraft() called, draftSegment:",d.value),console.log("[Draft] currentVideo:",(t=n.value)==null?void 0:t.id),!d.value)return console.warn("[Draft] Kein Draft zum Committen gefunden - draftSegment.value ist null/undefined"),null;if(!n.value)return console.warn("[Draft] Kein currentVideo gefunden"),null;const e=d.value;if(e.endTime===null||e.endTime===void 0)return console.error("[Draft] Draft-Ende muss gesetzt sein vor dem Committen. Current endTime:",e.endTime),null;try{const f=m.value.labels.find(_=>_.name===e.label);if(!f)return console.error(`[Draft] Label ${e.label} not found in store`),console.log("[Draft] Available labels:",m.value.labels.map(_=>_.name)),u.value=`Label ${e.label} nicht gefunden`,null;const N=((o=b.value)==null?void 0:o.fps)||30,O=Math.floor(e.startTime*N),Z=Math.floor(e.endTime*N),L={video_file:parseInt(n.value.id.toString()),label:f.id,start_frame_number:O,end_frame_number:Z};console.log("[Draft] Committing Draft-Segment with payload:",L);const w=(r=n.value)==null?void 0:r.id;if(!w)return console.error("[Draft] Cannot commit: no current video"),null;const D=await g.post(v(`media/videos/${w}/segments/`),L);console.log("[Draft] API response:",D.data);const T={id:D.data.id,label:e.label,startTime:D.data.startTime,endTime:D.data.endTime,avgConfidence:1,videoID:parseInt(n.value.id.toString()),labelID:f.id,startFrameNumber:D.data.startFrameNumber,endFrameNumber:D.data.endFrameNumber};(a=n.value)!=null&&a.segments&&(n.value.segments.push(T),console.log("[Draft] Added segment to currentVideo.segments, new count:",n.value.segments.length));const I=e.label;c[I]||(c[I]=[]),c[I].push(T),console.log("[Draft] Added segment to segmentsByLabel["+I+"], new count:",c[I].length);try{const{useAnnotationStore:_}=await ee(async()=>{const{useAnnotationStore:z}=await import("./annotationStore-DEHKjdKh.js");return{useAnnotationStore:z}},__vite__mapDeps([0,1,2])),{useAuthStore:xe}=await ee(async()=>{const{useAuthStore:z}=await import("./authStore-w8taChNC.js");return{useAuthStore:z}},__vite__mapDeps([3,1,2])),Ce=_(),R=xe();R.initMockUser(),(s=R.user)!=null&&s.id?(await Ce.createSegmentAnnotation(n.value.id.toString(),T,R.user.id),console.log(`âœ… Created annotation for segment ${T.id}`)):console.warn("No authenticated user found for annotation creation")}catch(_){console.error("Failed to create segment annotation:",_)}const ke={...d.value};return d.value=null,console.log("[Draft] Draft erfolgreich committed und gecleared:",ke,"-> New segment:",T),T}catch(f){return console.error("[Draft] Fehler beim Committen des Draft-Segments:",f),f instanceof te&&((i=f.response)!=null&&i.data)&&console.error("[Draft] Backend error details:",f.response.data),u.value=f instanceof te&&(((S=(l=f.response)==null?void 0:l.data)==null?void 0:S.detail)||f.message)||"Unbekannter Fehler beim Speichern",null}}function Fe(){if(!d.value){console.warn("[Draft] Kein Draft zum Abbrechen gefunden.");return}console.log("[Draft] Draft abgebrochen:",d.value),d.value=null}async function Ie(e,t){const o=e,r=Math.min(e+ae,x.value||e+ae);return J(t,o),X(r),await Y()}async function Ue(){var r;if(!((r=n.value)!=null&&r.id))return;const e=n.value.id,t=F.value.filter(a=>a.isDirty&&!a.isDraft);if(t.length===0)return;const o={segment_ids:t.map(a=>a.id),segments:t.map(a=>({id:a.id,start_time:a.startTime,end_time:a.endTime})),is_validated:!1,information_source_name:"manual_annotation"};try{await g.post(v(`media/videos/${e}/segments/validate-bulk/`),o),t.forEach(a=>a.isDirty=!1),K.success({text:"Ã„nderungen am Server gespeichert"})}catch(a){console.error("Save failed:",a),K.error({text:"Speichern der Ã„nderungen fehlgeschlagen"})}}async function Me(e){var r,a,s;if(console.log(`[VideoStore] loadVideo called with ID: ${e}`),!ze().overview.some(i=>i.id===Number(e)&&i.mediaType==="video"&&i.anonymizationStatus==="done_processing_anonymization"))throw new Error(`Video ${e} darf nicht annotiert werden, solange die Anonymisierung nicht abgeschlossen ist.`);try{n.value={id:e,isAnnotated:!1,errorMessage:"",segments:[],videoUrl:"",status:"available",assignedUser:null};try{const l=(await g.get(v(`media/videos/${e}/`))).data;console.log("[VideoStore] Got video metadata:",l),n.value={id:l.id||e,videoUrl:l.video_url||"",status:l.status||"available",assignedUser:l.assignedUser||null,isAnnotated:l.isAnnotated||!1,errorMessage:"",segments:[],duration:l.duration,fps:l.fps}}catch(i){console.warn(`[VideoStore] Could not fetch video metadata for ${e}, using basic object:`,i)}await Q(e),await W(e),console.log(`[VideoStore] Video ${e} successfully loaded with ${((a=(r=n.value)==null?void 0:r.segments)==null?void 0:a.length)||0} segments`)}catch(i){const l=i;console.error(`[VideoStore] Error loading video ${e}:`,((s=l.response)==null?void 0:s.data)||l.message),u.value="Error loading video. Please try again."}}const Ne=p(()=>F.value.map(e=>({id:e.id,label:e.label,label_display:U(e.label),name:U(e.label),startTime:e.startTime,endTime:e.endTime,avgConfidence:e.avgConfidence,video_id:e.videoID,label_id:e.labelID})));function Le(e,t){j(e,t,!0)}function Pe(e,t){d.value&&d.value.id===e&&Object.assign(d.value,t)}return{currentVideo:$(n),errorMessage:$(u),videoUrl:$(y),segmentsByLabel:c,videoList:$(m),videoMeta:$(b),videos:Ge,allSegments:F,draftSegment:d,activeSegment:le,duration:x,hasVideo:ne,segments:oe,labels:re,videoStreamUrl:we,timelineSegments:Ne,hasRawVideoFile:$(A),buildVideoStreamUrl:k,setCurrentVideo:ye,clearVideo:be,deleteVideo:ie,setVideo:Se,loadVideo:Me,fetchVideoUrl:Q,fetchAllSegments:W,fetchAllVideos:he,fetchLabels:q,fetchVideoSegments:H,fetchSegmentsByLabel:_e,createSegment:Te,updateSegmentAPI:Ve,deleteSegment:Ee,removeSegment:Ae,saveAnnotations:fe,getSegmentStyle:ue,getColorForLabel:B,getTranslationForLabel:U,jumpToSegment:de,setActiveSegment:ce,updateVideoStatus:ve,assignUserToVideo:pe,hasRawVideoFileFn:De,persistDirtySegments:Ue,updateSegmentInMemory:j,startDraft:J,updateDraftEnd:X,commitDraft:Y,cancelDraft:Fe,createFiveSecondSegment:Ie,patchDraftSegment:Pe,patchSegmentLocally:Le,backendSegmentToSegment:V,formatTime:M,getSegmentOptions:me,clearSegments:ge}});export{M as f,U as g,Je as u};
