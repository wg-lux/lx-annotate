apiVersion: apps/v1
kind: Deployment
metadata:
  name: lx-annotate
  namespace: lx-annotate
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lx-annotate
  template:
    metadata:
      labels:
        app: lx-annotate
      annotations:
        build-timestamp: "${BUILD_TS}"
    spec:
      securityContext:
        fsGroup: 10001
      containers:
        - name: lx-annotate
          image: ${IMAGE}
          imagePullPolicy: Always
          ports:
            - containerPort: 8118
          envFrom:
            - secretRef:
                name: lx-annotate-secrets
            - configMapRef:
                name: lx-annotate-config
          env:
            - name: DJANGO_SETTINGS_MODULE
              value: config.settings.prod
          readinessProbe:
            httpGet:
              path: /
              port: 8118
              httpHeaders:
                - name: Host
                  value: lx-annotate.lx-annotate.cluster.local
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
            successThreshold: 1
          livenessProbe:
            httpGet:
              path: /
              port: 8118
              httpHeaders:
                - name: Host
                  value: lx-annotate.lx-annotate.svc.cluster.local
            initialDelaySeconds: 60
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1
          resources:
            requests:
              cpu: "1"
              memory: 4Gi
            limits:
              cpu: "3"
              memory: 16Gi
          volumeMounts:
            - name: data
              mountPath: /app/data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: lx-annotate-data
